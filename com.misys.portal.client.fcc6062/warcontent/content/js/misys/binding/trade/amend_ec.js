/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.binding.trade.amend_ec"]){dojo._hasResource["misys.binding.trade.amend_ec"]=true;dojo.provide("misys.binding.trade.amend_ec");dojo.require("dijit.form.DateTextBox");dojo.require("misys.form.CurrencyTextBox");dojo.require("dijit.form.NumberTextBox");dojo.require("dijit.form.FilteringSelect");dojo.require("misys.form.file");dojo.require("misys.form.SimpleTextarea");dojo.require("misys.form.common");dojo.require("misys.validation.common");dojo.require("dijit.form.Form");dojo.require("dijit.form.Button");dojo.require("dijit.form.TextBox");dojo.require("misys.widget.Dialog");dojo.require("dijit.ProgressBar");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.CheckBox");dojo.require("dijit.layout.ContentPane");dojo.require("misys.widget.Collaboration");dojo.require("misys.widget.NoCloseDialog");dojo.require("misys.binding.trade.ls_common");dojo.require("misys.form.addons");(function(d,dj,m){var _1="deletegridrecord";var _2="label[for=tenor_period_label]";function _3(){var _4=dijit.byId("attachment-file");var _5=true;var _6=[];var _7=[];var _8=[];if(_4&&_4.store&&_4.store._arrayOfAllItems&&_4.store._arrayOfAllItems.length){d.forEach(_4.store._arrayOfAllItems,function(_9,_a){if(_9&&_9.attachment_id&&_9.file_name){_7.push(_9.attachment_id.toString());_8.push(_9.file_name.toString());}});}d.query("*[id^='documents_details_mapped_attachment_id_']").forEach(function(_b,_c){var _d=dijit.byId("documents_details_mapped_attachment_id_"+_c);var _e=_d?_d.get("value"):"";var _f=dijit.byId("documents_details_mapped_attachment_name_"+_c);var _10=_f?_f.get("value"):"";var _11=(_7&&_e!==""&&_7.indexOf(_e)==-1&&_8&&_10!==""&&_8.indexOf(_10)==-1);var _12=dojo.byId("document_row_"+_c);if(_d&&_f&&_11){_d.set("value","");_f.set("value","");_12.cells[6].innerHTML="";_5=false;}});if(!_5){m._config.onSubmitErrorMsg=m.getLocalization("incorrectDocumentMappingError");}return _5;};function _13(_14){if(_15(_14)){var _16=dj.byId("documents_details_total_send");var _17=d.number.parse(dj.byId("documents_details_first_mail_send").get("value"));var _18=d.number.parse(dj.byId("documents_details_second_mail_send").get("value"));_16.set("value",_17+_18);_16.set("readOnly",true);return true;}};function _15(_19){if(dj.byId(_19)){var _1a=dj.byId(_19).get("value");var _1b=new RegExp("^[0-9]+$");if(_1a!=""&&!_1b.test(_1a)){var _1c=m.getLocalization("invalidContent");dj.byId(_19).set("state","Error");dj.hideTooltip(dj.byId(_19).domNode);dj.showTooltip(_1c,dj.byId(_19).domNode,0);var _1d=function(){dj.hideTooltip(dj.byId(_19).domNode);};setTimeout(_1d,1500);return false;}return true;}};function _1e(){if(dj.byId("org_ec_amt")&&dj.byId("org_ec_amt").get("value")!==null&&dj.byId("dec_amt")&&dj.byId("dec_amt").get("value")!==null){if(d.number.parse(dijit.byId("org_ec_amt").get("displayedValue"))<d.number.parse(dijit.byId("dec_amt").get("displayedValue"))){var _1f=dj.byId("ec_cur_code").get("value");var _20=dojo.number.parse(dj.byId("org_ec_amt").get("displayedValue"));dj.byId("dec_amt").invalidMessage=m.getLocalization("decAmountLessThanECAmt",[_1f,_20.toFixed(2)]);misys.dialog.show("ERROR",dj.byId("dec_amt").invalidMessage,"",function(){dj.byId("dec_amt").focus();dj.byId("dec_amt").set("state","Error");});return false;}}return true;};d.mixin(m._config,{initReAuthParams:function(){var _21={productCode:"EC",subProductCode:"",transactionTypeCode:"03",entity:dj.byId("entity")?dj.byId("entity").get("value"):"",currency:dj.byId("ec_cur_code")?dj.byId("ec_cur_code").get("value"):"",amount:dj.byId("ec_amt")?m.trimAmount(dj.byId("ec_amt").get("value")):"",es_field1:dj.byId("ec_amt")?m.trimAmount(dj.byId("ec_amt").get("value")):"",es_field2:""};return _21;},xmlTransform:function(xml){var _22="<ec_tnx_record>";if(xml.indexOf(_22)!=-1){var _23=m._config.xmlTagName,_24=_23?["<",_23,">"]:[],_25="</ec_tnx_record>",_26="",_27=-1;_26=xml.substring(_22.length,(xml.length-_25.length));_24.push(_26);if(dj.byId("gridLicense")&&dj.byId("gridLicense").store&&dj.byId("gridLicense").store!==null&&dj.byId("gridLicense").store._arrayOfAllItems.length>0){_24.push("<linked_licenses>");dj.byId("gridLicense").store.fetch({query:{REFERENCEID:"*"},onComplete:dojo.hitch(dj.byId("gridLicense"),function(_28,_29){dojo.forEach(_28,function(_2a){_24.push("<license>");_24.push("<ls_ref_id>",_2a.REFERENCEID,"</ls_ref_id>");_24.push("<bo_ref_id>",_2a.BO_REF_ID,"</bo_ref_id>");_24.push("<ls_number>",_2a.LS_NUMBER,"</ls_number>");_24.push("<ls_allocated_amt>",_2a.LS_ALLOCATED_AMT,"</ls_allocated_amt>");_24.push("<ls_amt>",_2a.LS_AMT,"</ls_amt>");_24.push("<ls_os_amt>",_2a.LS_OS_AMT,"</ls_os_amt>");_24.push("<converted_os_amt>",_2a.CONVERTED_OS_AMT,"</converted_os_amt>");_24.push("<allow_overdraw>",_2a.ALLOW_OVERDRAW,"</allow_overdraw>");_24.push("</license>");});})});_24.push("</linked_licenses>");}if(_23){_24.push("</",_23,">");}return _24.join("");}else{return xml;}}});d.mixin(m,{bind:function(){m.setValidation("amd_date",m.validateAmendmentDate);m.connect("inc_amt","onBlur",function(){m.validateAmendAmount(true,this,"ec");});m.connect("dec_amt","onBlur",function(){_1e();m.validateAmendAmount(true,this,"ec");});if(dj.byId("tenor_base_date")){m.setValidation("tenor_base_date",m.validateBaseDateWithCurrentSystemDate);}if(dj.byId("tenor_maturity_date")){m.setValidation("tenor_maturity_date",m.validateMaturityDateWithSystemDate);}m.connect("inc_amt","onBlur",m.amendTransaction);m.connect("dec_amt","onBlur",m.amendTransaction);m.connect("ec_amt","onBlur",function(){var _2b=d.number.parse(dj.byId("org_ec_amt").get("displayedValue")),_2c=d.number.parse(dj.byId("ec_amt").get("displayedValue"));if(!isNaN(_2c)){if(_2b>_2c){dj.byId("dec_amt").set("value",_2b-_2c);dj.byId("dec_amt").set("disabled",false);dj.byId("inc_amt").set("disabled",true);dj.byId("inc_amt").set("value","");}if(_2b<_2c){dj.byId("inc_amt").set("value",_2c-_2b);dj.byId("inc_amt").set("disabled",false);dj.byId("dec_amt").set("disabled",true);dj.byId("dec_amt").set("value","");}if(_2b===_2c){dj.byId("inc_amt").set("value","");dj.byId("inc_amt").set("disabled",false);dj.byId("dec_amt").set("value","");dj.byId("dec_amt").set("disabled",false);}}if(d.number.parse(dj.byId("ec_amt").get("displayedValue"))<=0){m.showTooltip(m.getLocalization("valueShouldBeGreaterThanZero",[dj.byId("ec_amt").get("displayedValue")]),d.byId("ec_amt"),["after"],5000);misys.dialog.show("ERROR",dj.byId("ec_amt").invalidMessage,"",function(){dj.byId("dec_amt").set("value","");dj.byId("inc_amt").set("value","");dj.byId("dec_amt").set("disabled",false);dj.byId("inc_amt").set("disabled",false);dj.byId("ec_amt").set("state","Error");});return false;}if(isNaN(d.number.parse(dj.byId("ec_amt").get("displayedValue")))){dj.byId("dec_amt").set("value","");dj.byId("inc_amt").set("value","");dj.byId("dec_amt").set("disabled",false);dj.byId("inc_amt").set("disabled",false);dj.byId("ec_amt").set("state","Error");return false;}return true;});m.connect("license_lookup","onClick",function(){m.getLicenses("ec");});m.connect("inco_term_year","onChange",m.getIncoTerm);m.connect("inco_term_year","onChange",function(){m.toggleFields(this.get("value"),null,["inco_term"],false,true);});m.connect("inco_term","onChange",function(){m.toggleFields(this.get("value"),null,["inco_place"],false,false);});m.connect("term_code","onChange",function(){if(this.get("value")!="01"){dj.byId("accpt_adv_send_mode").set("disabled",false);}else{if(this.get("value")==="01"){dj.byId("accpt_adv_send_mode").set("value","");dj.byId("accpt_adv_send_mode").set("disabled",true);}}if(dj.byId("protest_non_accpt").get("checked",true)){dj.byId("protest_non_accpt").set("checked",false);}if(dj.byId("accpt_defd_flag").get("checked",true)){dj.byId("accpt_defd_flag").set("checked",false);}if(dj.byId("boe_flag")){if(this.get("value")!=="01"){m.animate("fadeIn",d.byId("boe"));}else{m.animate("fadeOut",d.byId("boe"));dj.byId("boe_flag").set("checked",false);}}if(this.get("value")==="01"){m.toggleFields(true,null,["tenor_type_1"],false);dj.byId("tenor_type_1").set("checked",true);dj.byId("tenor_type_2").set("disabled",true);dj.byId("tenor_type_2").set("checked",false);dj.byId("tenor_type_3").set("disabled",true);dj.byId("tenor_type_3").set("checked",false);dj.byId("tenor_desc").set("disabled",true);dj.byId("tenor_desc").set("value","");m.toggleRequired("tenor_desc",false);m.toggleAllTenorFields();}else{if(this.get("value")==="02"){dj.byId("tenor_type_2").set("disabled",false);dj.byId("tenor_type_2").set("checked",true);dj.byId("tenor_type_1").set("disabled",true);dj.byId("tenor_type_3").set("disabled",true);dj.byId("tenor_type_3").set("checked",false);dj.byId("tenor_type_1").set("checked",false);dj.byId("tenor_desc").set("disabled",true);dj.byId("tenor_desc").set("value","");m.toggleRequired("tenor_desc",false);m.toggleAllTenorFields();}else{if(this.get("value")==="04"){dj.byId("tenor_type_2").set("disabled",true);dj.byId("tenor_type_2").set("checked",false);dj.byId("tenor_type_3").set("disabled",false);dj.byId("tenor_type_3").set("checked",true);dj.byId("tenor_type_1").set("disabled",true);dj.byId("tenor_type_1").set("checked",false);dj.byId("tenor_desc").set("disabled",true);dj.byId("tenor_desc").set("value","");m.toggleRequired("tenor_desc",false);m.toggleAllTenorFields();}else{if(this.get("value")==="03"){dj.byId("tenor_type_1").set("disabled",false);dj.byId("tenor_type_2").set("disabled",false);dj.byId("tenor_type_3").set("disabled",false);dj.byId("tenor_type_1").set("checked",true);dj.byId("tenor_type_2").set("checked",false);dj.byId("tenor_desc").set("disabled",false);m.toggleRequired("tenor_desc",true);m.toggleAllTenorFields();}}}}});m.connect("protest_non_accpt","onClick",m.disableNonAcceptanceFields);m.connect("accpt_defd_flag","onClick",m.disableNonAcceptanceFields);m.connect("tenor_days_type","onChange",function(){m.toggleFields((this.get("value")==="O"),null,["tenor_type_details"]);});m.connect("tenor_type_1","onClick",m.toggleAllTenorFields);m.connect("tenor_type_2","onClick",m.toggleAllTenorFields);m.connect("tenor_type_3","onClick",m.toggleAllTenorFields);m.connect("tenor_maturity_date","onBlur",function(){var _2d=dj.byId("term_code")?dj.byId("term_code").get("value"):"";if((_2d==="02"||_2d==="04")&&dj.byId("tenor_maturity_date")){if(dj.byId("tenor_maturity_date").get("value")){dj.byId("tenor_days").set("value","");dj.byId("tenor_desc").set("value","");dj.byId("tenor_period").set("value","");dj.byId("tenor_from_after").set("value","");dj.byId("tenor_days_type").set("value","");dj.byId("tenor_base_date").set("displayedValue","");dj.byId("tenor_days").set("disabled",true);dj.byId("tenor_period").set("disabled",true);dj.byId("tenor_from_after").set("disabled",true);dj.byId("tenor_days_type").set("disabled",true);m.toggleRequired("tenor_days_type",false);dj.byId("tenor_type_details").set("disabled",true);dj.byId("tenor_base_date").set("disabled",true);m.toggleRequired("tenor_base_date",false);m.toggleRequired(dojo.query(_2)[0].innerHTML=m.getLocalization("tenorPeriod"),false);}else{if(!dj.byId("tenor_maturity_date").get("value")){dj.byId("tenor_days").set("disabled",false);dj.byId("tenor_period").set("disabled",false);dj.byId("tenor_from_after").set("disabled",false);dj.byId("tenor_days_type").set("disabled",false);m.toggleRequired("tenor_days_type",true);dj.byId("tenor_type_details").set("disabled",false);dj.byId("tenor_base_date").set("disabled",false);m.toggleAllTenorFields();}}}});m.connect("tenor_days","onBlur",function(){var _2e=dj.byId("term_code")?dj.byId("term_code").get("value"):"";if((_2e==="02"||_2e==="04")&&dj.byId("tenor_days")){if(dj.byId("tenor_days").get("value")){dj.byId("tenor_maturity_date").set("displayedValue","");dj.byId("tenor_maturity_date").set("disabled",true);}else{if(!dj.byId("tenor_days").get("value")){dj.byId("tenor_maturity_date").set("disabled",false);m.toggleAllTenorFields();}}}});m.connect("documents_details_first_mail_send","onBlur",function(){_13("documents_details_first_mail_send");});m.connect("documents_details_second_mail_send","onBlur",function(){_13("documents_details_second_mail_send");});},onFormLoad:function(){m.setCurrency(dj.byId("ec_cur_code"),["inc_amt","dec_amt","org_ec_amt","ec_amt","tnx_amt"]);m._config.isBank=false;dj.byId("tenor_maturity_date").set("disabled",true);if(dj.byId("inc_amt")&&!isNaN(dj.byId("inc_amt").get("value"))){dj.byId("dec_amt").set("disabled",true);}else{if(dj.byId("dec_amt")&&!isNaN(dj.byId("dec_amt").get("value"))){dj.byId("inc_amt").set("disabled",true);}}m.populateGridOnLoad("ec");var _2f=dj.byId("term_code")?dj.byId("term_code").get("value"):"";if(_2f){if(_2f!="01"){dj.byId("accpt_adv_send_mode").set("disabled",false);}else{if(_2f==="01"){dj.byId("accpt_adv_send_mode").set("value","");dj.byId("accpt_adv_send_mode").set("disabled",true);}}if(_2f==="01"){m.toggleFields(true,null,["tenor_type_1"]);dj.byId("tenor_type_1").set("checked",true);dj.byId("tenor_type_2").set("disabled",true);dj.byId("tenor_type_3").set("disabled",true);dj.byId("tenor_days").set("disabled",true);dj.byId("tenor_desc").set("disabled",true);dj.byId("tenor_period").set("disabled",true);dj.byId("tenor_from_after").set("disabled",true);dj.byId("tenor_days_type").set("disabled",true);dj.byId("tenor_type_details").set("disabled",true);dj.byId("tenor_base_date").set("disabled",true);dj.byId("tenor_days").set("value","");dj.byId("tenor_desc").set("value","");dj.byId("tenor_period").set("value","");dj.byId("tenor_from_after").set("value","");dj.byId("tenor_days_type").set("value","");dj.byId("tenor_base_date").set("displayedValue","");dj.byId("tenor_maturity_date").set("displayedValue","");}else{if(_2f==="02"){dj.byId("tenor_type_3").set("disabled",true);dj.byId("tenor_type_2").set("disabled",false);dj.byId("tenor_type_1").set("disabled",true);dj.byId("tenor_type_3").set("checked",false);dj.byId("tenor_type_1").set("checked",false);dj.byId("tenor_type_2").set("checked",true);dj.byId("tenor_desc").set("disabled",true);m.toggleAllTenorFields();m.toggleRequired("tenor_maturity_date",true);if(dj.byId("tenor_maturity_date").get("value")){dj.byId("tenor_days").set("disabled",true);dj.byId("tenor_period").set("disabled",true);dj.byId("tenor_from_after").set("disabled",true);dj.byId("tenor_days_type").set("disabled",true);m.toggleRequired("tenor_days_type",false);dj.byId("tenor_type_details").set("disabled",true);dj.byId("tenor_base_date").set("disabled",true);m.toggleRequired("tenor_base_date",false);m.toggleRequired(dojo.query(_2)[0].innerHTML=m.getLocalization("tenorPeriod"),false);}else{if(dj.byId("tenor_days")&&dj.byId("tenor_days").get("value")){dj.byId("tenor_maturity_date").set("displayedValue","");m.toggleRequired("tenor_maturity_date",false);dj.byId("tenor_maturity_date").set("disabled",true);}else{dj.byId("tenor_days").set("disabled",false);dj.byId("tenor_period").set("disabled",false);dj.byId("tenor_from_after").set("disabled",false);dj.byId("tenor_days_type").set("disabled",false);m.toggleRequired("tenor_days_type",true);dj.byId("tenor_type_details").set("disabled",false);dj.byId("tenor_base_date").set("disabled",false);m.toggleAllTenorFields();}}}else{if(_2f==="04"){dj.byId("tenor_type_3").set("disabled",false);dj.byId("tenor_type_2").set("disabled",true);dj.byId("tenor_type_1").set("disabled",true);dj.byId("tenor_type_1").set("checked",false);dj.byId("tenor_type_2").set("checked",false);dj.byId("tenor_type_3").set("checked",true);dj.byId("tenor_desc").set("disabled",true);m.toggleAllTenorFields();m.toggleRequired("tenor_maturity_date",true);if(dj.byId("tenor_maturity_date").get("value")){dj.byId("tenor_days").set("disabled",true);dj.byId("tenor_period").set("disabled",true);dj.byId("tenor_from_after").set("disabled",true);dj.byId("tenor_days_type").set("disabled",true);m.toggleRequired("tenor_days_type",false);dj.byId("tenor_type_details").set("disabled",true);dj.byId("tenor_base_date").set("disabled",true);m.toggleRequired("tenor_base_date",false);m.toggleRequired(dojo.query(_2)[0].innerHTML=m.getLocalization("tenorPeriod"),false);}else{if(dj.byId("tenor_days")&&dj.byId("tenor_days").get("value")){dj.byId("tenor_maturity_date").set("displayedValue","");m.toggleRequired("tenor_maturity_date",false);dj.byId("tenor_maturity_date").set("disabled",true);}else{dj.byId("tenor_days").set("disabled",false);dj.byId("tenor_period").set("disabled",false);dj.byId("tenor_from_after").set("disabled",false);dj.byId("tenor_days_type").set("disabled",false);m.toggleRequired("tenor_days_type",true);dj.byId("tenor_type_details").set("disabled",false);dj.byId("tenor_base_date").set("disabled",false);m.toggleAllTenorFields();}}}else{dj.byId("tenor_type_1").set("disabled",false);dj.byId("tenor_type_2").set("disabled",false);dj.byId("tenor_type_3").set("disabled",false);dj.byId("tenor_desc").set("disabled",false);m.toggleRequired("tenor_desc",true);if(dj.byId("tenor_type_2").get("checked")||dj.byId("tenor_type_3").get("checked")){m.toggleAllTenorFields();}else{dj.byId("tenor_days").set("disabled",true);dj.byId("tenor_period").set("disabled",true);dj.byId("tenor_from_after").set("disabled",true);dj.byId("tenor_days_type").set("disabled",true);dj.byId("tenor_type_details").set("disabled",true);dj.byId("tenor_base_date").set("disabled",true);m.toggleRequired("tenor_days",false);m.toggleRequired("tenor_period",false);m.toggleRequired("tenor_from_after",false);m.toggleRequired("tenor_maturity_date",false);}}}}var _30=dj.byId("tenor_days_type")?dj.byId("tenor_days_type").get("value"):"";if(_30==="O"){dj.byId("tenor_type_details").set("disabled",false);m.toggleRequired("tenor_type_details",true);}else{dj.byId("tenor_type_details").set("disabled",true);}}else{dj.byId("tenor_type_1").set("disabled",true);dj.byId("tenor_type_2").set("disabled",true);dj.byId("tenor_type_3").set("disabled",true);dj.byId("tenor_days").set("disabled",true);dj.byId("tenor_desc").set("disabled",true);dj.byId("tenor_period").set("disabled",true);dj.byId("tenor_from_after").set("disabled",true);dj.byId("tenor_days_type").set("disabled",true);dj.byId("tenor_type_details").set("disabled",true);dj.byId("tenor_base_date").set("disabled",true);}if(dj.byId("documents_details_total_send")){dj.byId("documents_details_total_send").set("readOnly",true);}if(dj.byId("inco_term_year")){m.getIncoYear();dijit.byId("inco_term_year").set("value",dj.byId("org_term_year").get("value"));}if(dj.byId("inco_term")){if(dj.byId("inco_term_year")&&dj.byId("inco_term_year").get("value")!=""){m.getIncoTerm();}dijit.byId("inco_term").set("value",dj.byId("org_inco_term").get("value"));}var _31=dj.byId("inco_term")?dj.byId("inco_term").get("value"):"";if(_31){m.toggleFields(_31,null,["inco_place"],false,true);}else{m.toggleFields(_31,null,["inco_place"],false,false);}},beforeSubmitValidations:function(){var _32=_3();if(_32){if(dj.byId("ec_amt")){if(!m.validateAmount((dj.byId("ec_amt"))?dj.byId("ec_amt"):0)){m._config.onSubmitErrorMsg=m.getLocalization("amountcannotzero");dj.byId("dec_amt").set("value","");dj.byId("dec_amt").onBlur();return false;}}_32=m.validateLSAmtSumAgainstTnxAmt("ec");}return _32;},beforeSubmit:function(){m.updateSubTnxTypeCode("ec");}});})(dojo,dijit,misys);dojo.require("misys.client.binding.trade.amend_ec_client");}