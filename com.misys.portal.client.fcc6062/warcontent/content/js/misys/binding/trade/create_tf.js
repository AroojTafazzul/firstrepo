/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.binding.trade.create_tf"]){dojo._hasResource["misys.binding.trade.create_tf"]=true;dojo.provide("misys.binding.trade.create_tf");dojo.require("dijit.form.Form");dojo.require("dijit.form.Button");dojo.require("dijit.form.TextBox");dojo.require("misys.widget.Dialog");dojo.require("dijit.ProgressBar");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.CheckBox");dojo.require("dijit.layout.ContentPane");dojo.require("dojo.data.ItemFileReadStore");dojo.require("dijit.form.DateTextBox");dojo.require("misys.form.CurrencyTextBox");dojo.require("dijit.form.NumberTextBox");dojo.require("dijit.form.FilteringSelect");dojo.require("misys.form.file");dojo.require("misys.form.SimpleTextarea");dojo.require("misys.form.common");dojo.require("misys.widget.Collaboration");dojo.require("misys.validation.common");dojo.require("misys.form.PercentNumberTextBox");dojo.require("misys.binding.trade.ls_common");(function(d,dj,m){var _1="fx-section";function _2(){dj.byId("principal_act_no").set("value","");dj.byId("fee_act_no").set("value","");};function _3(_4){var _5=function(){var _6=dijit.byId("fin_amt");_6.set("state","Error");m.defaultBindTheFXTypes();dj.byId("fin_amt").set("value","");dj.byId("fin_cur_code").set("value","");dj.byId("principal_act_name").set("value","");dj.byId("principal_act_cur_code").set("value","");dj.byId("principal_act_no").set("value","");dj.byId("principal_act_description").set("value","");dj.byId("principal_act_pab").set("value","");};m.dialog.show("ERROR",_4,"",function(){setTimeout(_5,500);});if(d.byId(_1)&&(d.style(d.byId(_1),"display")!=="none")){m.animate("wipeOut",d.byId(_1));}};d.mixin(m._config,{initReAuthParams:function(){var _7={productCode:"TF",subProductCode:"",transactionTypeCode:"01",entity:(dj.byId("entity")?dj.byId("entity").get("value"):""),currency:(dj.byId("req_cur_code")?dj.byId("req_cur_code").get("value"):""),amount:(dj.byId("req_amt")?m.trimAmount(dj.byId("req_amt").get("value")):""),bankAbbvName:dj.byId("issuing_bank_abbv_name")?dj.byId("issuing_bank_abbv_name").get("value"):"",es_field1:(dj.byId("req_amt")?m.trimAmount(dj.byId("req_amt").get("value")):""),es_field2:""};return _7;},xmlTransform:function(_8){var _9="<tf_tnx_record>";if(_8.indexOf(_9)!==-1){var _a=m._config.xmlTagName,_b=_a?["<",_a,">"]:[],_c="</tf_tnx_record>",_d="";_d=_8.substring(_9.length,(_8.length-_c.length));_b.push(_d);if(dj.byId("gridLicense")&&dj.byId("gridLicense").store&&dj.byId("gridLicense").store!==null&&dj.byId("gridLicense").store._arrayOfAllItems.length>0){_b.push("<linked_licenses>");dj.byId("gridLicense").store.fetch({query:{REFERENCEID:"*"},onComplete:dojo.hitch(dj.byId("gridLicense"),function(_e,_f){dojo.forEach(_e,function(_10){_b.push("<license>");_b.push("<ls_ref_id>",_10.REFERENCEID,"</ls_ref_id>");_b.push("<bo_ref_id>",_10.BO_REF_ID,"</bo_ref_id>");_b.push("<ls_number>",_10.LS_NUMBER,"</ls_number>");_b.push("<ls_allocated_amt>",_10.LS_ALLOCATED_AMT,"</ls_allocated_amt>");_b.push("<ls_allocated_add_amt>",_10.LS_ALLOCATED_ADD_AMT,"</ls_allocated_add_amt>");_b.push("<ls_amt>",_10.LS_AMT,"</ls_amt>");_b.push("<ls_os_amt>",_10.LS_OS_AMT,"</ls_os_amt>");_b.push("<converted_os_amt>",_10.CONVERTED_OS_AMT,"</converted_os_amt>");_b.push("<allow_overdraw>",_10.ALLOW_OVERDRAW,"</allow_overdraw>");_b.push("</license>");});})});_b.push("</linked_licenses>");}if(_a){_b.push("</",_a,">");}return _b.join("");}else{return _8;}}});d.mixin(m,{fireFXAction:function(){if(m._config.fxParamData&&m._config.fxParamData[dj.byId("sub_product_code")].fxParametersData.isFXEnabled==="Y"){var _11=dj.byId("menu_from").get("value");var _12,_13;var _14=dj.byId("fin_cur_code").get("value");var _15=dj.byId("fin_amt").get("value");var _16="";if(dj.byId("principal_act_cur_code")&&dj.byId("principal_act_cur_code").get("value")!==""){_16=dj.byId("principal_act_cur_code").get("value");}var _17=dj.byId("product_code").get("value");var _18=true;var _19="";if(dj.byId("issuing_bank_abbv_name")&&dj.byId("issuing_bank_abbv_name").get("value")!==""){_19=dj.byId("issuing_bank_abbv_name").get("value");}var _1a=dj.byId("bill_amt_cur_code").get("value");if(_11==="FROM_EXPORT_SCRATCH"||_11==="EXPORT_DRAFT"){_1a=dj.byId("fin_cur_code").get("value");}var _1b;if(_11==="FROM_IMPORT_SCRATCH"||_11==="FROM_IMPORT_LC"||_11==="FROM_IMPORT_COLLECTION"||_11==="IMPORT_DRAFT"||_11==="IMPORT_UNSIGNED"){_1b="IMPORT";}else{if(_11==="FROM_EXPORT_LC"||_11==="FROM_EXPORT_COLLECTION"||_11==="EXPORT_DRAFT"||_11==="EXPORT_UNSIGNED"||_11==="FROM_EXPORT_SCRATCH"){_1b="EXPORT";}}if(_14!==""&&!isNaN(_15)&&_17!==""&&_19!==""){_11=dj.byId("menu_from").get("value");if(_1b&&_1b==="IMPORT"){if(_11==="FROM_IMPORT_SCRATCH"||(_11==="IMPORT_DRAFT"&&_1a==="")){_12=_14;_13=_16;_1a=_16;}else{if(_16===""&&_14!==_1a){_12=_14;_13=_1a;}else{if(_16!==""){if(_14===_1a&&_14!==_16){if(dj.byId("fin_amt").get("value")>dj.byId("bill_amt").get("value")){_3(m.getLocalization("FXTranAmtGreaterThanBillAmtMessage"));}if(d.byId(_1)&&(d.style(d.byId(_1),"display")!=="none")){m.animate("wipeOut",d.byId(_1));}}else{if(_14===_16&&_14!==_1a){_12=_14;_13=_1a;}else{if(_1a===_16&&_1a!==_14){_12=_14;_13=_1a;}}}}}}}else{if(_1b&&_1b==="EXPORT"){if(_1a&&_1a!==""&&_1a===_14&&_14!==_16){_12=_14;_13=_16;_1a=_16;}}}if(_12&&_12!==""&&_13&&_13!==""&&_12!==_13){if(d.byId(_1)){m.animate("wipeIn",d.byId(_1));}m.fetchFXDetails(_12,_13,_15,_17,_19,_1a,_18);if(dj.byId("fx_rates_type_1")&&dj.byId("fx_rates_type_1").get("checked")){if(isNaN(dj.byId("fx_exchange_rate").get("value"))||dj.byId("fx_exchange_rate_cur_code").get("value")===""||isNaN(dj.byId("fx_exchange_rate_amt").get("value"))||(m._config.fxParamData[dj.byId("sub_product_code")].fxParametersData.toleranceDispInd==="Y"&&(isNaN(dj.byId("fx_tolerance_rate").get("value"))||isNaN(dj.byId("fx_tolerance_rate_amt").get("value"))||dj.byId("fx_tolerance_rate_cur_code").get("value")===""))){_3(m.getLocalization("FXDefaultErrorMessage"));}}}else{if(d.byId(_1)&&(d.style(d.byId(_1),"display")!=="none")){m.animate("wipeOut",d.byId(_1));}m.defaultBindTheFXTypes();}}}},bind:function(){m.setValidation("fx_tolerance_rate",m.validateToleranceAndExchangeRate);m.setValidation("fx_exchange_rate",m.validateToleranceAndExchangeRate);m.setValidation("iss_date",m.validateIssueDate);m.setValidation("maturity_date",m.validateTFMaturityDate);m.setValidation("fin_cur_code",m.validateCurrency);m.connect("iss_date","onBlur",m.getMaturityDate);m.connect("tenor","onBlur",m.getMaturityDate);m.connect("maturity_date","onBlur",m.getMaturityDate);m.connect("issuing_bank_abbv_name","onChange",m.populateReferences);m.connect("issuing_bank_abbv_name","onChange",m.updateBusinessDate);m.connect("issuing_bank_customer_reference","onChange",m.setApplicantReference);m.connect("issuing_bank_abbv_name","onChange",m.updateBusinessDate);if(dj.byId("issuing_bank_abbv_name")){m.connect("entity","onChange",function(){dj.byId("issuing_bank_abbv_name").onChange();});}m.connect("fin_cur_code","onChange",function(){m.setCurrency(this,["fin_amt"]);if(dj.byId("req_cur_code")){dj.byId("req_cur_code").set("value",dj.byId("fin_cur_code").get("value"));m.setCurrency(dj.byId("req_cur_code"),["req_amt"]);m.setValidation("req_cur_code",m.validateCurrency);}});m.connect("req_amt","onChange",function(){m.setTnxAmt(this.get("value"));});if(m._config.fxParamData&&m._config.fxParamData[dj.byId("sub_product_code")]&&m._config.fxParamData[dj.byId("sub_product_code")].fxParametersData.isFXEnabled==="Y"){m.connect("fin_cur_code","onBlur",function(){m.setCurrency(this,["fin_amt"]);if(dj.byId("fin_cur_code").get("value")!==""&&!isNaN(dj.byId("fin_amt").get("value"))){m.fireFXAction();}else{m.defaultBindTheFXTypes();}});m.connect("fin_amt","onBlur",function(){if(!isNaN(dj.byId("fin_amt").get("value"))&&dj.byId("fin_cur_code").get("value")!==""){m.fireFXAction();}else{m.defaultBindTheFXTypes();}});m.connect("principal_act_name","onChange",function(){if(dj.byId("principal_act_cur_code")&&dj.byId("principal_act_cur_code").get("value")!==""){m.fireFXAction();}else{m.defaultBindTheFXTypes();if(d.byId(_1)&&(d.style(d.byId(_1),"display")!=="none")){m.animate("wipeOut",d.byId(_1));}}});}m.connect("entity_img_label","onClick",_2);m.connect("license_lookup","onClick",function(){m.getLicenses("tf");});m.connect("req_pct","onBlur",function(){if(this.get("value")!==null&&!isNaN(this.get("value"))){if(parseFloat(this.get("value"))<=100&&!(parseFloat(this.get("value"))<=0)){var _1c=(parseFloat(this.get("value"))*parseFloat(dj.byId("fin_amt").get("value")))/100;dj.byId("req_amt").set("value",_1c);}else{displayMessage=misys.getLocalization("incorrectPercentage");this.focus();this.set("state","Error");dj.hideTooltip(this.domNode);dj.showTooltip(displayMessage,this.domNode,0);dj.showTooltip(displayMessage,domNode,0);}}else{if(dj.byId("fin_amt").get("value")!==null&&!isNaN(dj.byId("fin_amt").get("value"))){dj.byId("req_amt").set("value",dj.byId("fin_amt").get("value"));}}});m.connect("fin_amt","onBlur",function(){if(dj.byId("req_pct")&&dj.byId("req_pct").get("value")!==null&&!isNaN(dj.byId("req_pct").get("value"))){if(parseFloat(dj.byId("req_pct").get("value"))<=100&&!(parseFloat(dj.byId("req_pct").get("value"))<=0)){var _1d=(parseFloat(dj.byId("req_pct").get("value"))*parseFloat(dj.byId("fin_amt").get("value")))/100;dj.byId("req_amt").set("value",_1d);}}else{if(dj.byId("req_amt")){dj.byId("req_amt").set("value",dj.byId("fin_amt").get("value"));}}});},onFormLoad:function(){var _1e=dj.byId("menu_from").get("value");m.setCurrency(dj.byId("fin_cur_code"),["fin_amt"]);m.setCurrency(dj.byId("bill_amt_cur_code"),["bill_amt"]);if(_1e){if(_1e==="FROM_EXPORT_LC"||_1e==="FROM_EXPORT_COLLECTION"){dj.byId("fin_cur_code").set("readOnly",true);}if(_1e==="EXPORT_DRAFT"){if(dj.byId("fin_liab_amt").get("value")!==""){dj.byId("fin_cur_code").set("readOnly",true);}}}if(dj.byId("bill_amt")){dj.byId("bill_amt").set("readOnly",true);dj.byId("bill_amt_cur_code").set("readOnly",true);}var _1f=dj.byId("issuing_bank_customer_reference");var _20;if(_1f){_20=_1f.value;}var _21=dj.byId("issuing_bank_abbv_name");if(_21){_21.onChange();}if(_1f){_1f.onChange();_1f.set("value",_20);}if(_1e=="FROM_IMPORT_SCRATCH"||_1e=="FROM_EXPORT_SCRATCH"||_1e=="FROM_GENERAL_SCRATCH"||_1e=="GENERAL_DRAFT"){var _22=dojo.byId("bill_amount_div");if(_22){dojo.style(_22,"display","none");}}if(d.byId(_1)){if((dj.byId("fx_exchange_rate_cur_code")&&dj.byId("fx_exchange_rate_cur_code").get("value")!=="")||(dj.byId("fx_total_utilise_cur_code")&&dj.byId("fx_total_utilise_cur_code").get("value")!=="")){m.animate("wipeIn",d.byId(_1));}else{d.style(_1,"display","none");}}if(m._config.fxParamData&&m._config.fxParamData[dj.byId("sub_product_code")]&&m._config.fxParamData[dj.byId("sub_product_code")].fxParametersData.isFXEnabled==="Y"){m.initializeFX(dj.byId("sub_product_code"));m.onloadFXActions();}m.setTnxAmt(dj.byId("req_amt").get("value"));m.setCurrency(dj.byId("fin_cur_code"),["req_amt"]);m.populateGridOnLoad("tf");},calculateEquivalentAmount:function(_23,_24,_25){var _26=_23;m.xhrPost({url:m.getServletURL("/screen/AjaxScreen/action/GetConvertedAmount"),handleAs:"json",sync:true,content:{original_amt:_23,src_curr:_24,dest_curr:_25,token:document.getElementById("_token").getAttribute("value")},load:function(_27,_28){_26=_27.convertedAmount;},error:function(_29,_2a){console.error("[misys.binding.trade.create_tf] calculateEquivalentAmount error",_29);}});return _26;},beforeSaveValidations:function(){var _2b=dj.byId("principal_act_no");if(_2b&&_2b.get("value")!==""){if(!m.validatePricipleAccount()){m._config.onSubmitErrorMsg=m.getLocalization("invalidPrincipleAccountError",[_2b.get("displayedValue")]);m.showTooltip(m.getLocalization("invalidPrincipleAccountError",[_2b.get("displayedValue")]),_2b.domNode);_2b.focus();return false;}}var _2c=dj.byId("fee_act_no");if(_2c&&_2c.get("value")!==""){if(!m.validateFeeAccount()){m._config.onSubmitErrorMsg=m.getLocalization("invalidFeeAccountError",[_2c.get("displayedValue")]);m.showTooltip(m.getLocalization("invalidFeeAccountError",[_2c.get("displayedValue")]),_2c.domNode);_2c.focus();return false;}}var _2d=dj.byId("entity");if(_2d&&_2d.get("value")==""){return false;}else{return true;}},beforeSubmitValidations:function(){var _2e=true;if(dj.byId("fin_amt")){if(!m.validateAmount((dj.byId("fin_amt"))?dj.byId("fin_amt"):0)){m._config.onSubmitErrorMsg=m.getLocalization("amountcannotzero");dj.byId("fin_amt").set("value","");return false;}}if(dj.byId("issuing_bank_abbv_name")&&!m.validateApplDate(dj.byId("issuing_bank_abbv_name").get("value"))){m._config.onSubmitErrorMsg=m.getLocalization("changeInApplicationDates");m.goToTop();return false;}var _2f=dj.byId("fin_amt");var _30=dj.byId("bill_amt");var _31=dj.byId("bill_amt_cur_code");var _32=dj.byId("fin_cur_code");var _33=dj.byId("fx_exchange_rate_amt");if((_31.get("value")===_32.get("value"))&&(dojo.number.parse(_2f.get("value"))>dojo.number.parse(_30.get("value")))){m._config.onSubmitErrorMsg=m.getLocalization("FinAmtGreaterThanBillAmtValidation");dj.byId("fin_amt").set("value","");return false;}else{if(_31.get("value")!==_32.get("value")){var _34=m.calculateEquivalentAmount(_2f.get("value"),_32.get("value"),_31.get("value"));if(dojo.number.parse(_34)>dojo.number.parse(_30.get("value"))){m._config.onSubmitErrorMsg=m.getLocalization("FinAmtGreaterThanBillAmtValidation");dj.byId("fin_amt").set("value","");return false;}}}if(_33){if((_31.get("value")!==_32.get("value"))&&(dojo.number.parse(_33.get("value"))>dojo.number.parse(_30.get("value")))){m._config.onSubmitErrorMsg=m.getLocalization("FinAmtGreaterThanBillAmtValidation");dj.byId("fin_amt").set("value","");return false;}}var _35=dj.byId("principal_act_no");if(_35&&_35.get("value")!=""){if(!m.validatePricipleAccount()){m._config.onSubmitErrorMsg=m.getLocalization("invalidPrincipleAccountError",[_35.get("displayedValue")]);m.showTooltip(m.getLocalization("invalidPrincipleAccountError",[_35.get("displayedValue")]),_35.domNode);_35.focus();return false;}}var _36=dj.byId("fee_act_no");if(_36&&_36.get("value")!=""){if(!m.validateFeeAccount()){m._config.onSubmitErrorMsg=m.getLocalization("invalidFeeAccountError",[_36.get("displayedValue")]);m.showTooltip(m.getLocalization("invalidFeeAccountError",[_36.get("displayedValue")]),_36.domNode);_36.focus();return false;}}if(m._config.fxParamData&&m._config.fxParamData[dj.byId("sub_product_code")].fxParametersData.isFXEnabled==="Y"){if(!m.fxBeforeSubmitValidation()){return false;}var _37=true;var _38="";var _39=dj.byId("fx_rates_type_2");var _3a=dj.byId("fx_total_utilise_amt");var _3b=dj.byId("fin_amt");if(_39.get("checked")&&_3a&&!isNaN(_3a.get("value"))&&_3b&&!isNaN(_3b.get("value"))){if(dojo.number.parse(_3b.get("value"))<dojo.number.parse(_3a.get("value"))){_38+=m.getLocalization("FXUtiliseAmtGreaterMessage");_37=false;}}m._config.onSubmitErrorMsg=_38;return _37;}if(dj.byId("issuing_bank_abbv_name")&&!m.validateApplDate(dj.byId("issuing_bank_abbv_name").get("value"))){m._config.onSubmitErrorMsg=m.getLocalization("changeInApplicationDates");m.goToTop();return false;}return m.validateLSAmtSumAgainstTnxAmt("fin");}});})(dojo,dijit,misys);dojo.require("misys.client.binding.trade.create_tf_client");}