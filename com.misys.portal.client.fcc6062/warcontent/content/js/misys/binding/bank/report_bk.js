/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.binding.bank.report_bk"]){dojo._hasResource["misys.binding.bank.report_bk"]=true;dojo.provide("misys.binding.bank.report_bk");dojo.require("dojo.parser");dojo.require("dojo.data.ItemFileReadStore");dojo.require("dojo.window");dojo.require("dojo.DeferredList");dojo.require("dijit.layout.TabContainer");dojo.require("dijit.form.DateTextBox");dojo.require("misys.form.CurrencyTextBox");dojo.require("dijit.form.NumberTextBox");dojo.require("dijit.form.FilteringSelect");dojo.require("dijit.form.Form");dojo.require("dijit.form.Button");dojo.require("dijit.form.TextBox");dojo.require("dijit.form.Select");dojo.require("misys.widget.NoCloseDialog");dojo.require("dijit.ProgressBar");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.CheckBox");dojo.require("misys.form.PercentNumberTextBox");dojo.require("misys.form.SimpleTextarea");dojo.require("misys.widget.Collaboration");dojo.require("misys.form.common");dojo.require("misys.form.file");dojo.require("misys.form.addons");dojo.require("misys.validation.common");dojo.require("misys.binding.cash.ft_common");dojo.require("misys.form.BusinessDateTextBox");(function(d,dj,m){function _1(){var _2=dj.byId("bk_cur_code").get("value");dj.byId("bk_total_amt_cur_code").set("value",_2);dj.byId("bk_total_amt").set("value","");dj.byId("bk_highest_amt_cur_code").set("value",_2);dj.byId("bk_highest_amt").set("value","");d.byId("display_record_number").innerHTML="<b>0</b>";m.animate("wipeOut",d.byId("content1"),function(){m.animate("wipeIn",d.byId("content2"));});};d.mixin(m,{displayContent:function(){if(d.style("content1","display")=="block"){d.style("content1","display","none");}else{d.style("content1","display","block");}},fixBulkTransactions:function(){return m.xhrPost({url:m.getServletURL("/screen/AjaxScreen/action/FixBulkTransactionsAction"),sync:true,handleAs:"json",contentType:"application/json; charset=utf-8",content:{formContent:m.formToXML({selector:"#fakeform1",xmlRoot:"bk_tnx_record"})},load:function(_3,_4){if(_3.success){m.updateTransactionGrid(window);m.dialog.show("CUSTOM-NO-CANCEL",m.getLocalization("fixBulkResult",[_3.resultCount]),"");}else{m.dialog.show("ERROR",_3.errorMessage,"");}},error:function(_5,_6){m.dialog.show("ERROR",m.getLocalization("updateBulkError"),"");}});},showIframeDialog:function(_7,_8){var _9=d.byId("transactionFrame");var _a=d.byId("dialogTransaction");var _b=dj.byId(_7);var _c=d.byId(_7);if(_9){_9.parentNode.removeChild(_9);}_9=document.createElement("iframe");dojo.attr(_9,{"id":"transactionFrame","name":"transactionFrame"});d.style(_a,{"textAlign":"center","backgroundColor":"#FFFFFF"});_a.appendChild(_9);var _d=d.window.getBox();var _e=_d.w-10;var _f=_d.h-10;var _10=_e-23;var _11=_f-50;d.style(_9,{"height":_11+"px","width":_10+"px","position":"relative","marginTop":"-10px","marginLeft":"8px"});m.transactionDialog.resize({w:_e,h:_f});for(var x in _8){if(!_c[x]){d.create("input",{type:"hidden",name:x,value:_8[x]},_c);}else{_c[x].value=_8[x];}}_b.connectChildren();_b.set("action",misys.getServletURL("/screen/BulkTransactionPopup"));_b.startup();_b.submit();m.transactionDialog.show();},goToTransaction:function(_12,_13){var _14=d.byId("transactionFrame");var _15=dj.byId(_12);var _16=d.byId(_12);for(var x in _13){if(!_16[x]){d.create("input",{type:"hidden",name:x,value:_13[x]},_16);}else{_16[x].value=_13[x];}}_15.connectChildren();_15.set("action",misys.getServletURL("/screen/BulkScreen"));_15.startup();_15.submit();},confirmDeleteFromBulk:function(_17,_18){d.mixin(m,{bulkDeleteParameters:_17});this.dialog.show("CONFIRMATION",this.getLocalization("removeFromBulkConfirmation",[_17.referenceid]),"",_18);},editOrRemove:function(_19){var _1a=(_19)?_19:m.bulkDeleteParameters;if(_1a.operation&&_1a.operation=="DELETE"){m.xhrPost({url:m.getServletURL("/screen/AjaxScreen/action/DeleteBulkTransactionAction"),sync:true,handleAs:"json",content:{productcode:"FT",referenceid:_1a.referenceid,tnxid:_1a.tnxid},load:function(_1b,_1c){if(_1b.success){m.updateTransactionGrid(window);}else{m.dialog.show("ERROR",_1b.errorMessage,"");}},error:function(_1d,_1e){m.dialog.show("ERROR",m.getLocalization("updateBulkError"),"");}});}else{if(_1a.option&&_1a.option=="PENDING"){m.goToTransaction("existingForm",{tnxtype:"01",option:_1a.option,mode:_1a.mode,referenceid:_1a.referenceid,tnxid:_1a.tnxid});}else{this.dialog.show("ERROR",this.getLocalization("updateBulkError"));}}},transactionDialog:new m.widget.NoCloseDialog({title:"",id:"dialogTransaction",refocus:false,resizable:true,draggable:false,"class":"dialog",disableCloseButton:true},d.byId("dialogTransaction")),addTransaction:function(){var _1f=m.formToXML({selector:"#fakeform1",xmlRoot:"bk_tnx_record"});m.goToTransaction("transactionForm",{transactiondata:_1f,tnxtype:"01",option:"SCRATCH",mode:"BULK"});},verifyCanAdvance:function(){var _20;if(dj.byId("bk_type").get("value")==="PAYMT"||dj.byId("bk_type").get("value")==="PAYRL"){_20=dj.byId("sub_product_code").get("value")!==""&&dj.byId("applicant_act_name").validate()&&dj.byId("applicant_act_product_types").validate()&&dj.byId("bk_cur_code").validate();dj.byId("button_intrmdt_ok").set("disabled",!_20);}else{_20=dj.byId("sub_product_code").get("value")!==""&&dj.byId("applicant_collection_act_name").validate()&&dj.byId("applicant_collection_act_product_types").validate()&&dj.byId("bk_cur_code").validate();dj.byId("button_intrmdt_ok").set("disabled",!_20);}},togglebankref:function(){if(dj.byId("prod_stat_code").get("value")==="01"){m.toggleRequired("bo_ref_id",false);dj.byId("bo_ref_id").set("disabled",true);}else{m.toggleRequired("bo_ref_id",true);dj.byId("bo_ref_id").set("disabled",false);}},updateTransactionGrid:function(_21){var _22=_21.dijit,_23=_21.misys,_24=_21.dojo,_25=0,_26=0,_27=0;_23.xhrPost({url:_23.getServletURL("/screen/AjaxScreen/action/GetBulkDetailsAction"),sync:true,handleAs:"json",content:{productcode:"FT",bulk_ref_id:_22.byId("ref_id").get("value"),bulk_tnx_id:_22.byId("tnx_id").get("value")},load:function(_28,_29){_22.byId("bk_total_amt").set("value",_28.sum);_22.byId("bk_highest_amt").set("value",_28.max);_22.byId("record_number").set("value",_28.count);},error:function(_2a,_2b){_23.dialog.show("ERROR",_23.getLocalization("retrieveBulkDetailsError"),"");}});_23.grid.reloadForSearchTerms();},updateError:function(_2c,_2d){var _2e=_2c.dijit,_2f=_2c.misys,_30=_2c.dojo;_2f.dialog.show("ERROR",_2f.getLocalization("updateBulkError"),"");_2f.grid.reloadForSearchTerms();},bind:function(){m.setValidation("bk_cur_code",m.validateCurrency);m.setValidation("bk_total_amt_cur_code",m.validateCurrency);m.setValidation("bk_highest_amt_cur_code",m.validateCurrency);m.connect("bk_total_amt","onBlur",function(){m.setTnxAmt(this.get("value"));});m.connect("bk_highest_amt","onBlur",function(){m.setTnxAmt(this.get("value"));});m.connect("button_intrmdt_ok","onClick",_1);m.connect("bk_total_amt_cur_code","onChange",function(){m.setCurrency(this,["bk_total_amt"]);});m.connect("bk_highest_amt_cur_code","onChange",function(){m.setCurrency(this,["bk_highest_amt"]);});m.connect("entity","onChange",function(){d.byId("display_entity").innerHTML=dj.byId("entity").get("value");m.setApplicantReference();});m.connect("applicant_act_name","onChange",function(){d.byId("display_account").innerHTML=dj.byId("applicant_act_name").get("value");});m.connect("applicant_collection_act_name","onChange",function(){d.byId("display_to_account").innerHTML=dj.byId("applicant_collection_act_name").get("value");});m.connect("bk_total_amt","onChange",function(){dojo.forEach(d.query("#display_bk_total_amt_row div"),function(_31,i){_31.innerHTML=dj.byId("bk_total_amt").get("value");});});m.connect("bk_highest_amt","onChange",function(){dojo.forEach(d.query("#display_bk_highest_amt_row div"),function(_32,i){_32.innerHTML=dj.byId("bk_highest_amt").get("value");});});m.connect("record_number","onChange",function(){d.byId("display_record_number").innerHTML=dj.byId("record_number").get("value");});m.connect("bk_type","onChange",function(){if(this.get("value")==="COLLE"){dj.byId("applicant_collection_act_name").set("required",true);dj.byId("applicant_collection_act_name").set("value","");m.animate("wipeIn",d.byId("collection"));dj.byId("applicant_act_name").set("required",false);dj.byId("applicant_act_name").set("value","");m.animate("wipeOut",d.byId("otherpayments"));}else{dj.byId("applicant_act_name").set("required",true);dj.byId("applicant_act_name").set("value","");m.animate("wipeIn",d.byId("otherpayments"));dj.byId("applicant_collection_act_name").set("required",false);dj.byId("applicant_collection_act_name").set("value","");m.animate("wipeOut",d.byId("collection"));}m.verifyCanAdvance();});m.connect("bk_type","onChange",function(){if(this.get("value")==="COLLE"){m.animate("wipeIn",d.byId("display_to_account_row"));m.animate("wipeOut",d.byId("display_account_row"));}else{m.animate("wipeOut",d.byId("display_to_account_row"));m.animate("wipeIn",d.byId("display_account_row"));}});m.connect("applicant_act_name","onChange",m.verifyCanAdvance);m.connect("applicant_collection_act_name","onChange",m.verifyCanAdvance);m.connect("bk_cur_code","onChange",m.verifyCanAdvance);m.connect("prod_stat_code","onChange",m.togglebankref);d.mixin(m,{fixBulkTransactionsHandle:m.connect("value_date","onChange",m.fixBulkTransactions)});},onFormLoad:function(){if(dj.byId("prod_stat_code")&&dj.byId("prod_stat_code").get("value")==="01"){dj.byId("bo_ref_id").set("disabled",true);}if(dj.byId("bk_type").get("value")==="COLLE"){m.animate("wipeIn",d.byId("display_to_account_row"));m.animate("wipeOut",d.byId("display_account_row"));m.animate("wipeOut",d.byId("payrolltype"));d.byId("product_group").innerHTML=m.getLocalization("bulkCollectionProductGroup");}else{if(dj.byId("bk_type").get("value")==="PAYMT"){m.animate("wipeOut",d.byId("display_to_account_row"));m.animate("wipeIn",d.byId("display_account_row"));m.animate("wipeOut",d.byId("payrolltype"));d.byId("product_group").innerHTML=m.getLocalization("bulkPaymentsProductGroup");}else{if(dj.byId("bk_type").get("value")==="PAYRL"){d.byId("product_group").innerHTML=m.getLocalization("bulkPayrollProductGroup");}}}m.setCurrency(dj.byId("bk_total_amt_cur_code"),["bk_total_amt"]);m.setCurrency(dj.byId("bk_highest_amt_cur_code"),["bk_highest_amt"]);m.setApplicantReference();if(dj.byId("prod_stat_code")){dj.byId("prod_stat_code").onChange();}},submitBulk:function(_33){var _34=new d.Deferred();var _35=new d.Deferred();var _36=new d.DeferredList([_34,_35]);var _37=m.xhrPost({url:misys.getServletURL("/screen/AjaxScreen/action/GetBulkBusinessDateAction"),sync:true,handleAs:"json",content:{transactiondata:m.formToXML({selector:"#fakeform1",xmlRoot:"bk_tnx_record"})}});_37.then(function(_38,_39){m._config.oldDate=_38.requestedDate;if(_38.modified){m._config.newDate=_38.calculatedDate;m.dialog.show("CONFIRMATION",m.getLocalization("fixBulkForwardDate",[m._config.newDate]),"",function(){_34.resolve(_38);});}else{_34.resolve(_38);}},function(_3a,_3b){_34.reject(_3a);m._config.oldDate=_3a.requestedDate;m._config.onSubmitErrorMsg=m.getLocalization("technicalErrorWhileValidatingBusinessDays");});_34.then(function(_3c){if(_3c.modified){d.disconnect(m.fixBulkTransactionsHandle);dj.byId("value_date").set("value",m._config.newDate);setTimeout(function(){d.mixin(m,{fixBulkTransactionsHandle:m.connect("value_date","onChange",m.fixBulkTransactions)});},1000);m.xhrPost({url:m.getServletURL("/screen/AjaxScreen/action/FixBulkTransactionsAction"),sync:true,handleAs:"json",contentType:"application/json; charset=utf-8",content:{formContent:m.formToXML({selector:"#fakeform1",xmlRoot:"bk_tnx_record"})},load:function(_3d,_3e){if(_3d.success){_35.resolve(_3d);}else{_35.reject(_3d);}},error:function(_3f,_40){_35.reject(_3f);}});}else{_35.resolve(_3c);}},function(_41){_35.reject(_41);});_35.then(function(_42){},function(_43){});_36.then(function(_44){m.submit(_33);},function(_45){});}});})(dojo,dijit,misys);dojo.require("misys.client.binding.bank.report_bk_client");}