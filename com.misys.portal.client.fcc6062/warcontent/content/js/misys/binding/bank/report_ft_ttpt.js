/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.binding.bank.report_ft_ttpt"]){dojo._hasResource["misys.binding.bank.report_ft_ttpt"]=true;dojo.provide("misys.binding.bank.report_ft_ttpt");dojo.require("dojo.parser");dojo.require("dijit.layout.TabContainer");dojo.require("dijit.form.DateTextBox");dojo.require("misys.form.CurrencyTextBox");dojo.require("dijit.form.NumberTextBox");dojo.require("dijit.form.FilteringSelect");dojo.require("dijit.form.Form");dojo.require("dijit.form.Button");dojo.require("dijit.form.TextBox");dojo.require("misys.widget.Dialog");dojo.require("dijit.ProgressBar");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.CheckBox");dojo.require("misys.form.PercentNumberTextBox");dojo.require("misys.form.SimpleTextarea");dojo.require("misys.widget.Collaboration");dojo.require("misys.form.common");dojo.require("misys.form.file");dojo.require("misys.form.addons");dojo.require("misys.validation.common");dojo.require("misys.binding.trade.ls_common");dojo.require("misys.binding.cash.ft_common");dojo.require("misys.form.BusinessDateTextBox");(function(d,dj,m){var _1=d.byId("fx-message-type");function _2(_3){var _4=function(){var _5=dijit.byId("ft_amt");_5.set("state","Error");m.defaultBindTheFXTypes();dj.byId("ft_amt").set("value","");if(dj.byId("ft_cur_code")&&!dj.byId("ft_cur_code").get("readOnly")){dj.byId("ft_cur_code").set("value","");}};m.dialog.show("ERROR",_3,"",function(){setTimeout(_4,500);});if(d.byId("fx-section")&&(d.style(d.byId("fx-section"),"display")!=="none")){m.animate("wipeOut",d.byId("fx-section"));}};function _6(){var _7=true;var _8="";var _9=dj.byId("fx_rates_type_2");var _a=dj.byId("fx_total_utilise_amt");var _b=dj.byId("ft_amt");if(_9.get("checked")&&_a&&!isNaN(_a.get("value"))&&_b&&!isNaN(_b.get("value"))){if(_b.get("value")<_a.get("value")){_8+=m.getLocalization("FXUtiliseAmtGreaterMessage");_7=false;}}m._config.onSubmitErrorMsg=_8;return _7;};var _c,_d={};_d.fields=["beneficiary_name","beneficiary_account","beneficiary_act_cur_code","beneficiary_address","beneficiary_city","beneficiary_dom","cpty_bank_code","cpty_bank_name","cpty_bank_swift_bic_code","cpty_bank_address_line_1","cpty_bank_address_line_2","cpty_bank_dom","cpty_branch_code","cpty_branch_name","pre_approved"];_d.toggleReadonly=function(_e){m.toggleFieldsReadOnly(this.fields,_e);};_d.clear=function(){d.forEach(this.fields,function(_f,i){if(dj.byId(_f)){dj.byId(_f).set("value","");}});d.style("PAB","display","none");};function _10(){var _11=dj.byId("sub_product_code"),_12=dj.byId("beneficiary_account"),_13=dj.byId("beneficiary_act_cur_code");var _14=false;m.xhrPost({url:misys.getServletURL("/screen/AjaxScreen/action/ValidateBeneficiaryMasterAccount"),handleAs:"json",sync:true,content:{account_number:_12.get("value"),account_cur_code:_13.get("value"),sub_product_code:_11.get("value")},load:function(_15,_16){switch(_15.items.StatusCode){case "OK":_13.set("value",_15.items.AcctCur);_14=true;break;case "ERR_INVALID_ACCOUNT_NUMBER":_c=misys.getLocalization("invalidAccountNumber",[_12.get("value")]);_12.focus();_12.set("value","");_12.set("state","Error");dj.hideTooltip(_12.domNode);dj.showTooltip(_c,_12.domNode,0);break;case "ERR_INVALID_INTERFACE_PROCESSING_ERROR":_c=misys.getLocalization("accountValidationInterfaceError");_12.focus();_12.set("value","");_12.set("state","Error");dj.hideTooltip(_12.domNode);dj.showTooltip(_c,_12.domNode,0);break;default:_c=_15.items.StatusCodeMessage;_12.focus();_12.set("value","");_12.set("state","Error");dj.hideTooltip(_12.domNode);dj.showTooltip(_c,_12.domNode,0);break;}},error:function(_17,_18){console.error("[Could not validate Beneficiary Account] "+_12.get("value"));console.error(_17);}});return _14;};d.mixin(m._config,{initReAuthParams:function(){var _19={productCode:"FT",subProductCode:dj.byId("sub_product_code").get("value"),transactionTypeCode:"15",entity:dj.byId("entity")?dj.byId("entity").get("value"):"",currency:dj.byId("ft_cur_code").get("value"),amount:m.trimAmount(dj.byId("ft_amt").get("value")),es_field1:m.trimAmount(dj.byId("ft_amt").get("value")),es_field2:(dj.byId("beneficiary_account"))?dj.byId("beneficiary_account").get("value"):""};return _19;},xmlTransform:function(xml){var _1a="<ft_tnx_record>";if(xml.indexOf(_1a)!==-1){var _1b=m._config.xmlTagName,_1c=_1b?["<",_1b,">"]:[],_1d="</ft_tnx_record>",_1e="";_1e=xml.substring(_1a.length,(xml.length-_1d.length));_1c.push(_1e);if(dj.byId("gridLicense")&&dj.byId("gridLicense").store&&dj.byId("gridLicense").store!==null&&dj.byId("gridLicense").store._arrayOfAllItems.length>0){_1c.push("<linked_licenses>");dj.byId("gridLicense").store.fetch({query:{REFERENCEID:"*"},onComplete:dojo.hitch(dj.byId("gridLicense"),function(_1f,_20){dojo.forEach(_1f,function(_21){_1c.push("<license>");_1c.push("<ls_ref_id>",_21.REFERENCEID,"</ls_ref_id>");_1c.push("<bo_ref_id>",_21.BO_REF_ID,"</bo_ref_id>");_1c.push("<ls_number>",_21.LS_NUMBER,"</ls_number>");_1c.push("<ls_allocated_amt>",_21.LS_ALLOCATED_AMT,"</ls_allocated_amt>");_1c.push("<ls_amt>",_21.LS_AMT,"</ls_amt>");_1c.push("<ls_os_amt>",_21.LS_OS_AMT,"</ls_os_amt>");_1c.push("<converted_os_amt>",_21.CONVERTED_OS_AMT,"</converted_os_amt>");_1c.push("<allow_overdraw>",_21.ALLOW_OVERDRAW,"</allow_overdraw>");_1c.push("</license>");});})});_1c.push("</linked_licenses>");}if(_1b){_1c.push("</",_1b,">");}return _1c.join("");}else{return xml;}}});d.mixin(m,{fireFXAction:function(){if(m._config.fxParamData&&dj.byId("sub_product_code")&&dj.byId("sub_product_code").get("value")!==""){var _22=m._config.fxParamData[dj.byId("sub_product_code").get("value")];if(m._config.fxParamData&&_22.fxParametersData.isFXEnabled==="Y"){var _23,_24;var _25="";if(dj.byId("ft_cur_code")){_25=dj.byId("ft_cur_code").get("value");}var _26=dj.byId("ft_amt").get("value");var _27=dj.byId("applicant_act_cur_code").get("value");var _28=m._config.productCode;var _29="";if(dj.byId("issuing_bank_abbv_name")&&dj.byId("issuing_bank_abbv_name").get("value")!==""){_29=dj.byId("issuing_bank_abbv_name").get("value");}var _2a=dj.byId("applicant_act_cur_code").get("value");var _2b=false;if(_25!==""&&!isNaN(_26)&&_28!==""&&_29!==""){if(_25!==_27){_23=_27;_24=_25;_2a=_27;}if(_23&&_23!==""&&_24&&_24!==""){if(d.byId("fx-section")&&(d.style(d.byId("fx-section"),"display")==="none")){m.animate("wipeIn",d.byId("fx-section"));}m.fetchFXDetails(_23,_24,_26,_28,_29,_2a,_2b);if(dj.byId("fx_rates_type_1")&&dj.byId("fx_rates_type_1").get("checked")){if(isNaN(dj.byId("fx_exchange_rate").get("value"))||dj.byId("fx_exchange_rate_cur_code").get("value")===""||isNaN(dj.byId("fx_exchange_rate_amt").get("value"))||(m._config.fxParamData[dj.byId("sub_product_code").get("value")].fxParametersData.toleranceDispInd==="Y"&&(isNaN(dj.byId("fx_tolerance_rate").get("value"))||isNaN(dj.byId("fx_tolerance_rate_amt").get("value"))||dj.byId("fx_tolerance_rate_cur_code").get("value")===""))){_2(m.getLocalization("FXDefaultErrorMessage"));}}}else{if(d.byId("fx-section")&&(d.style(d.byId("fx-section"),"display")!=="none")){m.animate("wipeOut",d.byId("fx-section"));}m.defaultBindTheFXTypes();}}if(dj.byId("recurring_payment_enabled")&&dj.byId("recurring_payment_enabled").get("checked")&&dj.byId("fx_rates_type_2")){dj.byId("fx_rates_type_2").set("disabled",true);m.animate("wipeOut",d.byId("contracts_div"));}}}},bind:function(){m.setValidation("iss_date",m.validateTransferDateCustomer);dj.byId("sub_product_code").set("value","TTPT");m.bindRecurringFields();m.connect("prod_stat_code","onChange",m.populateReportingStatus);m.connect("prod_stat_code","onChange",function(){if(dj.byId("mode")&&dj.byId("mode").get("value")!=="RELEASE"){var _2c=this.get("value");m.toggleFields(_2c&&_2c!=="01"&&_2c!=="18",null,["bo_ref_id"]);}});m.connect("ft_cur_code","onChange",function(){m.setCurrency(this,["ft_amt"]);});m.setValidation("ft_cur_code",m.validateCurrency);m.connect("beneficiary_account","onChange",_10);m.connect("beneficiary_act_cur_code","onChange",function(){dj.byId("ft_cur_code").set("value",dj.byId("beneficiary_act_cur_code").get("value"));});m.setValidation("beneficiary_act_cur_code",m.validateCurrency);m.connect("license_lookup","onClick",function(){m.getLicenses("ft");});m.connect("entity","onChange",function(){m.setApplicantReference();dj.byId("applicant_act_name").set("value","");});m.connect("pre_approved_status","onChange",function(){if(dj.byId("pre_approved_status").get("value")==="N"){if(dj.byId("bank_img")){dj.byId("bank_img").set("disabled",false);}if(dj.byId("bank_iso_img")){dj.byId("bank_iso_img").set("disabled",false);}if(dj.byId("currency")){dj.byId("currency").set("disabled",false);}}var _2d=dj.byId("sub_product_code");});m.connect("recurring_flag","onClick",m.showRecurring);var _2e=dj.byId("sub_product_code").get("value");if(m._config.fxParamData&&m._config.fxParamData[_2e].fxParametersData.isFXEnabled==="Y"){m.connect("ft_cur_code","onBlur",function(){m.setCurrency(this,["ft_amt"]);if(dj.byId("ft_cur_code").get("value")!==""&&!isNaN(dj.byId("ft_amt").get("value"))){m.fireFXAction();}else{m.defaultBindTheFXTypes();}});m.connect("ft_amt","onBlur",function(){m.setTnxAmt(this.get("value"));var _2f="";if(dj.byId("ft_cur_code")){_2f=dj.byId("ft_cur_code").get("value");}if(!isNaN(dj.byId("ft_amt").get("value"))&&_2f!==""){m.fireFXAction();}else{m.defaultBindTheFXTypes();}});}else{if(d.byId("fx-section")&&dj.byId("fx_rates_type_1")&&!dj.byId("fx_rates_type_1").get("checked")&&dj.byId("fx_rates_type_2")&&!dj.byId("fx_rates_type_2").get("checked")){d.style("fx-section","display","none");}}},onFormLoad:function(){m.populateReportingStatus();m.setCurrency(dj.byId("ft_cur_code"),["ft_amt"]);m.populateGridOnLoad("ft");m.initForm();m.setApplicantReference();if(dj.byId("mode")&&dj.byId("mode").get("value")!=="RELEASE"){m.toggleFields(dj.byId("prod_stat_code").get("value")&&dj.byId("prod_stat_code").get("value")!=="01"&&dj.byId("prod_stat_code").get("value")!=="18",null,["bo_ref_id"]);}if(dj.byId("recurring_payment_enabled")&&dj.byId("recurring_payment_enabled").get("checked")){m.showSavedRecurringDetails(false);}else{if(d.byId("recurring_payment_div")){d.style("recurring_payment_div","display","none");}m.showSavedRecurringDetails(false);}if(dj.byId("applicant_act_product_types")&&dj.byId("applicant_act_no").get("value")!==""){m.toggleRequired("applicant_act_product_types",false);}if(m._config.fxParamData&&dj.byId("sub_product_code")&&dj.byId("sub_product_code").get("value")!==""&&dj.byId("sub_product_code").get("value")!=="IBG"){m.initializeFX(dj.byId("sub_product_code").get("value"));if(dj.byId("applicant_act_cur_code")&&dj.byId("applicant_act_cur_code").get("value")!==""&&dj.byId("ft_cur_code")&&dj.byId("ft_cur_code").get("value")!==""&&dj.byId("applicant_act_cur_code").get("value")!==dj.byId("ft_cur_code").get("value")){m.onloadFXActions();}else{m.defaultBindTheFXTypes();}}else{m.animate("fadeOut",_1);}if(d.byId("fx-section")){if(dj.byId("bulk_ref_id").get("value")!==""&&dj.byId("ft_cur_code").get("value")!==""&&!isNaN(dj.byId("ft_amt").get("value"))){m.initializeFX(dj.byId("sub_product_code").get("value"));m.fireFXAction();}else{if((dj.byId("fx_exchange_rate_cur_code")&&dj.byId("fx_exchange_rate_cur_code").get("value")!=="")||(dj.byId("fx_total_utilise_cur_code")&&dj.byId("fx_total_utilise_cur_code").get("value")!=="")||((dj.byId("fx_rates_type_1")&&dj.byId("fx_rates_type_1").get("checked"))||(dj.byId("fx_rates_type_2")&&dj.byId("fx_rates_type_2").get("checked")))){m.animate("wipeIn",d.byId("fx-section"));}else{d.style("fx-section","display","none");}}}},initForm:function(){dj.byId("sub_product_code").set("value","TTPT");if(dj.byId("pre_approved_status")&&dj.byId("pre_approved_status").get("value")==="Y"){d.style("PAB","display","inline");_d.toggleReadonly(true);if(dj.byId("bank_img")){dj.byId("bank_img").set("disabled",true);}if(dj.byId("bank_iso_img")){dj.byId("bank_iso_img").set("disabled",true);}if(dj.byId("currency")){dj.byId("currency").set("disabled",true);}}d.forEach(d.query(".CUR"),function(_30,i){d.style(_30,"display","inline");});dj.byId("beneficiary_mode").set("value","02");m.toggleRequired("beneficiary_act_cur_code",true);if(dj.byId("bank_img")){dj.byId("bank_img").set("disabled",true);}}});})(dojo,dijit,misys);dojo.require("misys.client.binding.bank.report_ft_ttpt_client");}