/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.binding.bank.report_cn"]){dojo._hasResource["misys.binding.bank.report_cn"]=true;dojo.provide("misys.binding.bank.report_cn");dojo.require("dijit.form.Form");dojo.require("dijit.form.Button");dojo.require("dijit.form.TextBox");dojo.require("misys.widget.Dialog");dojo.require("dijit.ProgressBar");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.CheckBox");dojo.require("dijit.layout.ContentPane");dojo.require("dijit.form.DateTextBox");dojo.require("misys.form.CurrencyTextBox");dojo.require("dijit.form.FilteringSelect");dojo.require("dijit.layout.TabContainer");dojo.require("misys.form.SimpleTextarea");dojo.require("misys.widget.Collaboration");dojo.require("misys.form.addons");dojo.require("misys.form.common");dojo.require("misys.form.file");dojo.require("misys.validation.common");(function(d,dj,m){function _1(){var _2=dj.byId("fscm_program_code")?dj.byId("fscm_program_code").get("value"):"";var _3=dj.byId("seller_abbv_name")?dj.byId("seller_abbv_name").get("value"):"";var _4=dj.byId("buyer_abbv_name")?dj.byId("buyer_abbv_name").get("value"):"";var _5=dj.byId("cn_cur_code")?dj.byId("cn_cur_code").get("value"):"";if(_2===""){m.dialog.show("ERROR",m.getLocalization("selectFSCMProgrammeFirst"));return;}m.showSearchDialog("invoice_item","['inv_ref_id', 'inv_ref','inv_curr','inv_amt']",{fscm_programme:_2,seller:_3,buyer:_4,cn_cur_code:_5},"","CN","width:710px;height:350px;",m.getLocalization("ListOfInvoicesTitleMessage"));};function _6(){var _7,_8=["buyer_name","buyer_bei","buyer_street_name","buyer_post_code","buyer_town_name","buyer_country_sub_div","buyer_country","buyer_account_type","buyer_account_value","fin_inst_bic","fin_inst_name","fin_inst_street_name","fin_inst_town_name","fscm_programme_01","fscm_programme_02","fscm_programme_03","fscm_programme_04","fin_inst_country_sub_div","buyer_abbv_name","access_opened","transaction_counterparty_email","ben_company_abbv_name"];d.forEach(_8,function(id){_7=dj.byId(id);if(_7){_7.set("value","");}});};d.mixin(m._config,{xmlTransform:function(_9){var _a=m._config.xmlTagName,_b=_a?["<",_a,">"]:[],_c="<cn_tnx_record>",_d="</cn_tnx_record>",_e="",_f=-1;_e=_9.substring(_c.length,(_9.length-_d.length));_b.push(_e);if(dj.byId("gridInvoice")&&dj.byId("gridInvoice").store&&dj.byId("gridInvoice").store!=null&&dj.byId("gridInvoice").store._arrayOfAllItems.length>0){_b.push("<invoice-items>");dj.byId("gridInvoice").store.fetch({query:{REFERENCEID:"*"},onComplete:dojo.hitch(dj.byId("gridInvoice"),function(_10,_11){dojo.forEach(_10,function(_12){_b.push("<invoice>");_b.push("<invoice_ref_id>",_12.REFERENCEID,"</invoice_ref_id>");_b.push("<invoice_reference>",_12.INVOICE_REFERENCE,"</invoice_reference>");_b.push("<invoice_currency>",_12.CURCODE,"</invoice_currency>");_b.push("<invoice_amount>",_12.INVOICE_AMOUNT,"</invoice_amount>");_b.push("<invoice_settlement_amt>",_12.INVOICE_SETTLEMENT_AMT,"</invoice_settlement_amt>");_b.push("</invoice>");});})});_b.push("</invoice-items>");}if(_a){_b.push("</",_a,">");}return _b.join("");}});d.mixin(m,{bind:function(){m.setValidation("buyer_bei",m.validateBEIFormat);m.setValidation("seller_bei",m.validateBEIFormat);m.setValidation("total_net_cur_code",m.validateCurrency);m.setValidation("buyer_country",m.validateCountry);m.setValidation("seller_country",m.validateCountry);m.connect("total_net_cur_code","onChange",function(){m.setCurrency(this,["total_net_amt"]);});m.connect("invoice_lookup","onClick",_1);},fetchInvoiceRecords:function(_13,url,_14){var _15=_13.selection.getSelected().length;var _16=_13.store?_13.store._arrayOfAllItems.length:0;if(_15>0&&_16>0){m.processInvoiceRecords(_13,_14);}dj.byId("xhrDialog").hide();},processInvoiceRecords:function(_17,_18){var _19=dj.byId("gridInvoice");var _1a=new dojo.data.ItemFileWriteStore({data:{"identifier":"REFERENCEID","items":[]}});var obj=[];if(_19&&_19.store&&_19.store._arrayOfTopLevelItems.length>0){_19.store.fetch({query:{REFERENCEID:"*"},onComplete:function(_1b,_1c){dojo.forEach(_1b,function(_1d){var _1e=_1d.REFERENCEID.slice().toString();var _1f=_1d.INVOICE_REFERENCE.slice().toString();var _20=_1d.CURCODE.toString();var _21=_1d.INVOICE_AMOUNT;var _22=_1d.INVOICE_SETTLEMENT_AMT;var _23="<img src="+misys.getContextualURL("/content/images/delete.png")+" onClick =\"javascript:misys.deleteInvoiceRecord('"+_1d.REFERENCEID+"')\"/>";var _24={"REFERENCEID":_1e,"INVOICE_REFERENCE":_1f,"CURCODE":_20,"INVOICE_AMOUNT":_21,"ACTION":_23,"INVOICE_SETTLEMENT_AMT":_22};_1a.newItem(_24);obj.push(_1d);});}});}var _25=_17.selection.getSelected();if(_25.length>0){for(var i=0;i<_25.length;i++){var _26=false;var _27="";var _28={};var _29=_25[i];var _2a=_29.REFERENCEID.slice().toString();var _2b=_29.INVOICE_REFERENCE.slice().toString();var _2c=_29.CURCODE.toString();var _2d=_29.INVOICE_AMOUNT;var _2e="<img src="+misys.getContextualURL("/content/images/delete.png")+" onClick =\"javascript:misys.deleteInvoiceRecord('"+_29.REFERENCEID+"')\"/>";if(obj.length>0){for(var t=0;t<obj.length;t++){if(obj[t].REFERENCEID.slice().toString()===_2a.slice().toString()){_26=true;}}if(!_26){var j;for(j=0;dj.byId("invoiceAmt_"+j);j++){continue;}_27=new misys.form.CurrencyTextBox({id:"invoiceAmt_"+j,name:"invoiceAmt_"+j,value:"",constraints:{min:0},readOnly:false,selectOnClick:true});if(_18){m.setCurrency(_18,["invoiceAmt_"+j]);}misys.connect("invoiceAmt_"+j,"onClick",function(){dijit.byId("gridInvoice").onCellFocus=function(_2f,_30){if(_2f.field==="INVOICE_SETTLEMENT_AMT"){var _31=dijit.byId("gridInvoice").store._arrayOfTopLevelItems[_30].INVOICE_SETTLEMENT_AMT[0].id;dijit.byId(_31).textbox.focus();}};});_28={"REFERENCEID":_2a,"INVOICE_REFERENCE":_2b,"CURCODE":_2c,"INVOICE_AMOUNT":_2d,"ACTION":_2e,"INVOICE_SETTLEMENT_AMT":_27};_1a.newItem(_28);}}else{_27=new misys.form.CurrencyTextBox({id:"invoiceAmt_"+i,name:"invoiceAmt_"+i,value:"",constraints:{min:0},readOnly:false,selectOnClick:true});if(_18){m.setCurrency(_18,["invoiceAmt_"+i]);}misys.connect("invoiceAmt_"+i,"onClick",function(){dijit.byId("gridInvoice").onCellFocus=function(_32,_33){if(_32.field==="INVOICE_SETTLEMENT_AMT"){var _34=dijit.byId("gridInvoice").store._arrayOfTopLevelItems[_33].INVOICE_SETTLEMENT_AMT[0].id;dijit.byId(_34).textbox.focus();}};});_28={"REFERENCEID":_2a,"INVOICE_REFERENCE":_2b,"CURCODE":_2c,"INVOICE_AMOUNT":_2d,"ACTION":_2e,"INVOICE_SETTLEMENT_AMT":_27};_1a.newItem(_28);}}}_19.setStore(_1a);dojo.style(_19.domNode,"display","");_19.resize();},deleteInvoiceRecord:function(ref){var _35=[];dj.byId("gridInvoice").store.fetch({query:{REFERENCEID:"*"},onComplete:dojo.hitch(dj.byId("gridInvoice"),function(_36,_37){dojo.forEach(_36,function(_38){if(_38.REFERENCEID.slice().toString()===ref.slice().toString()){dj.byId("gridInvoice").store.deleteItem(_38);var _39=_38.INVOICE_SETTLEMENT_AMT[0].id;if(dj.byId(_39)){dj.byId(_39).destroy(true);}}});})});dj.byId("gridInvoice").resize();},onFormLoad:function(){var _3a=dj.byId("gridInvoice");if(invoiceItems&&invoiceItems.length>0){var _3b=new dojo.data.ItemFileWriteStore({data:{"identifier":"REFERENCEID","items":[]}});if(dj.byId("gridInvoice")&&invoiceItems&&invoiceItems.length>0){for(var i=0;i<invoiceItems.length;i++){var _3c="";var _3d=invoiceItems[i];var _3e=_3d.REFERENCEID.slice().toString();var _3f=_3d.INVOICE_REFERENCE.slice().toString();var _40=_3d.CURCODE.toString();var _41=_3d.INVOICE_AMOUNT;var _42=_3d.INVOICE_SETTLEMENT_AMT;if(!dj.byId("invoiceAmt_"+i)){_3c=new misys.form.CurrencyTextBox({id:"invoiceAmt_"+i,name:"invoiceAmt_"+i,value:_42,constraints:{min:0},readOnly:false,selectOnClick:true});if(dj.byId("cn_cur_code")){m.setCurrency(dj.byId("cn_cur_code"),["invoiceAmt_"+i]);}misys.connect("invoiceAmt_"+i,"onClick",function(){dijit.byId("gridInvoice").onCellFocus=function(_43,_44){if(_43.field==="INVOICE_SETTLEMENT_AMT"){var _45=dijit.byId("gridInvoice").store._arrayOfTopLevelItems[_44].INVOICE_SETTLEMENT_AMT[0].id;dijit.byId(_45).textbox.focus();}};});}var _46="<img src="+misys.getContextualURL("/content/images/delete.png")+" onClick =\"javascript:misys.deleteInvoiceRecord('"+_3d.REFERENCEID+"')\"/>";dijit.byId("gridInvoice").onCellFocus=function(_47,_48){};var _49={"REFERENCEID":_3e,"INVOICE_REFERENCE":_3f,"CURCODE":_40,"INVOICE_AMOUNT":_41,"ACTION":_46,"INVOICE_SETTLEMENT_AMT":_3c};_3b.newItem(_49);}}_3a.setStore(_3b);dojo.style(_3a.domNode,"display","");_3a.resize();}else{dojo.style(dj.byId("gridInvoice").domNode,"display","none");}},beforeSubmitValidations:function(){var _4a=true;var _4b=dj.byId("gridInvoice");var sum=0;var _4c="";if(_4b&&_4b.store&&_4b.store._arrayOfTopLevelItems){for(var i=0;i<_4b.store._arrayOfTopLevelItems.length;i++){var _4d=_4b.store._arrayOfTopLevelItems[i].INVOICE_AMOUNT[i];var _4e=dj.byId("invoiceAmt_"+i);if(_4e&&_4e.state==="Error"){_4a=false;_4c=m.getLocalization("focusOnErrorAlert");break;}else{if(_4d&&_4e&&_4e.value!==null&&(_4e.value>_4d)){_4a=false;_4e.set("state","Error");_4c=m.getLocalization("settlementAmountGreaterThanInvoiceAmount");}else{if(_4e){sum=sum+dj.byId("invoiceAmt_"+i).value;if(sum>dj.byId("cn_amt").value){_4a=false;_4c=m.getLocalization("invoicesSumLessThanCNAmount");}}else{_4a=true;_4c="";}}}}}m._config.onSubmitErrorMsg=_4c;return _4a;}});})(dojo,dijit,misys);dojo.require("misys.client.binding.bank.report_cn_client");}