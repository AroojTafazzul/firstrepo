/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.binding.cash.TradeMessageTdBinding"]){dojo._hasResource["misys.binding.cash.TradeMessageTdBinding"]=true;dojo.provide("misys.binding.cash.TradeMessageTdBinding");dojo.require("misys.form.common");dojo.require("misys.validation.common");dojo.require("misys.form.DateTermField");dojo.require("misys.form.DateOrTermField");dojo.require("dijit.form.Form");dojo.require("dijit.form.Button");dojo.require("dijit.form.TextBox");dojo.require("dijit.Dialog");dojo.require("dijit.ProgressBar");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.CheckBox");dojo.require("dijit.layout.ContentPane");dojo.require("dojo.data.ItemFileReadStore");dojo.require("dijit.form.DateTextBox");dojo.require("dijit.form.CurrencyTextBox");dojo.require("dijit.form.NumberTextBox");dojo.require("dijit.form.FilteringSelect");dojo.require("misys.form.SimpleTextarea");dojo.require("dojo.parser");dojo.require("dojo.date");dojo.require("misys.widget.Collaboration");dojo.require("misys.binding.cash.common.request_action");(function(d,dj,m){d.mixin(m._config,{initReAuthParams:function(){var _1={productCode:"TD",subProductCode:dj.byId("sub_product_code")?dj.byId("sub_product_code").get("value"):"",transactionTypeCode:"01",entity:dj.byId("entity")?dj.byId("entity").get("value"):"",currency:"",amount:"",es_field1:"",es_field2:""};return _1;}});var _2=["input_maturity"];var _3=["reversal_reason"];var _4=["rebook_input_value","rebook_input_maturity","rebook_reason","rebook_input_td_amt","rebook_input_td_cur_code"];var _5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16;_fncToggleAction=function(_17){_9=_17;if("ROLLOVER"===_17.toUpperCase()){_fncEnableRequiredFields(_2);_fncDisabledRequiredFields(_3);_fncDisabledRequiredFields(_4);m.animate("fadeIn",d.byId("rollover-details"));m.animate("fadeIn",d.byId("request-button"));m.animate("fadeOut",d.byId("reverse-details"));m.animate("fadeOut",d.byId("rebook-details"));m.animate("fadeOut",d.byId("submit-button"));}else{if("REVERSE"===_17.toUpperCase()){_fncDisabledRequiredFields(_2);_fncEnableRequiredFields(_3);_fncDisabledRequiredFields(_4);m.animate("fadeIn",d.byId("reverse-details"));m.animate("fadeIn",d.byId("submit-button"));m.animate("fadeOut",d.byId("rollover-details"));m.animate("fadeOut",d.byId("rebook-details"));m.animate("fadeOut",d.byId("request-button"));}else{if("REBOOK"===_17.toUpperCase()){_fncDisabledRequiredFields(_2);_fncDisabledRequiredFields(_3);_fncEnableRequiredFields(_4);m.animate("fadeIn",d.byId("rebook-details"));m.animate("fadeIn",d.byId("request-button"));m.animate("fadeOut",d.byId("rollover-details"));m.animate("fadeOut",d.byId("reverse-details"));m.animate("fadeOut",d.byId("submit-button"));}else{m.animate("fadeOut",d.byId("rollover-details"));m.animate("fadeOut",d.byId("reverse-details"));m.animate("fadeOut",d.byId("rebook-details"));m.animate("fadeOut",d.byId("submit-button"));m.animate("fadeOut",d.byId("request-button"));_fncDisabledRequiredFields(_2);_fncDisabledRequiredFields(_3);_fncDisabledRequiredFields(_4);}}}};_fncEnableRequiredFields=function(_18){var _19=_18;d.forEach(_19,function(id){var _1a=dj.byId(id);if(_1a){m.toggleRequired(_1a,true);_1a.set("disabled",false);}});};_fncDisabledRequiredFields=function(_1b){var _1c=_1b;d.forEach(_1c,function(id){var _1d=dj.byId(id);if(_1d){_1d.set("disabled",true);}});};_fncTDCalculateNewAmt=function(_1e){var amt=dj.byId("rollover_td_amt");var _1f=dj.byId("org_reminder_td_amt");var _20=dojo.number.parse(dj.byId("total_with_interest").get("value"));var _21=!isNaN(_1f.get("value"))?_1f.get("value"):0;if(dj.byId("interest_capitalisation_Y").checked){_21=!isNaN(_20)?_20:0;}var _22=!isNaN(_1e.get("value"))?_1e.get("value"):0;if(_1e.id=="inc_amt"){amt.set("value",_21+_22);m.setTnxAmt(_22);}else{if(_22<=_21){amt.set("value",_21-_22);m.setTnxAmt(_22);}}};_fncTDAmendIncAmt=function(_23){var _24=("inc_amt"==_23.id)?dj.byId("dec_amt"):dj.byId("inc_amt");if(!isNaN(_23.get("value"))){_24.set("disabled",true);}else{_23.set("disabled",false);_24.set("disabled",false);}m.toggleFields((_23.get("value")&&_23.get("value")!==""),null,["amd_details"]);_fncTDCalculateNewAmt(_23);return _fncTDValidateAmendAmount(true,_23,null);};_fncTDValidateAmendAmount=function(_25,_26,_27){var _28=(_26.state=="Error")?false:true;_28=true;var _29=_26.id;var _2a=d.number.parse(dj.byId("org_reminder_td_amt").get("value"));if(_29=="inc_amt"){var _2b=_26.get("value");if(!isNaN(_2b)){if((_2b+_2a)>Number.MAX_VALUE){displayMessage=m.getLocalization("maximumValueError");dj.showTooltip(displayMessage,_26.domNode,0);_26.set("state","Error");_28=false;}else{if(_2b===0){displayMessage=m.getLocalization("increaseAmtCannotbeZero");dj.showTooltip(displayMessage,_26.domNode,0);_26.set("state","Error");_28=false;}}}}else{if(_29=="dec_amt"){var _2c=_26.get("value");if(!isNaN(_2c)){if((_2a-_2c)<0){displayMessage=m.getLocalization("decreaseAmtCannotMoreThanRolloverAmt");dj.showTooltip(displayMessage,_26.domNode,0);_26.set("state","Error");_28=false;}else{if((_2a-_2c)===0){displayMessage=m.getLocalization("rollOverAmtCannotbeZero");dj.showTooltip(displayMessage,_26.domNode,0);_26.set("state","Error");_28=false;}else{if(_2c===0){displayMessage=m.getLocalization("decreaseAmtCannotbeZero");dj.showTooltip(displayMessage,_26.domNode,0);_26.set("state","Error");_28=false;}}}}}}return _28;};m.updateSubTnxTypeCode=function(){var _2d=dj.byId("sub_tnx_type_code");var _2e=dj.byId("inc_amt");var _2f=dj.byId("dec_amt");var _30=dj.byId("amd_details");if(dj.byId("td_type").get("value")=="ROLLOVER"){if(!isNaN(_2e.get("value"))){_2d.set("value","26");}else{if(!isNaN(_2f.get("value"))){_2d.set("value","27");}else{_2d.set("value","28");}}}else{if(dj.byId("td_type").get("value")=="REVERSE"){_2d.set("value","29");}else{if(dj.byId("td_type").get("value")=="REBOOK"){_2d.set("value","30");}}}};_fncGetData=function(_31){d.query("#trade_id_report_row .content")[0].innerHTML=_31.trade_id;d.query("#maturity_report_row .content")[0].innerHTML=_31.maturity_date;d.query("#rate_report_row .content")[0].innerHTML=_31.rate;d.query("#interest_report_row .content")[0].innerHTML=_31.interest;dj.byId("trade_id").set("value",_31.trade_id);dj.byId("rec_id").set("value",_31.rec_id);dj.byId("remarks").set("value",_31.remarks);dj.byId("reversal_reason").set("value",_31.reason);trade_id=_31.trade_id;_6=_31.rec_id;dj.byId("rate").set("value",_31.rate);dj.byId("maturity_date").set("value",_31.maturity_date);dj.byId("value_date").set("value",_31.value_date);dj.byId("td_cur_code").set("value",_31.currency);dj.byId("td_amt").set("value",_31.amount);dj.byId("interest").set("value",_31.interest);};_fncManageErrors=function(_32,_33){var _34="";switch(_32){default:_34=m.getCommonMessageError(_32,_33);break;}m.dialog.show("ERROR",_34,"",function(){m.performClear();return;});m.performClear();};d.mixin(m,{bind:function(){m.connect("td_type","onChange",function(){_fncToggleAction(this.get("value"));});m.connect("cancelDelayDialogButton","onClick",m.performClear("delayDialog"));m.connect("delayDialog","onHide",m.closeDelayDialog());m.connect("buttonAcceptRequest","onClick",m.acceptRate);m.connect("buttonCancelRequest","onClick",m.fncPerformCancelRequest);m.connect("inc_amt","onBlur",function(){_fncTDAmendIncAmt(this);});m.connect("dec_amt","onBlur",function(){_fncTDAmendIncAmt(this);});m.connect("interest_capitalisation_Y","onChange",function(){if(dj.byId("inc_amt").getValue()>=0){_fncTDAmendIncAmt(dj.byId("inc_amt"));}else{_fncTDAmendIncAmt(dj.byId("dec_amt"));}});var _35=dj.byId("input_value_date").get("value");var _36=d.date.locale.parse(_35,{selector:"date",datePattern:m.getLocalization("g_strGlobalDateFormat")});m.setValidation("input_maturity_date",function(){return m.validateDate("input_maturity","input_value_date","errorUpdateTDMaturityGreaterStartDate",false,_36);});m.setValidation("rebook_input_value_date",function(){return m.validateDate("rebook_input_value","rebook_input_maturity","valueDateGreaterThanMaturityDate",true);});m.setValidation("rebook_input_maturity_date",function(){return m.validateDate("rebook_input_maturity","rebook_input_value","maturityDateLessThanValueDate",false);});m.setValidation("input_rebook_remarks",m.validateAlphaNumericRemarks);m.setValidation("input_rollover_remarks",m.validateAlphaNumericRemarks);m.setValidation("input_maturity_number",function(){return m.validateTermNumber("input_maturity","","TermCodeError",false);});},onFormLoad:function(){_fncToggleAction(dj.byId("td_type").get("value"));dj.byId("rollover_td_amt").set("value",dj.byId("td_amt").get("value"));if(dj.byId("org_reminder_td_amt")&&dj.byId("org_reminder_td_amt").get("value")!==""){m.setCurrency(dj.byId("org_reminder_td_amt"),["org_reminder_td_amt"]);}if(dj.byId("inc_amt")&&dj.byId("inc_amt").get("value")!==""){m.setCurrency(dj.byId("inc_amt"),["inc_amt"]);}if(dj.byId("dec_amt")&&dj.byId("dec_amt").get("value")!==""){m.setCurrency(dj.byId("dec_amt"),["dec_amt"]);}if(dj.byId("rollover_td_amt")&&dj.byId("rollover_td_amt").get("value")!==""){m.setCurrency(dj.byId("rollover_td_amt"),["rollover_td_amt"]);}},beforeSubmit:function(){m.updateSubTnxTypeCode();},fncPerformRequest:function(){m.doPerformRequest();},initVar:function(){_7=dj.byId("ref_id").get("value");if(dj.byId("applicant_reference")){_5=dj.byId("applicant_reference").get("value");}else{_5="";}_8=dj.byId("bo_ref_id").get("value");if(_9=="ROLLOVER"){if(dj.byId("interest_capitalisation_Y").checked){_a="Y";}else{_a="N";}_b=dj.byId("input_rollover_remarks").get("value");_c=dj.byId("td_cur_code").get("value");_d=dj.byId("org_reminder_td_amt").get("value");_e=dj.byId("inc_amt").get("value");_f=dj.byId("dec_amt").get("value");_10=dj.byId("input_maturity").getDate();_11=dj.byId("input_maturity").getNumber();_12=dj.byId("input_maturity").getCode();_13=dj.byId("input_value_date").get("value");_14="";_15="";}else{if(_9=="REBOOK"){_16=dj.byId("rebook_reason").get("value");_b=dj.byId("input_rebook_remarks").get("value");_a="";_c=dj.byId("rebook_input_td_cur_code").get("value");_d=dj.byId("rebook_input_td_amt").get("value");_e="";_f="";_10=dj.byId("rebook_input_maturity").getDate();_11=dj.byId("rebook_input_maturity").getNumber();_12=dj.byId("rebook_input_maturity").getCode();_13=dj.byId("rebook_input_value").getDate();_14=dj.byId("rebook_input_value").getNumber();_15=dj.byId("rebook_input_value").getCode();}}issuing_bank=dj.byId("issuing_bank_abbv_name").get("value");},getRate:function(){m.xhrPost({url:m.getServletURL("/screen/AjaxScreen/action/TreasuryRequestForQuoteSearchAction"),handleAs:"json",content:{operation:"REQUEST",ref_id:_7,applicant_reference:_5,interest_capitalisation:_a,reason:_16,original_trade_id:_8,td_type:_9,td_cur_code:_c,td_amt:_d,inc_amt:_e,dec_amt:_f,value_date:_13,value_days:_14,remarks:_b,value_period:_15,maturity_date:_10,maturity_days:_11,maturity_period:_12,bank:issuing_bank,productcode:"TD",subproductcode:"TRTD"},load:function(_37,_38){dj.byId("loadingDialog").hide();var _39=_37.status;switch(_39){case 5:_fncGetData(_37);validity=_37.validity;m.countDown(validity);m.showDetailField();break;case 6:trade_id=_37.trade_id;_6=_37.rec_id;m.frequencyStore=_37.delay_frequency;m.opicsFrequencyResponse=_37.delay_frequency;m.delayStore=_37.delay_timeout;m.openDelayDialog(m.frequencyStore,m.delayStore);break;default:_fncManageErrors(_39,_37);break;}},customError:function(_3a,_3b){dj.byId("loadingDialog").hide();console.error("[TdAjaxCall] error retrieving quote");_fncManageErrors("",_3a);}});},performDelayRequest:function(){if(m.frequencyStore>0){m.xhrPost({url:m.getServletURL("/screen/AjaxScreen/action/TreasuryRequestForQuoteSearchAction"),handleAs:"json",content:{operation:"DELAY",ref_id:_7,rec_id:_6,applicant_reference:_5,interest_capitalisation:_a,reason:_16,original_trade_id:_8,td_type:_9,td_cur_code:_c,td_amt:_d,inc_amt:_e,dec_amt:_f,value_date:_13,value_days:_14,value_period:_15,remarks:_b,maturity_date:_10,maturity_days:_11,maturity_period:_12,trade_id:trade_id,bank:issuing_bank,productcode:"TD",subproductcode:"TRTD"},load:function(_3c,_3d){var _3e=_3c.status;switch(_3e){case 5:_fncGetData(_3c);m.closeDelayDialog();validity=_3c.validity;m.countDown(validity);m.showDetailField();break;case 6:_6=_3c.rec_id;m.frequencyStore--;m.timer=setTimeout("misys.performDelayRequest()",(m.delayStore*1000));break;default:m.closeDelayDialog();_fncManageErrors(_3e,_3c);break;}},customError:function(_3f,_40){console.error("[TradeCreateTdAjaxCall] error retrieving quote");_fncManageErrors("",_3f);}});}else{m.stopCountDown(m.timer);m.showContinuationElement();}},performCancelDelayRequest:function(){dj.byId("buttonAcceptRequest").set("disabled",false);m.xhrPost({url:m.getServletURL("/screen/AjaxScreen/action/TreasuryRequestForQuoteSearchAction"),handleAs:"json",content:{operation:"CANCEL",ref_id:_7,applicant_reference:dj.byId("applicant_reference").get("value"),trade_id:trade_id,rec_id:_6,td_type:_9,td_cur_code:_c,td_amt:_d,value_date:_13,value_days:_14,value_period:_15,maturity_date:_10,maturity_days:_11,maturity_period:_12,bank:issuing_bank,productcode:"TD",subproductcode:"TRTD"},load:function(_41,_42){var _43=_41.status;switch(_43){case 7:m.dialog.show("CUSTOM-NO-CANCEL",m.getLocalization("confirmationCancelRequest"),m.getLocalization("confirmationCancelTitle"));break;default:_fncManageErrors(_43,_41);break;}},customError:function(_44,_45){console.error("[TdAjaxCall] error retrieving quote");m.dialog.show("ERROR",m.getLocalization("technicalError"));m.performClear();}});},cancelRequest:function(){dj.byId("buttonAcceptRequest").set("disabled",false);m.xhrPost({url:m.getServletURL("/screen/AjaxScreen/action/TreasuryRequestForQuoteSearchAction"),handleAs:"json",content:{operation:"REJECT",ref_id:_7,applicant_reference:dj.byId("applicant_reference").get("value"),trade_id:trade_id,td_type:_9,rec_id:_6,td_cur_code:_c,td_amt:_d,value_date:_13,value_days:_14,value_period:_15,maturity_date:_10,maturity_days:_11,maturity_period:_12,bank:issuing_bank,productcode:"TD",subproductcode:"TRTD"},load:function(_46,_47){m.toggleEnableFields();m.performClearDetails();},customError:function(_48,_49){console.error("[TdAjaxCall] error retrieving quote");m.dialog.show("ERROR",m.getLocalization("technicalError"));m.performClear();}});},getDisabledFields:function(){var _4a=["issuing_bank_customer_reference","trade_id","issuing_bank_abbv_name","input_td_cur_code","input_td_amt","td_type","input_td_amt_img","input_rollover_remarks","input_rebook_remarks","dijit_form_Button_2","dijit_form_Button_3","input_maturity","interest_capitalisation_Y","interest_capitalisation_N","reversal_reason","rebook_reason","rebook_input_td_cur_code","rebook_input_td_amt","rebook_input_value","request_button","request_clear_button","inc_amt","dec_amt","rebook_input_maturity","input_maturity_number","input_maturity_code"];return _4a;},getEnabledFields:function(){return m.getDisabledFields();},getHiddenFieldsToClear:function(){var _4b=["td_cur_code","td_amt","rate","input_rollover_remarks","input_rebook_remarks","value_date","maturity_date"];return _4b;},getFieldsToClear:function(){dj.byId("rollover_td_amt").set("value",dj.byId("td_amt").get("value"));dj.byId("interest_capitalisation_N").attr("checked",true);var _4c=["trade_id","reversal_reason","rebook_input_td_cur_code","input_maturity_code","input_maturity_date","input_td_cur_code","input_td_amt","rebook_reason","inc_amt","dec_amt","rebook_input_td_amt","input_rollover_remarks","rebook_input_value_date","rebook_input_maturity_date","input_rebook_remarks","interest_capitalisation_Y"];return _4c;},getDateTermFieldsToClear:function(){var _4d=["input_value","input_maturity"];return _4d;}});})(dojo,dijit,misys);dojo.require("misys.client.binding.cash.TradeMessageTdBinding_client");}