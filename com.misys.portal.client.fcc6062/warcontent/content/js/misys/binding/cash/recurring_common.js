/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.binding.cash.recurring_common"]){dojo._hasResource["misys.binding.cash.recurring_common"]=true;dojo.provide("misys.binding.cash.recurring_common");dojo.require("dojo.parser");dojo.require("dijit.layout.TabContainer");dojo.require("dijit.form.DateTextBox");dojo.require("misys.form.CurrencyTextBox");dojo.require("dijit.form.NumberTextBox");dojo.require("dijit.form.FilteringSelect");dojo.require("dijit.form.Form");dojo.require("dijit.form.Button");dojo.require("dijit.form.TextBox");dojo.require("misys.widget.Dialog");dojo.require("dijit.ProgressBar");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.CheckBox");dojo.require("misys.form.PercentNumberTextBox");dojo.require("misys.form.SimpleTextarea");dojo.require("misys.widget.Collaboration");dojo.require("misys.form.common");dojo.require("misys.form.file");dojo.require("misys.validation.common");(function(d,dj,m){var _1=true;function _2(_3){if(_3.get("type")==="hidden"){return d.date.locale.format(m.localizeDate(_3),{selector:"date"});}return _3.get("displayedValue");};function _4(_5,_6){if(_5){if(_6){_5.set("disabled",false);}else{_5.set("disabled",true);}}};d.mixin(m,{handleMultiBankRecurring:function(_7){if(!_7){if(dijit.byId("recurring_frequency")&&dijit.byId("customer_bank").get("value")!==""&&misys._config.perBankFrequency){var _8=misys._config.perBankFrequency[dijit.byId("customer_bank").get("value")];if(_8){dijit.byId("recurring_frequency").store=new dojo.data.ItemFileReadStore({data:{identifier:"value",label:"name",items:_8}});dijit.byId("recurring_frequency").fetchProperties={sort:[{attribute:"name"}]};}}if(dijit.byId("customer_bank").get("value")!==""&&misys._config.perBankRecurringAllowed){var _9=misys._config.perBankRecurringAllowed[dijit.byId("customer_bank").get("value")];if(_9==="Y"&&d.byId("recurring_payment_checkbox")){m.animate("fadeIn",d.byId("recurring_payment_checkbox"));if(dj.byId("recurring_flag")){dj.byId("recurring_flag").set("checked",false);m.toggleRecurringFields(["recurring_start_date","recurring_frequency","recurring_number_transfers"]);m.showRecurring();}}else{if(dj.byId("recurring_flag")){dj.byId("recurring_flag").set("checked",false);m.showRecurring();}if(d.byId("recurring_payment_checkbox")){m.animate("fadeOut",d.byId("recurring_payment_checkbox"));}if(dj.byId("recurring_start_date")&&dj.byId("recurring_frequency")&&dj.byId("recurring_number_transfers")){m.toggleFields(false,null,["recurring_start_date","recurring_frequency","recurring_number_transfers"],false,true);}if(d.byId("recurring_payment_div")){d.style("recurring_payment_div","display","none");}}}else{m.animate("fadeOut",dojo.byId("recurring_payment_checkbox"));}}},showRecurring:function(){if(dj.byId("recurring_flag")&&dj.byId("recurring_flag").get("checked")){dj.byId("recurring_payment_enabled").set("checked",true);}else{if(dj.byId("recurring_payment_enabled")){dj.byId("recurring_payment_enabled").set("checked",false);}}m.showSavedRecurringDetails(false);},toggleRecurringFields:function(_a){var _b=0,_c=/Check/,_d=/Date/,_e=/Time/;d.forEach(_a,function(id,i){var _f=dj.byId(id);if(_f){var _10=_f.declaredClass;var _11="";if(_c.test(_10)){_11=false;}else{if(_d.test(_10)||(_e.test(_10))){_11=null;}}_f.set("value",_11);if(i>=_b){_f.set("required",false);if(_f.validate){_f.validate(false);}}}});},showSavedRecurringDetails:function(_12){var _13=dj.byId("recurring_payment_enabled");var _14=dj.byId("recurring_end_date");if(_13){var _15=dj.byId("sub_product_code").get("value");if(_13.get("checked")){if(_15==="MT101"||_15==="MT103"||_15==="FI103"||_15==="FI202"){if(d.byId("process_request_dates_div")){d.style("process_request_dates_div","display","none");}m.toggleRequired("request_date",false);}else{if(d.byId("transfer_date_div")){d.style("transfer_date_div","display","none");}}m.animate("fadeIn","recurring_payment_div",function(){});m.toggleRequired("iss_date",false);if(m._config.clearOnSecondCall){m.toggleRequired("recurring_start_date",true);m.toggleRequired("recurring_frequency",true);var _16=dj.byId("recurring_number_transfers");if(_16){m.toggleRequired("recurring_number_transfers",true);}else{if(_14){m.toggleRequired("recurring_end_date",true);}}}if(_12){m.validateStartDateWithCurrentDate(dj.byId("recurring_start_date"));}}else{if(_15==="MT101"||_15==="MT103"||_15==="FI103"||_15==="FI202"){if(d.byId("process_request_dates_div")){d.style("process_request_dates_div","display","block");}m.toggleRequired("request_date",true);}else{if(d.byId("transfer_date_div")){d.style("transfer_date_div","display","block");}}if(dj.byId("recurring_start_date")){dj.byId("recurring_start_date").set("value",null);}if(dj.byId("recurring_frequency")){dj.byId("recurring_frequency").set("value","");}if(dj.byId("recurring_number_transfers")){dj.byId("recurring_number_transfers").set("value","");}m.animate("fadeOut","recurring_payment_div",function(){});m.toggleRequired("iss_date",true);m.toggleRequired("recurring_start_date",false);m.toggleRequired("recurring_frequency",false);m.toggleRequired("recurring_end_date",false);var _17=dj.byId("recurring_number_transfers");if(_17){m.toggleRequired("recurring_number_transfers",false);}else{if(_14){m.toggleRequired("recurring_end_date",false);}}}m.validateRecurringPaymentDetails();}},hasRecurringPayment:function(){var _18=d.byId("recurring_payment_checkbox_div")||d.byId("recurring_payment_checkbox"),_19=dj.byId("sub_product_code").get("value"),_1a;if(misys._config.recurring_product){_1a=misys._config.recurring_product[_19];}else{_1a="N";}if(_19!==""&&_1a=="Y"){d.style(_18,"display","block");}else{if(_19!==""&&(!_1a||_1a=="N")){dj.byId("recurring_flag").set("checked",false);d.style(_18,"display","none");}else{if(_19===""){d.style(_18,"display","block");}}}},validateFrequencyMode:function(){if(dj.byId("recurring_end_date")){dj.byId("recurring_end_date").set("value",null);}if(dj.byId("recurring_number_transfers")){dj.byId("recurring_number_transfers").set("value","");}m.validateRecurringPaymentDetails();m._config.formLoading=false;},validateTransfersNumber:function(){var _1b=true;if(dj.byId("recurring_payment_enabled").get("checked")){var _1c=dj.byId("recurring_number_transfers").get("value");var _1d=dj.byId("recurring_frequency").get("value");var _1e=dijit.byId("recurring_start_date")?dijit.byId("recurring_start_date").get("value"):"";var _1f;if(misys._config.isMultiBank&&dj.byId("customer_bank")&&misys._config.frequency_mode&&misys._config.frequency_mode[0][_1d+"_"+dj.byId("customer_bank").get("value")]){_1f=misys._config.frequency_mode[0][_1d+"_"+dj.byId("customer_bank").get("value")][2];}else{if(!misys._config.isMultiBank&&misys._config.frequency_mode&&misys._config.frequency_mode[0][_1d]){_1f=misys._config.frequency_mode[0][_1d][2];}}if(_1d==="DAILY"&&_1e&&dojo.date.isLeapYear(_1e)){var _20=_1f?parseInt(_1f,10):0;if(_20!=="NaN"&&_20&&_20>0&&(_20/366<1)){_1f=_20+1;}}if(_1c>_1f||_1c<1){this.invalidMessage=misys.getLocalization("invalidFreqMessage",[_1f]);_1b=false;}}return _1b;},validateRecurringOn:function(){var _21=dj.byId("recurring_start_date").get("value"),_22=dj.byId("recurring_frequency").get("value"),_23=_21==null?null:_21.getDate();if(dijit.byId("exact_day")){var _24=dj.byId("exact_day").get("value");if((_23===29||_23===30)&&_24==="01"&&(_22==="MONTHLY"||_22==="QUARTERLY")){if(_1){m.dialog.show("MESSAGE",m.getLocalization("customerMessage"));}_1=true;}}},setTransferDate:function(){if(dj.byId("recurring_payment_enabled")){if(dj.byId("recurring_payment_enabled").get("checked")){m.toggleRequired("iss_date",false);dj.byId("iss_date").set("value",dj.byId("recurring_start_date").get("value"));dj.byId("recurring_frequency").set("value",null);if(dj.byId("recurring_end_date")){dj.byId("recurring_end_date").set("value",null);}if(dj.byId("recurring_number_transfers")){dj.byId("recurring_number_transfers").set("value","");}}}},validateRecurringStartDate:function(){if(!this.get("value")){return true;}var _25=dj.byId("appl_date_hidden");var _26=dj.byId("appl_date_hidden").get("value");if(dj.byId("todays_date")&&dj.byId("todays_date").get("value")!==null&&dj.byId("todays_date").get("value")!==""){_25=dj.byId("todays_date");_26=dj.byId("todays_date").get("value");}var _27=dj.byId("sub_product_code").get("value");if(!m.compareDateFields(_25,this)){this.invalidMessage=m.getLocalization("startDateLessThanCurrentDateError",[_2(this),_2(_25)]);return false;}var _28=dj.byId("recurring_start_date").get("value");var _29=_28.getDate();var _2a="";var _2b="";if(misys._config.isMultiBank&&dj.byId("customer_bank")&&misys._config.offset[0][_27+"_"+dj.byId("customer_bank").get("value")]){_2a=misys._config.offset[0][_27+"_"+dj.byId("customer_bank").get("value")][0];_2b=misys._config.offset[0][_27+"_"+dj.byId("customer_bank").get("value")][1];}else{if(misys._config.offset[0][_27]){_2a=misys._config.offset[0][_27][0];_2b=misys._config.offset[0][_27][1];}}var _2c=new Date(_26.getFullYear(),_26.getMonth(),_26.getDate());var _2d=new Date(_26.getFullYear(),_26.getMonth(),_26.getDate());_2c.setHours(0,0,0,0);_2d.setHours(0,0,0,0);_2c.setDate(_26.getDate()+_2a);_2d.setDate(_26.getDate()+_2b);if(_28<_2c||_28>_2d){var _2e=_2c.getMonth();_2e=_2e+1;var _2f=_2c.getFullYear();var _30=_2c.getDate();var _31=_30+"/"+_2e+"/"+_2f;var _32=_2d.getMonth();_32=_32+1;var _33=_2d.getFullYear();var _34=_2d.getDate();var _35=_34+"/"+_32+"/"+_33;this.invalidMessage=misys.getLocalization("invalidStartDateMessage",[_31,_35]);return false;}m.validateRecurringPaymentDetails();return true;},validateRecurringPaymentDetails:function(){if(dj.byId("recurring_frequency")){var _36=dj.byId("recurring_frequency").get("value"),_37=dj.byId("recurring_start_date").get("value"),_38=d.byId("recurring_on_div"),_39=dj.byId("exact_day"),_3a=dj.byId("last_day"),_3b=_37==null?null:_37.getDate();if((_36==="MONTHLY"||_36==="QUARTERLY")&&(_3b===29||_3b===30||_3b===31)){m._config.clearOnSecondCall=true;}var _3c,_3d;if(misys._config.isMultiBank&&dj.byId("customer_bank")&&misys._config.frequency_mode&&misys._config.frequency_mode[0][_36+"_"+dj.byId("customer_bank").get("value")]){_3c=misys._config.frequency_mode[0][_36+"_"+dj.byId("customer_bank").get("value")][0];_3d=misys._config.frequency_mode[0][_36+"_"+dj.byId("customer_bank").get("value")][1];}else{if(!misys._config.isMultiBank&&misys._config.frequency_mode&&misys._config.frequency_mode[0][_36]){_3c=misys._config.frequency_mode[0][_36][0];_3d=misys._config.frequency_mode[0][_36][1];}}if(m._config.clearOnSecondCall&&_3c&&_3d){if(_3c==="N"&&_3d==="N"){m.animate("fadeOut",_38,function(){});_39.set("checked",true);}else{_39.set("checked",false);m.animate("fadeIn",_38,function(){});_4(_39,(_3c==="Y"?true:false));_4(_3a,(_3d==="Y"?true:false));}if(_3c==="Y"){if(!(_37==null||_37==="")){if(_36==="MONTHLY"||_36==="QUARTERLY"){if(_3b===31&&_3d==="Y"){_3a.set("checked",true);_4(_39,false);}else{if(_39.get("checked")===false&&_3a.get("checked")===false){_39.set("checked",true);}}m.animate("fadeIn",_38,function(){});}else{m.animate("fadeOut",_38,function(){});_39.set("checked",true);}}else{_39.set("checked",false);_3a.set("checked",false);}}else{if(_3d==="Y"){if(!(_37==null||_37==="")){if(_3b===31){_3a.set("checked",true);}}}}}else{if(_36==="MONTHLY"||_36==="QUARTERLY"){m.animate("fadeIn",_38,function(){});if(_3a.get("value")!=""){_3a.set("checked",true);}else{_39.set("checked",true);}}else{m.animate("fadeOut",_38,function(){});}}m._config.clearOnSecondCall=true;}},isRecurringDetailsValidForSubmit:function(){var _3e=dj.byId("recurring_payment_enabled"),_3f=dj.byId("recurring_start_date"),_40=dj.byId("recurring_frequency"),_41=dj.byId("exact_day"),_42=dj.byId("last_day"),_43="";if(_3e){if(_3e.get("checked")){_43=_40.get("value");if(_43==="MONTHLY"||_43==="QUARTERLY"){if(_41.get("checked")===false&&_42.get("checked")===false){_41.set("state","Error");dj.hideTooltip(_41.domNode);dj.showTooltip(misys.getLocalization("recurringOnRequired"),_41.domNode,0);var _44=function(){dj.hideTooltip(_41.domNode);};setTimeout(_44,3000);return false;}else{if(_41.get("checked")===true){_1=false;}}}}}return true;},validateStartDateWithCurrentDate:function(_45){var _46,_47;if(_45){if(_45.get("value")!=""){_46=new Date();_46.setHours(0,0,0,0);_47=d.date.compare(m.localizeDate(_45),_46)<0?false:true;if(!_47){_45.state="Error";_45.set("focusonerror",true);_45.invalidMessage=m.getLocalization("startDateGreaterThanCurrentDateError",[_2(_45)]);_45._setStateClass();dj.setWaiState(_45.focusNode,"invalid","true");return false;}}}return true;},bindRecurringFields:function(){m.setValidation("recurring_start_date",m.validateRecurringStartDate);m.setValidation("recurring_number_transfers",m.validateTransfersNumber);m.connect("recurring_start_date","onChange",m.setTransferDate);m.connect("recurring_number_transfers","onClick",function(){if(dj.byId("recurring_start_date").get("value")===""||dj.byId("recurring_start_date").get("value")===null){m.dialog.show("ERROR",m.getLocalization("selectStartDateFirst"),"",function(){dj.byId("recurring_start_date").focus();});return;}if(dj.byId("recurring_frequency").get("value")===""||dj.byId("recurring_frequency").get("value")===null){m.dialog.show("ERROR",m.getLocalization("selectFrequencyModeFirst"),"",function(){dj.byId("recurring_frequency").focus();});return;}});m.connect("recurring_end_date","onClick",function(){if(dj.byId("recurring_start_date").get("value")===""||dj.byId("recurring_start_date").get("value")===null){m.dialog.show("ERROR",m.getLocalization("selectStartDateFirst"),"",function(){dj.byId("recurring_start_date").focus();});return;}if(dj.byId("recurring_frequency").get("value")===""||dj.byId("recurring_frequency").get("value")===null){m.dialog.show("ERROR",m.getLocalization("selectFrequencyModeFirst"),"",function(){dj.byId("recurring_frequency").focus();});return;}});m.connect("recurring_number_transfers","onBlur",function(){if(misys._config.bothFieldsEnabled==="true"){m.getRecurringDetails("2");}});m.connect("recurring_end_date","onBlur",function(){if(misys._config.bothFieldsEnabled==="true"){m.getRecurringDetails("1");}});m.connect("recurring_start_date","onClick",function(){misys._config.dateCache=[];var _48;var _49=dj.byId("issuing_bank_abbv_name");if(dj.byId("customer_bank")){_48=dj.byId("customer_bank").get("value");}else{if(_49&&_49.get("value")!==""){_48=_49.get("value");}}if(_48!==""&&misys&&misys._config&&misys._config.businessDateForBank&&misys._config.businessDateForBank[_48][0]&&misys._config.businessDateForBank[_48][0].value!==""){var _4a=parseInt(misys._config.businessDateForBank[_48][0].value.substring(0,4),10);var _4b=parseInt(misys._config.businessDateForBank[_48][0].value.substring(5,7),10);var _4c=parseInt(misys._config.businessDateForBank[_48][0].value.substring(8,10),10);this.dropDown.currentFocus=new Date(_4a,_4b-1,_4c);}});m.connect("exact_day","onChange",m.validateRecurringOn);m.connect("recurring_frequency","onChange",m.validateFrequencyMode);m.connect("recurring_end_date","onChange",function(){var _4d=dj.byId("recurring_start_date");var _4e=dj.byId("recurring_end_date");if(!m.compareDateFields(_4d,_4e)){this.invalidMessage=m.getLocalization("endDateLessThanStartDateError",[dj.byId("recurring_end_date").get("displayedValue"),dj.byId("recurring_start_date").get("displayedValue")]);m.showTooltip(m.getLocalization("endDateLessThanStartDateError",[dj.byId("recurring_end_date").get("displayedValue"),dj.byId("recurring_start_date").get("displayedValue")]),d.byId("recurring_end_date"),["after"]);dj.byId("recurring_end_date").set("value",null);}});m.connect("recurring_start_date","onChange",function(){var _4f=dj.byId("recurring_start_date");var _50=dj.byId("recurring_end_date");if(_50){if(!m.compareDateFields(_4f,_50)){this.invalidMessage=m.getLocalization("startDateGreaterThanEndDateError",[dj.byId("recurring_start_date").get("displayedValue"),dj.byId("recurring_end_date").get("displayedValue")]);m.showTooltip(m.getLocalization("startDateGreaterThanEndDateError",[dj.byId("recurring_start_date").get("displayedValue"),dj.byId("recurring_end_date").get("displayedValue")]),d.byId("recurring_start_date"),["after"]);dj.byId("recurring_start_date").set("value",null);}}});},getRecurringDetails:function(_51){var _52=true;var _53=(dj.byId("recurring_start_date").get("displayedValue")!==null)?dj.byId("recurring_start_date").get("displayedValue"):null;var _54=dj.byId("recurring_end_date")?dj.byId("recurring_end_date").get("displayedValue"):"";var _55=dj.byId("recurring_number_transfers")?dj.byId("recurring_number_transfers").get("value"):0;var _56=dj.byId("recurring_frequency")?dj.byId("recurring_frequency").get("value"):"";var _57=(dj.byId("exact_day").checked)?true:false;if((_51==="1"&&_54!=="")||(_51==="2"&&!isNaN(_55)&&_55!==0)){m.xhrPost({url:m.getServletURL("/screen/AjaxScreen/action/CalculateRecurringEndDateAndTransfers"),handleAs:"json",sync:true,content:{mode:_51,startDate:_53,frequencyMode:_56,endDate:_54,transfers:_55,exactOrLastDay:_57},load:function(_58,_59){if(_51==="1"){var _5a=_58.calculatedTransfers;dj.byId("recurring_number_transfers").set("value",_5a);}else{dj.byId("recurring_end_date").set("value",new Date(_58.calculatedEndDate));}}});}}});d.ready(function(){m._config.clearOnSecondCall=false;m._config.checkExactDay=true;m._config.formLoading=true;});})(dojo,dijit,misys);dojo.require("misys.client.binding.cash.recurring_common_client");}