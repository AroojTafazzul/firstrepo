/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.binding.openaccount.create_po"]){dojo._hasResource["misys.binding.openaccount.create_po"]=true;dojo.provide("misys.binding.openaccount.create_po");dojo.require("dojo.parser");dojo.require("dijit.layout.BorderContainer");dojo.require("dijit.Dialog");dojo.require("dijit.form.Button");dojo.require("dijit.form.TextBox");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.DateTextBox");dojo.require("misys.form.CurrencyTextBox");dojo.require("dijit.form.NumberTextBox");dojo.require("dijit.form.CheckBox");dojo.require("dijit.form.FilteringSelect");dojo.require("dijit.form.Form");dojo.require("dijit.layout.ContentPane");dojo.require("dijit.layout.TabContainer");dojo.require("dojo.io.iframe");dojo.require("dijit.ProgressBar");dojo.require("dojo.behavior");dojo.require("dojo.date.locale");dojo.require("dijit.Tooltip");dojo.require("misys.openaccount.FormOpenAccountEvents");dojo.require("misys.grid.DataGrid");dojo.require("misys.form.SimpleTextarea");dojo.require("misys.form.common");dojo.require("misys.validation.common");dojo.require("misys.layout.FloatingPane");dojo.require("misys.openaccount.widget.LineItems");dojo.require("misys.openaccount.widget.LineItem");dojo.require("misys.openaccount.widget.ProductIdentifiers");dojo.require("misys.openaccount.widget.ProductIdentifier");dojo.require("misys.openaccount.widget.ProductCategories");dojo.require("misys.openaccount.widget.ProductCategory");dojo.require("misys.openaccount.widget.ProductCharacteristics");dojo.require("misys.openaccount.widget.ProductCharacteristic");dojo.require("misys.openaccount.widget.Adjustments");dojo.require("misys.openaccount.widget.Adjustment");dojo.require("misys.openaccount.widget.PaymentTerms");dojo.require("misys.openaccount.widget.PaymentTerm");dojo.require("misys.openaccount.widget.Taxes");dojo.require("misys.openaccount.widget.Tax");dojo.require("misys.openaccount.widget.FreightCharges");dojo.require("misys.openaccount.widget.FreightCharge");dojo.require("misys.openaccount.widget.Incoterms");dojo.require("misys.openaccount.widget.Incoterm");dojo.require("misys.openaccount.widget.ContactDetails");dojo.require("misys.openaccount.widget.ContactDetail");dojo.require("misys.openaccount.widget.SUserInformations");dojo.require("misys.openaccount.widget.SUserInformation");dojo.require("misys.openaccount.widget.BUserInformations");dojo.require("misys.openaccount.widget.BUserInformation");dojo.require("misys.openaccount.widget.TransportByAirDeptDetails");dojo.require("misys.openaccount.widget.TransportByAirDeptDetail");dojo.require("misys.openaccount.widget.TransportByAirDestDetails");dojo.require("misys.openaccount.widget.TransportByAirDestDetail");dojo.require("misys.openaccount.widget.TransportBySeaLoadingPortDetails");dojo.require("misys.openaccount.widget.TransportBySeaLoadingPortDetail");dojo.require("misys.openaccount.widget.TransportBySeaDischargePortDetails");dojo.require("misys.openaccount.widget.TransportBySeaDischargePortDetail");dojo.require("misys.openaccount.widget.TransportByRailReceiptPlaceDetail");dojo.require("misys.openaccount.widget.TransportByRailReceiptPlaceDetails");dojo.require("misys.openaccount.widget.TransportByRailDeliveryPlaceDetail");dojo.require("misys.openaccount.widget.TransportByRailDeliveryPlaceDetails");dojo.require("misys.openaccount.widget.TransportByRoadReceiptPlaceDetail");dojo.require("misys.openaccount.widget.TransportByRoadReceiptPlaceDetails");dojo.require("misys.openaccount.widget.TransportByRoadDeliveryPlaceDetail");dojo.require("misys.openaccount.widget.TransportByRoadDeliveryPlaceDetails");dojo.require("misys.openaccount.widget.RoutingSummary");dojo.require("misys.openaccount.widget.AirRoutingSummaries");dojo.require("misys.openaccount.widget.SeaRoutingSummaries");dojo.require("misys.openaccount.widget.RailRoutingSummaries");dojo.require("misys.openaccount.widget.RoadRoutingSummaries");(function(d,dj,m){d.mixin(m._config,{initReAuthParams:function(){var _1={productCode:"PO",subProductCode:"",transactionTypeCode:"01",entity:dj.byId("entity")?dj.byId("entity").get("value"):"",currency:dj.byId("total_net_cur_code")?dj.byId("total_net_cur_code").get("value"):"",amount:dj.byId("total_net_amt")?m.trimAmount(dj.byId("total_net_amt").get("value")):"",bankAbbvName:dj.byId("issuing_bank_abbv_name")?dj.byId("issuing_bank_abbv_name").get("value"):"",es_field1:"",es_field2:""};return _1;},_hasLineItemShipmentDate:function(){if(dj.byId("line-items").store!=null){var _2=dj.byId("line-items").store._arrayOfAllItems;for(i=0;i<_2.length;i++){if(_2[i]&&_2[i].last_ship_date!=""){dj.byId("last_ship_date").set("value",null);dj.byId("last_ship_date").set("disabled",true);break;}else{dj.byId("last_ship_date").set("disabled",false);}}}}});d.mixin(m,{bind:function(){m.connect("bill_to_name","onChange",m.enableRequiredTab);m.connect("ship_to_name","onChange",m.enableRequiredTab);m.connect("consgn_name","onChange",m.enableRequiredTab);m.connect("bill_to_post_code","onChange",m.enableRequiredTab);m.connect("ship_to_post_code","onChange",m.enableRequiredTab);m.connect("consgn_post_code","onChange",m.enableRequiredTab);m.connect("bill_to_town_name","onChange",m.enableRequiredTab);m.connect("ship_to_town_name","onChange",m.enableRequiredTab);m.connect("consgn_town_name","onChange",m.enableRequiredTab);m.connect("bill_to_country","onChange",m.enableRequiredTab);m.connect("ship_to_country","onChange",m.enableRequiredTab);m.connect("consgn_country","onChange",m.enableRequiredTab);m.setValidation("line_item_last_ship_date",m.validateOALastShipmentDate);m.setValidation("template_id",m.validateTemplateId);m.setValidation("contact_email",m.validateEmailAddr);m.setValidation("buyer_bei",m.validateBEIFormat);m.setValidation("fin_inst_bic",m.validateBICFormat);m.setValidation("total_cur_code",m.validateCurrency);m.setValidation("fake_total_cur_code",m.validateCurrency);m.setValidation("total_net_cur_code",m.validateCurrency);m.setValidation("line_item_price_cur_code",m.validateCurrency);m.setValidation("line_item_total_net_cur_code",m.validateCurrency);m.setValidation("adjustment_cur_code",m.validateCurrency);m.setValidation("details_cur_code",m.validateCurrency);m.setValidation("tax_cur_code",m.validateCurrency);m.setValidation("freight_charge_cur_code",m.validateCurrency);m.setValidation("buyer_country",m.validateCountry);m.setValidation("seller_country",m.validateCountry);m.setValidation("line_item_product_orgn_country",m.validateCountry);m.setValidation("fin_inst_country",m.validateCountry);m.connect("total_cur_code","onChange",m.toggleDisableButtons);m.connect("freight_charges_type","onFocus",m.saveOldFreightChargeType);m.connect("freight_charges_type","onChange",m.manageFreightButton);m.connect("total_cur_code","onChange",m.managePOCurrency);m.connect("total_cur_code","onBlur",_3);m.connect("adjustment_amt","onChange",function(){m.toggleFields(isNaN(this.get("value")),null,["adjustment_rate"],false,false);});m.connect("adjustment_rate","onChange",function(){m.toggleFields(isNaN(this.get("value")),null,["adjustment_amt","adjustment_cur_code"],false,false);});m.connect("freight_charge_amt","onChange",function(){m.toggleFields(isNaN(this.get("value")),null,["freight_charge_rate"],false,false);});m.connect("freight_charge_rate","onChange",function(){m.toggleFields(isNaN(this.get("value")),null,["freight_charge_amt","freight_charge_cur_code"],false,false);});m.connect("tax_amt","onChange",function(){m.toggleFields(isNaN(this.get("value")),null,["tax_rate"],false,false);});m.connect("tax_rate","onChange",function(){m.toggleFields(isNaN(this.get("value")),null,["tax_amt","tax_cur_code"],false,false);});m.connect("display_other_parties","onClick",m.showHideOtherParties);m.connect("total_cur_code","onFocus",m.saveOldPOCurrency);m.connect("seller_account_type","onChange",function(){m.onChangeSellerAccountType("form_settlement","seller_account_value","seller_account_type");});m.connect("seller_account_value","onFocus",m.onFocusSellerAccount);m.connect("last_match_date","onBlur",m.onBlurMatchDate);m.setValidation("last_ship_date",m.validateOALastShipmentDate);m.connect("line_item_qty_val","onBlur",m.computeLineItemAmount);m.connect("line_item_price_amt","onBlur",m.computeLineItemAmount);if(dojo.byId("line_item_qty_unit_measr_other_row")&&dojo.byId("line_item_qty_unit_measr_code")){if(dj.byId("line_item_qty_unit_measr_code")&&dj.byId("line_item_qty_unit_measr_code").get("value")==="OTHR"){m.animate("fadeIn","line_item_qty_unit_measr_other_row");}else{m.animate("fadeOut","line_item_qty_unit_measr_other_row");}}m.connect("line_item_qty_unit_measr_code","onChange",function(){m.toggleFields((this.get("value")==="OTHR"),null,["line_item_qty_unit_measr_other"]);if(dojo.byId("line_item_qty_unit_measr_other_row")){if(this.get("value")==="OTHR"){m.animate("fadeIn","line_item_qty_unit_measr_other_row");}else{m.animate("fadeOut","line_item_qty_unit_measr_other_row");}}});m.connect("fake_total_cur_code","onChange",function(){m.setCurrency(this,["fake_total_amt"]);});m.connect("total_net_cur_code","onChange",function(){m.setCurrency(this,["total_net_amt"]);});m.connect("line_item_price_cur_code","onChange",function(){m.setCurrency(this,["line_item_price_amt"]);});m.connect("details_cur_code","onChange",function(){m.setCurrency(this,["details_amt"]);});m.connect("fake_total_amt","onChange",function(){m.setTnxAmt(this.get("value"));});m.connect("line_item_total_cur_code","onChange",function(){m.setCurrency(this,["line_item_total_amt"]);});m.connect("line_item_total_net_cur_code","onChange",function(){m.setCurrency(this,["line_item_total_net_amt"]);});m.connect("adjustment_cur_code","onChange",function(){m.setCurrency(this,["adjustment_amt"]);});m.connect("tax_cur_code","onChange",function(){m.setCurrency(this,["tax_amt"]);});m.connect("freight_charge_cur_code","onChange",function(){m.setCurrency(this,["freight_charge_amt"]);});m.connect("issuing_bank_abbv_name","onChange",m.populateReferences);if(dj.byId("issuing_bank_abbv_name")){m.connect("entity","onChange",function(){dj.byId("issuing_bank_abbv_name").onChange();});}m.connect("issuing_bank_customer_reference","onChange",m.setBuyerReference);m.connect(dj.byId("line_item_qty_unit_measr_code"),"onChange",function(){dj.byId("line_item_price_unit_measr_code").set("value",this.get("value"));});m.connect(dj.byId("details_code"),"onChange",m.paymentDetailsChange);m.connect(dj.byId("line_item_qty_unit_measr_code"),"onChange",function(){dj.byId("line_item_qty_unit_measr_label").set("value",this.get("displayedValue"));});m.connect(dj.byId("contact_type"),"onChange",function(){dj.byId("contact_type_decode").set("value",this.get("displayedValue"));});m.connect(dj.byId("product_identifier_code"),"onChange",function(){dj.byId("product_identifier_code_label").set("value",this.get("displayedValue"));});m.connect(dj.byId("product_category_code"),"onChange",function(){dj.byId("product_category_code_label").set("value",this.get("displayedValue"));});m.connect(dj.byId("product_characteristic_code"),"onChange",function(){dj.byId("product_characteristic_code_label").set("value",this.get("displayedValue"));});m.connect(dj.byId("adjustment_type"),"onChange",function(){dj.byId("adjustment_type_label").set("value",this.get("displayedValue"));});m.connect(dj.byId("tax_type"),"onChange",function(){dj.byId("tax_type_label").set("value",this.get("displayedValue"));});m.connect(dj.byId("freight_charge_type"),"onChange",function(){dj.byId("freight_charge_type_label").set("value",this.get("displayedValue"));});m.connect(dj.byId("incoterm_code"),"onChange",function(){dj.byId("incoterm_code_label").set("value",this.get("displayedValue"));});if(dojo.byId("adjustment_other_type_row")&&dojo.byId("adjustment_type")){if(dj.byId("adjustment_type").get("value")==="OTHR"){m.animate("fadeIn","adjustment_other_type_row");}else{m.animate("fadeOut","adjustment_other_type_row");}}if(dojo.byId("tax_other_type_row")&&dojo.byId("tax_type")){if(dj.byId("tax_type").get("value")==="OTHR"){m.animate("fadeIn","tax_other_type_row");}else{m.animate("fadeOut","tax_other_type_row");}}m.connect("adjustment_type","onChange",function(){m.toggleFields((this.get("value")==="OTHR"),null,["adjustment_other_type"]);if(dojo.byId("adjustment_other_type_row")){if(this.get("value")==="OTHR"){m.animate("fadeIn","adjustment_other_type_row");}else{m.animate("fadeOut","adjustment_other_type_row");}}});m.connect("tax_type","onChange",function(){m.toggleFields((this.get("value")==="OTHR"),null,["tax_other_type"]);if(dojo.byId("tax_other_type_row")){if(this.get("value")==="OTHR"){m.animate("fadeIn","tax_other_type_row");}else{m.animate("fadeOut","tax_other_type_row");}}});if(dojo.byId("product_category_other_code_row")&&dojo.byId("product_category_code")){if(dj.byId("product_category_code").get("value")==="OTHR"){m.animate("fadeIn","product_category_other_code_row");}else{m.animate("fadeOut","product_category_other_code_row");}}if(dojo.byId("product_characteristic_other_code_row")&&dojo.byId("product_characteristic_code")){if(dj.byId("product_characteristic_code").get("value")==="OTHR"){m.animate("fadeIn","product_characteristic_other_code_row");}else{m.animate("fadeOut","product_characteristic_other_code_row");}}if(dojo.byId("product_identifier_other_code_row")&&dojo.byId("product_identifier_code")){if(dj.byId("product_identifier_code").get("value")==="OTHR"){m.animate("fadeIn","product_identifier_other_code_row");}else{m.animate("fadeOut","product_identifier_other_code_row");}}if(dojo.byId("incoterm_other_row")&&dojo.byId("incoterm_code")){if(dj.byId("incoterm_code").get("value")==="OTHR"){m.animate("fadeIn","incoterm_other_row");}else{m.animate("fadeOut","incoterm_other_row");}}if(dojo.byId("freight_charge_other_type_row")&&dojo.byId("freight_charge_type")){if(dj.byId("freight_charge_type").get("value")==="OTHR"){m.animate("fadeIn","freight_charge_other_type_row");}else{m.animate("fadeOut","freight_charge_other_type_row");}}m.connect("freight_charge_type","onChange",function(){m.toggleFields((this.get("value")==="OTHR"),null,["freight_charge_other_type"]);if(dojo.byId("freight_charge_other_type_row")){if(this.get("value")==="OTHR"){m.animate("fadeIn","freight_charge_other_type_row");}else{m.animate("fadeOut","freight_charge_other_type_row");}}});m.connect("incoterm_code","onChange",function(){m.toggleFields((this.get("value")==="OTHR"),null,["incoterm_other"]);if(dojo.byId("incoterm_other_row")){if(this.get("value")==="OTHR"){m.animate("fadeIn","incoterm_other_row");}else{m.animate("fadeOut","incoterm_other_row");}}});m.connect("product_identifier_code","onChange",function(){m.toggleFields((this.get("value")==="OTHR"),null,["product_identifier_other_code"]);if(dojo.byId("product_identifier_other_code_row")){if(this.get("value")==="OTHR"){m.animate("fadeIn","product_identifier_other_code_row");}else{m.animate("fadeOut","product_identifier_other_code_row");}}});m.connect("product_characteristic_code","onChange",function(){m.toggleFields((this.get("value")==="OTHR"),null,["product_characteristic_other_code"]);if(dojo.byId("product_characteristic_other_code_row")){if(this.get("value")==="OTHR"){m.animate("fadeIn","product_characteristic_other_code_row");}else{m.animate("fadeOut","product_characteristic_other_code_row");}}});m.connect("product_category_code","onChange",function(){m.toggleFields((this.get("value")==="OTHR"),null,["product_category_other_code"]);if(dojo.byId("product_characteristic_other_code_row")){if(this.get("value")==="OTHR"){m.animate("fadeIn","product_category_other_code_row");}else{m.animate("fadeOut","product_category_other_code_row");}}});m.onClickCheckPaymentTerms();m.oaCommonBindEvents();},onFormLoad:function(){var _4=dj.byId("display_other_parties");if(_4){m.showHideOtherParties();misys.toggleCountryFields(false,["bill_to_country","ship_to_country","consgn_country"]);}m.toggleDisableButtons();var _5=dj.byId("issuing_bank_abbv_name");if(_5){_5.onChange();}var _6=dj.byId("issuing_bank_customer_reference");if(_6){_6.onChange();_6.set("value",_6._resetValue);}m.computePOTotalAmount();m.managePOCurrency();m.oaOnLoadActions();m.setCurrency(dj.byId("total_net_cur_code"),["total_net_amt"]);},beforeSaveValidations:function(){var _7=dj.byId("entity");if(_7&&_7.get("value")==""){return false;}else{return true;}},beforeSubmitValidations:function(){var _8=true;var _9="";var _a=dj.byId("po-payments");var _b=dj.byId("line-items");m.checkPoReferenceExists();if(dj.byId("issuer_ref_id")&&(dj.byId("issuer_ref_id").get("state")==="Error"||dj.byId("issuer_ref_id").get("value")==="")){_9+=m.getLocalization("mandatoryPOReferenceError");_8=false;}if(!_a||!_a.store||_a.store._arrayOfTopLevelItems.length<=0){_9+=m.getLocalization("mandatoryPaymentTermError");_8=false;}if(!_b||!_b.store||_b.store._arrayOfTopLevelItems.length<=0){if(_9!=""){_9+="<br>";}_9+=misys.getLocalization("mandatoryLineItemError");_8=false;}m._config.onSubmitErrorMsg=_9;return _8;}});function _3(){var _c=misys.getLocalization("resetPurchaseOrderCurrency");if(dj.byId("line-items")&&dj.byId("line-items").store&&dj.byId("line-items").store!=null&&dj.byId("line-items").store._arrayOfAllItems.length>0){for(var i=0,_d=dj.byId("line-items").store._arrayOfAllItems.length;i<_d;i++){var _e=dj.byId("line-items").store._arrayOfAllItems[i];if(_e!=null&&_e.price_cur_code!==this.get("value")){var _f=function(){if(dj.byId("line-items").grid&&dj.byId("line-items").grid.store){dj.byId("line-items").grid.store.fetch({query:{store_id:"*"},onComplete:dojo.hitch(this,function(_10,_11){d.forEach(_10,function(_12){dj.byId("line-items").grid.store.setValue(_12,"price_cur_code",dj.byId("total_cur_code").get("value"));dj.byId("line-items").grid.store.setValue(_12,"total_cur_code",dj.byId("total_cur_code").get("value"));dj.byId("line-items").grid.store.setValue(_12,"total_net_cur_code",dj.byId("total_cur_code").get("value"));if(_12.taxes&&_12.taxes.length>0){dj.byId("tax_cur_code").set("value",dj.byId("total_cur_code").get("value"));if(_12.taxes[0]._values!=""&&_12.taxes[0]._values.length>0){for(i=0;i<_12.taxes[0]._values.length;i++){_12.taxes[0]._values[i].cur_code=dj.byId("total_cur_code").get("value");}}}if(_12.adjustments&&_12.adjustments.length>0){dj.byId("adjustment_cur_code").set("value",dj.byId("total_cur_code").get("value"));if(_12.adjustments[0]._values!=""&&_12.adjustments[0]._values.length>0){for(i=0;i<_12.adjustments[0]._values.length;i++){_12.adjustments[0]._values[i].cur_code=dj.byId("total_cur_code").get("value");}}}if(_12.freight_charges&&_12.freight_charges.length>0){dj.byId("freight_charge_cur_code").set("value",dj.byId("total_cur_code").get("value"));if(_12.freight_charges[0]._values!=""&&_12.freight_charges[0]._values.length>0){for(i=0;i<_12.freight_charges[0]._values.length;i++){_12.freight_charges[0]._values[i].cur_code=dj.byId("total_cur_code").get("value");}}}},dj.byId("line-items"));})});dj.byId("line-items").grid.store.save();var _13=dj.byId("line-items");setTimeout(function(){_13.renderSections();_13.grid.render();},200);}};var _14=function(){dj.byId("total_cur_code").set("value",dj.byId("line-items").store._arrayOfAllItems[0].price_cur_code);};m.dialog.show("CONFIRMATION",_c,"","","","",_f,_14);}}}if(dj.byId("po-adjustments")&&dj.byId("po-adjustments").store&&dj.byId("po-adjustments").store!=null&&dj.byId("po-adjustments").store._arrayOfAllItems.length>0){if(dj.byId("po-adjustments").grid&&dj.byId("po-adjustments").grid.store){dj.byId("po-adjustments").grid.store.fetch({query:{store_id:"*"},onComplete:dojo.hitch(this,function(_15,_16){d.forEach(_15,function(_17){dj.byId("po-adjustments").grid.store.setValue(_17,"cur_code",dj.byId("total_cur_code").get("value"));},dj.byId("po-adjustments"));})});}}if(dj.byId("po-taxes")&&dj.byId("po-taxes").store&&dj.byId("po-taxes").store!=null&&dj.byId("po-taxes").store._arrayOfAllItems.length>0){if(dj.byId("po-taxes").grid&&dj.byId("po-taxes").grid.store){dj.byId("po-taxes").grid.store.fetch({query:{store_id:"*"},onComplete:dojo.hitch(this,function(_18,_19){d.forEach(_18,function(_1a){dj.byId("po-taxes").grid.store.setValue(_1a,"cur_code",dj.byId("total_cur_code").get("value"));},dj.byId("po-taxes"));})});}}if(dj.byId("po-freight-charges")&&dj.byId("po-freight-charges").store&&dj.byId("po-freight-charges").store!=null&&dj.byId("po-freight-charges").store._arrayOfAllItems.length>0){if(dj.byId("po-freight-charges").grid&&dj.byId("po-freight-charges").grid.store){dj.byId("po-freight-charges").grid.store.fetch({query:{store_id:"*"},onComplete:dojo.hitch(this,function(_1b,_1c){d.forEach(_1b,function(_1d){dj.byId("po-freight-charges").grid.store.setValue(_1d,"cur_code",dj.byId("total_cur_code").get("value"));},dj.byId("po-freight-charges"));})});}}if(dj.byId("po-payments")&&dj.byId("po-payments").store&&dj.byId("po-payments").store!==null&&dj.byId("po-payments").store._arrayOfAllItems.length>0&&dj.byId("po-payments").grid&&dj.byId("po-payments").grid.store){dj.byId("po-payments").grid.store.fetch({query:{store_id:"*"},onComplete:dojo.hitch(this,function(_1e,_1f){d.forEach(_1e,function(_20){var _21=dj.byId("po-payments").grid.store;var _22=dj.byId("total_cur_code")?dj.byId("total_cur_code").get("value"):"";_21.setValue(_20,"cur_code",_22);if(dijit.byId("details_pct")&&dijit.byId("details_pct").get("value")===""){var _23=dojo.currency.format(_20.amt,{currency:_22});if(null!==_23&&_23!==""){_23=_23.replace((/[^\d\.\,]/g),"");}_21.setValue(_20,"amt",_23);}},dj.byId("po-payments"));})});}};})(dojo,dijit,misys);dojo.require("misys.client.binding.openaccount.create_po_client");}