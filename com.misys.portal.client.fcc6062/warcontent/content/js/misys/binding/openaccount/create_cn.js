/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.binding.openaccount.create_cn"]){dojo._hasResource["misys.binding.openaccount.create_cn"]=true;dojo.provide("misys.binding.openaccount.create_cn");dojo.require("dojo.parser");dojo.require("dijit.layout.BorderContainer");dojo.require("misys.widget.Dialog");dojo.require("dijit.form.Button");dojo.require("dijit.form.TextBox");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.DateTextBox");dojo.require("misys.form.CurrencyTextBox");dojo.require("dijit.form.NumberTextBox");dojo.require("dijit.form.CheckBox");dojo.require("dijit.form.FilteringSelect");dojo.require("dijit.form.Form");dojo.require("dijit.layout.ContentPane");dojo.require("dijit.layout.TabContainer");dojo.require("dojo.io.iframe");dojo.require("dijit.ProgressBar");dojo.require("dojo.behavior");dojo.require("dojo.date.locale");dojo.require("dijit.Tooltip");dojo.require("misys.openaccount.FormOpenAccountEvents");dojo.require("misys.grid.DataGrid");dojo.require("misys.form.SimpleTextarea");dojo.require("misys.form.common");dojo.require("misys.form.file");dojo.require("misys.validation.common");dojo.require("misys.layout.FloatingPane");(function(d,dj,m){var _1="width:710px;height:350px;";var _2=misys.getContextualURL("/content/images/delete.png");var _3=" onClick =\"javascript:misys.deleteInvoiceRecord('";function _4(){var _5=dj.byId("fscm_programme_code")?dj.byId("fscm_programme_code").get("value"):"";if(_5===""){m.dialog.show("ERROR",m.getLocalization("selectFSCMProgrammeFirst"));return;}m.showSearchDialog("baselineCustomer","['buyer_name','buyer_abbv_name','buyer_bei', 'buyer_street_name','buyer_post_code', 'buyer_town_name','buyer_country_sub_div', 'buyer_country','buyer_account_type','buyer_account_value','fin_inst_bic','fin_inst_name','fin_inst_street_name','fin_inst_town_name','fscm_programme_01','fscm_programme_02','fscm_programme_03','fscm_programme_04','fin_inst_country_sub_div','access_opened','transaction_counterparty_email','ben_company_abbv_name']",{fscm_programme:_5},"","CN",_1,m.getLocalization("ListOfBeneficiriesTitleMessage"));};function _6(){var _7=dj.byId("fscm_programme_code")?dj.byId("fscm_programme_code").get("value"):"";if(_7===""){m.dialog.show("ERROR",m.getLocalization("selectFSCMProgrammeFirst"));return;}m.showSearchDialog("baselineCustomer","['seller_name','seller_abbv_name','seller_bei', 'seller_street_name','seller_post_code', 'seller_town_name','seller_country_sub_div', 'seller_country','seller_account_type','seller_account_value','fin_inst_bic','fin_inst_name','fin_inst_street_name','fin_inst_town_name','fscm_programme_01','fscm_programme_02','fscm_programme_03','fscm_programme_04','fin_inst_country_sub_div','access_opened','transaction_counterparty_email','ben_company_abbv_name']",{fscm_programme:_7},"","CN",_1,m.getLocalization("ListOfBeneficiriesTitleMessage"));};function _8(){var _9=["buyer_name","buyer_bei","buyer_street_name","buyer_post_code","buyer_town_name","buyer_country_sub_div","buyer_country","buyer_account_type","buyer_account_value","fin_inst_bic","fin_inst_name","fin_inst_street_name","fin_inst_town_name","fscm_programme_01","fscm_programme_02","fscm_programme_03","fscm_programme_04","fin_inst_country_sub_div","buyer_abbv_name","access_opened","transaction_counterparty_email","buyerentity"];var i=0;d.forEach(_9,function(id){field=dj.byId(id);if(field){field.set("value",_a[i++]);}else{if(id==="buyerentity"&&dj.byId("entity")){dj.byId("entity").set("value",_a[i++]);}}});};function _b(){var _c=["seller_name","seller_bei","seller_street_name","seller_post_code","seller_town_name","seller_country_sub_div","seller_country","seller_account_type","seller_account_value","fin_inst_bic","fin_inst_name","fin_inst_street_name","fin_inst_town_name","fscm_programme_01","fscm_programme_02","fscm_programme_03","fscm_programme_04","fin_inst_country_sub_div","seller_abbv_name","access_opened","transaction_counterparty_email","entity"];var i=0;d.forEach(_c,function(id){field=dj.byId(id);if(field){field.set("value",_a[i++]);}});};function _d(){var _e=dj.byId("fscm_programme_code")?dj.byId("fscm_programme_code").get("value"):"";var _f=["buyer_name","buyer_abbv_name","buyer_bei","buyer_street_name","buyer_post_code","buyer_town_name","buyer_country_sub_div","buyer_country","buyer_account_type","buyer_account_value","fin_inst_bic","fin_inst_name","fin_inst_street_name","fin_inst_town_name","fin_inst_country_sub_div","access_opened","transaction_counterparty_email","ben_company_abbv_name"];m.clearFields(_f);m.clearLinkedInvoiceGrid();if(_e!==""&&dj.byId("invoice_lookup")){dj.byId("invoice_lookup").set("disabled",false);}else{if(_e===""&&dj.byId("invoice_lookup")){dj.byId("invoice_lookup").set("disabled",true);}}};function _10(){var _11=dj.byId("fscm_programme_code")?dj.byId("fscm_programme_code").get("value"):"";var _12=dj.byId("seller_abbv_name")?dj.byId("seller_abbv_name").get("value"):"";var _13=dj.byId("buyer_abbv_name")?dj.byId("buyer_abbv_name").get("value"):"";var _14=dj.byId("cn_cur_code")?dj.byId("cn_cur_code").get("value"):"";if(_11===""){m.dialog.show("ERROR",m.getLocalization("selectFSCMProgrammeFirst"));return;}if(_13===""){m.dialog.show("ERROR",m.getLocalization("selectBuyerFirst"));return;}if(_14===""){m.dialog.show("ERROR",m.getLocalization("cnCurrencyNotEntered"));return;}m.showSearchDialog("invoice_item","['inv_ref_id', 'inv_ref','inv_curr','inv_amt']",{fscm_programme:_11,seller:_12,buyer:_13,cn_cur_code:_14},"","CN",_1,m.getLocalization("ListOfInvoicesTitleMessage"));};function _15(){var _16,_17=["buyer_name","buyer_abbv_name","buyer_bei","buyer_street_name","buyer_post_code","buyer_town_name","buyer_country_sub_div","buyer_country","buyer_account_type","buyer_account_value","buyer_abbv_name","fin_inst_bic","fin_inst_name","fin_inst_street_name","fin_inst_town_name","fscm_programme_01","fscm_programme_02","fscm_programme_03","fscm_programme_04","fin_inst_country_sub_div","access_opened","transaction_counterparty_email","ben_company_abbv_name","buyerentity"];d.forEach(_17,function(id){_16=dj.byId(id);if(_16){_16.set("value","");}});};function _18(){var _19,_1a=["seller_name","seller_abbv_name","seller_bei","seller_street_name","seller_post_code","seller_town_name","seller_country_sub_div","seller_country","seller_account_type","seller_account_value","seller_abbv_name","fin_inst_bic","fin_inst_name","fin_inst_street_name","fin_inst_town_name","fscm_programme_01","fscm_programme_02","fscm_programme_03","fscm_programme_04","fin_inst_country_sub_div","access_opened","transaction_counterparty_email","ben_company_abbv_name","entity"];d.forEach(_1a,function(id){_19=dj.byId(id);if(_19){_19.set("value","");}});};var _a=[];d.mixin(m._config,{initReAuthParams:function(){var _1b={productCode:"CN",subProductCode:"",transactionTypeCode:"01",entity:dj.byId("entity")?dj.byId("entity").get("value"):"",currency:dj.byId("cn_cur_code")?dj.byId("cn_cur_code").get("value"):"",amount:dj.byId("cn_amt")?m.trimAmount(dj.byId("cn_amt").get("value")):"",bankAbbvName:dj.byId("issuing_bank_abbv_name")?dj.byId("issuing_bank_abbv_name").get("value"):"",es_field1:"",es_field2:""};return _1b;},xmlTransform:function(xml){var _1c="<cn_tnx_record>";if(xml.indexOf(_1c)!=-1){var _1d=m._config.xmlTagName,_1e=_1d?["<",_1d,">"]:[],_1f="</cn_tnx_record>",_20="",_21=-1;_20=xml.substring(_1c.length,(xml.length-_1f.length));_1e.push(_20);if(dj.byId("gridInvoice")&&dj.byId("gridInvoice").store&&dj.byId("gridInvoice").store!==null&&dj.byId("gridInvoice").store._arrayOfAllItems.length>0){_1e.push("<invoice-items>");dj.byId("gridInvoice").store.fetch({query:{REFERENCEID:"*"},onComplete:dojo.hitch(dj.byId("gridInvoice"),function(_22,_23){dojo.forEach(_22,function(_24){_1e.push("<invoice>");_1e.push("<invoice_ref_id>",_24.REFERENCEID,"</invoice_ref_id>");_1e.push("<invoice_reference>",_24.INVOICE_REFERENCE,"</invoice_reference>");_1e.push("<invoice_currency>",_24.CURCODE,"</invoice_currency>");_1e.push("<invoice_amount>",_24.INVOICE_AMOUNT,"</invoice_amount>");_1e.push("<invoice_settlement_amt>",_24.INVOICE_SETTLEMENT_AMT,"</invoice_settlement_amt>");_1e.push("</invoice>");});})});_1e.push("</invoice-items>");}if(_1d){_1e.push("</",_1d,">");}return _1e.join("");}else{return xml;}}});d.mixin(m,{bind:function(){m.setValidation("buyer_bei",m.validateBEIFormat);m.setValidation("seller_bei",m.validateBEIFormat);m.setValidation("cn_cur_code",m.validateCurrency);m.setValidation("buyer_country",m.validateCountry);m.setValidation("seller_country",m.validateCountry);m.connect("total_net_cur_code","onChange",function(){m.setCurrency(this,["total_net_amt"]);});m.connect("invoice_lookup","onClick",_10);m.connect("fscm_programme_code","onChange",_d);m.connect("buyer_abbv_name","onChange",function(){m.clearLinkedInvoiceGrid();});m.connect("seller_abbv_name","onChange",function(){m.clearLinkedInvoiceGrid();});m.connect("cn_cur_code","onChange",function(){m.setCurrency(this,["cn_amt"]);});m.connect("issuing_bank_abbv_name","onChange",m.populateReferences);if(dj.byId("fscm_programme_code")&&dj.byId("fscm_programme_code").get("value")==="04"){m.connect("issuing_bank_customer_reference","onChange",m.setBuyerReference);}else{m.connect("issuing_bank_customer_reference","onChange",m.setSellerReference);}if(dj.byId("issuing_bank_abbv_name")){m.connect("entity","onChange",function(){dj.byId("issuing_bank_abbv_name").onChange();if(dj.byId("buyerentity")&&dj.byId("fscm_programme_code")&&dj.byId("fscm_programme_code").get("value")==="04"){dj.byId("buyerentity").set("value",dj.byId("entity").get("value"));}else{if(dj.byId("buyerentity")&&dj.byId("fscm_programme_code")&&dj.byId("fscm_programme_code").get("value")!=="04"){dj.byId("buyerentity").set("value","");}}});}var _25=m._config.productCode.toLowerCase();var _26=dj.byId("issuing_bank_customer_reference"),_27=dj.byId("issuing_bank_abbv_name"),_28;if(_26){_28=_26.value;}if(_27){_27.onChange();}if(_26){_26.onChange();_26.set("value",_28);}},fetchInvoiceRecords:function(_29,url,_2a){var _2b=_29.selection.getSelected().length;var _2c=_29.store?_29.store._arrayOfAllItems.length:0;if(_2b>0&&_2c>0){m.processInvoiceRecords(_29,_2a);}dj.byId("xhrDialog").hide();},processInvoiceRecords:function(_2d,_2e){var _2f=dj.byId("gridInvoice");var _30=new dojo.data.ItemFileWriteStore({data:{"identifier":"REFERENCEID","items":[]}});var obj=[];if(_2f&&_2f.store&&_2f.store._arrayOfTopLevelItems.length>0){_2f.store.fetch({query:{REFERENCEID:"*"},onComplete:function(_31,_32){dojo.forEach(_31,function(_33){var _34=_33.REFERENCEID.slice().toString();var _35=_33.INVOICE_REFERENCE.slice().toString();var _36=_33.CURCODE.toString();var _37=_33.INVOICE_AMOUNT.toString();var _38=_33.INVOICE_SETTLEMENT_AMT;var _39="<img src="+_2+_3+_33.REFERENCEID+"')\"/>";var _3a={"REFERENCEID":_34,"INVOICE_REFERENCE":_35,"CURCODE":_36,"INVOICE_AMOUNT":_37,"ACTION":_39,"INVOICE_SETTLEMENT_AMT":_38};_30.newItem(_3a);obj.push(_33);});}});}var _3b=_2d.selection.getSelected();if(_3b.length>0){for(var i=0;i<_3b.length;i++){var _3c=false;var _3d="";var _3e={};var _3f=_3b[i];var _40=_3f.REFERENCEID.slice().toString();var _41=_3f.INVOICE_REFERENCE.slice().toString();var _42=_3f.CURCODE.toString();var _43=_3f.INVOICE_AMOUNT.toString();var _44="<img src="+_2+_3+_3f.REFERENCEID+"')\"/>";if(obj.length>0){for(var t=0;t<obj.length;t++){if(obj[t].REFERENCEID.slice().toString()===_40.slice().toString()){_3c=true;}}if(!_3c){var j;for(j=0;dj.byId("invoiceAmt_"+j);j++){continue;}_3d=new misys.form.CurrencyTextBox({id:"invoiceAmt_"+j,name:"invoiceAmt_"+j,value:"",constraints:{min:0,max:999999999999.99},readOnly:false,selectOnClick:true});if(_2e){m.setCurrency(_2e,["invoiceAmt_"+j]);}misys.connect("invoiceAmt_"+j,"onClick",function(){var _45=this.id;dijit.byId("gridInvoice").onCellFocus=function(_46,_47){if(_46.field==="INVOICE_SETTLEMENT_AMT"){dijit.byId(_45).textbox.focus();}};});_3e={"REFERENCEID":_40,"INVOICE_REFERENCE":_41,"CURCODE":_42,"INVOICE_AMOUNT":_43,"ACTION":_44,"INVOICE_SETTLEMENT_AMT":_3d};_30.newItem(_3e);}}else{_3d=new misys.form.CurrencyTextBox({id:"invoiceAmt_"+i,name:"invoiceAmt_"+i,value:"",constraints:{min:0},readOnly:false,selectOnClick:true});if(_2e){m.setCurrency(_2e,["invoiceAmt_"+i]);}misys.connect("invoiceAmt_"+i,"onClick",function(){var _48=this.id;dijit.byId("gridInvoice").onCellFocus=function(_49,_4a){if(_49.field==="INVOICE_SETTLEMENT_AMT"){dijit.byId(_48).textbox.focus();}};});_3e={"REFERENCEID":_40,"INVOICE_REFERENCE":_41,"CURCODE":_42,"INVOICE_AMOUNT":_43,"ACTION":_44,"INVOICE_SETTLEMENT_AMT":_3d};_30.newItem(_3e);}}}_2f.setStore(_30);dojo.style(_2f.domNode,"display","");_2f.resize();},deleteInvoiceRecord:function(ref){var _4b=[];dj.byId("gridInvoice").store.fetch({query:{REFERENCEID:"*"},onComplete:dojo.hitch(dj.byId("gridInvoice"),function(_4c,_4d){dojo.forEach(_4c,function(_4e){if(_4e.REFERENCEID.slice().toString()===ref.slice().toString()){dj.byId("gridInvoice").store.deleteItem(_4e);var _4f=_4e.INVOICE_SETTLEMENT_AMT[0].id;if(dj.byId(_4f)){dj.byId(_4f).destroy(true);}}});})});dj.byId("gridInvoice").resize();},onFormLoad:function(){m._config.cnCurCode=dj.byId("cn_cur_code")?dj.byId("cn_cur_code").get("value"):"";m.setCurrency(dj.byId("cn_cur_code"),["cn_amt"]);m.setCurrency(dj.byId("total_net_cur_code"),["total_net_amt"]);if(dj.byId("fscm_programme_code")&&dj.byId("invoice_lookup")&&dj.byId("fscm_programme_code").get("value")!==""){dj.byId("invoice_lookup").set("disabled",false);}else{if(dj.byId("invoice_lookup")){dj.byId("invoice_lookup").set("disabled",true);}}var _50=dj.byId("issuing_bank_customer_reference"),_51=dj.byId("issuing_bank_abbv_name"),_52;if(_50){_52=_50.value;}if(_51){_51.onChange();}if(_50){_50.onChange();_50.set("value",_52);}var _53=dj.byId("gridInvoice");if(invoiceItems&&_53&&invoiceItems.length>0){var _54=new dojo.data.ItemFileWriteStore({data:{"identifier":"REFERENCEID","items":[]}});if(dj.byId("gridInvoice")&&invoiceItems&&invoiceItems.length>0){for(var i=0;i<invoiceItems.length;i++){var _55="";var _56=invoiceItems[i];var _57=_56.REFERENCEID.slice().toString();var _58=_56.INVOICE_REFERENCE.slice().toString();var _59=_56.CURCODE.toString();var _5a=_56.INVOICE_AMOUNT.toString();var _5b=_56.INVOICE_SETTLEMENT_AMT;if(!dj.byId("invoiceAmt_"+i)){_55=new misys.form.CurrencyTextBox({id:"invoiceAmt_"+i,name:"invoiceAmt_"+i,value:_5b,constraints:{min:0},readOnly:false,selectOnClick:true});if(dj.byId("cn_cur_code")){m.setCurrency(dj.byId("cn_cur_code"),["invoiceAmt_"+i]);}misys.connect("invoiceAmt_"+i,"onClick",function(){var _5c=this.id;dijit.byId("gridInvoice").onCellFocus=function(_5d,_5e){if(_5d.field==="INVOICE_SETTLEMENT_AMT"){dijit.byId(_5c).textbox.focus();}};});}var _5f="<img src="+_2+_3+_56.REFERENCEID+"')\"/>";dijit.byId("gridInvoice").onCellFocus=function(_60,_61){};var _62={"REFERENCEID":_57,"INVOICE_REFERENCE":_58,"CURCODE":_59,"INVOICE_AMOUNT":_5a,"ACTION":_5f,"INVOICE_SETTLEMENT_AMT":_55};_54.newItem(_62);}}_53.setStore(_54);dojo.style(_53.domNode,"display","");_53.resize();}else{if(dj.byId("gridInvoice")){dojo.style(dj.byId("gridInvoice").domNode,"display","none");}}var _63=["seller_name","seller_bei","seller_street_name","seller_post_code","seller_town_name","seller_country_sub_div","seller_country","seller_account_type","seller_account_value","seller_abbv_name","fin_inst_bic","fin_inst_name","fin_inst_street_name","fin_inst_town_name","fscm_programme_01","fscm_programme_02","fscm_programme_03","fscm_programme_04","fin_inst_country_sub_div","access_opened","transaction_counterparty_email","entity"];_a=[];d.forEach(_63,function(id){field=dj.byId(id);if(field){_a.push(field.get("value"));}});},beforeSaveValidations:function(){var _64=dj.byId("entity");if(_64&&_64.get("value")===""){return false;}else{return true;}},beforeSubmitValidations:function(){var _65=true;var _66=dj.byId("gridInvoice");var sum=0;var _67="";var _68="";var _69="";m.checkCnReferenceExists();if(dj.byId("cn_reference")&&dj.byId("cn_reference").get("state")==="Error"){_67+=m.getLocalization("mandatoryCNReferenceError");_65=false;}if(!m.validateAmount((dj.byId("cn_amt"))?dj.byId("cn_amt"):0)){m._config.onSubmitErrorMsg=m.getLocalization("amountcannotzero");dj.byId("cn_amt").set("value","");return false;}if(_66&&_66.store&&_66.store._arrayOfTopLevelItems){for(var i=0;i<_66.store._arrayOfTopLevelItems.length;i++){var _6a=dj.byId("invoiceAmt_"+i);if(_6a&&_6a.state==="Error"){_65=false;_67=m.getLocalization("focusOnErrorAlert");break;}if(_6a&&(_6a.value===null||isNaN(_6a.value))){_65=false;_6a.set("state","Error");_67=m.getLocalization("CreditNoteAmountRequired");}else{if(_6a&&parseFloat(_6a.value)<=0){_65=false;_6a.set("state","Error");_67=m.getLocalization("CreditNoteAmountZero");}else{if(_6a){sum=sum+_6a.value;if(sum>dj.byId("cn_amt").value){_65=false;_67=m.getLocalization("invoicesSumLessThanCNAmount");_6a.set("state","Error");}}else{vaid=true;_67="";}}}if(dj.byId("invoiceAmt_"+i)){var _6b=dj.byId("gridInvoice").store._arrayOfAllItems[i].INVOICE_AMOUNT[0].replaceAll(",","");var _6c=dj.byId("gridInvoice").store._arrayOfAllItems[i].REFERENCEID[0];var _6d=dj.byId("invoiceAmt_"+i).value;if(parseFloat(_6d)>parseFloat(_6b)){_65=false;_67=m.getLocalization("settlementAmountLessThanOutstandingAmount");_6a.set("state","Error");}}}if(sum<dj.byId("cn_amt").value){_69=m.getLocalization("settlementamtlessCNAmt")+"<br/>";}}if(_67!=""){m._config.onSubmitErrorMsg=_67;return _65;}else{if((_68!=""||_69!="")&&m._config.validitycheck==undefined){var _6e="";_6e=_69;m._config.holidayCutOffEnabled=true;var _6f=function(){_65=true;};var _70=function(){_65=true;m._config.validitycheck=undefined;};m.dialog.show("WARNING",_6e,"","","","",_6f,_70);_65=false;m._config.validitycheck=_65;}}return _65;}});})(dojo,dijit,misys);dojo.require("misys.client.binding.openaccount.create_cn_client");}