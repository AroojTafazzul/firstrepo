/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.binding.openaccount.create_cr"]){dojo._hasResource["misys.binding.openaccount.create_cr"]=true;dojo.provide("misys.binding.openaccount.create_cr");dojo.require("dojo.parser");dojo.require("dijit.layout.BorderContainer");dojo.require("misys.widget.Dialog");dojo.require("dijit.form.Button");dojo.require("dijit.form.TextBox");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.DateTextBox");dojo.require("misys.form.CurrencyTextBox");dojo.require("dijit.form.NumberTextBox");dojo.require("dijit.form.CheckBox");dojo.require("dijit.form.FilteringSelect");dojo.require("dijit.form.Form");dojo.require("dijit.layout.ContentPane");dojo.require("dijit.layout.TabContainer");dojo.require("dojo.io.iframe");dojo.require("dijit.ProgressBar");dojo.require("dojo.behavior");dojo.require("dojo.date.locale");dojo.require("dijit.Tooltip");dojo.require("misys.openaccount.FormOpenAccountEvents");dojo.require("misys.grid.DataGrid");dojo.require("misys.form.SimpleTextarea");dojo.require("misys.form.common");dojo.require("misys.form.file");dojo.require("misys.validation.common");dojo.require("misys.layout.FloatingPane");(function(d,dj,m){var _1="width:710px;height:350px;";var _2=misys.getContextualURL("/content/images/delete.png");var _3=" onClick =\"javascript:misys.deleteInvoiceRecord('";function _4(){var _5=dj.byId("fscm_programme_code")?dj.byId("fscm_programme_code").get("value"):"";if(_5===""){m.dialog.show("ERROR",m.getLocalization("selectFSCMProgrammeFirst"));return;}m.showSearchDialog("baselineCustomer","['buyer_name','buyer_bei', 'buyer_street_name','buyer_post_code', 'buyer_town_name','buyer_country_sub_div', 'buyer_country','buyer_account_type','buyer_account_value','fin_inst_bic','fin_inst_name','fin_inst_street_name','fin_inst_town_name','fscm_programme_01','fscm_programme_02','fscm_programme_03','fscm_programme_04','fin_inst_country_sub_div','buyer_abbv_name','access_opened','transaction_counterparty_email','ben_company_abbv_name']",{fscm_programme:_5},"","CN",_1,m.getLocalization("ListOfBeneficiriesTitleMessage"));};function _6(){var _7=dj.byId("fscm_programme_code")?dj.byId("fscm_programme_code").get("value"):"";if(_7===""){m.dialog.show("ERROR",m.getLocalization("selectFSCMProgrammeFirst"));return;}m.showSearchDialog("baselineCustomer","['seller_name','seller_bei', 'seller_street_name','seller_post_code', 'seller_town_name','seller_country_sub_div', 'seller_country','seller_account_type','seller_account_value','fin_inst_bic','fin_inst_name','fin_inst_street_name','fin_inst_town_name','fscm_programme_01','fscm_programme_02','fscm_programme_03','fscm_programme_04','fin_inst_country_sub_div','seller_abbv_name','access_opened','transaction_counterparty_email','ben_company_abbv_name']",{fscm_programme:_7},"","CN",_1,m.getLocalization("ListOfBeneficiriesTitleMessage"));};function _8(){var _9=["buyer_name","buyer_bei","buyer_street_name","buyer_post_code","buyer_town_name","buyer_country_sub_div","buyer_country","buyer_account_type","buyer_account_value","buyer_abbv_name","fin_inst_bic","fin_inst_name","fin_inst_street_name","fin_inst_town_name","fscm_programme_01","fscm_programme_02","fscm_programme_03","fscm_programme_04","fin_inst_country_sub_div","access_opened","transaction_counterparty_email"];var i=0;d.forEach(_9,function(id){field=dj.byId(id);if(field){field.set("value",_a[i++]);}});};function _b(){var _c=["seller_name","seller_bei","seller_street_name","seller_post_code","seller_town_name","seller_country_sub_div","seller_country","seller_account_type","seller_account_value","seller_abbv_name","fin_inst_bic","fin_inst_name","fin_inst_street_name","fin_inst_town_name","fscm_programme_01","fscm_programme_02","fscm_programme_03","fscm_programme_04","fin_inst_country_sub_div","access_opened","transaction_counterparty_email"];var i=0;d.forEach(_c,function(id){field=dj.byId(id);if(field){field.set("value",_a[i++]);}});};function _d(){var _e=dj.byId("fscm_programme_code")?dj.byId("fscm_programme_code").get("value"):"";m.clearLinkedInvoiceGrid();if(dj.byId("fscm_programme_code").get("value")!==""&&dj.byId("invoice_lookup")){dj.byId("invoice_lookup").set("disabled",false);}else{if(dj.byId("fscm_programme_code").get("value")===""&&dj.byId("invoice_lookup")){dj.byId("invoice_lookup").set("disabled",true);}}};function _f(){var _10=dj.byId("fscm_programme_code")?dj.byId("fscm_programme_code").get("value"):"";var _11=dj.byId("seller_abbv_name")?dj.byId("seller_abbv_name").get("value"):"";var _12=dj.byId("buyer_abbv_name")?dj.byId("buyer_abbv_name").get("value"):"";var _13=dj.byId("cn_cur_code")?dj.byId("cn_cur_code").get("value"):"";if(_10===""){m.dialog.show("ERROR",m.getLocalization("selectFSCMProgrammeFirst"));return;}if(_11===""){m.dialog.show("ERROR",m.getLocalization("selectSellerFirst"));return;}if(_13===""){m.dialog.show("ERROR",m.getLocalization("cnCurrencyNotEntered"));return;}m.showSearchDialog("invoice_item","['inv_ref_id', 'inv_ref','inv_curr','inv_amt']",{fscm_programme:_10,seller:_11,buyer:_12,cn_cur_code:_13},"","CR",_1,m.getLocalization("ListOfInvoicesTitleMessage"));};function _14(){var _15,_16=["buyer_name","buyer_bei","buyer_street_name","buyer_post_code","buyer_town_name","buyer_country_sub_div","buyer_country","buyer_account_type","buyer_account_value","buyer_abbv_name","fin_inst_bic","fin_inst_name","fin_inst_street_name","fin_inst_town_name","fscm_programme_01","fscm_programme_02","fscm_programme_03","fscm_programme_04","fin_inst_country_sub_div","access_opened","transaction_counterparty_email","ben_company_abbv_name"];d.forEach(_16,function(id){_15=dj.byId(id);if(_15){_15.set("value","");}});};function _17(){var _18,_19=["seller_name","seller_bei","seller_street_name","seller_post_code","seller_town_name","seller_country_sub_div","seller_country","seller_account_type","seller_account_value","seller_abbv_name","fin_inst_bic","fin_inst_name","fin_inst_street_name","fin_inst_town_name","fin_inst_country_sub_div","access_opened","transaction_counterparty_email","ben_company_abbv_name"];d.forEach(_19,function(id){_18=dj.byId(id);if(_18){_18.set("value","");}});};var _a=[];d.mixin(m._config,{initReAuthParams:function(){var _1a={productCode:"CR",subProductCode:"",transactionTypeCode:"01",entity:dj.byId("entity")?dj.byId("entity").get("value"):"",currency:dj.byId("cn_cur_code")?dj.byId("cn_cur_code").get("value"):"",amount:dj.byId("cn_amt")?m.trimAmount(dj.byId("cn_amt").get("value")):"",bankAbbvName:dj.byId("issuing_bank_abbv_name")?dj.byId("issuing_bank_abbv_name").get("value"):"",es_field1:"",es_field2:""};return _1a;},xmlTransform:function(xml){var _1b=m._config.xmlTagName,_1c=_1b?["<",_1b,">"]:[],_1d="<cr_tnx_record>",_1e="</cr_tnx_record>",_1f="",_20=-1;if(xml.indexOf(_1d)!==-1){_1f=xml.substring(_1d.length,(xml.length-_1e.length));_1c.push(_1f);if(dj.byId("gridInvoice")&&dj.byId("gridInvoice").store&&dj.byId("gridInvoice").store!=null&&dj.byId("gridInvoice").store._arrayOfAllItems.length>0){_1c.push("<invoice-items>");dj.byId("gridInvoice").store.fetch({query:{REFERENCEID:"*"},onComplete:dojo.hitch(dj.byId("gridInvoice"),function(_21,_22){dojo.forEach(_21,function(_23){_1c.push("<invoice>");_1c.push("<invoice_ref_id>",_23.REFERENCEID,"</invoice_ref_id>");_1c.push("<invoice_reference>",_23.INVOICE_REFERENCE,"</invoice_reference>");_1c.push("<invoice_currency>",_23.CURCODE,"</invoice_currency>");_1c.push("<invoice_amount>",_23.INVOICE_AMOUNT,"</invoice_amount>");_1c.push("<invoice_settlement_amt>",_23.INVOICE_SETTLEMENT_AMT,"</invoice_settlement_amt>");_1c.push("</invoice>");});})});_1c.push("</invoice-items>");}if(_1b){_1c.push("</",_1b,">");}return _1c.join("");}else{return xml;}}});d.mixin(m,{bind:function(){m.setValidation("buyer_bei",m.validateBEIFormat);m.setValidation("seller_bei",m.validateBEIFormat);m.setValidation("cn_cur_code",m.validateCurrency);m.setValidation("buyer_country",m.validateCountry);m.setValidation("seller_country",m.validateCountry);m.connect("total_net_cur_code","onChange",function(){m.setCurrency(this,["total_net_amt"]);});m.connect("invoice_lookup","onClick",_f);m.connect("fscm_programme_code","onChange",_d);m.connect("buyer_abbv_name","onChange",function(){m.clearLinkedInvoiceGrid();});m.connect("seller_abbv_name","onChange",function(){m.clearLinkedInvoiceGrid();});m.connect("cn_cur_code","onChange",function(){m.setCurrency(this,["cn_amt"]);});m.connect("issuing_bank_abbv_name","onChange",m.populateReferences);m.connect("issuing_bank_customer_reference","onChange",m.setBuyerReference);if(dj.byId("issuing_bank_abbv_name")){m.connect("entity","onChange",function(){dj.byId("issuing_bank_abbv_name").onChange();});}var _24=m._config.productCode.toLowerCase();var _25=dj.byId("issuing_bank_customer_reference"),_26=dj.byId("issuing_bank_abbv_name"),_27;if(_25){_27=_25.value;}if(_26){_26.onChange();}if(_25){_25.onChange();_25.set("value",_27);}},fetchInvoiceRecords:function(_28,url,_29){var _2a=_28.selection.getSelected().length;var _2b=_28.store?_28.store._arrayOfAllItems.length:0;if(_2a>0&&_2b>0){m.processInvoiceRecords(_28,_29);}dj.byId("xhrDialog").hide();},processInvoiceRecords:function(_2c,_2d){var _2e=dj.byId("gridInvoice");var _2f=new dojo.data.ItemFileWriteStore({data:{"identifier":"REFERENCEID","items":[]}});var obj=[];if(_2e&&_2e.store&&_2e.store._arrayOfTopLevelItems.length>0){_2e.store.fetch({query:{REFERENCEID:"*"},onComplete:function(_30,_31){dojo.forEach(_30,function(_32){var _33=_32.REFERENCEID.slice().toString();var _34=_32.INVOICE_REFERENCE.slice().toString();var _35=_32.CURCODE.toString();var _36=_32.INVOICE_AMOUNT.toString();var _37=_32.INVOICE_SETTLEMENT_AMT;var _38="<img src="+_2+_3+_32.REFERENCEID+"')\"/>";var _39={"REFERENCEID":_33,"INVOICE_REFERENCE":_34,"CURCODE":_35,"INVOICE_AMOUNT":_36,"ACTION":_38,"INVOICE_SETTLEMENT_AMT":_37};_2f.newItem(_39);obj.push(_32);});}});}var _3a=_2c.selection.getSelected();if(_3a.length>0){for(var i=0;i<_3a.length;i++){var _3b=false;var _3c="";var _3d={};var _3e=_3a[i];var _3f=_3e.REFERENCEID.slice().toString();var _40=_3e.INVOICE_REFERENCE.slice().toString();var _41=_3e.CURCODE.toString();var _42=_3e.INVOICE_AMOUNT.toString();var _43="<img src="+_2+_3+_3e.REFERENCEID+"')\"/>";if(obj.length>0){for(var t=0;t<obj.length;t++){if(obj[t].REFERENCEID.slice().toString()===_3f.slice().toString()){_3b=true;}}if(!_3b){var j;for(j=0;dj.byId("invoiceAmt_"+j);j++){continue;}_3c=new misys.form.CurrencyTextBox({id:"invoiceAmt_"+j,name:"invoiceAmt_"+j,value:"",constraints:{min:0},readOnly:false,selectOnClick:true});if(_2d){m.setCurrency(_2d,["invoiceAmt_"+j]);}misys.connect("invoiceAmt_"+j,"onClick",function(){dijit.byId("gridInvoice").onCellFocus=function(_44,_45){if(_44.field==="INVOICE_SETTLEMENT_AMT"){var _46=dijit.byId("gridInvoice").store._arrayOfTopLevelItems[_45].INVOICE_SETTLEMENT_AMT[0].id;dijit.byId(_46).textbox.focus();}};});_3d={"REFERENCEID":_3f,"INVOICE_REFERENCE":_40,"CURCODE":_41,"INVOICE_AMOUNT":_42,"ACTION":_43,"INVOICE_SETTLEMENT_AMT":_3c};_2f.newItem(_3d);}}else{_3c=new misys.form.CurrencyTextBox({id:"invoiceAmt_"+i,name:"invoiceAmt_"+i,value:"",constraints:{min:0},readOnly:false,selectOnClick:true});if(_2d){m.setCurrency(_2d,["invoiceAmt_"+i]);}misys.connect("invoiceAmt_"+i,"onClick",function(){dijit.byId("gridInvoice").onCellFocus=function(_47,_48){if(_47.field==="INVOICE_SETTLEMENT_AMT"){var _49=dijit.byId("gridInvoice").store._arrayOfTopLevelItems[_48].INVOICE_SETTLEMENT_AMT[0].id;dijit.byId(_49).textbox.focus();}};});_3d={"REFERENCEID":_3f,"INVOICE_REFERENCE":_40,"CURCODE":_41,"INVOICE_AMOUNT":_42,"ACTION":_43,"INVOICE_SETTLEMENT_AMT":_3c};_2f.newItem(_3d);}}}_2e.setStore(_2f);dojo.style(_2e.domNode,"display","");_2e.resize();},deleteInvoiceRecord:function(ref){var _4a=[];dj.byId("gridInvoice").store.fetch({query:{REFERENCEID:"*"},onComplete:dojo.hitch(dj.byId("gridInvoice"),function(_4b,_4c){dojo.forEach(_4b,function(_4d){if(_4d.REFERENCEID.slice().toString()===ref.slice().toString()){dj.byId("gridInvoice").store.deleteItem(_4d);var _4e=_4d.INVOICE_SETTLEMENT_AMT[0].id;if(dj.byId(_4e)){dj.byId(_4e).destroy(true);}}});})});dj.byId("gridInvoice").resize();},onFormLoad:function(){m.setCurrency(dj.byId("total_net_cur_code"),["total_net_amt"]);m.setCurrency(dj.byId("cn_cur_code"),["cn_amt"]);if(dj.byId("fscm_programme_code")&&dj.byId("invoice_lookup")&&dj.byId("fscm_programme_code").get("value")!==""){dj.byId("invoice_lookup").set("disabled",false);}else{if(dj.byId("invoice_lookup")){dj.byId("invoice_lookup").set("disabled",true);}}if(d.byId("buyerentity_row")){d.style(d.byId("buyerentity_row"),"display","none");dj.byId("buyerentity").set("required",false);}if(d.byId("entity_row")){d.style(d.byId("entity_row"),"display","inline-block");}var _4f=dj.byId("issuing_bank_customer_reference"),_50=dj.byId("issuing_bank_abbv_name"),_51;if(_4f){_51=_4f.value;}if(_50){_50.onChange();}if(_4f){_4f.onChange();_4f.set("value",_51);}var _52=dj.byId("gridInvoice");if(invoiceItems&&_52&&invoiceItems.length>0){var _53=new dojo.data.ItemFileWriteStore({data:{"identifier":"REFERENCEID","items":[]}});if(dj.byId("gridInvoice")&&invoiceItems&&invoiceItems.length>0){for(var i=0;i<invoiceItems.length;i++){var _54="";var _55=invoiceItems[i];var _56=_55.REFERENCEID.slice().toString();var _57=_55.INVOICE_REFERENCE.slice().toString();var _58=_55.CURCODE.toString();var _59=_55.INVOICE_AMOUNT.toString();var _5a=_55.INVOICE_SETTLEMENT_AMT;if(!dj.byId("invoiceAmt_"+i)){_54=new misys.form.CurrencyTextBox({id:"invoiceAmt_"+i,name:"invoiceAmt_"+i,value:_5a,constraints:{min:0},readOnly:false,selectOnClick:true});if(dj.byId("cn_cur_code")){m.setCurrency(dj.byId("cn_cur_code"),["invoiceAmt_"+i]);}misys.connect("invoiceAmt_"+i,"onClick",function(){dijit.byId("gridInvoice").onCellFocus=function(_5b,_5c){if(_5b.field==="INVOICE_SETTLEMENT_AMT"){var _5d=dijit.byId("gridInvoice").store._arrayOfTopLevelItems[_5c].INVOICE_SETTLEMENT_AMT[0].id;dijit.byId(_5d).textbox.focus();}};});}var _5e="<img src="+_2+_3+_55.REFERENCEID+"')\"/>";dijit.byId("gridInvoice").onCellFocus=function(_5f,_60){};var _61={"REFERENCEID":_56,"INVOICE_REFERENCE":_57,"CURCODE":_58,"INVOICE_AMOUNT":_59,"ACTION":_5e,"INVOICE_SETTLEMENT_AMT":_54};_53.newItem(_61);}}_52.setStore(_53);dojo.style(_52.domNode,"display","");_52.resize();}else{if(dj.byId("gridInvoice")){dojo.style(dj.byId("gridInvoice").domNode,"display","none");}}var _62=["seller_name","seller_bei","seller_street_name","seller_post_code","seller_town_name","seller_country_sub_div","seller_country","seller_account_type","seller_account_value","seller_abbv_name","fin_inst_bic","fin_inst_name","fin_inst_street_name","fin_inst_town_name","fscm_programme_01","fscm_programme_02","fscm_programme_03","fscm_programme_04","fin_inst_country_sub_div","access_opened","transaction_counterparty_email"];_a=[];d.forEach(_62,function(id){field=dj.byId(id);if(field){_a.push(field.get("value"));}});},beforeSaveValidations:function(){var _63=dj.byId("entity");if(_63&&_63.get("value")===""){return false;}else{return true;}},beforeSubmitValidations:function(){var _64=true;var _65=dj.byId("gridInvoice");var sum=0;var _66="";var _67="";var _68="";m.checkCnReferenceExists();if(dj.byId("cn_reference")&&dj.byId("cn_reference").get("state")==="Error"){_66+=m.getLocalization("mandatoryCNReferenceError");_64=false;}if(_65&&_65.store&&_65.store._arrayOfTopLevelItems){for(var i=0;i<_65.store._arrayOfTopLevelItems.length;i++){if(dj.byId("invoiceAmt_"+i)&&dj.byId("invoiceAmt_"+i).state==="Error"){_64=false;_66=m.getLocalization("focusOnErrorAlert");break;}if(dj.byId("invoiceAmt_"+i)&&(dj.byId("invoiceAmt_"+i).value===null||isNaN(dj.byId("invoiceAmt_"+i).value))){_64=false;dj.byId("invoiceAmt_"+i).set("state","Error");_66=m.getLocalization("CreditNoteAmountRequired");}else{if(dj.byId("invoiceAmt_"+i)&&(parseFloat(dj.byId("invoiceAmt_"+i).value)<=0)){_64=false;dj.byId("invoiceAmt_"+i).set("state","Error");_66=m.getLocalization("CreditNoteAmountZero");}else{if(dj.byId("invoiceAmt_"+i)){sum=sum+dj.byId("invoiceAmt_"+i).value;if(dj.byId("cn_amt")&&sum>dj.byId("cn_amt").value){_64=false;_66=m.getLocalization("invoicesSumLessThanCNAmount");}}else{_64=true;_66="";}}}if(dj.byId("invoiceAmt_"+i)){var _69=dj.byId("gridInvoice").store._arrayOfAllItems[i].INVOICE_AMOUNT[0].replaceAll(",","");var _6a=dj.byId("gridInvoice").store._arrayOfAllItems[i].REFERENCEID[0];var _6b=dj.byId("invoiceAmt_"+i).value;if(parseFloat(_6b)>parseFloat(_69)){var _6c=dj.byId("invoiceAmt_"+i);_64=false;_66=m.getLocalization("settlementAmountLessThanOutstandingAmount");_6c.set("state","Error");}}}if(sum<dj.byId("cn_amt").value){_68=m.getLocalization("settlementamtlessCNAmt")+"<br/>";}}if((_66!="")){m._config.onSubmitErrorMsg=_66;return _64;}else{if((_67!=""||_68!="")&&m._config.validitycheck==undefined){var _6d="";_6d=_68;m._config.holidayCutOffEnabled=true;var _6e=function(){_64=true;};var _6f=function(){_64=true;m._config.validitycheck=undefined;};m.dialog.show("WARNING",_6d,"","","","",_6e,_6f);_64=false;m._config.validitycheck=_64;}}return _64;}});})(dojo,dijit,misys);dojo.require("misys.client.binding.openaccount.create_cr_client");}