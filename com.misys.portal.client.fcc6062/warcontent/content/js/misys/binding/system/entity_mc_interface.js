/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.binding.system.entity_mc"]){dojo._hasResource["misys.binding.system.entity_mc"]=true;dojo.provide("misys.binding.system.entity_mc");dojo.require("dijit.form.FilteringSelect");dojo.require("dijit.layout.TabContainer");dojo.require("misys.form.MultiSelect");dojo.require("misys.form.common");dojo.require("misys.validation.common");dojo.require("dijit.form.Form");dojo.require("dijit.form.Button");dojo.require("dijit.form.TextBox");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.CheckBox");dojo.require("misys.editor.plugins.ProductFieldChoice");dojo.require("misys.form.SimpleTextarea");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("misys.grid.DataGrid");dojo.require("misys.widget.Dialog");dojo.require("dojox.xml.DomParser");dojo.require("dojox.grid.EnhancedGrid");dojo.require("dojox.grid.enhanced.plugins.DnD");dojo.require("dojox.grid.enhanced.plugins.IndirectSelection");dojo.require("dojox.collections.ArrayList");(function(d,dj,m){var _1="entity_list",_2="avail_list",_3=d.byId("entity-roles"),_4,_5,_6,_7,_8;function _9(){var _a=dj.byId("legal_id_type").getValue(),_b=dj.byId("legal_id_no").getValue(),_c=dj.byId("country_legalid").getValue(),_d=dj.byId("reference"),_e=dj.byId("name"),_f=dj.byId("second_entity_name");var _10;if(_d.value!==""){_d.set("value","");}if(_e.value!==""){_e.set("value","");}if(_f.value!=""){_f.set("value","");}m.xhrPost({url:misys.getServletURL("/screen/AjaxScreen/action/GetCompanyCIF"),handleAs:"json",sync:true,content:{legalIdType:_a,legalIdNo:_b,legalCountryNo:_c},load:function(_11,_12){switch(_11.items.StatusCode){case "0000000":if(!_11.items.CIFNo||_11.items.CIFNO===""){_10=misys.getLocalization("NoCIFFound");_d.focus();_d.set("value","");_d.set("state","Error");dj.hideTooltip(_d.domNode);dj.showTooltip(_10,_d.domNode,0);}else{_d.set("value",_11.items.CIFNo);_d.set("readOnly",true);_e.set("value",_11.items.CustomerName1);_e.set("readOnly",true);}if(_11.items.CustomerName2){_f.set("value",_11.items.AcctCur);}break;case "ERR_MQ_INTERFACE_FAILURE":_10=misys.getLocalization("CIFFetcingmqFailure");_d.focus();_d.set("value","");_d.set("state","Error");dj.hideTooltip(_d.domNode);dj.showTooltip(_10,_d.domNode,0);break;case "ERR_SAME_CIF_EXISTS":_10=misys.getLocalization("CIFAlreadyAssignedtoOtherEntity",[_11.items.CIFNo]);_d.focus();_d.set("value","");_d.set("state","Error");dj.hideTooltip(_d.domNode);dj.showTooltip(_10,_d.domNode,0);break;default:_10=_11.items.StatusCodeMessage;_d.focus();_d.set("value","");_d.set("state","Error");dj.hideTooltip(_d.domNode);dj.showTooltip(_10,_d.domNode,0);break;}},error:function(_13,_14){console.error("[] ");console.error(_13);}});};function _15(){if(dj.byId("account-interface-grid")){dj.byId("account-interface-grid").errorMessage="";}};function _16(dom,_17){var _18=dom.getElementsByTagName(_17)[0],_19=(_18)?_18.childNodes[0]:"",_1a=(_19)?_19.nodeValue.split(","):[],_1b=["<existing_roles>"];dojo.forEach(dojo.query("option",dijit.byId(_17).domNode),function(_1c){_1b.push("<roles_desc_record><role>",_1c.value,"</role></roles_desc_record>");});_1b.push("</existing_roles>");return _1b.join("");};function _1d(){var _1e=dj.byId("charging_account").get("value");if(_1e&&_1e!==""){var _1f,_20=dj.byId("entity_address_line_1"),_21=dj.byId("entity_address_line_2"),_22=dj.byId("entity_address_line_3"),_23=dj.byId("entity_address_line_4"),_24=dj.byId("entity_alternative_address_line_1"),_25=dj.byId("entity_alternative_address_line_2"),_26=dj.byId("entity_alternative_address_line_3"),_27=dj.byId("entity_alternative_address_line_4");dj.byId("accounts-grid").store.fetch({query:{store_id:"*"},onComplete:dojo.hitch(this,function(_28,_29){dojo.forEach(_28,function(_2a){var _2b=_2a["account_number"];var _2c=_2a["description"];var _2d=_2a["type"];if(_2b==_1e){_1f=_2d[0];}},this);})});m.xhrPost({url:misys.getServletURL("/screen/AjaxScreen/action/GetChargingAccountAddrDetails"),handleAs:"json",sync:true,content:{chargingAccountNo:_1e,chargingAccountType:_1f},load:function(_2e,_2f){switch(_2e.items.StatusCode){case "0000000":if(!_2e.items.address_line_1||_2e.items.address_line_1===""){displayMessage=misys.getLocalization("NoAddressFound");reference_field.focus();_20.set("value","");_20.set("state","Error");dj.hideTooltip(_20.domNode);dj.showTooltip(displayMessage,_20.domNode,0);}else{_20.set("value",_2e.items.address_line_1);_20.set("readOnly",true);_21.set("value",_2e.items.address_line_2);_21.set("readOnly",true);_22.set("value",_2e.items.address_line_3);_22.set("readOnly",true);if(_2e.items.address_line_4){_23.set("value",_2e.items.address_line_4);_23.set("readOnly",true);}_24.set("readOnly",false);_25.set("readOnly",false);_26.set("readOnly",false);if(_2e.items.address_line_4){_27.set("readOnly",false);}}break;case "ERR_MQ_INTERFACE_FAILURE":displayMessage=misys.getLocalization("AddressFetcingmqFailure");_20.focus();_20.set("value","");_20.set("state","Error");dj.hideTooltip(_20.domNode);dj.showTooltip(displayMessage,_20.domNode,0);break;default:displayMessage=_2e.items.StatusCodeMessage;_20.focus();_20.set("value","");_20.set("state","Error");dj.hideTooltip(_20.domNode);dj.showTooltip(displayMessage,_20.domNode,0);break;}},error:function(_30,_31){console.error("[] ");console.error(_30);}});}};function _32(){var _33=dj.byId("subscription_package");m.xhrPost({url:misys.getServletURL("/screen/AjaxScreen/action/GetSubscriptionPackageDetails"),handleAs:"json",sync:true,content:{packageIdValue:_33.get("value")},load:function(_34,_35){var _36=_34.packageDetails;dj.byId("stnd_charge_cur_code").setValue(_36[0]);dj.byId("stnd_charge_amt").setValue(_36[1]);_4=_36[2];_8=_36[3];_39();},error:function(_37,_38){console.error("[Couldnot Get Subscription Package Details] "+_33.get("value"));console.error(_37);}});};function _39(){if(dj.byId("charging_account")){var _3a=dj.byId("charging_account"),_3b="",_3c=dj.byId("stnd_charge_cur_code").get("value"),_3d=dj.byId("charging_account").value;if(dj.byId("accounts-grid")){dj.byId("accounts-grid").store.fetch({query:{store_id:"*"},onComplete:dojo.hitch(this,function(_3e,_3f){dojo.forEach(_3e,function(_40){var _41=_40["account_number"][0];var _42=_40["description"][0];var ccy=_40["ccy"][0];if(_41==_3d){_3b=ccy;}},this);})});}if(_3b!==_3c){dj.byId("special_charge_cur_code").set("required",true);dj.byId("special_charge_amt").set("required",true);}else{dj.byId("special_charge_cur_code").set("required",false);dj.byId("special_charge_amt").set("required",false);}}};function _43(_44){while(_44.hasChildNodes()){_44.removeChild(_44.lastChild);}};function _45(){var _46=dj.byId("entity_avail_list_nosend"),_47=dj.byId("entity_role_list");_5=new dojox.collections.ArrayList();_6=new dojox.collections.ArrayList();_7=new dojox.collections.ArrayList();dojo.query("option",_46.containerNode).forEach(function(n){_5.add(n);_6.add(n);});dojo.query("option",_47.containerNode).forEach(function(n){_5.add(n);_7.add(n);});};function _48(){var _49=dj.byId("entity_avail_list_nosend"),_4a=_4b();_43(dojo.byId("entity_avail_list_nosend"));_5.forEach(function(_4c){if(!_4a.contains(_4c.value)){_49.containerNode.appendChild(_4c);}},_5);};function _4d(){var _4e=dj.byId("entity_avail_list_nosend"),_4f=dj.byId("entity_role_list"),_50=_4b();_43(dojo.byId("entity_avail_list_nosend"));_43(dojo.byId("entity_role_list"));_6.forEach(function(_51){if(!_50.contains(_51.value)){_4e.containerNode.appendChild(_51);}},_6);_7.forEach(function(_52){if(!_50.contains(_52.value)){_4f.containerNode.appendChild(_52);}},_7);};function _4b(){var _53=new dojox.collections.ArrayList();for(var i=0;i<_8.length;i++){_53.add(_8[i]);}return _53;};function _54(){var _55=["name","second_entity_name","reference","description"];d.forEach(_55,function(_56){var _57=dj.byId(_56);if(_57){_57.set("value","");}});var _58=dj.byId("abbv_name");if(_58&&!_58.get("readOnly")){_58.set("value","");}_59();};function _59(){var _5a={items:[]},_5b;if(dj.byId("accounts-grid")){_5b=new dojo.data.ItemFileReadStore({data:_5a});dj.byId("accounts-grid").setStore(_5b);dj.byId("accounts-grid")._refresh();}if(dj.byId("charging_account")){_5b=new dojo.data.ItemFileReadStore({data:_5a});dj.byId("charging_account").set("value","");dj.byId("charging_account").store=_5b;}};function _5c(){var _5d=[{"name":"Ccy","field":"ccy","width":"10%"},{"name":"Account Number","field":"account_number","width":"15%"},{"name":"Account Type","field":"type","width":"15%"},{"name":"Product Type","field":"account_product_type","width":"15%"},{"name":"Description","field":"description","width":"25%"},{"name":"NRA Flag","field":"nra","width":"7%"},{"name":"Existing BIB Account","field":"existing_bib_account","width":"7%"}];var _5e=new dojox.grid.EnhancedGrid({id:"account-interface-grid",structure:_5d,rowSelector:"0px",autoHeight:10,rowsPerPage:"10",plugins:{dnd:true,indirectSelection:{width:"3%",styles:"text-align: center;"}}},dojo.create("div",{style:"position: relative;"}));d.place(_5e.domNode,"dialog-buttons","before");};d.mixin(m,{bind:function(){m.setValidation("bei",m.validateBEIFormat);m.setValidation("abbv_name",m.validateCharacters);m.setValidation("country_legalid",m.validateCountry);m.setValidation("entity_country",m.validateCountry);m.connect("add","onClick",function(){m.addMultiSelectItems(dijit.byId("entity_list"),dijit.byId("avail_list"));});m.connect("remove","onClick",function(){m.addMultiSelectItems(dijit.byId("avail_list"),dijit.byId("entity_list"));});m.connect("charging_account","onChange",_1d);m.connect("charging_account","onChange",_39);m.connect("subscription_package","onChange",function(){_43(dojo.byId("entity_role_list"));_32();_48();});m.connect("reference","onChange",_59);m.connect("legal_id_type","onChange",_54);m.connect("legal_id_no","onChange",_54);m.connect("country_legalid","onChange",_54);m.connect("enable_additional_role","onChange",function(){if(dj.byId("enable_additional_role").get("checked")){m.animate("fadeIn",_3);}else{m.animate("fadeOut",_3);}});m.connect("personal","onChange",function(){if(!dj.byId("personal").get("checked")){dj.byId("legal_id_type").set("value","");dj.byId("legal_id_no").set("value","");dj.byId("country_legalid").set("value","");}});m.setValidation("account_ccy_cur_code",m.validateCurrency);m.setValidation("special_charge_cur_code",m.validateCurrency);m.setValidation("stnd_charge_cur_code",m.validateCurrency);m.connect("subscription_package","onMouseOver",function(){var _5f=dj.byId("subscription_package");if(_4){m.showTooltip(_4,_5f.domNode,10);}});m.setValidation("email",m.validateEmailAddr);m.connect("special_charge_cur_code","onChange",function(){var _60=this.get("value"),_61=dj.byId("charging_account"),_62=dj.byId("charging_account").get("value"),_63;m.setCurrency(this,["special_charge_amt"]);if(dj.byId("accounts-grid")&&dj.byId("accounts-grid").store){dj.byId("accounts-grid").store.fetch({query:{store_id:"*"},onComplete:dojo.hitch(this,function(_64,_65){dojo.forEach(_64,function(_66){var _67=_66["account_number"];var _68=_66["description"];var ccy=_66["ccy"];if(_67==_62){_63=ccy[0];}},this);})});if(_63!==_60){var _69=m.getLocalization("invalidSpecialChargeCurrency"),_6a=dj.byId("special_charge_cur_code");_6a.focus();_6a.set("state","Error");dijit.hideTooltip(_6a.domNode);dijit.showTooltip(_69,_6a.domNode,0);}}});m.connect("stnd_charge_cur_code","onChange",function(){m.setCurrency(this,["stnd_charge_amt"]);});var _6b=dj.byId("total_value_added_services");if(_6b){for(var i=1;i<=_6b.get("value");i++){(function(_6c){m.setValidation("service_stnd_charge_"+_6c+"_cur_code",m.validateCurrency);m.setValidation("service_special_chge_"+_6c+"_cur_code",m.validateCurrency);m.connect("service_stnd_charge_"+_6c+"_cur_code","onChange",function(){m.setCurrency(this,["service_stnd_amt_"+_6c]);});m.connect("service_special_chge_"+_6c+"_cur_code","onChange",function(){m.setCurrency(this,["service_special_amt_"+_6c]);});})(i);}}m.setValidation("abbv_name",m.validateCharactersExcludeSpace);m.connect("abbv_name","onKeyPress",function(e){if(e.keyCode===32||e.charCode===32){dojo.stopEvent(e);}});},onFormLoad:function(){dj.byId("entity_address_line_1").set("readonly",true);dj.byId("entity_address_line_2").set("readonly",true);dj.byId("entity_address_line_3").set("readonly",true);dj.byId("entity_address_line_4").set("readonly",true);dj.byId("entity_alternative_address_line_1").set("readonly",false);dj.byId("entity_alternative_address_line_2").set("readonly",false);dj.byId("entity_alternative_address_line_3").set("readonly",false);dj.byId("entity_alternative_address_line_4").set("readonly",false);dj.byId("reference").set("readOnly",true);dj.byId("name").set("readOnly",true);dj.byId("second_entity_name").set("readOnly",true);var _6d=dj.byId("total_value_added_services");if(_6d){for(var i=1;i<=_6d.get("value");i++){m.setCurrency(dj.byId("service_stnd_charge_"+i+"_cur_code"),["service_stnd_amt_"+i]);m.setCurrency(dj.byId("service_special_chge_"+i+"_cur_code"),["service_special_amt_"+i]);}}m.setCurrency(dj.byId("stnd_charge_cur_code"),["stnd_charge_amt"]);m.setCurrency(dj.byId("special_charge_cur_code"),["special_charge_amt"]);_5c();_45();_32();_4d();}});m._config=m._config||{};d.mixin(m._config,{xmlTransform:function(xml){var _6e=[dj.byId("entity_list"),dj.byId("avail_list")],_6f=xml.indexOf("<"+_1+">"),_70=xml.indexOf("<"+_2+">"),_71=(_6f!==-1)?xml.substring(_6f+_1.length+2,xml.indexOf("</"+_1+">")).split(","):[],_72=(_70!==-1)?xml.substring(_70+_2.length+2,xml.indexOf("</"+_2+">")).split(","):[],_73=[],_74=[],_75=[],_76=dj.byId("total_value_added_services").value,dom=dojox.xml.DomParser.parse(xml);_75.push("<entity>");if(xml.indexOf("<"+"entity"+">")!==-1){_75.push(xml.substring(xml.indexOf("<"+"entity"+">")+8,xml.indexOf("</"+"entity"+">")));}for(var i=1;i<=_76;i++){if(dj.byId("select_service_"+i).get("checked")){_75.push("<value_added_services_"+i+">");_75.push(m.getDomNode(dom,"sevice_name_"+i));_75.push(m.getDomNode(dom,"service_std_chge_ccy_"+i));_75.push(m.getDomNode(dom,"service_stnd_charge_"+i));_75.push(m.getDomNode(dom,"service_chge_"+i+"_cur_code"));_75.push(m.getDomNode(dom,"service_special_charge_"+i));_75.push(m.getDomNode(dom,"service_special_charge_expiry_"+i));_75.push(m.getDomNode(dom,"service_subscription_waive_"+i));_75.push(m.getDomNode(dom,"service_waive_expiry_date"+i));_75.push(m.getDomNode(dom,"service_local_tax_"+i));_75.push("</value_added_services_"+i+">");}}_75.push("<references>");_75.push(m.getDomNode(dom,"reference"));_75.push(m.getDomNode(dom,"description"));_75.push("</references>");if(dj.byId("enable_additional_role")){if(dj.byId("enable_additional_role").get("checked")){if(dom.getElementsByTagName("entity_role_list").length>0){_75.push(_16(dom,"entity_role_list"));}}}_75.push("</entity>");return _75.join("");}});d.mixin(m,{getCIFDetails:function(cif){var _77=dijit.byId("legal_id_type").getValue(),_78=dijit.byId("legal_id_no").getValue(),_79=dijit.byId("country_legalid").getValue();if(_77===""){dijit.byId("legal_id_type").set("state","Error");}if(_78===""){dijit.byId("legal_id_no").set("state","Error");}if(_79===""){dijit.byId("legal_id_country").set("state","Error");}_9();},fncValidateAccountPopup:function(){dj.byId("accountOkButton").set("disabled",true);var _7a=["account_number"];var _7b=dojo.every(_7a,function(id){var _7c=dj.byId(id);if(_7c){var _7d=_7c.get("value");if(_7d===""||_7c.state==="Error"){misys.showTooltip(misys.getLocalization("mandatoryFieldsError"),_7c.domNode,["above","before"]);_7c.state="Error";_7c._setStateClass();dijit.setWaiState(_7c.focusNode,"invalid","true");return false;}}return true;});dj.byId("accountOkButton").set("disabled",false);dj.byId("account-dialog-template").gridMultipleItemsWidget.updateData();dj.byId("accounts").dialog.hide();return true;},fncUpdateNickName:function(){var _7e=dj.byId("nickname");if(_7e){var _7f=_7e.get("value");if(_7f===""||_7e.state==="Error"){misys.showTooltip(misys.getLocalization("mandatoryFieldsError"),_7e.domNode,["above","before"]);_7e.state="Error";_7e._setStateClass();dijit.setWaiState(_7e.focusNode,"invalid","true");return;}}dj.byId("edit-account-dialog-template").gridMultipleItemsWidget.updateAccountNickName();dj.byId("accounts").dialog.hide();}});d.ready(function(){d.require("misys.system.widget.MultipleAccountGrid");d.require("misys.system.widget.Account");});})(dojo,dijit,misys);dojo.require("misys.client.binding.system.entity_mc_interface_client");}