/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.binding.system.external_account_mc"]){dojo._hasResource["misys.binding.system.external_account_mc"]=true;dojo.provide("misys.binding.system.external_account_mc");dojo.require("dojo.data.ItemFileReadStore");dojo.require("dijit.form.FilteringSelect");dojo.require("misys.form.CurrencyTextBox");dojo.require("dijit.form.Form");dojo.require("dijit.form.Button");dojo.require("dijit.form.TextBox");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.CheckBox");dojo.require("misys.form.common");dojo.require("misys.validation.common");dojo.require("misys.form.addons");(function(d,dj,m){function _1(){var _2=0;for(var i=0;i<m._config.user_entity_accounts_record_count;i++){var _3=m._config.entityIdArray[i];if(dj.byId("entity_"+_3)&&dj.byId("entity_"+_3).get("checked")){_2++;}}if(_2===m._config.user_entity_accounts_record_count&&dj.byId("entity_select_all")){dj.byId("entity_select_all").set("checked",true);}else{if(_2!==m._config.user_entity_accounts_record_count&&dj.byId("entity_select_all")&&dj.byId("entity_select_all").get("checked")===true){dj.byId("entity_select_all").set("checked",false);}}};function _4(){var _5=dj.byId("account_no");var _6=dj.byId("alternative_acct_no");var _7=2000;var _8=function(){dj.hideTooltip(_6.domNode);};if(_6.get("value")===""&&_5.get("value")===""){}else{if(_6.get("value")===_5.get("value")){displayMessage=m.getLocalization("duplicateAlternativeAccNo");_6.set("value","");_6.set("state","Error");dj.hideTooltip(_6.domNode);dj.showTooltip(displayMessage,_6.domNode,0);setTimeout(_8,_7);}}};d.mixin(m,{_submit:m.submit,bind:function(){m.setValidation("account_cur_code",m.validateCurrency);misys.setValidation("ccy",misys.validateCurrency);m.setValidation("bank_iso_code",m.validateBICFormat);m.connect("bank_iso_code","onChange",_9);m.connect("entity_select_all","onChange",function(){if(dj.byId("entity_select_all")&&dj.byId("entity_select_all").get("checked")){for(i=0;i<m._config.user_entity_accounts_record_count;i++){entityId=m._config.entityIdArray[i];if(dj.byId("entity_"+entityId)&&dj.byId("entity_"+entityId).get("disabled")===false){dj.byId("entity_"+entityId).set("checked",true);}}}else{if(dj.byId("entity_select_all")&&dj.byId("entity_select_all").get("checked")===false){var _a=0;for(i=0;i<m._config.user_entity_accounts_record_count;i++){entityId=m._config.entityIdArray[i];if(dj.byId("entity_"+entityId)&&dj.byId("entity_"+entityId).get("checked")){_a++;}}if(_a===m._config.user_entity_accounts_record_count){for(i=0;i<m._config.user_entity_accounts_record_count;i++){entityId=m._config.entityIdArray[i];if(dj.byId("entity_"+entityId)){dj.byId("entity_"+entityId).set("checked",false);}}}else{_1();}}}});m.connect("alternative_acct_no","onBlur",_4);m.connect("account_no","onBlur",_4);},onFormLoad:function(){m.setSwiftBankDetailsForOnBlurEvent(false,"bank_iso_code","",null,null,"bank_",true,true,true,"");var _b=["bank_iso_code","bank_name","bank_address_line_1","bank_address_line_2","bank_dom","bank_country"];_c(_b,true,false);if(m._config.user_entity_accounts_record_count){_1();var _d=true;for(var i=0;i<m._config.user_entity_accounts_record_count;i++){var _e=m._config.entityIdArray[i];if(dj.byId("entity_"+_e)&&!dj.byId("entity_"+_e).get("checked")&&!dj.byId("entity_"+_e).get("disabled")){_d=false;}m.connect(dj.byId("entity_"+_e),"onChange",function(){_1();});}if(_d){if(dj.byId("entity_select_all")){dj.byId("entity_select_all").set("checked",true);}}}if(dj.byId("account_no")&&dj.byId("description")&&dj.byId("account_no").get("value")===""){dj.byId("description").set("value","");}if((dj.byId("external_acc_reference_val")&&dj.byId("external_acc_reference_val").get("value")!=="")&&(dj.byId("external_acc_reference")&&dj.byId("external_acc_reference").get("displayedValue")==="")){dj.byId("external_acc_reference").set("displayedValue",dj.byId("external_acc_reference_val").get("value"));}},beforeSubmitValidations:function(){var _f=true;if(dj.byId("format")&&dj.byId("format").value==="02"){_f=_10();}return _f;},beforeSaveValidations:function(){var _11=dijit.byId("account_no").get("value");if(!(_11.length>0)){m._config.onSubmitErrorMsg=m.getLocalization("externalAccount_noEmptyError");dijit.byId("account_no").focus();return false;}else{return true;}},submit:function(_12){var _13="";for(i=0;i<m._config.user_entity_accounts_record_count;i++){entityId=m._config.entityIdArray[i];if(dj.byId("entity_"+entityId)&&dj.byId("entity_"+entityId).get("checked")===true){if(i===0&&m._config.entityIdNmArray&&m._config.entityIdNmArray[0]&&m._config.entityIdNmArray[0][entityId]){_13=m._config.entityIdNmArray[0][entityId];}else{if(m._config.entityIdNmArray&&m._config.entityIdNmArray[0]&&m._config.entityIdNmArray[0][entityId]){_13=_13+":"+m._config.entityIdNmArray[0][entityId];}}}}if(_13===""){dj.byId("url_parameter_entity").set("disabled",true);dj.byId("url_parameter_entity").set("value",_13);}else{dj.byId("url_parameter_entity").set("value",_13);}m._submit(_12);},setExecuteClientPassBack:function(_14){m._config.executeClientPassBack=_14;m.disconnect(m._config.clearbankFieldsHandle);m._config.bankIsoCodeOnBlur=false;}});d.mixin(m._config,{passBack:function(_15,_16,_17){if(m._config.executeClientPassBack){var _18=["bank_iso_code","bank_name","bank_address_line_1","bank_address_line_2","bank_dom","bank_country"];_c(_18,true,false);}}});function _c(_19,_1a,_1b){d.forEach(_19,function(_1c){var _1d=dj.byId(_1c);if(_1d){_1d.set("readOnly",_1a);if(_1b){_1d.set("value","");}}});};function _9(){m.setSwiftBankDetailsForOnBlurEvent(false,"bank_iso_code","",null,null,"bank_",true,true,true,"");};function _10(){var _1e=dj.byId("bank_country").get("value");var _1f=dj.byId("account_cur_code").get("value");var _20=dj.byId("account_no").get("value");var _21=dj.byId("alternative_acct_no").get("value");var _22=true;var _23=true;var _24=true;if(_1e!==""&&_1f!==""&&_20!==""){var _25=dj.byId("includedIBANProducts")?dj.byId("includedIBANProducts").get("value"):"";var _26=dj.byId("product_type")?dj.byId("product_type").get("value"):"";var _27=new RegExp(misys._config.ibanAccountValidationRegex);_22=misys._config.ibanAccountValidationEnabled==="true"?_27.test(_20):true;_23=misys._config.ibanAccountValidationEnabled==="true"?_27.test(_21):true;if(dj.byId("format").value==="02"){m.xhrPost({url:m.getServletURL("/screen/AjaxScreen/action/IBANValidationAction"),sync:true,handleAs:"json",content:{COUNTRY:_1e,CURRENCY:_1f,ACCOUNT_NO:_20},load:function(_28,_29){_24=_28.responseFlag;},error:function(_2a,_2b){console.error("[misys.grid._base] IBAN Validation error",_2a);}});}if(!(_22&&_24)){if(_20){_20=_20.replace(/</g,"&lt;");_20=_20.replace(/>/g,"&gt;");}m._config.onSubmitErrorMsg=m.getLocalization("invalidIBANAccNoError",[_20]);return false;}if(!(_23&&_24)){if(_21){_21=_21.replace(/</g,"&lt;");_21=_21.replace(/>/g,"&gt;");}m._config.onSubmitErrorMsg=m.getLocalization("invalidIBANAlterAccNoError",[_21]);return false;}}return _24;};})(dojo,dijit,misys);dojo.require("misys.client.binding.system.external_account_mc_client");}