/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.binding.system.facility"]){dojo._hasResource["misys.binding.system.facility"]=true;dojo.provide("misys.binding.system.facility");dojo.require("dojo.data.ItemFileReadStore");dojo.require("dijit.form.FilteringSelect");dojo.require("dijit.layout.TabContainer");dojo.require("misys.validation.login");dojo.require("misys.validation.password");dojo.require("misys.form.common");dojo.require("misys.form.addons");dojo.require("misys.validation.common");dojo.require("dijit.form.Form");dojo.require("dijit.form.Button");dojo.require("dijit.form.TextBox");dojo.require("dijit.form.NumberTextBox");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.CheckBox");dojo.require("misys.form.SimpleTextarea");dojo.require("dijit.layout.ContentPane");dojo.require("misys.form.MultiSelect");dojo.require("dojox.xml.DomParser");dojo.require("misys.form.CurrencyTextBox");dojo.require("dijit.form.RadioButton");dojo.require("misys.system.widget.LimitDetails");dojo.require("misys.system.widget.LimitDetail");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("dijit.Editor");dojo.require("misys.grid.DataGrid");dojo.require("misys.form.static_document");dojo.require("dojox.lang.aspect");(function(d,dj,m){function _1(){var _2=dj.byId("limit_review_date");var _3=new Date();var _4=dj.form.DateTextBox("");_3.setHours(0,0,0,0);_4.setValue(_3);var _5=dj.byId("review_date");if(!(m.compareDateFields(_4,_5))){dj.byId("limit_review_date").set("disabled",true);}if(!(m.compareDateFields(_4,_2))){_2.invalidMessage=misys.getLocalization("limitDateSmallerThanCurrentDate");return false;}if(_5){if(!(m.compareDateFields(_2,_5))){_2.invalidMessage=misys.getLocalization("limitDateError");return false;}}return true;};function _6(){var _7=dj.byId("limit_defn_grid");var _8=dj.byId("limit_ref");var _9=true;if(_7!=null&&_7.store!=null&&_7.store._arrayOfTopLevelItems.length>0){if(_8){_7.store.fetch({query:{store_id:"*"},onComplete:function(_a,_b){dojo.forEach(_a,function(_c){if(misys._config.storeId!==_c.store_id[0]){var _d=_c.limit_ref[0];if(_d===_8.getValue()){_8.invalidMessage=misys.getLocalization("LimitRefExists");_9=false;}}});}});}if(!_9){return _9;}return _9;}return true;};function _e(){var _f=dj.byId("limit_defn_grid");var _10=dj.byId("review_date");var _11=true;var _12=new Date();var _13=dj.form.DateTextBox("");_12.setHours(0,0,0,0);_13.setValue(_12);if(!(m.compareDateFields(_13,_10))){_10.invalidMessage=misys.getLocalization("reviewDateSmallerThanCurrentDate");return false;}if(_f!=null&&_f.store!=null&&_f.store._arrayOfTopLevelItems.length>0){if(_10){_f.store.fetch({query:{store_id:"*"},onComplete:function(_14,_15){dojo.forEach(_14,function(_16){var _17=d.date.locale.parse(_16.limit_review_date[0],{datePattern:"dd/MM/yyyy",selector:"date"});var _18=dj.form.DateTextBox("");_18.setValue(_17);if(!(m.compareDateFields(_18,_10))){_10.invalidMessage=misys.getLocalization("reviewDateError");_11=false;}});}});}if(!_11){return _11;}return _11;}return true;};function _19(){var _1a=dj.byId("limit_defn_grid");var _1b=function(){if(dj.byId("entity_avail_list_facility")){entityAvailWidget=dj.byId("entity_avail_list_facility");entitySelectWidget=dj.byId("entity_select_list_facility");if(entityAvailWidget&&entitySelectWidget){entityAvailWidget.domNode.innerHTML="";entitySelectWidget.domNode.innerHTML="";}}};var _1c=function _boRefChange(){var _1d=dj.byId("limit_defn_grid");if(_1d){_1d.gridMultipleItemsWidget.clear();}var _1e=dj.byId("bo_reference");_1b();if(dj.byId("bo_reference")){dj.byId("bo_reference").attr("displayedValue","",false);dj.byId("bo_reference").attr("value","",false);_1f();}};if(_1a!=null&&_1a.store!=null&&_1a.store._arrayOfTopLevelItems.length>0){m.dialog.show("CONFIRMATION",m.getLocalization("deleteLimitsOnAbbvNameChange"),"",null,null,"",_1c,function(){dj.byId("bank_abbv_name").attr("value",dj.byId("bank_abbv_name").oldValue,false);dj.byId("bank_abbv_name").attr("displayedValue",dj.byId("bank_abbv_name").oldValue,false);});}else{_1b();if(dj.byId("bo_reference")){dj.byId("bo_reference").attr("displayedValue","",false);dj.byId("bo_reference").attr("value","",false);_1f();}}};function _20(){var _21=dj.byId("limit_defn_grid");var _22=function(){if(dj.byId("entity_avail_list_facility")){entityAvailWidget=dj.byId("entity_avail_list_facility");entitySelectWidget=dj.byId("entity_select_list_facility");if(entityAvailWidget&&entitySelectWidget){entityAvailWidget.domNode.innerHTML="";entitySelectWidget.domNode.innerHTML="";}}};var _23=function _boRefChange(){var _24=dj.byId("limit_defn_grid");if(_24){_24.gridMultipleItemsWidget.clear();}var _25=dj.byId("bo_reference");_22();_26();};if(_21!=null&&_21.store!=null&&_21.store._arrayOfTopLevelItems.length>0){m.dialog.show("CONFIRMATION",m.getLocalization("deleteLimitsOnRefChange"),"",null,null,"",_23,function(){dj.byId("bo_reference").attr("value",dj.byId("bo_reference").oldValue,false);});}else{_22();_26();}};function _27(){var _28=dj.byId("limit_defn_grid");var _29=dj.byId("entity_select_list_facility");var _2a=true;if(_28!=null&&_28.store!=null&&_28.store._arrayOfTopLevelItems.length>0){if(_29){var _2b=_29.getSelected();for(var i=0;i<_2b.length;i++){var _2c=_2b[i].value;_28.store.fetch({query:{store_id:"*"},onComplete:function(_2d,_2e){dojo.forEach(_2d,function(_2f){var _30=_2f.entity_select_list_limit[0],_31=_30.split(",");if(_31.indexOf(_2c)>=0){_2a=false;}});}});if(!_2a){break;}}if(!_2a){var _32=misys.getLocalization("entityValidationError");var _33=function(){dj.hideTooltip(dj.byId("removeFacilityEntityButton").domNode);};dj.showTooltip(_32,dj.byId("removeFacilityEntityButton").domNode,0);setTimeout(_33,2000);return;}}}m.addMultiSelectItems(dijit.byId("entity_avail_list_facility"),dijit.byId("entity_select_list_facility"));};function _1f(){var _34=dj.byId("bank_abbv_name").get("value"),_35=dj.byId("bo_reference"),_36=m._config.custRefCollection[_34];if(_36){_35.store=new dojo.data.ItemFileReadStore({data:{identifier:"value",label:"name",items:_36}});_35.fetchProperties={sort:[{attribute:"name"}]};}};function _26(){var _37=dj.byId("bo_reference"),_38=dj.byId("entity_avail_list_facility");if(_37&&_37.get("value")!=""){var _39=m._config.entityCollection[_37];if(_39){for(var i=0;i<_39.length;i++){var op=dojo.create("option");op.innerHTML=_39[i].name;op.value=_39[i].value;_38.domNode.appendChild(op);}}}};function _3a(){var _3b=dojo.byId("accDiv"),_3c=m.isVisible(_3b);var _3d=dj.byId("product_code")?dj.byId("product_code").get("value"):"";var _3e=dj.byId("sub_product_code")?dj.byId("sub_product_code").get("value"):"";if(_3d==="SE"||(_3d==="FT"&&!(_3e==="TINT"||_3e==="TTPT"))||_3d==="BK"||_3d==="TD"){m.animate("wipeIn",_3b);if(m._config.company_type==="03"){m.toggleRequired("account_no",true);}}else{if(_3c){m.animate("wipeOut",_3b);if(m._config.company_type==="03"){m.toggleRequired("account_no",false);}}}};function _3f(){var _40=dj.byId("product_code").get("value"),_41=dj.byId("product_type_code"),_42=(_40==="*")?"ALL":_40,_43=m._config.productTypeCodeList[_42],_44=dj.byId("product_type_code_hidden").get("value");if(_43){_41.store=new dojo.data.ItemFileReadStore({data:{identifier:"value",label:"name",items:_43}});_41.fetchProperties={sort:[{attribute:"value"}]};m.animate("wipeIn",d.byId("productTypeDiv"));if(!misys.dialog.isActive){var _45=dj.byId("limit_defn_grid");if(_45!=null&&_45.store!=null&&_45.store._arrayOfTopLevelItems.length>0){_45.store.fetch({query:{store_id:misys._config.storeId},onComplete:function(_46,_47){dojo.forEach(_46,function(_48){_41.set("value",_48.product_type_code[0]);});}});}}else{_41.attr("value","");}}else{m.animate("wipeOut",d.byId("productTypeDiv"));_41.set("value","");}};function _49(){var _4a=dj.byId("product_type_code").get("value"),_4b=dj.byId("sub_product_code").get("value"),_4c=dj.byId("product_code").get("value"),_4d=dj.byId("product_template"),_4e=dj.byId("bank_abbv_name").get("value"),_4f=dj.byId("product_template_hidden").get("value"),_50=dj.byId("entity_select_list_limit"),_51=m._config.guaranteeTemplateList[_4e],_52="",_53=_51[_4a];if(dj.byId("isSwift2019Enabled")&&_4c.toUpperCase()==="BG"){_52=m._config.guaranteeFacilityTemplateList[_4e];var _54=_52[_4a];if(_4b!=="*"){_53=_54[_4b];}}if(_53){_4d.store=new dojo.data.ItemFileReadStore({data:{identifier:"value",label:"name",items:_53}});if(!misys.dialog.isActive){var _55=dj.byId("limit_defn_grid");if(_55!=null&&_55.store!=null&&_55.store._arrayOfTopLevelItems.length>0){_55.store.fetch({query:{store_id:misys._config.storeId},onComplete:function(_56,_57){dojo.forEach(_56,function(_58){_4d.set("value",_58.product_template[0]);});}});}}else{_4d.set("value","");}}};function _59(){var _5a=dj.byId("product_type_code"),_5b=dj.byId("product_template");_5a.set("value","");_5b.set("value","");};function _5c(){var _5d=dj.byId("previous_limit_amt");if(_5d&&!isNaN(_5d.get("value"))&&_5d.get("value")+"S"!=="S"){_5e(this,_5d,dj.byId("limit_outstanding_amt"));}else{if(dj.byId("limit_outstanding_amt")){dj.byId("limit_outstanding_amt").set("value",dj.byId("limit_amt").get("value"));}}};function _5f(){_3f();if(dj.byId("product_template")){_49();}};function _60(){var _61=dj.byId("product_code").get("value"),_62=dj.byId("sub_product_code"),_63=(_61==="*")?"ALL":_61,_64=m._config.SubProductsCollection[_63],_65=dj.byId("sub_product_code_hidden"),_66=dj.byId("account_no");if(_64&&_65){_62.store=new dojo.data.ItemFileReadStore({data:{identifier:"value",label:"name",items:_64}});_62.fetchProperties={sort:[{attribute:"name"}]};_62.set("value",_65.get("value"));}};function _67(dom,_68,_69){var _6a=dom.getElementsByTagName(_68)[0],_6b=dom.getElementsByTagName(_69)[0],_6c="",_6d=[],_6e=new Array();if(_6a){var _6f=_6a.childNodes[0];if(_6f&&_6f.nodeValue){_6c=_6f.nodeValue;}}if(_6b){var _70=_6b.childNodes[0];if(_70&&_70.nodeValue){_6e=_70.nodeValue.split(",");}}if(_6e.length>0){_6d.push("<attached_entities>");dojo.forEach(_6e,function(_71){if(_71!==null&&_71!==""){_6d.push("<entity><entity_abbv_name>",_71,"</entity_abbv_name></entity>");}});_6d.push("</attached_entities>");}return _6d.join("");};function _72(_73,_74,_75){var _76=parseFloat((dj.byId("temp_outstanding_facility_amt").get("value").split(",").join("")));var _77;if(_73.get("value")<_74.get("value")){if(_76<_74.get("value")){misys.dialog.show("ERROR",misys.getLocalization("facilityAmountDecreaseError"));_73.set("value",_74.get("value"));}else{if(_75){var _78=function(){_79.store.fetch({query:{store_id:"*"},onComplete:function(_7a,_7b){dojo.forEach(_7a,function(_7c){_7c.limit_amt="";_7c.limit_outstanding_amt="";});}});_75.set("value",_73.get("value"));_79.render();};var _7d=function(){_73.set("value",_74.get("value"));};var _79=dj.byId("limit_defn_grid");var _7e=dj.byId("limit_ref");var _7f=true;if(_79!=null&&_79.store!=null&&_79.store._arrayOfTopLevelItems.length>0){var _80=dj.byId("facility_reference");facilityReference=_80?_80.get("displayedValue"):"";m.xhrPost({url:m.getServletURL("/screen/AjaxScreen/action/GetPendingLimitAmt"),handleAs:"text",sync:true,content:{facility:facilityReference,option:"FACILITY"},load:function(_81,_82){if(parseFloat((_81.split(",").join("")))>0){_7f=false;}}});if(!_7f){misys.dialog.show("ERROR",misys.getLocalization("facilityAmountDecreaseError"));_73.set("value",_74.get("value"));}else{m.dialog.show("CONFIRMATION",misys.getLocalization("limitAmountWillBeCleared"),"","","","",_78,_7d);}}else{var _83=_74.get("value")-_73.get("value");_77=_76-_83;_75.set("value",_77);}}}}else{if(_73.get("value")>_74.get("value")){if(_75){var _84=_73.get("value")-_74.get("value");_77=_76+_84;_75.set("value",_77);}}}};function _5e(_85,_86,_87){var _88=parseFloat((dj.byId("temp_limit_outstanding_amt").get("value").split(",").join("")));var _89=dj.byId("limit_pending_bank_amt");var _8a=dj.byId("limit_utilised_amt");var _8b;if(_85.get("value")<_86.get("value")){if(dj.byId("facilityAmtValidation")&&dj.byId("facilityAmtValidation").get("value")=="false"){misys.dialog.show("ERROR",misys.getLocalization("facilityAmountDecreaseError"));_85.set("value",_86.get("value"));}else{if(parseFloat((_8a.get("value").split(",").join("")))>_85.get("value")){misys.dialog.show("ERROR",misys.getLocalization("facilityAmountDecreaseError"));_85.set("value",_86.get("value"));}var _8c=dj.byId("limit_ref");var _8d=true;limitReference=_8c?_8c.get("displayedValue"):"";m.xhrPost({url:m.getServletURL("/screen/AjaxScreen/action/GetPendingLimitAmt"),handleAs:"text",sync:true,content:{limit:limitReference,option:"LIMIT"},load:function(_8e,_8f){var _90=parseFloat((_8e.split(",").join("")))+parseFloat((_8a.get("value").split(",").join("")));if(_90>_85.get("value")){_8d=false;}}});if(!_8d){misys.dialog.show("ERROR",misys.getLocalization("facilityAmountDecreaseError"));_85.set("value",_86.get("value"));}else{var _91=_86.get("value")-_85.get("value");_8b=_88-_91;_87.set("value",_8b);}}}else{if(_87){var _92=_85.get("value")-_86.get("value");_8b=_88+_92;_87.set("value",_8b);}}};m._config=m._config||{};d.mixin(m._config,{xmlTransform:function(xml){if(xml.indexOf(m._config.xmlTagName)===-1){return xml;}var _93=new Array("entity_select_list_facility"),_94=m._config.xmlTagName,_95=_94?["<",_94,">"]:[],dom=dojox.xml.DomParser.parse(xml);dojo.forEach(_93,function(id){if(dj.byId(id)){var _96=dj.byId(id);if(_96&&_96.declaredClass.indexOf("MultiSelect")!=-1){_96.reset();_96.invertSelection();}}});var _97=xml.substring(_94.length+2,(xml.length-_94.length-3));_95.push(_97);dojo.forEach(_93,function(id){if(dom.getElementsByTagName(id).length>0){_95.push(_67(dom,"attached_entities",id));}});if(_94){_95.push("</",_94,">");}return _95.join("");}});d.mixin(m,{bind:function(){m.connect("bank_abbv_name","onChange",function(){_19();});m.connect("bank_abbv_name","onFocus",function(){this.oldValue=this.get("value");});m.connect("bo_reference","onChange",function(){_20();});m.connect("bo_reference","onFocus",function(){this.oldValue=this.get("value");});m.connect("base_cur_code","onChange",function(){m.setCurrency(this,["facility_amt"]);});m.connect("base_cur_code","onChange",function(){m.setCurrency(this,["facility_outstanding_amt"]);});m.connect("limit_cur_code","onChange",function(){m.setCurrency(this,["limit_amt"]);});m.connect("limit_cur_code","onChange",function(){m.setCurrency(this,["limit_outstanding_amt"]);});m.setValidation("review_date",_e);m.setValidation("base_cur_code",m.validateCurrency);m.setValidation("limit_ref",_6);m.connect("product_code","onChange",function(){_60();_3a();});m.connect("sub_product_code","onChange",_3a);m.connect("removeFacilityEntityButton","onClick",_27);m.connect("facility_reference","onChange",function(){m.checkFacilityReferenceExists();});m.setValidation("limit_cur_code",m.validateCurrency);m.setValidation("beneficiary_country",m.validateCountry);m.setValidation("limit_review_date",_1);m.connect("product_code","onChange",function(){if(dj.byId("product_type_code")){_5f();}});m.connect("product_type_code","onChange",function(){if(dj.byId("product_template")){_49();}});m.connect("sub_product_code","onChange",function(){if(dj.byId("product_type_code")&&dj.byId("product_template")){_59();}});m.connect("limit_amt","onChange",function(){if(misys.dialog.isActive){_5c();}});if(dj.byId("isModified")&&dj.byId("previous_facility_amt")){m.connect("facility_amt","onChange",function(){_72(this,dj.byId("previous_facility_amt"),dj.byId("facility_outstanding_amt"));});}else{m.connect("facility_amt","onChange",function(){if(dj.byId("facility_outstanding_amt")){dj.byId("facility_outstanding_amt").set("value",this.get("value"));}});}},onFormLoad:function(){if(dj.byId("facility_amt")){dj.byId("facility_amt").attr("constraints",{min:0.01});if(dj.byId("isModified")){dj.byId("base_cur_code").set("disabled",true);}}m.setCurrency("base_cur_code",["facility_amt","facility_outstanding_amt"]);if(dj.byId("limit_amt")){dj.byId("limit_amt").attr("constraints",{min:0.01});dj.byId("limit_amt").attr("trim",false);}if(dj.byId("bank_abbv_name")&&dj.byId("bo_reference")){_1f();}_26();m._config.storeId="";},showDialogByCompany:function(_98){var _99="";if(m._config.bankNameIdCollection&&dj.byId("bank_abbv_name")){_99=m._config.bankNameIdCollection[dj.byId("bank_abbv_name").get("value")];}m.showSearchDialog("beneficiary","['beneficiary_name','','','','beneficiary_country']","","","","width:710px;height:350px;",_98,_99);},beforeSubmitValidations:function(){var _9a=dj.byId("limit_defn_grid");var _9b=dj.byId("limit_ref");var _9c=true;if(_9a!=null&&_9a.store!=null&&_9a.store._arrayOfTopLevelItems.length>0){if(_9b){_9a.store.fetch({query:{store_id:"*"},onComplete:function(_9d,_9e){dojo.forEach(_9d,function(_9f){if(_9f.limit_amt==""){m._config.onSubmitErrorMsg=m.getLocalization("limitAmountCannotBeZero");_9c=false;}});}});}if(!_9c){return _9c;}return _9c;}return true;}});})(dojo,dijit,misys);dojo.require("misys.client.binding.system.facility_client");}