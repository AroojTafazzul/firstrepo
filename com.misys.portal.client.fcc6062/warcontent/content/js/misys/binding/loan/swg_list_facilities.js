/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.binding.loan.swg_list_facilities"]){dojo._hasResource["misys.binding.loan.swg_list_facilities"]=true;dojo.provide("misys.binding.loan.swg_list_facilities");dojo.require("dojo.data.ItemFileReadStore");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("dijit.form.FilteringSelect");dojo.require("misys.form.MultiSelect");dojo.require("dijit.layout.TabContainer");dojo.require("misys.form.common");dojo.require("misys.validation.common");dojo.require("dijit.form.Form");dojo.require("dijit.form.Button");dojo.require("dijit.form.TextBox");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.CheckBox");dojo.require("dijit.layout.ContentPane");dojo.require("misys.form.CurrencyTextBox");dojo.require("dijit.form.RadioButton");dojo.require("misys.grid._base");(function(d,dj,m){function _1(_2){var _3=dj.byId(_2)?dj.byId(_2).get("value"):"";dijit.byId("fetch_deals").set("disabled",true);m.xhrPost({url:m.getServletURL("/screen/AjaxScreen/action/GetBorrowerDealsForSwingline"),handleAs:"json",sync:true,content:{borrowerid:_3},load:function(_4){misys._config.facilityListResponse=_4;_a();},error:function(_5){}});};function _6(){var _7=dj.byId("custrefid");_7.set("state","Error");var _8=m.getLocalization("noBorrowerForTransaction");var _9=function(){dj.hideTooltip(_7.domNode);};dj.showTooltip(_8,_7.domNode,0);setTimeout(_9,5000);};function _a(){var _b=dj.byId("custrefid")?dj.byId("custrefid").get("value"):"";var _c=dijit.byId("dealid");_c.set("value","");_c.set("state"," ");var _d=misys._config.facilityListResponse["items"];if(_d){_c.store=new dojo.data.ItemFileReadStore({data:{identifier:"id",label:"name",items:_d["dealNames"]}});}var _e=0;var _f=function(_10,_11){_e=_10;};_c.get("store").fetch({query:{},onBegin:_f,start:0,count:0});if(_e===0){var _12=m.getLocalization("noDealsDataFound");var _13=function(){dj.hideTooltip(dj.byId("custrefid").domNode);};dj.showTooltip(_12,dj.byId("custrefid").domNode,0);setTimeout(_13,5000);}else{_c.set("disabled",false);dijit.byId("fetch_deals").set("disabled",false);for(var x=1;x<_c.store._arrayOfTopLevelItems.length;x++){_c.set("value",_c.store._arrayOfTopLevelItems[x].name[x]);_c.set("displayedValue",_c.store._arrayOfTopLevelItems[x].name[x]);}_c.set("value",_c.store._arrayOfTopLevelItems[0].name[0]);_c.set("displayedValue",_c.store._arrayOfTopLevelItems[0].name[0]);dijit.byId("fetch_deals").onClick();}if((_e===1&&_c.store&&_c.store._arrayOfTopLevelItems.length)||(m.getLocalization("loanBorrowerReferenceDefault")==="true"&&_e!==0)){_c.set("value",_c.store._arrayOfTopLevelItems[0].name[0]);_c.set("displayedValue",_c.store._arrayOfTopLevelItems[0].name[0]);dijit.byId("fetch_deals").onClick();}};function _14(_15){var _16=dj.byId(_15)?dj.byId(_15).get("value"):"";var _17=misys._config.facilityListResponse["items"];var _18=_17["facilities"];var _19;if(_16!==""&&_17.facilities[_16]){_19=new dojo.data.ItemFileReadStore({data:{identifier:"id",label:"Facility",items:_18[_16]}});}else{var _1a={items:""};_19=new dojo.data.ItemFileWriteStore({data:_1a});if(_16===""){var _1b=m.getLocalization("requiredToolTip");var _1c=function(){dj.hideTooltip(dj.byId(_15).domNode);};dj.showTooltip(_1b,dj.byId(_15).domNode,0);setTimeout(_1c,5000);}}_19.comparatorMap={};_19.comparatorMap["Expiry Date"]=misys.grid.sortDateColumn;_19.comparatorMap["Maturity"]=misys.grid.sortDateColumn;_19.comparatorMap["Total"]=misys.grid.sortAmountColumn;_19.comparatorMap["Available"]=misys.grid.sortAmountColumn;_19.comparatorMap["FCN"]=misys.grid.sortCaseSensetiveColumn;_19.comparatorMap["Facility"]=misys.grid.sortLinkColumn;_19.comparatorMap["Borrower"]=misys.grid.sortCaseSensetiveColumn;_19.comparatorMap["Ccy"]=misys.grid.sortCaseSensetiveColumn;var _1d=dj.byId("loanFacilitiesGrid");if(!_17.facilities[_16]){_1d.noDataMessage=m.getLocalization("facilityMISCodeBlockedError");}_1d.setStore(_19);if(dijit.byId("loanFacilitiesGrid").store._arrayOfAllItems.length===0){dojo.query("div.dojoxGridMasterMessages")[0].innerHTML=m.getLocalization("facilityNotPresent");}};d.mixin(m,{bind:function(){m.connect("fetch_deals","onClick",function(){_14("dealid");});m.connect("custrefid","onChange",function(){var _1e=dijit.byId("dealid");_1e.set("value","");_1e.set("state","");_1e.set("disabled",true);dijit.byId("fetch_deals").set("disabled",true);var _1f={items:""};var _20=new dojo.data.ItemFileWriteStore({data:_1f});var _21=dj.byId("loanFacilitiesGrid");_21.setStore(_20);if(dj.byId("custrefid").get("value")){_1("custrefid");}});},onFormLoad:function(){dijit.byId("dealid").set("disabled",true);dijit.byId("fetch_deals").set("disabled",true);if(dijit.byId("custrefid")&&dijit.byId("custrefid").get("value")!==""){dijit.byId("custrefid").onChange();}if(dijit.byId("custrefid")&&dijit.byId("custrefid").get("value")==""){_6();}},blockFacility:function(_22){m.dialog.show("ERROR",misys.getLocalization("facilityBlockError",[_22]));},sortFacilityColumn:function(a,b){var _23;var _24;if(a.indexOf(">",0)>-1){_23=(a.substring(a.indexOf(">",1)+1,a.indexOf("<",1))).toLowerCase();}else{_23=a.toLowerCase();}if(b.indexOf(">",0)>-1){_24=(b.substring(b.indexOf(">",1)+1,b.indexOf("<",1))).toLowerCase();}else{_24=b.toLowerCase();}if(_23>_24){return 1;}if(_23<_24){return -1;}return 0;}});})(dojo,dijit,misys);dojo.require("misys.client.binding.loan.swg_list_facilities_client");}