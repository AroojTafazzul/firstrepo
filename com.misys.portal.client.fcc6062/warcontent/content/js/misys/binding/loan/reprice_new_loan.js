/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.binding.loan.reprice_new_loan"]){dojo._hasResource["misys.binding.loan.reprice_new_loan"]=true;dojo.provide("misys.binding.loan.reprice_new_loan");dojo.require("dojo.parser");dojo.require("dijit.layout.TabContainer");dojo.require("dijit.form.DateTextBox");dojo.require("misys.form.CurrencyTextBox");dojo.require("dijit.form.NumberTextBox");dojo.require("dijit.form.FilteringSelect");dojo.require("dijit.form.Form");dojo.require("dijit.form.Button");dojo.require("dijit.form.TextBox");dojo.require("misys.widget.Dialog");dojo.require("dijit.ProgressBar");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.CheckBox");dojo.require("dojo.data.ItemFileReadStore");dojo.require("misys.form.file");dojo.require("misys.form.SimpleTextarea");dojo.require("misys.form.common");dojo.require("misys.validation.common");dojo.require("misys.widget.Collaboration");dojo.require("misys.binding.SessionTimer");dojo.require("dojox.xml.DomParser");(function(d,dj,m){misys._config.count=1;misys._config.errorMsgFlag=false;misys._config.isReprcingDateFlag=false;var _1="CUSTOM-NO-CANCEL";function _2(){if(this.get("value")==null){return true;}var _3=dj.byId(this.id);var _4=dijit.byId("facility_maturity_date");if(!m.compareDateFields(_3,_4)){this.invalidMessage=misys.getLocalization("loanMatDateGreaterThanFacMatDateError",[m.getLocalizeDisplayDate(this),m.getLocalizeDisplayDate(_4)]);return false;}var _5=dijit.byId("effective_date");if(!m.compareDateFields(_5,_3)){this.invalidMessage=misys.getLocalization("loanMatDateLessThanLoanEffDateError",[m.getLocalizeDisplayDate(this),m.getLocalizeDisplayDate(_5)]);return false;}return true;};function _6(){var _7=true;var _8=dj.byId("bo_facility_id").get("value");var _9="";var _a=0;var _b=dijit.byId("repricing_date").get("value");var _c;if(_b!==""){var _d=window.opener.oldLoanGrid;if(_d&&_d.store){_d.store.fetch({query:{loan_facility_id:_8},onComplete:dojo.hitch(this,function(_e,_f){d.forEach(_e,function(_10){_9=_9.concat(_10.loan_ref_id[0]);_9=_9.concat(",");var _11=_10.loan_outstanding_amt[0];if(typeof _11==="string"||_11 instanceof String){_c=_10.loan_outstanding_amt[0].split(",").join("");}else{_c=_10.loan_outstanding_amt[0];}_a=parseFloat(_a)+parseFloat(_c);_7=false;},this);})});}_7f();var _12=dijit.byId("faciliy_global_available_amount").get("value");if(!parseFloat(_12)>0&&!_7){var _13=dijit.byId("ref_id").get("value");var _14=dijit.byId("repricing_date").get("displayedValue");if(_14===""||_14===null){_14=dijit.byId("ln_maturity_date").get("displayedValue");}var _15=window.opener.newLoanGrid;var _16=dj.byId("ln_amt").get("value");var _17=parseFloat(_16);var _18=true;var _19;var _1a=window.opener.fac_cur_code;var _1b=window.opener.loan_currency;if(_15&&_15.store){_15.store.fetch({query:{new_loan_facility_id:_8},onComplete:dojo.hitch(this,function(_1c,_1d){d.forEach(_1c,function(_1e){if(_13!==_1e.new_loan_ref_id[0]){var _1f=_1e.new_loan_outstanding_amt[0];var _20;if(typeof _1f==="string"||_1f instanceof String){_20=_1e.new_loan_outstanding_amt[0].split(",").join("");}else{_20=_1e.new_loan_outstanding_amt[0];}_17=parseFloat(_17)+parseFloat(_20);}},this);})});}m.xhrPost({url:m.getServletURL("/screen/AjaxScreen/action/ValidateAmountWithCommitmentSchedule"),handleAs:"json",preventCache:true,sync:true,content:{facilityid:_8,repricing_date:_14,loanAmount:_17,linkedLoans:_9,repriced_ln_amt:_a,facCurCode:_1a,loanCurrency:_1b},load:function(_21,_22){_18=_21.commitmentViolated;_19=_21.errorMsg;},error:function(_23,_24){_18=false;console.error(" processRepricingOfRecords error",_23);}});if(!_18){m.dialog.show("ERROR",_19);return false;}else{return true;}}else{return true;}}};function _25(){var _26=dijit.byId("bo_facility_id");var _27=new Array();var _28=0;window.opener.facilitiesStore.fetch({query:{id:"*"},onComplete:d.hitch(this,function(_29,_2a){dojo.forEach(_29,function(_2b){var _2c=_2b.status;if(_2c[0]==="Expired"){_27.push(_2b.id[0]);_28=_28+1;}},this);})});if(_27.indexOf(_26.get("value"))>-1){return false;}else{return true;}};function _2d(){dijit.byId("ln_amt").set("value",parseFloat(dj.byId("ln_amt").get("value")));if(_2e()){if(_25()){var _2f=dj.byId("bo_facility_id").get("value");var _30=window.opener.oldLoanGrid;var _31=[];if(_30&&_30.store){_30.store.fetch({query:{loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_32,_33){dojo.forEach(_32,function(_34){var _35=""+_34.loan_facility_id;_31.push(_35);},this);})});}var _36=window.opener.facilityAvailableAmountStore;var _37=window.opener.riskTypeLimitStore;var _38=window.opener.currencyTypeLimitStore;var _39=window.opener.borrowerTypeLimitStore;var _3a=[];var _3b=true;var _3c;_36.fetch({query:{id:_2f},onComplete:d.hitch(dj.byId("bo_facility_id"),function(_3d,_3e){var _3f=_3d[0];if(_3f){var _40=""+_3f.borrowerAvailableLimitAmount[0];_3c=parseFloat(_40.split(",").join(""));if(_3c<=0&&_31.indexOf(_2f)==-1){_3c=Number.NEGATIVE_INFINITY;}_3a.push({limitValue:_3c,validateMethod:"_checkForFacliltyFullDrawn"});}})});var _41;_36.fetch({query:{id:_2f},onComplete:d.hitch(dj.byId("bo_facility_id"),function(_42,_43){var _44=_42[0];if(_44){if(typeof _44.borrowerAvailableLimitAmountWithPend!=="undefined"){var _45=""+_44.borrowerAvailableLimitAmountWithPend[0];_41=parseFloat(_45.split(",").join(""));if(_41<=0&&_31.indexOf(_2f)==-1){_41=Number.NEGATIVE_INFINITY;}_3a.push({limitValue:_41,validateMethod:"_checkForFacliltyWithPendLoansFullDrawn"});}}})});var _46;_39.fetch({query:{id:_2f},onComplete:d.hitch(dj.byId("bo_facility_id"),function(_47,_48){var _49=_47[0];if(_49){var _4a=""+_49.borrowerTypeLimitAmount[0];_46=parseFloat(_4a.split(",").join(""));_3a.push({limitValue:_46,validateMethod:"_checkBorrowerTypeLimitAmount"});}})});var _4b;_37.fetch({query:{id:_2f},onComplete:d.hitch(dj.byId("bo_facility_id"),function(_4c,_4d){var _4e=_4c[0];if(_4e){var _4f=""+_4e.riskTypeLimitAmount[0];_4b=parseFloat(_4f.split(",").join(""));_3a.push({limitValue:_4b,validateMethod:"_checkRiskTypeLimitAmount"});}})});var _50;_38.fetch({query:{id:_2f},onComplete:d.hitch(dj.byId("bo_facility_id"),function(_51,_52){var _53=_51[0];if(_53){var _54=""+_53.currencyLimitAmount[0];_50=parseFloat(_54.split(",").join(""));_3a.push({limitValue:_50,validateMethod:"_checkCurrencyTypeLimitAmount"});}})});if(dijit.byId("repricingdate_validation").value=="true"){var _55=_127();if(_55!==null&&_55.get("commitmentScheduled")){var _56=_55.get("commitmentSchAmount");var _57=parseFloat(_56);_3a.push({limitValue:_57,validateMethod:"_checkCommitmentAmountLimit"});}}if(_3a.length>0){_3a=_3a.sort(function(a,b){return a.limitValue-b.limitValue;});for(var i=0;i<_3a.length;i++){var _58=_3a[i].validateMethod;if("_checkForFacliltyFullDrawn"==_58){_3b=_ed();}else{if("_checkForFacliltyWithPendLoansFullDrawn"==_58){_3b=_9a();}else{if("_checkRiskTypeLimitAmount"==_58){_3b=_130();}else{if("_checkCurrencyTypeLimitAmount"==_58){_3b=_152();}else{if("_checkBorrowerTypeLimitAmount"==_58){_3b=_141();}else{if("_checkCommitmentAmountLimit"==_58){_3b=_10e(_3a[i].limitValue);}}}}}}var _59=window.opener.limitValidationFlag;if(!_3b){break;}else{if(_59!=="error"){return _3b;}}}if(!_3b){var _5a=dj.byId("ln_amt");var _5b=_5a.invalidMessage;dj.hideTooltip(_5a.domNode);_5a.set("state","Error");dj.showTooltip(_5b,_5a.domNode,["after"],0);setTimeout(function(){dj.hideTooltip(_5a.domNode);},5000);return false;}}return _3b;}else{return true;}}else{return false;}};function _5c(){var _5d=false;if(_5e()&&_5f()&&_60()&&_2d()&&_61()){_5d=true;}if(_5d&&dijit.byId("repricingdate_validation").value!="true"){_5d=_6();}return _5d;};function _62(){if(_5e()&&_5f()){return true;}return false;};function _5e(){dj.byId("addLoan").set("disabled",true);var _63=["bo_facility_id","pricing_option","ln_amt","effective_date","ln_maturity_date","repricing_frequency","repricing_date","risk_type"];var _64=dojo.every(_63,function(id){var _65=dj.byId(id);if(_65){var _66=_65.get("value");if(_66===""||_65.state==="Error"||_65.get("displayedValue")===""){var _67=_65.get("id");if((_67==="ln_maturity_date"||_67==="repricing_frequency"||_67==="repricing_date")){if(_68(_67)){misys.showTooltip(misys.getLocalization("mandatoryFieldsError"),_65.domNode,["above","before"]);_65.state="Error";_65._setStateClass();dj.setWaiState(_65.focusNode,"invalid","true");return false;}else{return true;}}misys.showTooltip(misys.getLocalization("mandatoryFieldsError"),_65.domNode,["above","before"]);_65.state="Error";_65._setStateClass();_65.focus();dj.setWaiState(_65.focusNode,"invalid","true");return false;}}return true;});dj.byId("addLoan").set("disabled",false);if(_64){var _69=dijit.byId("fc_access_type");if(_69.get("value")!=="A"){var _6a=misys.getLocalization("facilityBlockError",[dj.byId("bo_facility_id").get("displayedValue")]);m.dialog.show("ERROR",_6a);return false;}}return _64;};function _6b(){var _6c=window.opener.totalRepricingAmountId.get("value");var _6d=window.opener.totalNewRepricingAmountId.get("value");var _6e=window.opener.document.getElementById("loan_increase_Section");var _6f=window.opener.document.getElementById("remittance_inst_section");var _70=window.opener.loanRemittanceGrid;if(_6d>_6c){_71();dojo.style(_6e,"display","block");if(_6f&&_70){dojo.style(_6f,"display","block");_70._refresh();}window.opener.adjustAmuntOptions.set("disabled",true);}else{dojo.style(_6e,"display","none");if(_6f){dojo.style(_6f,"display","none");}}};function _72(){var _73=window.opener.interestDetailsGrids;var _74=0;if(_73&&_73.store){_73.store.fetch({query:{loan_alias:"*"},onComplete:dojo.hitch(this,function(_75,_76){dojo.forEach(_75,function(_77){_74=parseFloat(_74)+parseFloat(_77.totalProjectedEOCamt_fmt[0].split(",").join(""));},this);})});}var _78=window.opener.totalRepricingAmountId.get("value");var _79=window.opener.totalNewRepricingAmountId.get("value");var _7a=(parseFloat(_79)-parseFloat(_78)).toFixed(2);if(_7a<=_74&&_7a>0){window.opener.borrowerSettlement.set("checked",false);window.opener.borrowerSettlement.set("disabled",true);}else{window.opener.borrowerSettlement.set("checked",true);window.opener.borrowerSettlement.set("disabled",false);}};function _71(){var _7b=window.opener.totalRepricingAmountId.get("value");var _7c=window.opener.totalNewRepricingAmountId.get("value");var _7d=parseFloat(_7c)-parseFloat(_7b);var _7e=window.opener.loanIncreaseAmount;_7e.set("value",_7d);};function _7f(){var _80=dj.byId("bo_facility_id").get("value");window.opener.facilitiesStore.fetch({query:{id:_80},onComplete:d.hitch(this,function(_81,_82){var _83=_81[0];dj.byId("faciliy_global_available_amount").set("value",_83.globalAvailableAmount[0]);})});};function _84(){d.require("misys.widget.Dialog");d.require("dijit.form.Button");var _85=new dj.Dialog({id:"",title:m.getLocalization("warningMessage")});var _86=d.create("div",{id:""});var _87=d.create("div",{id:""},_86,"first");var _88=m.getLocalization("loanRiskTypeLimtAmtExceededWarning");_87.innerHTML=_88;var _89=d.create("div",{id:"",style:"text-align:right;"},_86,"last");var _8a=new dj.form.Button({label:m.getLocalization("okMessage"),id:""});var _8b=new dj.form.Button({label:m.getLocalization("cancelMessage"),id:""});d.place(_8a.domNode,_89);d.place(_8b.domNode,_89);_85.attr("content",_86);m.dialog.connect(_8a,"onClick",function(){_85.hide();var _8c=_61();if(_8c){if(window.editMode===true){_1e4();}else{_1e5();}window.close();}else{var _8d=window.opener.loanIncreaseFlag;if(_8d==="false"){var _8e=misys.getLocalization("loanRepricingAmountError");m.dialog.show("ERROR",_8e);}else{var _8f=function(){if(window.editMode===true){_1e4();}else{_1e5();}window.close();};m.dialog.show("CONFIRMATION",misys.getLocalization("loanIncreaseRepricingAmountError"," "),"",null,null,"",_8f);}}},_85.id);m.dialog.connect(_8b,"onClick",function(){_85.hide();},_85.id);m.dialog.connect(_85,"onHide",function(){m.dialog.disconnect(_85);});_85.show();};function _90(){if(!this.get("value")){return true;}var _91=dj.byId(this.id);var _92=_91.get("value");var _93=new Date();_93.setHours(0,0,0,0);var _94=d.date.compare(m.localizeDate(this),_93)<0?false:true;if(!_94){this.invalidMessage=m.getLocalization("effectiveDateGreaterThanSystemDate",[m.getLocalizeDisplayDate(this)]);return false;}var _95=dijit.byId("facility_effective_date");if(!m.compareDateFields(_95,_91)){this.invalidMessage=misys.getLocalization("loanEffDateGreaterThanFacEffDateError",[m.getLocalizeDisplayDate(this),m.getLocalizeDisplayDate(_95)]);return false;}var _96=dijit.byId("facility_expiry_date");if(!m.compareDateFields(_91,_96)){this.invalidMessage=misys.getLocalization("loanEffDateLessThanFacExpDateError",[m.getLocalizeDisplayDate(this),m.getLocalizeDisplayDate(_96)]);return false;}var _97=dijit.byId("facility_maturity_date");if(!m.compareDateFields(_91,_97)){this.invalidMessage=misys.getLocalization("loanEffDateLessThanFacMatDateError",[m.getLocalizeDisplayDate(this),m.getLocalizeDisplayDate(_97)]);return false;}var _98=dijit.byId("ln_maturity_date");if(!m.compareDateFields(_91,_98)){this.invalidMessage=misys.getLocalization("loanEffDateLessThanLoanMatDateError",[m.getLocalizeDisplayDate(this),m.getLocalizeDisplayDate(_98)]);return false;}return true;};function _2e(){var _99=dj.byId("ln_amt");if(_99.get("value")==null){return true;}if(_99.get("value")<=0){_99.invalidMessage=misys.getLocalization("loanAmountZeroError");return false;}return true;};function _9a(){if(window.editMode===true){return _9b();}else{var _9c=dj.byId("bo_facility_id").get("value");var _9d=dj.byId("ln_amt").get("value");var _9e=dijit.byId("ln_cur_code");var _9f=window.opener.facilityAvailableAmountStore;var _a0=false;var _a1;var _a2;var _a3=d.cldr.monetary.getData(_9e.get("value"));_9f.fetch({query:{id:_9c},onComplete:d.hitch(dj.byId("bo_facility_id"),function(_a4,_a5){var _a6=_a4[0];if(_a6){var _a7=_a8();var _a9=_aa();var _ab=_a6.borrowerAvailableLimitAmountWithPend[0];if(typeof _ab==="string"||_ab instanceof String){_a2=_ab.split(",").join("");}else{_a2=_ab;}_a1=parseFloat(_a7)+parseFloat(_a2)-parseFloat(_a9);if(parseFloat(_9d)>(_a1.toFixed(2))){_a0=true;}}})});if(_a0){var _ac=dj.byId("ln_amt");if(_a1<=0){_ac.invalidMessage=m.getLocalization("facilityFullyDrawnErrorWithPend");}else{_ac.invalidMessage=m.getLocalization("loanFacilityLimtPendAmtExceeded",[_9e.get("value"),d.currency.format(_a1,{round:_a3.round,places:_a3.places})]);}return false;}return true;}};function _9b(){var _ad=dj.byId("bo_facility_id").get("value");var _ae=window.opener.newLoanGrid;var _af=0;var _b0=0;var _b1;if(_ae&&_ae.store){_ae.store.fetch({query:{new_loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_b2,_b3){dojo.forEach(_b2,function(_b4){if(_ad==_b4.new_loan_facility_id){var _b5=""+_b4.new_loan_outstanding_amt[0];_af=parseFloat(_af)+parseFloat(_b5.split(",").join(""));}},this);})});}var _b6=dijit.byId("ln_amt").get("value");var _b7=dijit.byId("ln_cur_code");var _b8=dj.byId("dummy_ln_amt").get("value");_b8=_b8.split(",").join("");var _b9;var _ba=d.cldr.monetary.getData(_b7.get("value"));if(_b8>_b6){_b0=parseFloat(_b8)-parseFloat(_b6);_b9=parseFloat(_af)-parseFloat(_b0);}else{_b0=parseFloat(_b6)-parseFloat(_b8);_b9=parseFloat(_af)+parseFloat(_b0);}var _bb=window.opener.facilityAvailableAmountStore;var _bc=false;var _bd,_be;_bb.fetch({query:{id:_ad},onComplete:d.hitch(dj.byId("bo_facility_id"),function(_bf,_c0){var _c1=_bf[0];if(_c1){if(_ad==_c1.id[0]){var _c2=_a8();var _c3=_aa();var _c4=""+_c1.borrowerAvailableLimitAmountWithPend[0];_bd=parseFloat(_c2)+parseFloat(_c4.split(",").join(""));_bd=_bd.toFixed(2);_be=(parseFloat(_c2)+parseFloat(_c4.split(",").join(""))-(parseFloat(_c3)-parseFloat(_b8))).toFixed(2);}if(parseFloat(_b6)>_bd||_b9>_bd){_bc=true;}}})});if(_bc){var _c5=dj.byId("ln_amt");if(_bd<=0){_c5.invalidMessage=m.getLocalization("loanFacilityAmtWithPendExceeded");}else{_c5.invalidMessage=misys.getLocalization("loanFacilityLimtPendAmtExceeded",[_b7.get("value"),d.currency.format(_be,{round:_ba.round,places:_ba.places})]);}return false;}return true;};function _c6(){var _c7=dj.byId("bo_facility_id").get("value");var _c8=dj.byId("ln_amt").get("value");var _c9=window.opener.facilityAvailableAmountStore;var _ca;_c9.fetch({query:{id:_c7},onComplete:d.hitch(dj.byId("bo_facility_id"),function(_cb,_cc){var _cd=_cb[0];if(_cd){var _ce=""+_cd.dummyBorrowerAvailableLimitAmount[0];if(window.editMode===true){var _cf=dj.byId("dummy_ln_amt").get("value");if(_c8>_cf){_ca=parseFloat(_c8.toFixed(2))-parseFloat(_cf.split(",").join(""));_cd.dummyBorrowerAvailableLimitAmount[0]=parseFloat(_ce.split(",").join(""))-parseFloat(_ca.toFixed(2));}else{_ca=parseFloat(_cf.split(",").join(""))-parseFloat(_c8.toFixed(2));_cd.dummyBorrowerAvailableLimitAmount[0]=parseFloat(_ce.split(",").join(""))+parseFloat(_ca.toFixed(2));}}else{_cd.dummyBorrowerAvailableLimitAmount[0]=parseFloat(_ce.split(",").join(""))-parseFloat(_c8.toFixed(2));}}})});};function _d0(){var _d1=dj.byId("bo_facility_id").get("value");var _d2=dj.byId("ln_amt").get("value");var _d3;var _d4=window.opener.riskTypeLimitStore;_d4.fetch({query:{id:_d1},onComplete:d.hitch(dj.byId("bo_facility_id"),function(_d5,_d6){var _d7=_d5[0];if(_d7){var _d8=""+_d7.dummyRiskTypeLimitAmount[0];if(window.editMode===true){var _d9="0";if(misys._config.facilityId===_d1){_d9=dj.byId("dummy_ln_amt").get("value");}if(_d2>_d9){_d3=parseFloat(_d2.toFixed(2))-parseFloat(_d9.split(",").join(""));_d7.dummyRiskTypeLimitAmount[0]=parseFloat(_d8.split(",").join(""))-parseFloat(_d3.toFixed(2));_d7.dummyRiskTypeLimitAmount[0]=_d7.dummyRiskTypeLimitAmount[0].toFixed(2);}else{_d3=parseFloat(_d9.split(",").join(""))-parseFloat(_d2.toFixed(2));_d7.dummyRiskTypeLimitAmount[0]=parseFloat(_d8.split(",").join(""))+parseFloat(_d3.toFixed(2));_d7.dummyRiskTypeLimitAmount[0]=_d7.dummyRiskTypeLimitAmount[0].toFixed(2);}}else{_d7.dummyRiskTypeLimitAmount[0]=parseFloat(_d8.split(",").join(""))-parseFloat(_d2.toFixed(2));_d7.dummyRiskTypeLimitAmount[0]=_d7.dummyRiskTypeLimitAmount[0].toFixed(2);}}})});_d4=window.opener.borrowerTypeLimitStore;_d4.fetch({query:{id:_d1},onComplete:d.hitch(dj.byId("bo_facility_id"),function(_da,_db){var _dc=_da[0];if(_dc){var _dd=""+_dc.dummyBorrowerTypeLimitAmount[0];if(window.editMode===true){var _de="0";if(misys._config.facilityId===_d1){_de=dj.byId("dummy_ln_amt").get("value");}if(_d2>_de){_d3=parseFloat(_d2.toFixed(2))-parseFloat(_de.split(",").join(""));_dc.dummyBorrowerTypeLimitAmount[0]=parseFloat(_dd.split(",").join(""))-parseFloat(_d3.toFixed(2));}else{_d3=parseFloat(_de.split(",").join(""))-parseFloat(_d2.toFixed(2));_dc.dummyBorrowerTypeLimitAmount[0]=parseFloat(_dd.split(",").join(""))+parseFloat(_d3.toFixed(2));}}else{_dc.dummyBorrowerTypeLimitAmount[0]=parseFloat(_dd.split(",").join(""))-parseFloat(_d2.toFixed(2));}}})});_d4=window.opener.currencyTypeLimitStore;_d4.fetch({query:{id:_d1},onComplete:d.hitch(dj.byId("bo_facility_id"),function(_df,_e0){var _e1=_df[0];if(_e1){var _e2=""+_e1.dummyCurrencyLimitAmount[0];if(window.editMode===true){var _e3="0";if(misys._config.facilityId===_d1){_e3=dj.byId("dummy_ln_amt").get("value");}if(_d2>_e3){_d3=parseFloat(_d2.toFixed(2))-parseFloat(_e3.split(",").join(""));_e1.dummyCurrencyLimitAmount[0]=parseFloat(_e2.split(",").join(""))-parseFloat(_d3.toFixed(2));_e1.dummyCurrencyLimitAmount[0]=_e1.dummyCurrencyLimitAmount[0].toFixed(2);}else{_d3=parseFloat(_e3.split(",").join(""))-parseFloat(_d2.toFixed(2));_e1.dummyCurrencyLimitAmount[0]=parseFloat(_e2.split(",").join(""))+parseFloat(_d3.toFixed(2));_e1.dummyCurrencyLimitAmount[0]=_e1.dummyCurrencyLimitAmount[0].toFixed(2);}}else{_e1.dummyCurrencyLimitAmount[0]=parseFloat(_e2.split(",").join(""))-parseFloat(_d2.toFixed(2));_e1.dummyCurrencyLimitAmount[0]=_e1.dummyCurrencyLimitAmount[0].toFixed(2);}}})});};function _a8(){var _e4=dj.byId("bo_facility_id").get("value");var _e5=window.opener.oldLoanGrid;var _e6=0;var _e7=0;var _e8=0;if(_e5&&_e5.store){_e5.store.fetch({query:{loan_facility_id:_e4},onComplete:dojo.hitch(this,function(_e9,_ea){dojo.forEach(_e9,function(_eb){var _ec=""+_eb.loan_outstanding_amt[0];_e6=parseFloat(_e6)+parseFloat(_ec.split(",").join(""));},this);})});}return _e6.toFixed(2);};function _ed(){if(window.editMode===true){return _ee();}else{var _ef=dj.byId("bo_facility_id").get("value");var _f0=dj.byId("ln_amt").get("value");var _f1=dijit.byId("ln_cur_code");var _f2=window.opener.facilityAvailableAmountStore;var _f3=false;var _f4;var _f5;var _f6=d.cldr.monetary.getData(_f1.get("value"));_f2.fetch({query:{id:_ef},onComplete:d.hitch(dj.byId("bo_facility_id"),function(_f7,_f8){var _f9=_f7[0];if(_f9){var _fa=_a8();var _fb=_aa();var _fc=_f9.borrowerAvailableLimitAmount[0];if(typeof _fc==="string"||_fc instanceof String){_f5=_fc.split(",").join("");}else{_f5=_fc;}_f4=parseFloat(_fa)+parseFloat(_f5)-parseFloat(_fb);if(parseFloat(_f0)>(_f4.toFixed(2))){_f3=true;}}})});if(_f3){var _fd=dj.byId("ln_amt");if(_f4<=0){_fd.invalidMessage=m.getLocalization("facilityFullyDrawnError");}else{_fd.invalidMessage=m.getLocalization("loanFacilityLimtAmtExceeded",[_f1.get("value"),d.currency.format(_f4,{round:_f6.round,places:_f6.places})]);}return false;}return true;}};function _aa(){var _fe=dj.byId("bo_facility_id").get("value");var _ff=window.opener.newLoanGrid;var _100=0;if(_ff&&_ff.store){_ff.store.fetch({query:{new_loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_101,_102){dojo.forEach(_101,function(item){if(_fe===item.new_loan_facility_id[0]){var _103=""+item.new_loan_outstanding_amt[0];_100=parseFloat(_100)+parseFloat(_103.split(",").join(""));}},this);})});}return _100;};function _104(){var _105=dijit.byId("bo_facility_id").get("value");var _106=window.opener.newLoanGrid;var _107=0;var _108=dijit.byId("ref_id").get("value");var _109=new Date(dijit.byId("repricing_date").get("value"));if(_106&&_106.store){_106.store.fetch({query:{new_loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_10a,_10b){dojo.forEach(_10a,function(item){var _10c=""+item.new_loan_repricing_date[0];var date=dojo.date.locale.parse(_10c,{selector:"date",datePattern:misys.getLocalization("g_strGlobalDateFormat")});if(_105===item.new_loan_facility_id[0]&&(dojo.date.compare(_109,date,"date")>=0||_108===""+item.new_loan_ref_id[0])){var _10d=""+item.new_loan_outstanding_amt[0];_107=parseFloat(_107)+parseFloat(_10d.split(",").join(""));}},this);})});}return _107;};function _10e(_10f){if(window.editMode){return _110(_10f);}var _111=window.opener.limitValidationFlag;var _112=dj.byId("ln_cur_code");var _113=d.cldr.monetary.getData(_112.get("value"));var _114=dj.byId("ln_amt");var _115=_114.get("value");var _116=_104();var _117=_a8();var _118=parseFloat(_117)+parseFloat(_10f)-parseFloat(_116);if(parseFloat(_115)>(_118.toFixed(2))){if(_111==="error"){if(_118>0){_114.invalidMessage=misys.getLocalization("commitmentScheduleAmountError",[_112.get("value"),d.currency.format(_118,{round:_113.round,places:_113.places})]);}else{_114.invalidMessage=misys.getLocalization("commitmentScheduleFullyDrawnError",[_112.get("value")]);}return false;}else{var _119;if(_118>0){_119=misys.getLocalization("commitmentScheduleAmountError",[_112.get("value"),d.currency.format(_118,{round:_113.round,places:_113.places})]);}else{_119=misys.getLocalization("commitmentScheduleFullyDrawnError",[_112.get("value")]);}m.dialog.show(_1,_119,"Info");return true;}}else{return true;}};function _110(_11a){var _11b=_104();var _11c=0;var _11d=dijit.byId("ln_amt").get("value");var _11e=dijit.byId("ln_cur_code");var _11f=dj.byId("dummy_ln_amt").get("value");_11f=_11f.split(",").join("");var _120;var _121=d.cldr.monetary.getData(_11e.get("value"));if(_11f>_11d){_11c=parseFloat(_11f)-parseFloat(_11d);_120=parseFloat(_11b)-parseFloat(_11c);}else{_11c=parseFloat(_11d)-parseFloat(_11f);_120=parseFloat(_11b)+parseFloat(_11c);}var flag=false;var _122,_123;var _124=_a8();var _125=_104();_122=parseFloat(_124)+_11a;_122=_122.toFixed(2);_123=(parseFloat(_124)+_11a)-(parseFloat(_125)-parseFloat(_11f)).toFixed(2);if(parseFloat(_11d)>_122||_120>_122){flag=true;}if(flag){var _126=dj.byId("ln_amt");if(_123<=0){_126.invalidMessage=misys.getLocalization("commitmentScheduleFullyDrawnError",[_11e.get("value")]);}else{_126.invalidMessage=misys.getLocalization("commitmentScheduleAmountError",[_11e.get("value"),d.currency.format(_123,{round:_121.round,places:_121.places})]);}return false;}return true;};function _127(){var _128=dj.byId("bo_facility_id").get("value");var _129=dj.byId("repricing_date").get("displayedValue");var _12a=window.opener.fac_cur_code;var _12b=dijit.byId("ln_cur_code").value;var _12c=dijit.byId("ln_amt").value;var _12d=new Map();if(!isNaN(_12c)&&_12c>=0&&_129!==""){m.xhrPost({url:m.getServletURL("/screen/AjaxScreen/action/ValidateAmountWithCommitmentSchedule"),handleAs:"json",preventCache:true,sync:true,content:{facilityid:_128,repricing_date:_129,loanAmount:_12c,facilityCurrency:_12a,loanCurrency:_12b},load:function(_12e,args){_12d.set("commitmentSchAmount",_12e.commitmentSchAmount);_12d.set("commitmentViolated",_12e.commitmentViolated);_12d.set("commitmentScheduled",_12e.commitmentScheduled);},error:function(_12f,args){return null;}});}else{return null;}return _12d;};function _130(){if(window.editMode===true){return _131();}var _132=dj.byId("bo_facility_id").get("value");var _133=dj.byId("ln_amt").get("value");var _134=dijit.byId("ln_cur_code");var _135=_a8();var _136=window.opener.riskTypeLimitStore;var flag=false;var _137;var _138;var _139=d.cldr.monetary.getData(_134.get("value"));_136.fetch({query:{id:_132},onComplete:d.hitch(dj.byId("bo_facility_id"),function(_13a,_13b){var item=_13a[0];if(item){_137=item.riskTypeLimitAmount[0];var _13c=""+item.dummyRiskTypeLimitAmount[0];var _13d=parseFloat(_13c.split(",").join(""))+parseFloat(_135);_138=_13d.toFixed(2);if(parseFloat(_133)>(_13d.toFixed(2))){flag=true;}}})});if(flag){var _13e=window.opener.limitValidationFlag;if(_13e!=="error"){var _13f;if(_138>0){_13f=misys.getLocalization("loanRiskTypeLimtAmtExceeded",[_134.get("value"),d.currency.format(_138,{round:_139.round,places:_139.places})]);}else{_13f=misys.getLocalization("noAmountForRiskLimitError");}m.dialog.show(_1,_13f,"Info");return true;}else{var _140=dj.byId("ln_amt");if(_138>0){_140.invalidMessage=misys.getLocalization("loanRiskTypeLimtAmtExceeded",[_134.get("value"),d.currency.format(_138,{round:_139.round,places:_139.places})]);}else{_140.invalidMessage=misys.getLocalization("noAmountForRiskLimitError");}}return false;}return true;};function _141(){if(window.editMode===true){return _142();}var _143=dj.byId("bo_facility_id").get("value");var _144=dj.byId("ln_amt").get("value");var _145=dijit.byId("ln_cur_code");var _146=window.opener.borrowerTypeLimitStore;var _147;var _148;var flag=false;var _149=d.cldr.monetary.getData(_145.get("value"));_146.fetch({query:{id:_143},onComplete:d.hitch(dj.byId("bo_facility_id"),function(_14a,_14b){var item=_14a[0];if(item){var _14c=_a8();_147=item.dummyBorrowerTypeLimitAmount[0];var _14d;if(typeof _147==="string"||_147 instanceof String){_14d=item.dummyBorrowerTypeLimitAmount[0].split(",").join("");}else{_14d=item.dummyBorrowerTypeLimitAmount[0];}var _14e=parseFloat(_14c)+parseFloat(_14d);_148=_14e.toFixed(2);if(parseFloat(_144)>(_14e.toFixed(2))){flag=true;}}})});if(flag){var _14f=window.opener.limitValidationFlag;if(_14f==="error"){var _150=dj.byId("ln_amt");if(_148>0){_150.invalidMessage=misys.getLocalization("loanBorrowerTypeLimtAmtExceeded",[_145.get("value"),d.currency.format(_148,{round:_149.round,places:_149.places})]);}else{_150.invalidMessage=misys.getLocalization("noAmountForBorrowerLimitError");}return false;}else{var _151;if(_148>0){_151=misys.getLocalization("loanBorrowerTypeLimtAmtExceeded",[_145.get("value"),d.currency.format(_148,{round:_149.round,places:_149.places})]);}else{_151=misys.getLocalization("noAmountForBorrowerLimitError");}m.dialog.show(_1,_151,"Info");return true;}}return true;};function _152(){if(window.editMode===true){return _153();}var _154=dj.byId("bo_facility_id").get("value");var _155=dj.byId("ln_amt").get("value");var _156=dijit.byId("ln_cur_code");var _157=window.opener.currencyTypeLimitStore;var _158;var _159;var flag=false;var _15a=d.cldr.monetary.getData(_156.get("value"));_157.fetch({query:{id:_154},onComplete:d.hitch(dj.byId("bo_facility_id"),function(_15b,_15c){var item=_15b[0];if(item){var _15d=_a8();_158=item.dummyCurrencyLimitAmount[0];var _15e;if(typeof _158==="string"||_158 instanceof String){_15e=item.dummyCurrencyLimitAmount[0].split(",").join("");}else{_15e=item.dummyCurrencyLimitAmount[0];}var _15f=parseFloat(_15d)+parseFloat(_15e);_159=_15f.toFixed(2);if(parseFloat(_155)>(_15f.toFixed(2))){flag=true;}}})});if(flag){var _160=window.opener.limitValidationFlag;var _161=dj.byId("ln_cur_code").get("value");if(_160==="error"){var _162=dj.byId("ln_amt");if(_159>0){_162.invalidMessage=misys.getLocalization("loanCurrencyTypeLimtAmtExceeded",[_156.get("value"),d.currency.format(_159,{round:_15a.round,places:_15a.places})]);}else{_162.invalidMessage=misys.getLocalization("noAmountForCurrencyLimitError",[_161]);}return false;}else{var _163;if(_159>0){_163=misys.getLocalization("loanCurrencyTypeLimtAmtExceeded",[_156.get("value"),d.currency.format(_159,{round:_15a.round,places:_15a.places})]);}else{_163=misys.getLocalization("noAmountForCurrencyLimitError",[_161]);}m.dialog.show(_1,_163,"Info");return true;}}return true;};function _153(){var _164=dj.byId("bo_facility_id").get("value");var _165=window.opener.newLoanGrid;var _166=0;var _167=0;var _168;var _169;if(_165&&_165.store){_165.store.fetch({query:{new_loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_16a,_16b){dojo.forEach(_16a,function(item){if(_164==item.new_loan_facility_id){var _16c=""+item.new_loan_outstanding_amt[0];_166=parseFloat(_166)+parseFloat(_16c.split(",").join(""));_166=_166.toFixed(2);}},this);})});}var _16d=dijit.byId("ln_amt").get("value");var _16e=dijit.byId("ln_cur_code");var _16f=0;var _170=d.cldr.monetary.getData(_16e.get("value"));if(misys._config.facilityId===_164){_16f=dj.byId("dummy_ln_amt").get("value");if(typeof _16f==="string"||_16f instanceof String){_16f=_16f.split(",").join("");}}var _171;if(_16f>_16d){_167=parseFloat(_16f)-parseFloat(_16d);_171=parseFloat(_166)-parseFloat(_167);}else{_167=parseFloat(_16d)-parseFloat(_16f);_171=parseFloat(_166)+parseFloat(_167);}var _172=window.opener.currencyTypeLimitStore;var flag=false;_172.fetch({query:{id:_164},onComplete:d.hitch(dj.byId("bo_facility_id"),function(_173,_174){var item=_173[0];if(item){var _175=_a8();var _176=parseFloat(_175)+parseFloat(item.currencyLimitAmount[0].split(",").join(""));_169=_176.toFixed(2)-(_166-parseFloat(_16f));if(parseFloat(_16d)>_176.toFixed(2)||_171>_176.toFixed(2)){flag=true;}}})});if(flag){var _177=window.opener.limitValidationFlag;var _178=dj.byId("ln_cur_code").get("value");if(_177==="error"){var _179=dj.byId("ln_amt");if(_169>0){_179.invalidMessage=misys.getLocalization("loanCurrencyTypeLimtAmtExceeded",[_16e.get("value"),d.currency.format(_169,{round:_170.round,places:_170.places})]);}else{_179.invalidMessage=misys.getLocalization("noAmountForCurrencyLimitError",[_178]);}return false;}else{var _17a;if(_169>0){_17a=misys.getLocalization("loanCurrencyTypeLimtAmtExceeded",[_16e.get("value"),d.currency.format(currencyLimit,{round:_170.round,places:_170.places})]);}else{_17a=misys.getLocalization("noAmountForCurrencyLimitError",[_178]);}m.dialog.show(_1,_17a,"Info");return true;}}return true;};function _142(){var _17b=dj.byId("bo_facility_id").get("value");var _17c=window.opener.newLoanGrid;var _17d=0;var _17e=0;var _17f;var _180;if(_17c&&_17c.store){_17c.store.fetch({query:{new_loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_181,_182){dojo.forEach(_181,function(item){if(_17b==item.new_loan_facility_id){var _183=""+item.new_loan_outstanding_amt[0];_17d=parseFloat(_17d)+parseFloat(_183.split(",").join(""));}},this);})});}var _184=dijit.byId("ln_amt").get("value");var _185=dijit.byId("ln_cur_code");var _186=d.cldr.monetary.getData(_185.get("value"));var _187=0;if(misys._config.facilityId===_17b){_187=dj.byId("dummy_ln_amt").get("value");if(typeof _187==="string"||_187 instanceof String){_187=_187.split(",").join("");}}var _188;if(_187>_184){_17e=parseFloat(_187)-parseFloat(_184);_188=parseFloat(_17d)-parseFloat(_17e);}else{_17e=parseFloat(_184)-parseFloat(_187);_188=parseFloat(_17d)+parseFloat(_17e);}var _189=window.opener.borrowerTypeLimitStore;var flag=false;_189.fetch({query:{id:_17b},onComplete:d.hitch(dj.byId("bo_facility_id"),function(_18a,_18b){var item=_18a[0];if(item){var _18c=_a8();var _18d=item.borrowerTypeLimitAmount[0];var _18e;if(typeof _18d==="string"||_18d instanceof String){_18e=item.borrowerTypeLimitAmount[0].split(",").join("");}else{_18e=item.borrowerTypeLimitAmount[0];}var _18f=parseFloat(_18c)+parseFloat(_18e);_180=_18f.toFixed(2)-(_17d-parseFloat(_187));if(parseFloat(_184)>_18f.toFixed(2)||_188>_18f.toFixed(2)){flag=true;}}})});if(flag){var _190=window.opener.limitValidationFlag;if(_190==="error"){var _191=dj.byId("ln_amt");if(_180>0){_191.invalidMessage=misys.getLocalization("loanBorrowerTypeLimtAmtExceeded",[_185.get("value"),d.currency.format(_180,{round:_186.round,places:_186.places})]);}else{_191.invalidMessage=misys.getLocalization("noAmountForBorrowerLimitError");}return false;}else{var _192;if(_180>0){_192=misys.getLocalization("loanBorrowerTypeLimtAmtExceeded",[_185.get("value"),d.currency.format(_180,{round:_186.round,places:_186.places})]);}else{_192=misys.getLocalization("noAmountForBorrowerLimitError");}m.dialog.show(_1,_192,"Info");return true;}}return true;};function _131(){var _193=dj.byId("bo_facility_id").get("value");var _194=window.opener.newLoanGrid;var _195=0;var _196=0;var _197;var _198;if(_194&&_194.store){_194.store.fetch({query:{new_loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_199,_19a){dojo.forEach(_199,function(item){if(_193==item.new_loan_facility_id){var _19b=""+item.new_loan_outstanding_amt[0];_195=parseFloat(_195)+parseFloat(_19b.split(",").join(""));}},this);})});}var _19c=dijit.byId("ln_amt").get("value");var _19d=dijit.byId("ln_cur_code");var _19e=0;var _19f=d.cldr.monetary.getData(_19d.get("value"));if(misys._config.facilityId===_193){_19e=dj.byId("dummy_ln_amt").get("value");if(typeof _19e==="string"||_19e instanceof String){_19e=_19e.split(",").join("");}}var _1a0;if(_19e>_19c){_196=parseFloat(_19e)-parseFloat(_19c);_1a0=parseFloat(_195)-parseFloat(_196);}else{_196=parseFloat(_19c)-parseFloat(_19e);_1a0=parseFloat(_195)+parseFloat(_196);}var _1a1=_a8();var _1a2=window.opener.riskTypeLimitStore;var flag=false;_1a2.fetch({query:{id:_193},onComplete:d.hitch(dj.byId("bo_facility_id"),function(_1a3,_1a4){var item=_1a3[0];if(item){var _1a5=""+item.riskTypeLimitAmount[0];var _1a6=parseFloat(_1a5.split(",").join(""))+parseFloat(_1a1);_197=_1a6.toFixed(2)-(_195-parseFloat(_19e));if(parseFloat(_19c)>_1a6.toFixed(2)||_1a0>_1a6.toFixed(2)){flag=true;}}})});if(flag){var _1a7=window.opener.limitValidationFlag;if(_1a7==="error"){var _1a8=dj.byId("ln_amt");if(_197>0){_1a8.invalidMessage=misys.getLocalization("loanRiskTypeLimtAmtExceeded",[_19d.get("value"),d.currency.format(_197,{round:_19f.round,places:_19f.places})]);}else{_1a8.invalidMessage=misys.getLocalization("noAmountForRiskLimitError");}return false;}else{var _1a9;if(riskTypeLimitAmt>0){_1a9=misys.getLocalization("loanRiskTypeLimtAmtExceeded",[_19d.get("value"),d.currency.format(riskTypeLimitAmt,{round:_19f.round,places:_19f.places})]);}else{_1a9=misys.getLocalization("noAmountForRiskLimitError");}m.dialog.show(_1,_1a9,"Info");return true;}}return true;};function _ee(){var _1aa=dj.byId("bo_facility_id").get("value");var _1ab=window.opener.newLoanGrid;var _1ac=0;var _1ad=0;var _1ae;if(_1ab&&_1ab.store){_1ab.store.fetch({query:{new_loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_1af,_1b0){dojo.forEach(_1af,function(item){if(_1aa==item.new_loan_facility_id){var _1b1=""+item.new_loan_outstanding_amt[0];_1ac=parseFloat(_1ac)+parseFloat(_1b1.split(",").join(""));}},this);})});}var _1b2=dijit.byId("ln_amt").get("value");var _1b3=dijit.byId("ln_cur_code");var _1b4=dj.byId("dummy_ln_amt").get("value");if(typeof _1b4==="string"||_1b4 instanceof String){_1b4=_1b4.split(",").join("");}var _1b5;var _1b6=d.cldr.monetary.getData(_1b3.get("value"));if(_1b4>_1b2){_1ad=parseFloat(_1b4)-parseFloat(_1b2);_1b5=parseFloat(_1ac)-parseFloat(_1ad);}else{_1ad=parseFloat(_1b2)-parseFloat(_1b4);_1b5=parseFloat(_1ac)+parseFloat(_1ad);}var _1b7=window.opener.facilityAvailableAmountStore;var flag=false;var _1b8;_1b7.fetch({query:{id:_1aa},onComplete:d.hitch(dj.byId("bo_facility_id"),function(_1b9,_1ba){var item=_1b9[0];if(item){if(_1aa==item.new_loan_facility_id){var _1bb=_a8();var _1bc=""+item.borrowerAvailableLimitAmount[0];_1b8=parseFloat(_1bb)+parseFloat(_1bc.split(",").join(""));_1b8=_1b8.toFixed(2);}if(parseFloat(_1b2)>_1b8||_1b5>_1b8){flag=true;}}})});if(flag){var _1bd=dj.byId("ln_amt");_1bd.invalidMessage=misys.getLocalization("loanIncreaseFacilityAvailableAmountError",[_1b3.get("value"),d.currency.format(_1b8,{round:_1b6.round,places:_1b6.places})]);return false;}return true;};function _60(){if(!_25()){var _1be=dj.byId("ln_amt");var _1bf=dj.byId("bo_facility_id");var _1c0=new Array();var _1c1=0;var _1c2;var _1c3;window.opener.facilitiesStore.fetch({query:{id:"*"},onComplete:d.hitch(this,function(_1c4,_1c5){dojo.forEach(_1c4,function(item){var _1c6=item.status;if(_1c6[0]==="Expired"){_1c0[_1c1]=item.id[0];_1c1=_1c1+1;}},this);})});var _1c7=window.opener.oldLoanGrid;var _1c8=0;if(_1c7&&_1c7.store){_1c7.store.fetch({query:{loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_1c9,_1ca){dojo.forEach(_1c9,function(item){var _1cb=""+item.loan_facility_id;if(_1c0.indexOf(_1cb)>-1&&_1bf.get("value")===_1cb){var _1cc=item.loan_current_amt[0];if(typeof _1cc==="string"||_1cc instanceof String){_1c2=item.loan_current_amt[0].split(",").join("");}else{_1c2=item.loan_current_amt[0];}_1c8=parseFloat(_1c8)+parseFloat(_1c2);}},this);})});}var _1cd=window.opener.newLoanGrid;var _1ce=0;var _1cf=dijit.byId("ref_id").get("value");if(_1cd&&_1cd.store){_1cd.store.fetch({query:{new_loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_1d0,_1d1){dojo.forEach(_1d0,function(item){if(_1cf!==item.new_loan_ref_id[0]){var _1d2=""+item.new_loan_facility_id;if(_1c0.indexOf(_1d2)>-1&&_1bf.get("value")===_1d2){var _1d3=item.new_loan_outstanding_amt[0];if(typeof _1d3==="string"||_1d3 instanceof String){_1c3=item.new_loan_outstanding_amt[0].split(",").join("");}else{_1c3=item.new_loan_outstanding_amt[0];}_1ce=parseFloat(_1ce)+parseFloat(_1c3);}}},this);})});}if(_1c8>0){var _1d4=parseFloat(_1c8)-parseFloat(_1ce);if(_1be.get("value")>_1d4){var _1d5=misys.getLocalization("loanIncreaseOnExpiredFacilityError");m.dialog.show("ERROR",_1d5);return false;}return true;}else{return true;}}return true;};function _61(){var _1d6=dijit.byId("ln_amt");var _1d7=dijit.byId("ref_id").get("value");if(_1d6.get("value")==null){return true;}var _1d8=_1d6.get("value");if(!parseFloat(_1d8)>0){var _1d9=misys.getLocalization("loanAmountZeroError");m.dialog.show("ERROR",_1d9);return false;}var _1da=window.opener.totalRepricingLoanAmt;var _1db=window.opener.totalNewRepricingLoanAmt;var _1dc=window.opener.newLoanGrid;var _1dd=window.opener.loanIncreaseFlag;var _1de=0;if(_1dc&&_1dc.store){_1dc.store.fetch({query:{new_loan_ref_id:_1d7},onComplete:dojo.hitch(this,function(_1df,_1e0){dojo.forEach(_1df,function(item){var _1e1=""+item.new_loan_outstanding_amt[0];_1db=parseFloat(_1db.toFixed(2))-parseFloat(_1e1.split(",").join(""));},this);})});}if((parseFloat(_1d8)+parseFloat(_1db))>parseFloat(_1da)){if(_1dd==="false"){var _1e2=misys.getLocalization("loanRepricingAmountError");m.dialog.show("ERROR",_1e2);return false;}else{var _1e3=function(){if(window.editMode===true){_1e4();}else{_1e5();}window.close();};m.dialog.show("CONFIRMATION",misys.getLocalization("loanIncreaseRepricingAmountError"," "),"",null,null,"",_1e3);return false;}}return true;};function _1e6(){var _1e7=dijit.byId("repricing_date").get("value");var _1e8=dijit.byId("effective_date").get("value");if(_1e7>=_1e8){return true;}else{return false;}};function _5f(){var _1e9=dijit.byId("repricing_date");var _1ea;if(_1e9.get("value")==null){return true;}var _1eb=dijit.byId("effective_date");if(!m.compareDateFields(_1eb,_1e9)){_1ea=misys.getLocalization("loanRepricingDateGreaterThanLoanEffDateError",[m.getLocalizeDisplayDate(_1e9),m.getLocalizeDisplayDate(_1eb)]);m.dialog.show("ERROR",_1ea);return false;}var _1ec=dijit.byId("ln_maturity_date");if(!m.compareDateFields(_1e9,_1ec)){_1ea=misys.getLocalization("loanRepricingDateLessThanLoanMatDateError",[m.getLocalizeDisplayDate(_1e9),m.getLocalizeDisplayDate(_1ec)]);m.dialog.show("ERROR",_1ea);return false;}var _1ed=dijit.byId("facility_maturity_date");if(!m.compareDateFields(_1e9,_1ed)){_1ea=misys.getLocalization("loanRepricingDateLessThanFacMatDateError",[m.getLocalizeDisplayDate(_1e9),m.getLocalizeDisplayDate(_1ed)]);m.dialog.show("ERROR",_1ea);return false;}return true;};d.mixin(m,{bind:function(){misys.setValidation("ln_maturity_date",_2);m.connect("ln_amt","onBlur",_2d);misys.setValidation("effective_date",_90);m.connect("bo_facility_id","onChange",_1ee);misys.connect("pricing_option","onChange",_1ef);misys.connect("pricing_option","onChange",_1f0);m.connect("repricing_frequency","onChange",_1f1);m.connect("effective_date","onChange",_1f2);m.connect("repricing_date","onChange",function(){if(misys._config.isReprcingDateFlag&&_1e6()){_1f3();}else{misys._config.isReprcingDateFlag=true;}if(dijit.byId("repricingdate_validation").value=="true"){if(_2d()){dijit.byId("ln_amt").set("state","");}}});},onFormLoad:function(){var _1f4=dijit.byId("bo_facility_id");var _1f5=dj.byId("pricing_option");var _1f6=dj.byId("risk_type");_1f6.set("disabled",true);var _1f7=dj.byId("repricing_frequency");_1f4.set("store",window.opener.facilitiesStore);var _1f8=dj.byId("ln_cur_code");_1f8.set("value",window.opener.loan_currency);_1f8.set("disabled",true);if(dijit.byId("ln_cur_code")){misys.setCurrency(dijit.byId("ln_cur_code"),["ln_amt"]);}_1f9();_1fa();var _1fb=dj.byId("effective_date");_1fb.set("displayedValue",window.opener.earliestRepricingDate);_1fb.set("disabled",true);window.editLoanItem=null;window.editMode=false;if(window.opener.refId){var _1fc=dijit.byId("ref_id");_1fc.set("value",window.opener.refId);var _1fd=window.opener.refId;var _1fe;var _1ff;var _200;var _201=window.opener.newLoanGrid;if(_201&&_201.store){_201.store.fetch({query:{new_loan_ref_id:_1fd},onComplete:dojo.hitch(this,function(_202,_203){dojo.forEach(_202,function(item){_1f4.set("value",item.new_loan_facility_id[0]);window.editLoanItem=item;window.editMode=true;},this);})});}if(window.editMode==true){var _204=window.editLoanItem;if(_204){dj.byId("cust_ref_id").set("value",_204.new_loan_our_ref[0]);dj.byId("cust_ref_id").set("displayedValue",_204.new_loan_our_ref[0]);}}_1f5.set("value",_1fe);_1f5.set("displayedValue",_1fe);}else{var _205=0;var _206=function(size,_207){_205=size;};_1f4.store.fetch({query:{},onBegin:_206,start:0,count:0});if(_205===1){_1f4.store.fetch({onComplete:function(_208,_209){var item=_208[0];_1f4.set("value",item.id[0]);}});}}var _20a=window.opener.fac_cur_code;var _20b=window.opener.loan_currency;var _20c=dojo.byId("facFXRateId");var _20d=window.opener.fxConversionRate;if(_20b!==_20a){dijit.byId("fx_display").set("value","1 "+_20a+" = "+_20d+" "+_20b);dijit.byId("fx_conversion_rate").set("value",_20d);dojo.style(_20c,"display","block");}misys._config.facilityId=dijit.byId("bo_facility_id").get("value");},addNewRepriceLoan:function(){var _20e=_5c();if(_20e){if(window.editMode===true){_1e4();}else{_1e5();}if(false===window.closed){window.close();}}},cancelRepriceLoan:function(){if(false===window.closed){window.close();}}});function _1e5(){var _20f=dj.byId("repricing_date").get("displayedValue");var _210=dj.byId("ln_maturity_date").get("displayedValue");var _211=dj.byId("effective_date").get("displayedValue");var _212=dj.byId("bo_facility_id").get("value");var _213=dj.byId("bo_facility_id").get("displayedValue");var _214=dj.byId("ln_amt").get("displayedValue");var _215=dj.byId("ln_amt").get("value");var _216=dj.byId("ref_id").get("value");var _217=dj.byId("new_ln_tnxid").get("value");var _218=dj.byId("pricing_option").get("value");var _219=dj.byId("pricing_option").get("displayedValue");var _21a=dj.byId("risk_type").get("value");var _21b=dj.byId("repricing_frequency").get("value");var _21c=dj.byId("repricing_frequency").get("displayedValue");var _21d=dj.byId("match_funding").get("value");var fcn=dj.byId("fcn").get("value");var _21e=dj.byId("cust_ref_id").get("value");var _21f=window.opener.bo_deal_name;var _220=window.opener.fxConversionRate;var _221=window.opener.fac_cur_code;var _222=window.opener.bo_deal_id;var _223=window.opener.loan_currency;var _224=window.opener.loan_borrower_reference;var _225=window.opener.entity;var _226=window.opener.newLoanGrid;if(_226&&_226.store){_226.store.newItem({new_loan_ref_id:_216,new_loan_deal_id:_222,new_loan_tnx_id:_217,new_loan_deal_name:_21f,new_loan_entity:_225,new_loan_pricing_option:_218,new_loan_risk_type:_21a,new_loan_effective_date:_211,new_loan_maturity_date:_210,new_loan_repricing_frequency_id:_21b,new_loan_repricing_frequency:_21c,new_loan_pricing_option_disp:_219,new_loan_borrower_reference:_224,new_loan_our_ref:_21e,new_loan_ccy:_223,new_loan_outstanding_amt:_215,new_loan_outstanding_amt_disp:_214,new_loan_repricing_date:_20f,new_loan_facility_name:_213,new_loan_fcn:fcn,new_loan_matchFunding:_21d,new_fx_conversion_rate:_220,new_fac_cur_code:_221,new_loan_facility_id:_212});}if(_226.store._arrayOfAllItems.length==1){_226._refresh();}_227();_228();_229();_c6();_d0();if(window.opener.loanIncreaseFlag==="true"){_6b();}if(dijit.byId("net_cashFlow").value=="true"){_72();}};function _229(){var _22a=window.opener.totalRepricingAmountId.get("value");var _22b=window.opener.totalNewRepricingAmountId.get("value");var _22c=window.opener.totalPrincipalAmount;if(_22a===_22b||_22b>_22a){var _22d="0.00";window.opener.adjustAmuntOptions.set("disabled",true);window.opener.adjustAmuntOptions.set("checked",false);_22c.set("value",_22d);}else{window.opener.adjustAmuntOptions.set("disabled",false);if(window.opener.adjustAmuntOptions.get("value")===""){_22c.set("value","");}}};function _228(){if(window.opener.adjustAmuntOptions.checked===true){var _22e=window.opener.totalRepricingAmountId.get("value");var _22f=window.opener.totalNewRepricingAmountId.get("value");var _230=parseFloat(_22e)-parseFloat(_22f);var _231=window.opener.totalPrincipalAmount;_231.set("value",_230);}};function _227(){var _232=_233();var _234=window.opener.newLoanAmtField;_234.set("value",_232);};function _233(){var _235=window.opener.newLoanGrid;var _236=0;if(_235&&_235.store){_235.store.fetch({query:{new_loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_237,_238){dojo.forEach(_237,function(item){var _239=""+item.new_loan_outstanding_amt[0];_236=parseFloat(_236)+parseFloat(_239.split(",").join(""));},this);})});}return _236;};function _1e4(){var _23a=dj.byId("repricing_date").get("displayedValue");var _23b=dj.byId("ln_maturity_date").get("displayedValue");var _23c=dj.byId("effective_date").get("displayedValue");var _23d=dj.byId("bo_facility_id").get("value");var _23e=dj.byId("bo_facility_id").get("displayedValue");var _23f=dj.byId("ln_amt").get("displayedValue");var _240=dj.byId("ln_amt").get("value");var _241=dj.byId("ref_id").get("value");var _242=dj.byId("pricing_option").get("value");var _243=dj.byId("pricing_option").get("displayedValue");var _244=dj.byId("risk_type").get("value");var _245=dj.byId("repricing_frequency").get("value");var _246=dj.byId("repricing_frequency").get("displayedValue");var _247=dj.byId("match_funding").get("value");var fcn=dj.byId("fcn").get("value");var _248=dj.byId("cust_ref_id").get("value");var _249=window.opener.newLoanGrid;if(_249&&_249.store){_249.store.fetch({query:{new_loan_ref_id:_241},onComplete:dojo.hitch(this,function(_24a,_24b){dojo.forEach(_24a,function(item){_249.store.setValue(item,"new_loan_pricing_option",_242);_249.store.setValue(item,"new_loan_pricing_option_disp",_243);_249.store.setValue(item,"new_loan_risk_type",_244);_249.store.setValue(item,"new_loan_effective_date",_23c);_249.store.setValue(item,"new_loan_maturity_date",_23b);_249.store.setValue(item,"new_loan_repricing_frequency_id",_245);_249.store.setValue(item,"new_loan_repricing_frequency",_246);_249.store.setValue(item,"new_loan_outstanding_amt",_240);_249.store.setValue(item,"new_loan_outstanding_amt_disp",_23f);_249.store.setValue(item,"new_loan_repricing_date",_23a);_249.store.setValue(item,"new_loan_facility_name",_23e);_249.store.setValue(item,"new_loan_fcn",fcn);_249.store.setValue(item,"new_loan_matchFunding",_247);_249.store.setValue(item,"new_loan_facility_id",_23d);_249.store.setValue(item,"new_loan_our_ref",_248);},this);})});_249.store.save();_227();_228();_229();if(window.opener.loanIncreaseFlag==="true"){_6b();}if(dijit.byId("net_cashFlow").value=="true"){_72();}_c6();_d0();}};function _1f9(){dj.byId("repricing_date").set("displayedValue","");dj.byId("repricing_frequency").set("displayedValue","");dj.byId("pricing_option").set("displayedValue","");dj.byId("ln_maturity_date").set("displayedValue","");dj.byId("risk_type").set("value","");dj.byId("ln_amt").set("displayedValue","");dj.byId("effective_date").set("displayedValue","");};function _1fa(){dj.byId("pricing_option").set("disabled",true);dj.byId("ln_maturity_date").set("disabled",true);dj.byId("repricing_frequency").set("disabled",true);dj.byId("repricing_date").set("disabled",true);dj.byId("ln_amt").set("disabled",true);dj.byId("effective_date").set("disabled",true);};function _1ee(){var _24c=dj.byId("bo_facility_id").get("value");var _24d=dijit.byId("pricing_option"),_24e=dijit.byId("risk_type");var _24f=dijit.byId("repricing_frequency");if(_24c){_24f.set("value","");_24f.set("store",null);dj.byId("repricing_date").set("displayedValue","");dj.byId("pricing_option").set("value","");dj.byId("pricing_option").set("disabled",false);dj.byId("risk_type").set("disabled",false);dj.byId("ln_amt").set("disabled",false);var _250=window.editLoanItem;if(_250){dj.byId("ln_maturity_date").set("displayedValue",_250.new_loan_maturity_date[0]);dj.byId("effective_date").set("displayedValue",_250.new_loan_effective_date[0]);dj.byId("ln_amt").set("value",_250.new_loan_outstanding_amt[0]);dj.byId("dummy_ln_amt").set("value",_250.new_loan_outstanding_amt[0]);}window.opener.facilitiesStore.fetch({query:{id:_24c},onComplete:d.hitch(this,function(_251,_252){var item=_251[0];dj.byId("facility_effective_date").set("displayedValue",item.effectiveDate[0]);dj.byId("facility_maturity_date").set("displayedValue",item.maturityDate[0]);dj.byId("facility_expiry_date").set("displayedValue",item.expiryDate[0]);dj.byId("fcn").set("value",item.fcn[0]);dj.byId("fc_access_type").set("value",item.access_type[0]);var _253=dijit.byId("ln_maturity_date");if(_253==""&&dijit.byId("facility_maturity_date")){_253.set("displayedValue",dj.byId("facility_maturity_date").get("displayedValue"));}_253.set("disabled",false);})});var _254=JSON.parse(window.opener.pricingOptionsStores[_24c]);if(_254){_24d.set("store",new dojo.data.ItemFileReadStore(_254));misys._config.maturityMandatoryOptions=_254;misys._config.matchFundingOfPricingOption=_254;if(_250){_24d.set("value",_250.new_loan_pricing_option[0]);}else{var _255=0;var _256=function(size,_257){_255=size;};_24d.store.fetch({query:{},onBegin:_256,start:0,count:0});if(_255===1){_24d.store.fetch({onComplete:function(_258,_259){dojo.forEach(_258,function(item){_24d.set("value",item.name);});}});}else{_24d.set("value","");}}}else{_24d.set("store",null);_24d.set("value","");}var _25a=JSON.parse(window.opener.riskTypesStores[_24c]);if(_25a){var _25b=new dojo.data.ItemFileReadStore(_25a);_25b.fetch({query:{id:"*"},onComplete:d.hitch(this,function(_25c,_25d){var item=_25c[0];dj.byId("risk_type_disp").set("displayedValue",item.name[0]);dj.byId("risk_type").set("value",item.id[0]);})});if(_250){_24e.set("value",_250.new_loan_risk_type[0]);}}}else{_1f9();}};function _1ef(){var _25e=dijit.byId("pricing_option");var _25f=dijit.byId("repricing_frequency");var _260=dj.byId("bo_facility_id").get("value");var _261=_25e.get("value");if(_261&&_260){_25f.set("value","");_25f.set("store",null);dj.byId("repricing_date").set("value","");dj.byId("repricing_date").set("displayedValue","");var _262=JSON.parse(window.opener.pricingOptionsStores[_260]);var _263=new dojo.data.ItemFileReadStore(_262);_263.fetch({query:{id:_261},onComplete:d.hitch(this,function(_264,_265){var item=_264[0];dj.byId("match_funding").set("value",item.matchFundedIndicator[0]);})});var _266=JSON.parse(window.opener.repricingFrequenciesStores[_260]);var _267=_25e.get("value");var _268=_266[_267];if(_268){_25f.set("store",new dojo.data.ItemFileReadStore(_268));var _269=0;var _26a=function(size,_26b){_269=size;};_25f.get("store").fetch({query:{},onBegin:_26a,start:0,count:0});if(_269==0){dj.byId("repricing_frequency").set("disabled",true);dj.byId("repricing_date").set("displayedValue","");dj.byId("repricing_date").set("disabled",true);}else{dj.byId("repricing_frequency").set("disabled",false);dj.byId("repricing_date").set("disabled",false);if(window.editLoanItem){_25f.set("value",window.editLoanItem.new_loan_repricing_frequency_id[0]);dj.byId("repricing_date").set("displayedValue",window.editLoanItem.new_loan_repricing_date[0]);}else{if(_269==1){_25f.get("store").fetch({onComplete:function(_26c,_26d){dojo.forEach(_26c,function(item){_25f.set("value",item.id);_25f.set("displayedValue",item.name);});}});}}}}else{dj.byId("repricing_date").set("displayedValue","");}if(window.editLoanItem){window.editLoanItem=null;}}};function _1f0(){var _26e=dijit.byId("pricing_option");var _26f=dj.byId("bo_facility_id").get("value");var _270=_26e.get("value");if(_270&&_26f){var _271=JSON.parse(window.opener.pricingOptionsStores[_26f]);var _272=new dojo.data.ItemFileReadStore(_271);_272.fetch({query:{id:_270},onComplete:d.hitch(this,function(_273,_274){var item=_273[0];var _275=item.maturityDateMandatory[0];if("Y"===_275){dijit.byId("ln_maturity_date").set("disabled",false);if(dijit.byId("facility_maturity_date")){var _276=dijit.byId("ln_maturity_date");if(_276==""){_276.set("displayedValue",dj.byId("facility_maturity_date").get("displayedValue"));}}}else{if("N"===_275){dijit.byId("ln_maturity_date").set("disabled",true);dijit.byId("ln_maturity_date").set("displayedValue","");}}})});}};function _277(date){var _278=dj.byId("repricing_frequency");if(date.get("value")&&_278.get("value")){var _279=_278.get("value"),_27a,_27b,_27c;if(_279.length>0){_27a=_279.substring(0,_279.length-1);_27b=_279.substring(_279.length-1,_279.length);}if(_27b==="W"){_27c="week";}else{if(_27b==="M"){_27c="month";}else{if(_27b==="Y"){_27c="year";}else{if(_27b==="D"){_27c="day";}}}}return dojo.date.add(date.get("value"),_27c,parseInt(_27a,10));}};function _1f2(){var _27d=dj.byId("repricing_frequency");var _27e=_27d.get("value");var _27f=dj.byId("repricing_date");if(_27e){_1f1();}};function _1f1(){var _280=dj.byId("repricing_date");var _281=dj.byId("effective_date");var _282=dj.byId("repricing_frequency");if(_281.get("value")&&_282.get("value")&&window.editMode===false){_280.set("displayedValue","");_280.set("value",_277(_281));}else{if(_281.get("value")&&_282.get("value")&&window.editMode===true){if(misys._config.count!==1){_280.set("displayedValue","");_280.set("value",_277(_281));}}}misys._config.count=misys._config.count+1;};function _283(){var _284=dj.byId("effective_date");var _285=_277(_284);var _286=dj.byId("repricing_date").get("value");if(_286.getDate()===_285.getDate()&&_286.getMonth()===_285.getMonth()&&_286.getYear()===_285.getYear()){dj.byId("repricing_frequency").set("disabled",false);}else{misys.toggleRequired("repricing_frequency",false);}};function _68(_287){var _288=dijit.byId("pricing_option");var _289=dj.byId("bo_facility_id").get("value");var _28a=_288.get("value");var _28b=dijit.byId("repricing_frequency");var _28c;if(_289&&_28a){if(_287==="repricing_frequency"||_287==="repricing_date"){var _28d=0;var _28e=function(size,_28f){_28d=size;};_28b.get("store").fetch({query:{},onBegin:_28e,start:0,count:0});if(_28d===0){return false;}else{return true;}}else{var _290=JSON.parse(window.opener.pricingOptionsStores[_289]);var _291=new dojo.data.ItemFileReadStore(_290);var _292;var _293=function(_294,_295){var item=_294[0];_292=item.maturityDateMandatory[0];};_291.fetch({query:{id:_28a},onComplete:d.hitch(this,_293)});if("Y"===_292){return true;}else{return false;}}}};function _1f3(){var _296=dj.byId("bo_facility_id").get("value");var _297=dj.byId("pricing_option").get("value");var _298=dijit.byId("repricing_date");var _299=_298.get("displayedValue");var _29a=dj.byId("ln_cur_code").get("value");var _29b=dijit.byId("facility_maturity_date");var _29c="Y";if(m.compareDateFields(_298,_29b)){m.xhrPost({url:m.getServletURL("/screen/AjaxScreen/action/GetBusinessDayValidatedDate"),handleAs:"json",preventCache:true,sync:true,content:{boFacilityId:_296,pricingOptionName:_297,dateToValidate:_299,currency:_29a,isRepricingDate:_29c},load:function(_29d){misys._config.dateValuesResponse=_29d;misys._config.isDirtyFlag=true;if(_29d.items.dateValues&&dj.byId("repricing_date").get("displayedValue")===_29d.items.dateValues[0].localizedDate){misys._config.isRepricingDateFlag=true;}else{misys._config.isRepricingDateFlag=false;}_29f();},error:function(_29e){}});}};function _29f(){var _2a0=dj.byId("repricing_date");var _2a1=dj.byId("repricing_date").get("displayedValue");var _2a2=(dj.byId("repricing_date").get("value")!==null)?dj.byId("repricing_date").get("value"):"";var _2a3;var _2a4=misys._config.dateValuesResponse["items"];_2a0.store=new dojo.data.ItemFileReadStore({data:{identifier:"id",label:"name",items:_2a4["dateValues"]}});var _2a5=0;var _2a6=function(size,_2a7){_2a5=size;};_2a0.get("store").fetch({query:{},onBegin:_2a6,start:0,count:0});var _2a8=_2a0.store._arrayOfTopLevelItems[0].name[0];var darr=_2a8.split("/");var _2a9=new Date(parseInt(darr[2],10),parseInt(darr[1],10)-1,parseInt(darr[0],10));if(_2a0.get("disabled")===false){_2a0.set("value",_2a9);}var _2aa=new Date(_2a2);if(_2a9.valueOf()>_2aa.valueOf()||_2a9.valueOf()<_2aa.valueOf()){var _2ab=m.getLocalization("repricingDateBusinessDayValidationErrorMsg",[_2a1]);m.dialog.show(_1,_2ab,"Info");}};})(dojo,dijit,misys);dojo.require("misys.client.binding.loan.reprice_new_loan_client");}