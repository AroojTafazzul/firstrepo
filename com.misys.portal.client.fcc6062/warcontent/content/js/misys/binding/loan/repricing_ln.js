/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.binding.loan.repricing_ln"]){dojo._hasResource["misys.binding.loan.repricing_ln"]=true;dojo.provide("misys.binding.loan.repricing_ln");dojo.require("dojo.parser");dojo.require("dijit.layout.TabContainer");dojo.require("dijit.form.DateTextBox");dojo.require("misys.form.CurrencyTextBox");dojo.require("dijit.form.NumberTextBox");dojo.require("dijit.form.FilteringSelect");dojo.require("dijit.form.Form");dojo.require("dijit.form.Button");dojo.require("dijit.form.TextBox");dojo.require("misys.widget.Dialog");dojo.require("dijit.ProgressBar");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.CheckBox");dojo.require("dojo.data.ItemFileReadStore");dojo.require("misys.form.file");dojo.require("misys.form.SimpleTextarea");dojo.require("misys.form.common");dojo.require("misys.validation.common");dojo.require("misys.widget.Collaboration");dojo.require("misys.binding.SessionTimer");dojo.require("dojox.xml.DomParser");dojo.require("misys.common");(function(d,dj,m){function _1(_2){var _3="ReportingPopup",_4=[];_4.push("/screen/",_3);_4.push("?option=","ADD_NEW_REPRICING_LN");window.newLoanGrid=dj.byId("gridNewLoanRepricingTransactions");window.oldLoanGrid=dj.byId("gridRepricingLoanTransactions");window.facilitiesStore=misys._config.facilitiesStore;window.riskTypesStores=misys._config.riskTypesStores;window.pricingOptionsStores=misys._config.pricingOptionsStores;window.repricingFrequenciesStores=misys._config.repricingFrequenciesStores;window.facilityAvailableAmountStore=misys._config.facilityAvailableAmountStore;window.riskTypeLimitStore=misys._config.riskTypeLimitStore;window.borrowerTypeLimitStore=misys._config.borrowerTypeLimitStore;window.currencyTypeLimitStore=misys._config.currencyTypeLimitStore;window.newLoanAmtField=dj.byId("total_ln_amt");window.borrowerSettlement=dj.byId("borrower_settlement");window.interestDetailsGrids=dj.byId("gridLayoutInterestDetailsLoanTransactions");window.loanIncreaseAmount=dj.byId("loan_increase_ln_amt");window.loanIncreaseSection=dj.byId("loan_increase_Section");window.loanRemittanceSection=dj.byId("remittance_inst_section");window.loanRemittanceGrid=dj.byId("gridRemittanceInstruction");window.totalRepricingAmountId=dj.byId("total_repricing_ln_amt");window.totalNewRepricingAmountId=dj.byId("total_ln_amt");window.bo_deal_name=dj.byId("deal_name").get("value");window.bo_deal_id=dj.byId("bo_deal_id").get("value");window.loan_currency=dj.byId("loan_ccy").get("value");window.fxConversionRate=dj.byId("fxConversionRate").get("value");window.fac_cur_code=dj.byId("fac_cur_code").get("value");window.cust_ref_id=dj.byId("loan_cust_ref_id").get("value");window.loan_borrower_reference=dj.byId("borrower_reference").get("value");window.totalRepricingLoanAmt=dj.byId("total_repricing_ln_amt").get("value");window.loanIncreaseFlag=dj.byId("loan_increase_flag").get("value");window.limitValidationFlag=dj.byId("limit_validation_flag").get("value");window.totalNewRepricingLoanAmt=dj.byId("total_ln_amt").get("value");window.entity=dj.byId("entity").get("value");window.totalPrincipalAmount=dj.byId("total_principal_amt");window.adjustAmuntOptions=dj.byId("adjust_amount_option");window.earliestRepricingDate=dj.byId("recent_repricing_date").get("value");window.refId=_2;var _5=misys.getLocalization("transactionPopupWindowTitle");var _6=d.global.open(m.getServletURL(_4.join("")),_5,"width=800,height=500,resizable=yes,scrollbars=yes");_6.onbeforeunload=function(){_7();};_6.focus();};function _8(){d.require("misys.widget.Dialog");d.require("dijit.form.Button");var _9=new dj.Dialog({id:"",title:m.getLocalization("warningMessage")});var _a=d.create("div",{id:""});var _b=d.create("div",{id:""},_a,"first");var _c=m.getLocalization("principalPayementWarning");_b.innerHTML=_c;var _d=d.create("div",{id:"",style:"text-align:right;"},_a,"last");var _e=new dj.form.Button({label:m.getLocalization("okMessage"),id:""});d.place(_e.domNode,_d);_9.attr("content",_a);m.dialog.connect(_e,"onClick",function(){_9.hide();},_9.id);m.dialog.connect(_9,"onHide",function(){m.dialog.disconnect(_9);});_9.show();};function _f(_10){var _11={identifier:"description",label:"description",items:misys._config.remittanceInstructions};var _12=new dojo.data.ItemFileReadStore({data:_11});var _13=dijit.byId("gridRemittanceInstruction");if(_13){_13.set("store",_12);_13.startup();_13.render();var _14=dj.byId("rem_inst_description_view"),_15=dj.byId("rem_inst_location_code_view"),_16=dj.byId("rem_inst_servicing_group_alias_view");_13.store.fetch({query:{preferred:"*"},onComplete:dojo.hitch(this,function(_17,_18){dojo.forEach(_17,function(_19,_1a){if(_19.preferred[0]==="Y"&&_14.get("value")===""){_13.selection.select(_1a);}else{if(_14.get("value")===_19.description[0]&&_15.get("value")===_19.locationCode[0]&&_16.get("value")===_19.servicingGroupAlias[0]){_13.selection.select(_1a);}else{_13.selection.deselect(_1a);}}if(_10){_13.rowSelectCell.setDisabled(_1a,true);}else{_13.rowSelectCell.setDisabled(_1a,false);}},this);})});}};function _7(){if(dj.byId("adjust_amount_option").checked===true){var _1b=dj.byId("total_principal_amt").get("value");if(_1b===0||_1b<0){_8();dj.byId("adjust_amount_option").set("checked",false);dj.byId("adjust_amount_option").set("disabled",true);}else{dj.byId("adjust_amount_option").set("disabled",false);}}else{dj.byId("total_principal_amt").set("value",0);}};function _1c(){var _1d=dj.byId("total_repricing_ln_amt").get("value");var _1e=dj.byId("total_ln_amt").get("value");var _1f=dj.byId("loan_increase_flag").get("value");if(_1f==="false"){if(parseFloat(_1e)<parseFloat(_1d)){return true;}else{m.dialog.show("ERROR",misys.getLocalization("loanRepricingAmountError"));}return false;}else{return true;}};function _20(){var _21=dj.byId("interest_Payment_loan_flag");var _22=dijit.byId("gridLayoutInterestDetailsLoanTransactions");var _23=dojo.byId("loan-repricing-interest-details-checkbox");if(_21.get("value")==="true"){dojo.style(_23,"display","none");if(_22&&_22.store){_22.store.fetch({query:{loan_alias:"*"},onComplete:dojo.hitch(this,function(_24,_25){d.forEach(_24,function(_26,_27){if(_26.totalProjectedEOCamt[0]>0){_22.selection.select(_27);_22.rowSelectCell.setDisabled(_27,false);}else{_22.rowSelectCell.setDisabled(_27,true);}},this);})});}}};function _28(){var _29=dijit.byId("gridNewLoanRepricingTransactions");if(_29&&_29.store){var _2a=0;var _2b=function(_2c,_2d){_2a=_2c;};_29.get("store").fetch({query:{},onBegin:_2b,start:0,count:0});if(_2a>0){return true;}else{m._config.onSubmitErrorMsg=misys.getLocalization("emptyLoanRepricingError");return false;}}};function _2e(){var _2f=dj.byId("total_repricing_ln_amt");var _30=dj.byId("total_ln_amt");if(dj.byId("loan_increase_ln_amt")){var _31=dj.byId("loan_increase_ln_amt").get("value");if(!_31>0){if(_2f&&_30&&(parseFloat(_30.get("value"))!==parseFloat(_2f.get("value")))){var _32=0;var _33=_30.get("value");var _34=_2f.get("value");var _35=dj.byId("total_principal_amt").get("value");_32=parseFloat(_35.toFixed(2))+parseFloat(_33.toFixed(2));if(parseFloat(_34)===parseFloat(_32.toFixed(2))){return true;}else{m._config.onSubmitErrorMsg=misys.getLocalization("loanRepricingPrinipalPaymentError");}}else{return true;}return false;}else{return true;}}else{return true;}};function _36(){var _37=dijit.byId("gridRepricingLoanTransactions");var _38=0;if(_37&&_37.store){_37.store.fetch({query:{loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_39,_3a){dojo.forEach(_39,function(_3b){_38=parseFloat(_38)+parseFloat(_3b.loan_current_amt[0].split(",").join(""));},this);})});}dj.byId("total_repricing_ln_amt").set("value",_38);};function _3c(){var _3d=dijit.byId("gridLayoutInterestDetailsLoanTransactions");var _3e=0;if(_3d&&_3d.store){_3d.store.fetch({query:{loan_alias:"*"},onComplete:dojo.hitch(this,function(_3f,_40){dojo.forEach(_3f,function(_41){_3e=parseFloat(_3e)+parseFloat(_41.totalProjectedEOCamt_fmt[0].split(",").join(""));},this);})});}if(_3e===0){var _42=dj.byId("interest_payment");_42.set("disabled",true);_42.set("checked",false);}};function _43(){var _44=dijit.byId("gridRepricingLoanTransactions");var _45=[];if(_44&&_44.store){_44.store.fetch({query:{loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_46,_47){dojo.forEach(_46,function(_48){var _49=d.date.locale.parse(_48.loan_repricing_date[0],{selector:"date",datePattern:m.getLocalization("g_strGlobalDateFormat")});_45.push(_49);},this);})});}var _4a=new Date(Math.min.apply(null,_45));var _4b=dojo.date.locale.format(_4a,{datePattern:m.getLocalization("g_strGlobalDateFormat"),selector:"date"});dj.byId("recent_repricing_date").set("value",_4b);};function _4c(){var _4d=dijit.byId("gridNewLoanRepricingTransactions");var _4e=0;if(_4d&&_4d.store){_4d.store.fetch({query:{new_loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_4f,_50){dojo.forEach(_4f,function(_51){var _52=""+_51.new_loan_outstanding_amt[0];_4e=parseFloat(_4e)+parseFloat(_52.split(",").join(""));},this);})});}dj.byId("total_ln_amt").set("value",_4e);};function _53(){var _54=dj.byId("total_principal_amt");var _55=dj.byId("total_repricing_ln_amt").get("value");var _56=dj.byId("total_ln_amt").get("value");var _57=parseFloat(_55)-parseFloat(_56);var _58=_54.get("value");if(_58>0&&_57===0){_8();}if(dj.byId("adjust_amount_option").checked===false){_54.set("value",0);}else{_54.set("value",_57);}if(_57===0){dj.byId("adjust_amount_option").set("disabled",true);}else{dj.byId("adjust_amount_option").set("disabled",false);}};function _59(_5a,_5b){var _5c=""+_5a;var _5d=""+_5b;var _5e=misys._config.riskTypeLimitStore;_5e.fetch({query:{id:_5c},onComplete:dojo.hitch(this,function(_5f,_60){var _61=_5f[0];if(_61){var _62=""+_61.dummyRiskTypeLimitAmount[0];_61.dummyRiskTypeLimitAmount[0]=parseFloat(_62.split(",").join(""))+parseFloat(_5d.split(",").join(""));}})});var _63=misys._config.borrowerTypeLimitStore;_63.fetch({query:{id:_5c},onComplete:dojo.hitch(this,function(_64,_65){var _66=_64[0];if(_66){var _67=""+_66.dummyBorrowerTypeLimitAmount[0];_66.dummyBorrowerTypeLimitAmount[0]=parseFloat(_67.split(",").join(""))+parseFloat(_5d.split(",").join(""));}})});var _68=misys._config.currencyTypeLimitStore;_68.fetch({query:{id:_5c},onComplete:dojo.hitch(this,function(_69,_6a){var _6b=_69[0];if(_6b){var _6c=""+_6b.dummyCurrencyLimitAmount[0];_6b.dummyCurrencyLimitAmount[0]=parseFloat(_6c.split(",").join(""))+parseFloat(_5d.split(",").join(""));}})});};function _6d(_6e,_6f){var _70=""+_6e;var _71=""+_6f;var _72=misys._config.facilityAvailableAmountStore;_72.fetch({query:{id:_70},onComplete:dojo.hitch(this,function(_73,_74){var _75=_73[0];if(_75){var _76=""+_75.dummyBorrowerAvailableLimitAmount[0];_75.dummyBorrowerAvailableLimitAmount[0]=parseFloat(_76.split(",").join(""))+parseFloat(_71.split(",").join(""));}})});};function _77(){var _78=dj.byId("total_repricing_ln_amt").get("value");var _79=dj.byId("total_ln_amt").get("value");var _7a=dojo.byId("loan_increase_Section");var _7b=dojo.byId("remittance_inst_section");if(_79>_78){_7c();dojo.style(_7a,"display","block");if(_7b){dojo.style(_7b,"display","block");}dj.byId("adjust_amount_option").set("disabled",true);}else{dojo.style(_7a,"display","none");if(_7b){dojo.style(_7b,"display","none");}}};function _7d(){var _7e=dj.byId("borrower_settlement");var _7f=dj.byId("total_ln_amt");var _80=dj.byId("total_principal_amt");var _81=dj.byId("loan_increase_ln_amt");if(_7e&&!(_7f.get("value")>0||_80.get("value")>0)){_7e.set("checked",true);}if(dijit.byId("net_cashFlow").value=="true"&&_81){var _82=_83();var _84=_81.get("value");if(_84>0&&_84<=_82){_7e.set("checked",false);_7e.set("disabled",true);}}};function _83(){var _85=dijit.byId("gridLayoutInterestDetailsLoanTransactions");var _86=0;if(_85&&_85.store){_85.store.fetch({query:{loan_alias:"*"},onComplete:dojo.hitch(this,function(_87,_88){dojo.forEach(_87,function(_89){_86=parseFloat(_86)+parseFloat(_89.totalProjectedEOCamt_fmt[0].split(",").join(""));},this);})});}return _86;};function _8a(){var _8b=misys._config.riskTypeLimitStore;var _8c=misys._config.currencyTypeLimitStore;var _8d=misys._config.borrowerTypeLimitStore;var _8e=[];var _8f=dj.byId("gridNewLoanRepricingTransactions");var _90=0;if(_8f&&_8f.store){_8f.store.fetch({query:{new_loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_91,_92){dojo.forEach(_91,function(_93){var _94=""+_93.new_loan_facility_id[0];var _95=""+_93.new_loan_outstanding_amt[0];_8e.push({facilityId:_94,loanAmount:_95});},this);})});}for(var i=0;i<_8e.length;i++){var _96=_8e[i].facilityId;var _97=_8e[i].loanAmount;var _98;_8d.fetch({query:{id:_96},onComplete:d.hitch(this,function(_99,_9a){var _9b=_99[0];if(_9b){var _9c=""+_9b.dummyBorrowerTypeLimitAmount[0];if(_9c!=""){_98=parseFloat(_9c.split(",").join(""));_98=_98-parseFloat(_97.split(",").join(""));_9b.dummyBorrowerTypeLimitAmount[0]=parseFloat(_98);}}})});var _9d;_8b.fetch({query:{id:_96},onComplete:d.hitch(this,function(_9e,_9f){var _a0=_9e[0];if(_a0){var _a1=""+_a0.dummyRiskTypeLimitAmount[0];if(_a1!=""){_9d=parseFloat(_a1.split(",").join(""));_9d=_9d-parseFloat(_97.split(",").join(""));_a0.dummyRiskTypeLimitAmount[0]=parseFloat(_9d);}}})});var _a2;_8c.fetch({query:{id:_96},onComplete:d.hitch(this,function(_a3,_a4){var _a5=_a3[0];if(_a5){var _a6=""+_a5.dummyCurrencyLimitAmount[0];if(_a6!=""){_a2=parseFloat(_a6.split(",").join(""));_a2=_a2-parseFloat(_97.split(",").join(""));_a5.dummyCurrencyLimitAmount[0]=parseFloat(_a2);}}})});}};function _7c(){var _a7=dj.byId("total_repricing_ln_amt").get("value");var _a8=dj.byId("total_ln_amt").get("value");var _a9=parseFloat(_a8)-parseFloat(_a7);var _aa=dj.byId("loan_increase_ln_amt");_aa.set("value",_a9);};function _ab(){var _ac=dj.byId("interest_Payment_loan_flag");if(_ac.get("value")==="false"){var _ad=dj.byId("interest_payment");if(_ad.checked===true){dojo.style(dojo.byId("loanInterestDetailsGrid"),"display","block");}else{dojo.style(dojo.byId("loanInterestDetailsGrid"),"display","none");}dijit.byId("gridLayoutInterestDetailsLoanTransactions").resize();}};function _ae(){var _af=misys._config.MaturedFacilityStore;var _b0=dijit.byId("bo_deal_id").get("value");var _b1=dijit.byId("gridRepricingLoanTransactions");var _b2=[];var _b3=[];var _b4=[],_b5=true,_b6;var _b7=[];if(_b1&&_b1.store){_b1.store.fetch({query:{loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_b8,_b9){d.forEach(_b8,function(_ba){_b3.push(_ba.loan_facility_id[0]);},this);})});}var _bb=dj.byId("gridNewLoanRepricingTransactions");var _bc;if(_bb&&_bb.store){_bb.store.fetch({query:{new_loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_bd,_be){dojo.forEach(_bd,function(_bf){_b2.push(_bf.new_loan_facility_id[0]);},this);})});}_b4.push(_b3);_b4.push(_b2);if(_af&&_af._jsonData.items[_b0].length!==0){var _c0=_af._jsonData.items;var _c1=_c0[_b0];var i,j;for(i=0;i<_c1.length;i++){var _c2=_c1[i].facilityID;var _c3=_c1[i].facilityName;for(j=0;j<_b4.length;j++){var _c4=_b4[j];if(_c2==_c4){_b5=false;if(dojo.indexOf(_b7,_c3)===-1){_b7.push(_c3);}}}}}var _c5=function(){var _c6=m._config.homeUrl;var _c7=dijit.byId("mode").get("value");var _c8=dijit.byId("tnxtype").get("value");var _c9=["/screen/LoanScreen?tnxtype="+_c8+"&mode="+_c7];_c6=misys.getServletURL(_c9.join(""));document.location.href=_c6;};if(!_b5){m.dialog.show("ERROR",misys.getLocalization("maturedFacilityError",[_b7.toString()]),null,_c5);}};function _ca(){var _cb=true;var _cc;m.xhrPost({url:m.getServletURL("/screen/AjaxScreen/action/ValidateRepricingLoanLimitAmount"),handleAs:"json",preventCache:true,sync:true,content:{xml:misys.formToXML({ignoreDisabled:true})},load:function(_cd,_ce){_cb=_cd.isValid;_cc=_cd.errorMsg;},error:function(_cf,_d0){_cb=false;console.error("Process repricing error due to limit violation",_cf);}});if(!_cb){m._config.onSubmitErrorMsg=_cc;return false;}else{return true;}};function _d1(){var _d2={identifier:"description",label:"description",items:misys._config.remittanceInstructions};var _d3=dj.byId("bk_cur_code").get("value");var _d4=0;if(_d2.items&&_d2.items.length){_d4=_d2.items.length;}var _d5=true;var y;for(y=0;y<_d4;y++){if(_d3===_d2.items[y].currency[0]){_d5=false;break;}}if(dijit.byId("remittance_flag").get("value")==="mandatory"&&!_d5){var _d6=dijit.byId("gridRemittanceInstruction");var _d7=_d6.selection.getSelected();if(_d7.length!==0){return true;}else{if(dj.byId("screenMode").get("value")==="UNSIGNED"){m._config.onSubmitErrorMsg=misys.getLocalization("ErrorForMandatoryRemittanceForCheckerUser");}else{m._config.onSubmitErrorMsg=misys.getLocalization("ErrorForMandatoryRemittance");}return false;}}return true;};function _d8(){var _d9=dijit.byId("ref_id");var _da=dijit.byId("borrower_reference").get("value");var _db=dijit.byId("gridRepricingLoanTransactions");var _dc="";var _dd="",_de=true,_df=false,_e0;var _e1=dijit.byId("bo_deal_id").get("value");var _e2=misys._config.MaturedFacilityStore;var _e3=(_e2&&_e2._jsonData.items[_e1].length!==0)?JSON.stringify(_e2._jsonData.items):"";if(_db&&_db.store){_db.store.fetch({query:{loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_e4,_e5){d.forEach(_e4,function(_e6){_dd=_dd.concat(_e6.loan_ref_id[0]);_dd=_dd.concat(",");},this);})});}var _e7=dj.byId("gridNewLoanRepricingTransactions");var _e8;if(_e7&&_e7.store){_e7.store.fetch({query:{new_loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_e9,_ea){dojo.forEach(_e9,function(_eb){_e8=""+_eb.new_loan_effective_date[0];_dc=_dc.concat(_eb.new_loan_ref_id[0]);_dc=_dc.concat(",");},this);})});}m.xhrPost({url:m.getServletURL("/screen/AjaxScreen/action/ValidateRepricingTransaction"),handleAs:"json",preventCache:true,sync:true,content:{ref_id:_d9.get("value"),linkedLoans:_dd,effectiveDate:_e8,borrowerId:_da,newlinkedLoansRefIds:_dc,facilitydata:_e3,deal_id:dijit.byId("bo_deal_id").get("value")},load:function(_ec,_ed){_de=_ec.isValid;_e0=_ec.errorMsg;_df=_ec.isFacilityMatured;},error:function(_ee,_ef){console.error(" processRepricingOfRecords error",_ee);}});if(_df){m._config.onSubmitErrorMsg=_e0;return false;}if(!_de){m._config.onSubmitErrorMsg=_e0;return false;}else{return true;}};d.mixin(m._config,{initReAuthParams:function(){var _f0={productCode:"BK",subProductCode:"LNRPN",transactionTypeCode:"01",entity:dj.byId("entity")?dj.byId("entity").get("value"):"",currency:"",amount:"",es_field1:"",es_field2:""};return _f0;}});d.mixin(m,{bind:function(){m.connect("adjust_amount_option","onClick",_53);m.connect("interest_payment","onChange",_ab);if(dj.byId("screenMode").get("value")==="UNSIGNED"){_f(true);}else{_f(false);}},getLinkedLoansInterestDetailsAction:function(_f1,_f2){if(!_f2){return this.defaultValue;}return {ref_id:this.grid.store.getValue(_f2,"loan_ref_id"),deal_name:this.grid.store.getValue(_f2,"loan_deal_name"),facility_name:this.grid.store.getValue(_f2,"loan_facility_name"),loan_alias:this.grid.store.getValue(_f2,"loan_bo_ref"),entity:this.grid.store.getValue(_f2,"entity")};},onFormLoad:function(){_36();_4c();_43();if(dj.byId("adjust_amount_option")&&dj.byId("adjust_amount_option").checked===true){_53();}_3c();_ab();if(dj.byId("loan_increase_flag").get("value")==="true"){_77();}if(dj.byId("loan_ccy")){misys.setCurrency(dijit.byId("loan_ccy"),["total_repricing_ln_amt","total_ln_amt","total_principal_amt","loan_increase_ln_amt"]);}_7d();_8a();_ae();_20();},addNewLoanForRepricing:function(){if(_1c()){_1(null);}},formatLinkedLoanInterestDetailsPreviewActions:function(_f3){var _f4=dojo.create("a");var id=""+_f3.ref_id+"_details_link";if(_f3.deal_name&&_f3.deal_name.indexOf("'")||_f3.deal_name.indexOf("\"")||_f3.deal_name.indexOf("<")||_f3.deal_name.indexOf(">")||_f3.deal_name.indexOf("&")){_f3.deal_name=m.escapeHtml(_f3.deal_name);}if(_f3.facility_name&&_f3.facility_name.indexOf("'")||_f3.facility_name.indexOf("\"")||_f3.facility_name.indexOf("<")||_f3.facility_name.indexOf(">")||_f3.facility_name.indexOf("&")){_f3.facility_name=m.escapeHtml(_f3.facility_name);}if(_f3.entity&&_f3.entity.indexOf("'")||_f3.entity.indexOf("\"")||_f3.entity.indexOf("<")||_f3.entity.indexOf(">")||_f3.entity.indexOf("&")){_f3.entity=m.escapeHtml(_f3.entity);}var _f5="referenceid="+_f3.ref_id+"&dealName="+_f3.deal_name+"&facilityName="+_f3.facility_name+"&borefid="+_f3.loan_alias+"&entity="+_f3.entity+"&productcode="+dj.byId("product_code").get("value");if(window.isAccessibilityEnabled){_f5=_f5+"&parentTitle="+window.document.title;}var _f6="javascript:";var _f7="Click Here";_f6="javascript:misys.popup.showPopup ('"+_f5+"','INTEREST_DETAILS')";var _f8=dojo.create("a",{"id":id,"href":_f6,"innerHTML":_f7},_f4);var _f9="#dialog-link-inst";if(window.isAccessibilityEnabled){if(dojo.query(_f9)&&dojo.query(_f9).length>0){var _fa=dojo.attr(dojo.query(_f9)[0],"innerHTML");var _fb=dojo.create("span",{"id":_fc,"innerHTML":_fa},_f8);dojo.addClass(_fb,"sr-only");}var _fc=id+"_details_a11y_span";dojo.attr(_f8,"aria-describedby",_fc);}return _f4.innerHTML;},newRepricingLoanFormatActions:function(_fd){var _fe=dojo.create("div");var div=dojo.create("div",{"class":"gridActions"},_fe);dojo.create("img",{"src":misys.getContextualURL(misys._config.imagesSrc+m._config.imageStore.editIcon),"alt":"Edit","title":"Edit","border":"0","type":"Edit","onclick":"misys.editNewRepricingLoans(\""+_fd.ref_id+"\")"},div);dojo.create("img",{"src":misys.getContextualURL(misys._config.imagesSrc+m._config.imageStore.deleteIcon),"alt":"Delete","title":"Delete","border":"0","type":"remove","onclick":"misys.deleteNewRepricingLoans(\""+_fd.ref_id+"\")"},div);return _fe.innerHTML;},getRepricedNewLoansAction:function(_ff,item){if(!item){return this.defaultValue;}return {ref_id:this.grid.store.getValue(item,"new_loan_ref_id")};},editNewRepricingLoans:function(_100){_1(_100);},beforeSaveValidations:function(){if(dj.byId("tnx_amt")&&dj.byId("total_ln_amt")){var _101=dj.byId("total_ln_amt").get("value");dj.byId("bk_total_amt").set("value",_101);dj.byId("tnx_amt").set("value",_101);}if(_2e()&&_d8()){return true;}return false;},setCustomConfirmMessage:function(){var _102=dj.byId("interest_payment");var _103=null,_104=null;if(dj.byId("mode").get("value")==="UNSIGNED"){_103=dj.byId("bk_cur_code")&&dj.byId("bk_cur_code").get("value")!=null?dj.byId("bk_cur_code").get("value"):"";_104=dj.byId("bk_total_amt")&&dj.byId("bk_total_amt").get("value")!=null?dj.byId("bk_total_amt").get("value"):"";}else{_103=dj.byId("bk_cur_code")&&dj.byId("bk_cur_code").get("value")!=null?dj.byId("bk_cur_code").get("value"):"";_104=dj.byId("total_ln_amt")&&dj.byId("total_ln_amt").get("value")!=null?dj.byId("total_ln_amt").get("value"):"";var _105=d.cldr.monetary.getData(_103);_104=_104!==""?d.currency.format((Math.floor((parseFloat(_104)*100).toFixed(2))/100),{round:_105.round,places:_105.places}):"";}if(_102&&_102.checked===false){m._config.globalSubmitConfirmationMsg=m.getLocalization("submitLoanForRepricingError",[_103,_104]);}else{m._config.globalSubmitConfirmationMsg=m.getLocalization("submitTransactionConfirmationForLoan",["Repricing",_103,_104]);}},beforeSubmitValidations:function(){if(dj.byId("tnx_amt")&&dj.byId("total_ln_amt")){var _106=dj.byId("total_ln_amt").get("value");dj.byId("bk_total_amt").set("value",_106);dj.byId("tnx_amt").set("value",_106);}var _107=_28()&&_d1()&&_2e()&&_d8()&&_ca();if(!_107){m._config.legalTextEnabled=false;return false;}var _108=m.isLegalTextAcceptedForAuthorizer();if(_107&&!(_108)){m._config.legalTextEnabled=true;return false;}else{if(_107&&(_108)){return true;}}return false;},toggleAdditionalDetails:function(){var _109=d.byId("actionDown");var _10a=d.byId("actionUp");var _10b=d.byId("AdditionalDetailsContainer");if(d.style("AdditionalDetailsContainer","display")==="none"){m.animate("wipeIn",_10b);dj.byId("additionalInnerDetailsGrid").resize();d.style("actionDown","display","none");d.style("actionUp","display","block");d.style("actionUp","cursor","pointer");}else{m.animate("wipeOut",_10b);d.style("actionUp","display","none");d.style("actionDown","display","block");d.style("actionDown","cursor","pointer");}},onCancelNavigation:function(){var _10c=misys._config.homeUrl;var _10d=dj.byId("product_code");var _10e=dj.byId("sub_product_code");if(_10d&&_10d.get("value")==="BK"&&_10e&&_10e.get("value")==="LNRPN"){var _10f=["/screen/LoanScreen?tnxtype=01","&operation=LIST_REPRICING"];_10c=misys.getServletURL(_10f.join(""));}return _10c;},toggleLegalTextDetails:function(){var _110=d.byId("actionDown");var _111=d.byId("actionUp");var _112=d.byId("LegalTextContainer");if(d.style("LegalTextContainer","display")==="none"){m.animate("wipeIn",_112);dj.byId("LegalTextDetailsGrid").resize();d.style("actionDown","display","none");d.style("actionUp","display","block");d.style("actionUp","cursor","pointer");}else{m.animate("wipeOut",_112);d.style("actionUp","display","none");d.style("actionDown","display","block");d.style("actionDown","cursor","pointer");}},deleteNewRepricingLoans:function(_113){var _114=dijit.byId("gridNewLoanRepricingTransactions");if(_114&&_114.store){var _115=0;var _116=function(size,_117){_115=size;};_114.get("store").fetch({query:{},onBegin:_116,start:0,count:0});if(_115>1){var _118;var _119;var _11a=function(){_114.store.fetch({query:{new_loan_ref_id:_113},onComplete:dojo.hitch(this,function(_11b,_11c){dojo.forEach(_11b,function(item){_118=item.new_loan_facility_id;_119=item.new_loan_outstanding_amt;_114.store.deleteItem(item);},this);})});_114.store.save();_4c();_53();_59(_118,_119);_6d(_118,_119);if(dj.byId("loan_increase_flag").get("value")==="true"){_77();}};m.dialog.show("CONFIRMATION",misys.getLocalization("linkedLoanDeleteAction",[_113]),"",null,null,"",_11a);}else{m.dialog.show("CONFIRMATION",misys.getLocalization("lastLoanInlinkedLoanDeleteAction",[_113]));}}}});m._config=m._config||{};d.mixin(m._config,{xmlTransform:function(xml){var _11d="bk_tnx_record",_11e=["<",_11d,">"];var dom=dojox.xml.DomParser.parse(xml);var _11f=xml.substring(_11d.length+2,(xml.length-_11d.length-3));var _120=dj.byId("interest_payment");var _121=dj.byId("borrower_settlement");var _122=dj.byId("adjust_amount_option");if(_121&&(_121.get("value")==="on"||_121.get("value")==="Y")){_11e.push("<borrower_settlement_ind>","Y","</borrower_settlement_ind>");}else{_11e.push("<borrower_settlement_ind>","N","</borrower_settlement_ind>");}if(_122&&(_122.get("value")==="Y"||_122.get("value")==="on")){_11e.push("<adjust_payment_options>","Y","</adjust_payment_options>");}else{_11e.push("<adjust_payment_options>","N","</adjust_payment_options>");}if(dijit.byId("legalDialog")&&dijit.byId("accept_legal_text")&&dijit.byId("accept_legal_text").get("checked")){_11f=_11f.concat("<accept_legal_text>");_11f=_11f.concat("Y");_11f=_11f.concat("</accept_legal_text>");}else{if(dijit.byId("legalDialog")&&dijit.byId("accept_legal_text")&&!(dijit.byId("accept_legal_text").get("checked"))){_11f=_11f.concat("<accept_legal_text>");_11f=_11f.concat("N");_11f=_11f.concat("</accept_legal_text>");}}var _123=dijit.byId("gridRepricingLoanTransactions");if(_123&&_123.store){var _124="";_124=_124.concat("<linked_loans>");_123.store.fetch({query:{loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_125,_126){d.forEach(_125,function(item){_124=_124.concat("<loan_ref_id>");_124=_124.concat(item.loan_ref_id[0]);_124=_124.concat("</loan_ref_id>");},this);})});_124=_124.concat("</linked_loans>");}_11f=_11f.concat(_124);_11e.push(_11f);var _127;var _128;var _129=0;var _12a=dijit.byId("gridNewLoanRepricingTransactions");var _12b="";if(_12a&&_12a.store){_11e.push("<repricing_new_loans>");var _12c=dijit.byId("gridRemittanceInstruction");if(_12c&&_12c.selection&&_12c.selection.getSelected()&&_12c.selection.getSelected()[0]&&_12c.selection.getSelected()[0].description&&_12c.selection.getSelected()[0].description[0]){_12b=_12b.concat("<rem_inst_description>");_12b=_12b.concat(_12c.selection.getSelected()[0].description[0]);_12b=_12b.concat("</rem_inst_description>");_12b=_12b.concat("<rem_inst_location_code>");_12b=_12b.concat(_12c.selection.getSelected()[0].locationCode[0]);_12b=_12b.concat("</rem_inst_location_code>");_12b=_12b.concat("<rem_inst_servicing_group_alias>");_12b=_12b.concat(_12c.selection.getSelected()[0].servicingGroupAlias[0]);_12b=_12b.concat("</rem_inst_servicing_group_alias>");_12b=_12b.concat("<rem_inst_account_no>");_12b=_12b.concat(_12c.selection.getSelected()[0].accountNo[0]);_12b=_12b.concat("</rem_inst_account_no>");}else{_12b=_12b.concat("<rem_inst_description>");_12b=_12b.concat("</rem_inst_description>");_12b=_12b.concat("<rem_inst_location_code>");_12b=_12b.concat("</rem_inst_location_code>");_12b=_12b.concat("<rem_inst_servicing_group_alias>");_12b=_12b.concat("</rem_inst_servicing_group_alias>");_12b=_12b.concat("<rem_inst_account_no>");_12b=_12b.concat("</rem_inst_account_no>");}_12a.store.fetch({query:{new_loan_ref_id:"*"},onComplete:dojo.hitch(this,function(_12d,_12e){d.forEach(_12d,function(item){_11e.push("<ln_tnx_record>");_11e.push("<new_loan_ref_id>",item.new_loan_ref_id[0],"</new_loan_ref_id>");_11e.push("<new_loan_tnx_id>",item.new_loan_tnx_id[0],"</new_loan_tnx_id>");_11e.push("<new_loan_entity>",item.new_loan_entity[0],"</new_loan_entity>");_11e.push("<new_loan_our_ref>",dojox.html.entities.encode(item.new_loan_our_ref[0],dojox.html.entities.html),"</new_loan_our_ref>");_11e.push("<new_loan_deal_name>",dojox.html.entities.encode(item.new_loan_deal_name[0],dojox.html.entities.html),"</new_loan_deal_name>");_11e.push("<new_loan_deal_id>",item.new_loan_deal_id[0],"</new_loan_deal_id>");_11e.push("<new_loan_facility_name>",dojox.html.entities.encode(item.new_loan_facility_name[0],dojox.html.entities.html),"</new_loan_facility_name>");_11e.push("<new_loan_facility_id>",item.new_loan_facility_id[0],"</new_loan_facility_id>");_11e.push("<new_loan_pricing_option>",item.new_loan_pricing_option[0],"</new_loan_pricing_option>");_11e.push("<new_loan_ccy>",item.new_loan_ccy[0],"</new_loan_ccy>");_11e.push("<new_loan_outstanding_amt>",item.new_loan_outstanding_amt[0],"</new_loan_outstanding_amt>");_11e.push("<new_loan_effective_date>",item.new_loan_effective_date[0],"</new_loan_effective_date>");_11e.push("<new_loan_maturity_date>",item.new_loan_maturity_date[0],"</new_loan_maturity_date>");_11e.push("<new_loan_borrower_reference>",dojox.html.entities.encode(item.new_loan_borrower_reference[0],dojox.html.entities.html),"</new_loan_borrower_reference>");_11e.push("<new_loan_repricing_frequency>",item.new_loan_repricing_frequency_id[0],"</new_loan_repricing_frequency>");_11e.push("<new_loan_repricing_date>",item.new_loan_repricing_date[0],"</new_loan_repricing_date>");_11e.push("<new_loan_repricing_riskType>",item.new_loan_risk_type[0],"</new_loan_repricing_riskType>");_11e.push("<new_loan_fcn>",item.new_loan_fcn[0],"</new_loan_fcn>");_11e.push("<new_loan_matchFunding>",item.new_loan_matchFunding[0],"</new_loan_matchFunding>");_11e.push("<new_fx_conversion_rate>",item.new_fx_conversion_rate[0],"</new_fx_conversion_rate>");_11e.push("<new_fac_cur_code>",item.new_fac_cur_code[0],"</new_fac_cur_code>");_11e.push(_12b);_11e.push("</ln_tnx_record>");_127=item.new_loan_effective_date[0];_128=item.new_loan_facility_name[0];if(_129===0||_129===item.new_loan_facility_name[0]){_129=_128;_128=item.new_loan_facility_name[0];}else{_128="*";}},this);})});_11e.push("</repricing_new_loans>");}if(_120&&(_120.get("value")==="on"||_120.get("value")==="Y")){_11e.push("<interest_payment>","Y","</interest_payment>");}else{_11e.push("<interest_payment>","N","</interest_payment>");}_11e.push("<bulk_Effective_Date>",_127,"</bulk_Effective_Date>");_11e.push("<bulk_facility_name>",dojox.html.entities.encode(_128,dojox.html.entities.html),"</bulk_facility_name>");var _12f=dijit.byId("gridLayoutInterestDetailsLoanTransactions");var _130=dijit.byId("interest_Payment_loan_flag");if(_12f&&_12f.store){_11e.push("<interestPayments>");var _131=[];if(_130.get("value")==="true"){var _132=_12f.selection.getSelected();if(_132.length>0){for(var i=0;i<_132.length;i++){var item=_132[i];_11e.push("<interestPayment>");_11e.push("<loanAlias>",dojox.html.entities.encode(item.loan_alias[0],dojox.html.entities.html),"</loanAlias>");_131.push(dojox.html.entities.encode(item.loan_alias[0],dojox.html.entities.html),",");if(item.loan_alias[0]!==""){_131.push(dojox.html.entities.encode(item.loan_alias[0],dojox.html.entities.html),",");}_11e.push("<interesteDueAmt>",item.totalProjectedEOCamt[0],"</interesteDueAmt>");_11e.push("<cycleStartDate>",item.cycleStartDate[0],"</cycleStartDate>");_11e.push("</interestPayment>");}}}else{_12f.store.fetch({query:{loan_alias:"*"},onComplete:dojo.hitch(this,function(_133,_134){d.forEach(_133,function(item){_11e.push("<interestPayment>");_11e.push("<loanAlias>",dojox.html.entities.encode(item.loan_alias[0],dojox.html.entities.html),"</loanAlias>");_131.push(dojox.html.entities.encode(item.loan_alias[0],dojox.html.entities.html),",");_11e.push("<interesteDueAmt>",item.totalProjectedEOCamt[0],"</interesteDueAmt>");_11e.push("<cycleStartDate>",item.cycleStartDate[0],"</cycleStartDate>");_11e.push("</interestPayment>");},this);})});}_11e.push("</interestPayments>");_11e.push("<repricing_old_loan_aliases>",_131.join(""),"</repricing_old_loan_aliases>");}if(_11d){_11e.push("</",_11d,">");}return _11e.join("");}});})(dojo,dijit,misys);dojo.require("misys.client.binding.loan.repricing_ln_client");}