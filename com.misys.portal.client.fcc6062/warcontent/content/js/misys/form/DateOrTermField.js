/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.form.DateOrTermField"]){dojo._hasResource["misys.form.DateOrTermField"]=true;dojo.provide("misys.form.DateOrTermField");dojo.require("misys.form._FilteringTermSelect");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("dijit.form._FormWidget");dojo.require("dijit.form.TextBox");dojo.require("dijit.form.DateTextBox");dojo.require("dijit.form.NumberTextBox");dojo.declare("misys.form.DateOrTermField",[dijit.form._FormValueWidget],{templateString:dojo.cache("misys.form","templates/DateOrTermField.html","<div dojoAttachPoint=\"dateTermFieldNode, containerNode, focusNode\" class=\"dijit dijitReset dijitInlineTable dijitLeft\">\n\t<div dojoAttachPoint=\"selectFieldNode, selectNode\" id=\"${id}_select\"></div>\n\t<div dojoAttachPoint=\"calendarFieldNode, calendarNode\" id=\"${id}_calendar\"></div>\n\t<div dojoAttachPoint=\"numberFieldNode, numberNode\" id=\"${id}_number\"></div>\n</div>\n"),widgetsInTemplate:true,required:false,fieldsize:"small",displaymode:"edit",readOnly:false,_selectWidget:null,_calendarWidget:null,_numberField:null,date:"",code:"",number:"",_myStore:null,_optionsJson:null,constructor:function(_1,_2){this.inherited(arguments);this.srcNodeRef=_2;if(!this.store){var _3={};_3.items=[];var _4;var _5;dojo.forEach(dojo.query("select",this.srcNodeRef),function(s,i){var _6=(i===0)?"term":"static";dojo.forEach(dojo.query("option",s),function(o){_3.items.push({"value":o.value,"label":o.innerHTML,"type":_6});});dojo.destroy(s);});_myStore=new dojo.data.ItemFileWriteStore({data:_3});this.set("_optionsJson",_3);}},postMixInProperties:function(){this.inherited(arguments);},postCreate:function(){this.inherited(arguments);if(this.displaymode=="edit"){this._calendarWidget=new dijit.form.DateTextBox({id:this.get("id")+"_date",name:this.get("id")+"_date","class":this.fieldsize,required:this.required},this.calendarFieldNode);misys.connect(this._calendarWidget,"onChange",this,this._onChangeCalendar);this._selectWidget=new misys.form._FilteringTermSelect({id:this.get("id")+"_code",name:this.get("id")+"_code","class":this.fieldsize,store:_myStore,_optionJson:this._optionsJson,searchAttr:"label",labelAttr:"label",required:this.required},this.selectFieldNode);misys.connect(this._selectWidget,"onChange",this,this._onChangeSelect);this._numberField=new dijit.form.NumberTextBox({id:this.get("id")+"_number",name:this.get("id")+"_number","class":this.fieldsize,required:this.required},this.numberFieldNode);misys.connect(this._numberField,"onChange",this,this._onChangeNumber);if(this.date!=""){this._calendarWidget.set("displayedValue",this.date);}if(this.code!=""){var _7=this._optionsJson.items;for(var i=0;i<_7.length;i++){if(_7[i].value==this.code){this._selectWidget._setDisplayedValueAttr(_7[i].label);break;}}}this.set("disabled",this.readonly=="Y"?true:false);}else{var _8="";if(this.date!=""){_8=_8+this.date;}if(this.code!=""){var _9=this._optionsJson.items;if(_8!=""){_8=_8+" ";}for(var j=0;j<_9.length;j++){if(_9[j].value==this.code){_8=_8+_9[j].label;break;}}}this.dateTermFieldNode.innerHTML=_8;dojo.addClass(this.dateTermFieldNode,"content");dojo.removeClass(this.dateTermFieldNode,"dijit");dojo.removeClass(this.dateTermFieldNode,"dijitReset");dojo.removeClass(this.dateTermFieldNode,"dijitInlineTable");dojo.removeClass(this.dateTermFieldNode,"dijitLeft");dojo.removeClass(this.dateTermFieldNode,"ReadOnly");dojo.removeClass(this.dateTermFieldNode,"dijitReadOnly");}},_isEmpty:function(_a){return (!_a||_a.trim().length===0);},isValidCalDate:function(_b){var _c=_b.textbox.value;var _d={"fullYear":true,"selector":"date"};return (new RegExp("^(?:"+_b.regExpGen(_d)+")"+(_b.required?"":"?")+"$")).test(_c)&&(!_b.required||!this._isEmpty(_c))&&(this._isEmpty(_c)||_b.parse(_c,_d)!==undefined);},isValidCalNumber:function(_e){var _f=_e.textbox.value;return (new RegExp("^[0-9,]*$")).test(_f)&&(!_e.required||(!this._isEmpty(_f)&&_f!=="0"));},_onChangeCalendar:function(_10){this.date=this._calendarWidget.get("displayedValue");this.value=this.date+this.code;},_onChangeSelect:function(){var _11=this._selectWidget.value;if(_11===""){this.code="";this.toggleDisabledCalendarField(true);this.toggleDisabledNumberField(true);}else{var _12=this._optionsJson.items[_11].value;if(_12[0]==="d"||_12[0]==="w"||_12[0]==="m"||_12[0]==="y"){this.toggleDisabledCalendarField(true);this.toggleDisabledNumberField(false);this._calendarWidget.reset();this._numberField.reset();if(dojo.byId("date-value_description")){dojo.byId("date-value_description").textContent="";}}else{if(this.isStaticCodeSelected()){var _13=this._optionsJson.items[_11].value;var _14="";this.toggleDisabledCalendarField(true);this.toggleDisabledNumberField(true);this._calendarWidget.reset();this._numberField.reset();if((_13[0]==="CASH")&&dojo.byId("date-value_description")){_14=_14+misys.getLocalization("valueToday");dojo.byId("date-value_description").innerText=_14;}else{if((_13[0]==="TOM")&&dojo.byId("date-value_description")){_14=_14+misysgetLocalization("valueOneBusinessDay");dojo.byId("date-value_description").innerText=_14;}else{if((_13[0]==="SPOT")&&dojo.byId("date-value_description")&&dojo.byId("payment_cur_code").value==="CAD"&&dojo.byId("applicant_cur_code").value==="USD"){_14=_14+misys.getLocalization("valueOneBusinessDayCADdeal");dojo.byId("date-value_description").innerText=_14;}else{if((_13[0]==="SPOT")&&dojo.byId("date-value_description")){_14=_14+misys.getLocalization("valueTwoBusinessDay");dojo.byId("date-value_description").innerText=_14;}}}}}else{this.toggleDisabledCalendarField(false);this.toggleDisabledNumberField(true);this._numberField.reset();if(dojo.byId("date-value_description")){dojo.byId("date-value_description").textContent="";}}}this.code=this._optionsJson.items[_11].value[0];this._selectWidget._isvalid=true;}this._selectWidget._optionValue=this.code;this.set("value",this.date+this.code);},_onChangeNumber:function(){this.number=this._numberField.get("value");},_onChange:function(){},focus:function(){},isTermCodeSelected:function(){return (this._selectWidget!=null&&!(this._selectWidget.value===""||this._optionsJson.items[this._selectWidget.value].value[0]==="dt"))?this._optionsJson.items[this._selectWidget.value].type[0]==="term":false;},isBlankSelected:function(){return (this._selectWidget!=null&&this._selectWidget.value==="")?true:false;},isDateSelected:function(){return (this._selectWidget!=null&&this._selectWidget.value!==""&&this._optionsJson.items[this._selectWidget.value].value[0]==="dt")?true:false;},isValidDate:function(){return this._calendarWidget!=null?(this.isValidCalDate(this._calendarWidget)&&this.isDateSelected()):false;},isValidNumber:function(){return this._numberField!=null?this.isValidCalNumber(this._numberField):false;},isCorrectlyFilled:function(){return (this.isDateSelected()&&!this._isEmpty(this._calendarWidget.textbox.value))||(this.isTermCodeSelected()&&!this._isEmpty(this._numberField.textbox.value));},isStaticCodeSelected:function(){return (this._selectWidget!=null&&!(this._selectWidget.value===""))?this._optionsJson.items[this._selectWidget.value].type=="static":false;},toggleDisabledSelectField:function(_15){if(this._selectWidget!=null){this._selectWidget.set("disabled",_15);this._selectWidget.set("required",!_15);}},toggleDisabledCalendarField:function(_16){if(this._calendarWidget!=null){this._calendarWidget.set("disabled",_16);this._calendarWidget.set("required",!_16);var _17="widget_"+this.get("id")+"_date";if(dojo.byId(_17)&&_16){dojo.style(dojo.byId(_17),"display","none");}else{if(dojo.byId(_17)&&!_16){dojo.style(dojo.byId(_17),"display","inline-block");}}}},toggleDisabledNumberField:function(_18){if(this._numberField!=null){this._numberField.set("disabled",_18);this._numberField.set("required",!_18);var _19="widget_"+this.get("id")+"_number";if(dojo.byId(_19)&&_18){dojo.style(dojo.byId(_19),"display","none");}else{if(dojo.byId(_19)&&!_18){dojo.style(dojo.byId(_19),"display","inline-block");}}}},_setValueAttr:function(_1a){this.inherited(arguments);if(_1a===""){if(this._calendarWidget!=null){this._calendarWidget.reset();}if(this._selectWidget!=null){this._selectWidget.reset();}if(this._numberField!=null){this._numberField.reset();}}},_setRequiredAttr:function(_1b){if(this._calendarWidget!=null){this._calendarWidget.set("required",_1b);}if(this._selectWidget!=null){this._selectWidget.set("required",_1b);}this.inherited(arguments);},_setDisabledAttr:function(_1c){this.inherited(arguments);this.toggleDisabledSelectField(_1c);this._onChangeCalendar();this._onChangeSelect();},_setNumberValue:function(_1d){this._numberField.set("value",_1d);},getNumber:function(){return this.get("number");},getCode:function(){return this.get("code");},getDate:function(){return this.isValidDate()?this.get("date"):"";},getFormalValueDate:function(){return this.isValidDate()?this._calendarWidget.get("value"):"";}});}