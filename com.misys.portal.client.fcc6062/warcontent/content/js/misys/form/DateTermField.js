/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.form.DateTermField"]){dojo._hasResource["misys.form.DateTermField"]=true;dojo.provide("misys.form.DateTermField");dojo.require("misys.form._DateTermTextBox");dojo.require("misys.form._FilteringTermSelect");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("dijit.form._FormWidget");dojo.require("dijit.form.TextBox");dojo.declare("misys.form.DateTermField",[dijit.form._FormValueWidget],{templateString:dojo.cache("misys.form","templates/DateTermField.html","<div dojoAttachPoint=\"dateTermFieldNode, containerNode, focusNode\" class=\"dijit dijitReset dijitInlineTable dijitLeft\">\n\t<div dojoAttachPoint=\"calendarFieldNode, calendarNode\" id=\"${id}_calendar\"></div>\n\t<div dojoAttachPoint=\"selectFieldNode, selectNode\" id=\"${id}_select\"></div>\n\t<div dojoAttachPoint=\"numberFieldNode, numberNode\" id=\"${id}_number\"></div>\n</div>\n"),widgetsInTemplate:true,required:false,fieldsize:"small",displaymode:"edit",readOnly:false,_selectWidget:null,_calendarWidget:null,_numberField:null,date:"",code:"",_store:"",_myStore:null,_optionsJson:null,constructor:function(_1,_2){this.inherited(arguments);this.srcNodeRef=_2;if(!this.store){var _3={};_3.items=[];var _4;var _5;dojo.forEach(dojo.query("select",this.srcNodeRef),function(s,i){var _6=(i===0)?"term":"static";dojo.forEach(dojo.query("option",s),function(o){_3.items.push({"value":o.value,"label":o.innerHTML,"type":_6});});dojo.destroy(s);});_myStore=new dojo.data.ItemFileWriteStore({data:_3});this.set("_optionsJson",_3);}},postMixInProperties:function(){this.inherited(arguments);},postCreate:function(){this.inherited(arguments);if(this.displaymode=="edit"){this._calendarWidget=new misys.form._DateTermTextBox({id:this.get("id")+"_date",name:this.get("id")+"_date","class":this.fieldsize,required:this.required,_parent:this},this.calendarFieldNode);misys.connect(this._calendarWidget,"onChange",this,this._onChangeCalendar);this._selectWidget=new misys.form._FilteringTermSelect({id:this.get("id")+"_code",name:this.get("id")+"_code","class":this.fieldsize,store:_myStore,_optionJson:this._optionsJson,searchAttr:"label",labelAttr:"label",required:this.required},this.selectFieldNode);misys.connect(this._selectWidget,"onChange",this,this._onChangeSelect);this._numberField=new dijit.form.TextBox({id:this.get("id")+"_number",type:"hidden"},this.numberFieldNode);if(this.date!=""){this._calendarWidget.set("displayedValue",this.date);}if(this.code!=""){var _7=this._optionsJson.items;for(var i=0;i<_7.length;i++){if(_7[i].value==this.code){this._selectWidget._setDisplayedValueAttr(_7[i].label);break;}}}this.set("disabled",this.readonly=="Y"?true:false);}else{var _8="";if(this.date!=""){_8=_8+this.date;}if(this.code!=""){var _9=this._optionsJson.items;if(_8!=""){_8=_8+" ";}for(var j=0;j<_9.length;j++){if(_9[j].value==this.code){_8=_8+_9[j].label;break;}}}this.dateTermFieldNode.innerHTML=_8;dojo.addClass(this.dateTermFieldNode,"content");dojo.removeClass(this.dateTermFieldNode,"dijit");dojo.removeClass(this.dateTermFieldNode,"dijitReset");dojo.removeClass(this.dateTermFieldNode,"dijitInlineTable");dojo.removeClass(this.dateTermFieldNode,"dijitLeft");dojo.removeClass(this.dateTermFieldNode,"ReadOnly");dojo.removeClass(this.dateTermFieldNode,"dijitReadOnly");}},_onChangeCalendar:function(_a){this.date=this._calendarWidget.get("displayedValue");this.value=this.date+this.code;if(this._calendarWidget.isValidDate()&&this.date!=""){this._selectWidget.reset();this.toggleDisabledSelectField(true);this._numberField.set("value","");}else{if((this._calendarWidget.isValidNumber()||this._calendarWidget.value==null)&&this._selectWidget.value===""){this._selectWidget.set("_isvalid",false);}if(!this.disabled){this.toggleDisabledSelectField(false);}this._numberField.set("value",this.date);}},_onChangeSelect:function(){var _b=this._selectWidget.value;if(_b===""){this.code="";}else{if(this.isStaticCodeSelected()){this._calendarWidget.value="";this.toggleDisabledCalendarField(true);this._numberField.set("value","");}else{if(this.isTermCodeSelected()){this.toggleDisabledCalendarField(false);}}this.code=this._optionsJson.items[_b].value;this._selectWidget._isvalid=true;}this._selectWidget._optionValue=this.code;this.set("value",this.date+this.code);},_onChange:function(){},focus:function(){},isStaticCodeSelected:function(){return (this._selectWidget!=null&&!(this._selectWidget.value===""))?this._optionsJson.items[this._selectWidget.value].type=="static":false;},isTermCodeSelected:function(){return (this._selectWidget!=null&&!(this._selectWidget.value===""))?this._optionsJson.items[this._selectWidget.value].type=="term":false;},isBlankSelected:function(){return (this._selectWidget!=null&&this._selectWidget.value==="")?true:false;},isValidDate:function(){return this._calendarWidget!=null?(this._calendarWidget.isValidDate()&&this.isBlankSelected()):false;},isValidNumber:function(){return this._calendarWidget!=null?this._calendarWidget.isValidNumber():false;},isCorrectlyFilled:function(){return (this.isValidDate()||(this.isValidNumber()&&this.isTermCodeSelected())||this.isStaticCodeSelected());},toggleDisabledSelectField:function(_c){if(this._selectWidget!=null){this._selectWidget.set("disabled",_c);this._selectWidget.set("required",!_c);}},toggleDisabledCalendarField:function(_d){if(this._calendarWidget!=null){this._calendarWidget.set("disabled",_d);this._calendarWidget.set("required",!_d);}},_setValueAttr:function(_e){this.inherited(arguments);if(_e==""){if(this._calendarWidget!=null){this._calendarWidget.reset();}if(this._selectWidget!=null){this._selectWidget.reset();}}},_setRequiredAttr:function(_f){if(this._calendarWidget!=null){this._calendarWidget.set("required",_f);}if(this._selectWidget!=null){this._selectWidget.set("required",_f);}this.inherited(arguments);},_setDisabledAttr:function(_10){this.toggleDisabledCalendarField(_10);this.toggleDisabledSelectField(_10);this.inherited(arguments);this._onChangeCalendar();this._onChangeSelect();},_setNumberValue:function(_11){this._numberField.set("value",_11);},getNumber:function(){return this._numberField.get("value");},getCode:function(){return this.get("code");},getDate:function(){return this.isValidDate()?this.get("date"):"";},getFormalValueDate:function(){return this.isValidDate()?this._calendarWidget.get("value"):"";}});}