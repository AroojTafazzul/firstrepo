/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.form.addons"]){dojo._hasResource["misys.form.addons"]=true;dojo.provide("misys.form.addons");dojo.require("misys.form.addon_definitions");dojo.require("dojo.data.ItemFileReadStore");dojo.require("misys.grid._base");(function(d,dj,m){m._config=m._config||{};d.mixin(m._config,{isEditMode:false,logoData:"",currentAddonId:"",errorField:[]});function _1(_2,id,_3,_4){var _5=(_2==="customerReference")?"_"+dj.byId("customerReference_target_bank").get("value"):"";var _6=d.byId(_3+_2+_5+"-master-table");var _7=(_4)?+_4+1:_6.rows.length;var _8=m._addons.tableCells[_2](_3);var _9=m._addons.hiddenFields[_2](id,_3);var _a=[];var _b;var _c;if(m._config.isEditMode&&_2==="role"){_7=m._config.currentRowIndex;}if(_6.lastChild.localName=="tbody"){_b=_6.lastChild.insertRow(_7-1);}else{_b=_6.insertRow(_7);}_b.setAttribute("id",_2+_5+"_row_"+id);d.style(_b,"display","none");d.style(_b,"opacity",0);d.forEach(_8,function(_d,_e){var _f;if(_2==="topic"){_f=d.create("div",{innerHTML:_d.value},_b.insertCell(_e));}else{if(_2==="customerReference"){_f=d.create("div",{innerHTML:m.grid.sanitizeHTMLDataForUI(_d.value)},_b.insertCell(_e));d.style(_f,"white-space","pre");}else{_f=d.create("div",{innerHTML:m.grid.sanitizeHTMLDataForUI(_d.value)},_b.insertCell(_e));}}if(_2==="charge"&&_e=="1"){dojo.attr(_f,"class","chrgaddcmt");}});_12(_b,_8.length,id,_2+_5,_3);d.forEach(_9,function(_10){var _11=new dijit.form.TextBox({id:_10.name,name:_10.name,readOnly:true,value:_10.value,type:"hidden"});if(_11){_11.placeAt(_2+"_fields"+_5,"last");}});if(dj.byId(_2+"_product_nosend")){if(dj.byId(_2+"_details_usercode_nosend").get("value")==="*"){dj.byId("alerts_"+_2.substr(5,2)+"_details_langcode_"+id).set("value",dj.byId(_2+"_details_langcode_nosend").get("value"));dj.byId("alerts_"+_2.substr(5,2)+"_details_usercode_"+id).set("value","*");}else{dj.byId("alerts_"+_2.substr(5,2)+"_details_langcode_"+id).set("value","*");dj.byId("alerts_"+_2.substr(5,2)+"_details_address_"+id).set("value",dj.byId(_2+"_details_usercode_nosend").get("value"));}}_c=m.animate("fadeIn",_b,true,null,{display:m._config.showTableRow});if(m._config.isEditMode){m.deleteTransactionAddon(_2+_5,m._config.currentAddonId,"",_c);}else{_a.push(_c);if(d.style(_6,"display")==="none"){d.style(d.byId(_2+_5+"-notice"),"display","none");_a.push(m.animate("fadeIn",_6,null,true,{display:m._config.showTable}));}try{dojo.fx.combine(_a).play();}catch(err){}}if(!m._config.isEditMode){m._config[_2+_5+"Attached"]++;}};function _12(row,_13,id,_14,_15){var _16=row.insertCell(_13),_17=d.create("div",null,_16),_18=d.create("div",null,_16),_19=d.create("div",null,_18),_1a=d.doc.createElement("p"),_1b,_1c,_1d,_1e,_1f;_1a.innerHTML=m.getLocalization("delete"+_14+"FileConfirmation");_19.appendChild(_1a);_1b=d.create("div",null,_19,"last");_1c=new dj.form.Button({label:"<img src='"+misys.getContextualURL(misys._config.imagesSrc+m._config.imageStore.editIcon)+"' alt='Edit'>",onClick:function(){m.editTransactionAddon(_14,id,_15,row.rowIndex);}},_17);d.addClass(_1c.domNode,"noborder");d.create("p",{innerHTML:m.getLocalization("delete"+_14+"Confirmation")},_19,"first");_1d=new dj.form.Button({label:m.getLocalization("deleteMessage"),type:"submit"},_1b);_1e=new dj.TooltipDialog({title:m.getLocalization("deleteMessage"),execute:function(){if(dj.byId("customerReference_target_bank")&&(/customerReference/).test(_14)){m.fncDeleteCustomerReferenceRow(_14,id,_15,null,_14.substring("customerReference_".length));}else{m.deleteTransactionAddon(_14,id,_15);}}},_19);_1e.startup();_1f=new dj.form.DropDownButton({label:"<img src='"+m.getContextualURL(m._config.imagesSrc+m._config.imageStore.deleteIcon)+"' alt='Delete'>"},_18);d.addClass(_1f.domNode,"noborder");_1f.startup();};d.mixin(m,{addTransactionAddon:function(_20,_21){var _22=(_20==="customerReference")?"_"+dj.byId("customerReference_target_bank").get("value"):"",id=(_20==="customerReference")?0:m._config[_20+_22+"Attached"],_23=m._addons.mandatoryFields[_20](_21,_22.replace("_","")),_24=m._config.errorField,_25=false,_26,_27,_28;_21=_21||"";while(d.byId(_20+_22+"_row_"+id)){id++;}_25=d.every(_23,function(_29,_2a,arr){_26=dj.byId(_29.name);if(_26){_28=_26.get("displayedValue");_27=_26.declaredClass;if(/Number/.test(_27)||(/Currency/.test(_27))){_28=_26.get("value");_28=!isNaN(_28)?_28:"";}if(_28===""||_26.state==="Error"){var _2b=null;if(_28===""){_2b=m.getLocalization("mandatoryFieldsError");}else{if(_26.state==="Error"){_2b=m.getLocalization("mandatoryFieldsInvalidStateError");}}m.showTooltip(_2b,_26.domNode,["above","before"]);_26.state="Error";_26._setStateClass();dj.setWaiState(_26.focusNode,"invalid","true");return false;}}return true;});if(_24&&_24.length>0){_25=false;}if(_20==="topic"){_25=_25&&m.validateImage();}if(!_25){return false;}var _2c=dj.byId(_21+_20+"Dialog"+_22);if(_2c){_2c.hide();}if(_20.toLowerCase()==="role"&&m._config.isEditMode){_1(_20,id,_21,dj.byId("roles_order_number_role_name_nosend").get("value"));}else{_1(_20,id,_21);}m._config.isEditMode=false;m._config.currentAddonId="";return true;},deleteTransactionAddon:function(_2d,id,_2e,_2f,_30){var _31=(_2d.toLowerCase()==="role"&&!m._config.isEditMode)?+dj.byId("authorization_level_order_number_"+id).get("value"):0,_32,_33="",_34=[],_35,_36,_37,_38;_2e=_2e||"";if(/customerReference/.test(_2d)){_37=_2d.split("_");if(_37.length===2){dj.byId("customerReference_target_bank").set("value",_37[1]);_33="_"+_37[1];}else{if(_37.length>2){var _39="";_39=_39+_37[1];for(var i=2;i<_37.length;i++){_39=_39+"_"+_37[i];}dj.byId("customerReference_target_bank").set("value",_39);_33="_"+_39;}}_2d="customerReference";}_32=m._addons.hiddenFields[_2d](id,_2e);_35=d.byId(_2e+_2d+_33+"-master-table");if(m._addons.deleteAddon.hasOwnProperty(_2d)){m._addons.deleteAddon[_2d](id);}d.forEach(_32,function(_3a){if(dj.byId(_3a.name)){dj.byId(_3a.name).destroy();}});if(!m._config.isEditMode){d.query("*[id^=authorization_level_order_number_]").forEach(function(_3b){_38=dj.byId(_3b.id);if((+_38.get("value"))>_31){_38.set("value",_38.get("value")-1);}});}if(!m._config.isEditMode){m._config[_2d+_33+"Attached"]--;}_36=d.byId(_2d+_33+"_row_"+id);_34.push(m.animate("fadeOut",_36,function(){_35.deleteRow(_36.rowIndex);if(_30){_30();}if(_2f){try{_2f.play();}catch(err){}}},true));if(m._config[_2d+_33+"Attached"]<1){d.style(d.byId(_2d+_33+"-notice"),"display","block");_34.push(m.animate("fadeOut",_35,null,true));}try{dojo.fx.combine(_34).play();}catch(err){}},editTransactionAddon:function(_3c,id,_3d,_3e){var _3f="",_40,_41,_42,_43,_44;var _45=dijit.byId("product_code");var _46=dijit.byId("company_type");if(_45&&(_45.get("value")==="EC"||_45.get("value")==="IC")&&_3c==="document"){m.populateAttachmentInfo();if(_46&&_46.get("value")!=="01"){m.updateDocumentSection();}}_3d=_3d||"";m._config.isEditMode=true;m._config.currentAddonId=id;m._config.currentRowIndex=_3e;if(/customerReference/.test(_3c)){_41=_3c.split("_");if(_41.length===2){dj.byId("customerReference_target_bank").set("value",_41[1]);_3f="_"+_41[1];}else{if(_41.length>2){var _47="";_47=_47+_41[1];for(var i=2;i<_41.length;i++){_47=_47+"_"+_41[i];}dj.byId("customerReference_target_bank").set("value",_47);_3f="_"+_47;}}_3c="customerReference";}_40=m._addons.hiddenFields[_3c](id,_3d);if(m._addons.bind.hasOwnProperty(_3c)&&d.isFunction(m._addons.bind[_3c])){m._addons.bind[_3c](_3d);}d.forEach(_40,function(_48){if(dj.byId(_48.name)&&dj.byId(_48.id)){_44=dj.byId(_48.id).declaredClass;if(/Select/.test(_44)){dj.byId(_48.id).set("value",dj.byId(_48.name).get("value"));}else{if(/Radio/.test(_44)||(/Check/.test(_44))){dj.byId(_48.id).set("checked",true);}else{dj.byId(_48.id).set("displayedValue",dj.byId(_48.name).get("value"));}}}});if(dj.byId(_3c+"_product_nosend")){_42=_3c.substr(5,2);m.connect(_3c+"_product_nosend","onChange",function(){if(dj.byId(_3c+"_datecode_nosend")){dj.byId(_3c+"_datecode_nosend").set("value",dj.byId("alerts_"+_42+"_details_select_datecode_"+id).get("value"));}});dj.byId(_3c+"_product_nosend").set("value",dj.byId("alerts_"+_42+"_details_select_prodcode_"+id).get("value"));if(dj.byId(_3c+"_type_nosend")){dj.byId(_3c+"_type_nosend").set("value",dj.byId("alerts_"+_42+"_details_select_tnxtypecode_"+id).get("value"));}if(dj.byId(_3c+"_details_offsetcode_nosend")){dj.byId(_3c+"_details_offsetcode_nosend").set("value",dj.byId("alerts_"+_42+"_details_offsetcode_"+id).get("value"));}if(dj.byId("alerts_"+_42+"_details_offsetsigncode_"+id)){dj.byId(_3c+"_details_offsetsigncode_nosend_"+dj.byId("alerts_"+_42+"_details_offsetsigncode_"+id).get("value")).set("checked",true);}if(dj.byId("alerts_"+_42+"_details_langcode_"+id).value==="*"){dj.byId(_3c+"_details_usercode_nosend").set("value",dj.byId("alerts_"+_42+"_details_address_"+id).get("value"));}else{dj.byId(_3c+"_details_usercode_nosend").set("value","*");dj.byId(_3c+"_details_langcode_nosend").set("value",dj.byId("alerts_"+_42+"_details_langcode_"+id).value);dj.byId(_3c+"_details_email_nosend").set("value",dj.byId("alerts_"+_42+"_details_address_"+id).value);}if(dj.byId(_42+"entity")){dj.byId(_3c.substr(5,2)+"entity").set("value",dj.byId("alerts_"+_42+"_details_entity_"+id).get("value"));}}else{if(dj.byId("customerReference"+_3f+"_details_reference_nosend")){m.customerRefDialogTempValue=dj.byId("customerReference"+_3f+"_details_reference_nosend").get("value");_43=dj.byId("common_fixed_id_"+_3f.substring(1)).get("value");var _49=misys._config.coreReferenceFields||[];var _4a=misys._config.customReferenceFields||[];var _4b=_49.concat(_4a);dojo.forEach(_4b,function(_4c,_4d){if(dj.byId("customerReference_details_"+_4c+"_nosend")&&dj.byId("customer_reference_"+_43+"_details_"+_4c+"_"+id)){dj.byId("customerReference_details_"+_4c+"_nosend").set("value",dj.byId("customer_reference_"+_43+"_details_"+_4c+"_"+id).get("value"));}});}else{if(dj.byId("documents_details_code_nosend")&&_3c==="document"){dj.byId("documents_details_code_nosend").set("value",dj.byId("documents_details_code_"+id).get("value"));dj.byId("documents_details_name_nosend").set("value",dj.byId("documents_details_name_"+id).get("value"));dj.byId("documents_details_first_mail_send").set("value",dj.byId("documents_details_first_mail_"+id).get("value"));dj.byId("documents_details_second_mail_send").set("value",dj.byId("documents_details_second_mail_"+id).get("value"));dj.byId("documents_details_total_send")?dj.byId("documents_details_total_send").set("value",dj.byId("documents_details_total_"+id).get("value")):"";if(dj.byId("documents_details_mapped_attachment_name_send")&&dj.byId("documents_details_mapped_attachment_id_send")){var _4e=dj.byId("documents_details_mapped_attachment_name_"+id).get("value");var _4f=dj.byId("documents_details_mapped_attachment_id_"+id).get("value");dj.byId("documents_details_mapped_attachment_name_send").set("displayedValue",_4e);}dj.byId("documents_details_doc_no_send")?dj.byId("documents_details_doc_no_send").set("value",dj.byId("documents_details_doc_no_"+id).get("value")):"";dj.byId("documents_details_doc_date_send")?dj.byId("documents_details_doc_date_send").set("displayedValue",dj.byId("documents_details_doc_date_"+id).get("value")):"";}else{if(dj.byId("title_offsetcode_nosend")){dj.byId("title_offsetcode_nosend").set("value",dj.byId("title_"+id).get("value"));dj.byId("link_offsetcode_nosend").set("value",dj.byId("link_"+id).get("value"));dj.byId("img_file_id_offsetcode_nosend").set("value",dj.byId("img_file_id_"+id).get("value"));dj.byId("dialog_topic_id_offsetcode_nosend").set("value",dj.byId("topic_id_"+id).get("value"));d.attr(d.byId("new-image"),"src",m.getServletURL("/screen/AjaxScreen/action/GetCustomerLogo?logoid="+dj.byId("img_file_id_"+id).get("value")));dj.byId("new").set("value",dj.byId("img_file_id_"+id).get("value"));d.style(d.byId("new-logo-row"),"display","block");m._config.logoData="";}else{if(dj.byId("roles_details_role_name_nosend")){dj.byId("roles_level_id_role_name_nosend").set("value",dj.byId("authorization_level_level_id_"+id).get("value"));dj.byId("roles_details_role_name_nosend").set("value",dj.byId("authorization_level_role_id_"+id).get("value"));dj.byId("roles_order_number_role_name_nosend").set("value",dj.byId("authorization_level_order_number_"+id).get("value"));}}}}}dj.byId(_3d+_3c+"Dialog"+_3f).show();m.connect(dj.byId(_3d+_3c+"Dialog"+_3f),"onHide",function(){m._config.currentAddonId="";});},showLogoUploadDialog:function(){dj.byId("logofile").set("value","");dj.byId("logoUploadDialog").show();},hideLogoUploadDialog:function(){var _50=dj.byId("logoUploadDialog");if(_50){_50.hide();}},uploadLogo:function(id){var _51=dj.byId("sendlogofiles"),_52=dj.byId("logofile");if(!_52.get("value")){m.showTooltip(m.getLocalization("mandatoryPathToFileError"),_52.domNode);return false;}m.dialog.show("PROGRESS",m.getLocalization("uploadingLogo"),m.getLocalization("progressMessage"));d.io.iframe.send({url:m.getServletURL("/screen/GTPUploadLogoScreen"),method:"post",handleAs:"json",content:{logoid:"",token:document.getElementById("_token").getAttribute("value")},form:d.byId("sendlogofiles"),handle:function(_53,_54){var _55=dj.byId("logoUploadDialog");if(_55){dj.byId("alertDialog").hide();_55.hide();}if(_53.status==="success"){dj.byId(id).set("value",_53.details.id);d.attr(id+"-image","src",m.getServletURL("/screen/AjaxScreen/action/GetCustomerLogo?logoid="+_53.details.id));m.animate("fadeIn",d.byId(id+"-logo-row"));m._config.logoData=_53;m.populateLogoFeedBack();m.validateImage();}else{m.showTooltip(_53.details.message,dj.byId("openUploadLogoDialog").domNode);console.error("[FileUpload] File upload error, response status = "+_53.status);}_52.set("value","");_52.reset();}});return true;},showTransactionAddonsDialog:function(_56,_57,_58){var _59=_58||"",_5a,_5b;if(/customerReference/.test(_56)){_5a=_56.split("_");if(_5a.length===2){dj.byId("customerReference_target_bank").set("value",_5a[1]);_59="_"+_5a[1];}else{if(_5a.length>2){var _5c="";_5c=_5c+_5a[1];for(var i=2;i<_5a.length;i++){_5c=_5c+"_"+_5a[i];}dj.byId("customerReference_target_bank").set("value",_5c);_59="_"+_5c;}}_56="customerReference";}_57=_57||"";if(m._addons.bind.hasOwnProperty(_56)&&d.isFunction(m._addons.bind[_56])){m._addons.bind[_56](_57);}_5b=_57+_56+"Dialog"+_59;if(!m._config.isEditMode){d.query("#"+_5b+" input[id^="+_56+"], #"+_5b+" textarea[id^="+_56+"]").forEach(function(_5d){dj.byId(_5d.id).reset();});if(dj.byId("01entity")){dj.byId("01entity").reset();}}if(_56==="topic"){d.style(d.byId("new-logo-row"),"display","none");dj.byId("title_offsetcode_nosend").set("value","");dj.byId("link_offsetcode_nosend").set("value","");dj.byId("img_file_id_offsetcode_nosend").set("value","");dj.byId("dialog_topic_id_offsetcode_nosend").set("value","");dj.byId("new").set("value","");}dj.byId(_5b).show();},hideTransactionAddonsDialog:function(_5e,_5f){_5f=_5f||"";var _60=dj.byId("customerReference_target_bank")?dj.byId("customerReference_target_bank").get("value"):"";if(_60!==""){_60="_"+_60;}var _61=dj.byId(_5f+_5e+"Dialog"+_60);if(_61){_61.hide();}m._config.isEditMode=false;},openCounterpartyDialog:function(_62){var _63;if(dj.byId("input_cur_code").get("value")){m.dialog.show("ERROR",m.getLocalization("mandatoryCurrencyCodeError"));dj.byId("input_cur_code").focus();return false;}if(!m._config.isEditMode){d.query("#"+_62+"Dialog input[id^="+_62+"]").forEach(function(_64){if(_64.id){dj.byId(_64.id).set("value","");}});_63=dj.byId("counterparty_details_ft_cur_code_nosend");if(dj.byId("input_cur_code").get("value")){_63.set("value",dj.byId("input_cur_code").get("value"));m.setCurrency(dj.byId("input_cur_code"),["counterparty_details_ft_amt_nosend"]);}}dj.byId("counterpartyDialog").show();return true;},addCounterpartyAddon:function(_65){var _66=dj.byId("counterparty_details_ft_amt_nosend").get("value"),_67=0,_68,_69;if(m.addTransactionAddon(_65)){if(dj.byId("ft_amt").get("value")){_67=dj.byId("ft_amt").get("value");}dj.byId("ft_amt").set("value",_67+parseFloat(_66));_68=dj.byId("counterparty_details_ft_cur_code_nosend");_69=dj.byId("input_cur_code");if(_69.get("value")){_68.set("value",_69.get("value"));m.setCurrency(_69,["counterparty_details_ft_amt_nosend"]);}return true;}return false;},toggleAlertAdditionalFields:function(_6a){var _6b=dj.byId("alert"+_6a+"_details_usercode_nosend").get("value");if(_6b==="*"){dj.byId("alert"+_6a+"_details_langcode_nosend").domNode.parentNode.style.display="block";dj.byId("alert"+_6a+"_details_email_nosend").domNode.parentNode.style.display="block";}else{dj.byId("alert"+_6a+"_details_langcode_nosend").domNode.parentNode.style.display="none";dj.byId("alert"+_6a+"_details_email_nosend").domNode.parentNode.style.display="none";}},toggleAlertDateFields:function(_6c){var _6d=dj.byId("alert"+_6c+"_datecode_nosend"),_6e,_6f;if(_6d){_6e=dj.byId("alert"+_6c+"_product_nosend").get("value");_6d.reset();_6f=new d.data.ItemFileWriteStore({data:{identifier:"index",label:"name",items:[]}});for(var _70 in myDates){if(myDates.hasOwnProperty(_70)){code=_70.substring(0,2);value=_70.substring(3,_70.length);if(_6e===code){_6f.newItem({"index":value,"name":myDates[_70]});}}}_6d.set("store",_6f);}},validateImage:function(){var _71,_72="";if(dj.byId("new").get("value")===""&&!d.byId("image")){m.showTooltip(m.getLocalization("missingLogo"),dj.byId("openUploadLogoDialog").domNode);return false;}if(m._config.logoData&&(m._config.logoData.details.imagewidth>100||m._config.logoData.details.imageheight>100)){_72+=m.getLocalization("imageSizeInappropriate",[100,100]);m.showTooltip(_72,dj.byId("openUploadLogoDialog").domNode);return false;}return true;},populateLogoFeedBack:function(){dj.byId("img_file_id_offsetcode_nosend").set("value",m._config.logoData.details.id);},populateAttachmentInfo:function(){var _73=dijit.byId("product_code");var _74=dijit.byId("documents_details_mapped_attachment_name_send");if(_73&&(_73.get("value")==="EC"||_73.get("value")==="IC")&&_74){var _75=dijit.byId("attachment-file");var _76=(_75&&_75.store&&_75.store._arrayOfAllItems&&_75.store._arrayOfAllItems.length);if(_76&&_74){var _77=[];_77.push({id:"",name:""});d.forEach(_75.store._arrayOfAllItems,function(_78,_79){if(_78&&_78.attachment_id&&_78.file_name){_77.push({id:_78.attachment_id,name:_78.file_name});}});_74.store=new dojo.data.ItemFileReadStore({data:{identifier:"id",label:"name",items:_77}});}}},updateDocumentSection:function(){var _7a=dijit.byId("attachment-file");var _7b=[];var _7c=[];var _7d=[];if(_7a&&_7a.store&&_7a.store._arrayOfAllItems&&_7a.store._arrayOfAllItems.length){d.forEach(_7a.store._arrayOfAllItems,function(_7e,_7f){if(_7e&&_7e.attachment_id&&_7e.file_name){_7c.push(_7e.attachment_id.toString());_7d.push(_7e.file_name.toString());}});}d.query("*[id^='documents_details_mapped_attachment_id_']").forEach(function(_80,_81){var _82=dijit.byId("documents_details_mapped_attachment_id_"+_81);var _83=_82?_82.get("value"):"";var _84=dijit.byId("documents_details_mapped_attachment_name_"+_81);var _85=_84?_84.get("value"):"";var _86=(_7c&&_83!==""&&_7c.indexOf(_83)===-1&&_7d&&_85!==""&&_7d.indexOf(_85)===-1);var _87=dojo.byId("document_row_"+_81);if(_82&&_84&&_86){_82.set("value","");_84.set("value","");_87.cells[6].innerHTML="";}});}});})(dojo,dijit,misys);}