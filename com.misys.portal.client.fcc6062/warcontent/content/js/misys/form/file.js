/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.form.file"]){dojo._hasResource["misys.form.file"]=true;dojo.provide("misys.form.file");dojo.require("dojo.io.iframe");(function(d,dj,m){var _1=["txt","doc","pdf","gif","zip"],_2="file_",_3="file_ext",_4=".gif",_5,_6;function _7(_8){var _9=dj.byId(_8);if(_9&&_9.validate()){_9.execute();_9.hide();m.isFormDirty=true;}};function _a(){if(dj.byId("validation_type")){if(dj.byId("validation_type").get("value")===""){return "none";}else{return dj.byId("validation_type").get("value");}}};function _b(){if(dj.byId("entity")){if(dj.byId("entity").get("value")===""){return "none";}else{return dj.byId("entity").get("value");}}else{return "";}};function _c(){if(dj.byId("upload_file_type")){if(dj.byId("upload_file_type").get("value")===""){return "none";}else{return dj.byId("upload_file_type").get("value");}}};d.mixin(m,{formatFileActions:function(_d,_e){var _f=d.create("div"),_10=d.create("div",{"class":"gridActions","style":"text-align:center"}),_11=_e;if(!_5){_5=m.getContextualURL(m._config.imagesSrc+m._config.imageStore.downloadIcon);}if(!_6){_6=m.getContextualURL(m._config.imagesSrc+m._config.imageStore.deleteIcon);}d.create("img",{src:_5,alt:m.getLocalization("view_label"),onclick:"misys.downloadFile("+_d+", '"+_11+"')"},_10);d.create("img",{src:_6,alt:m.getLocalization("delete_label"),type:"remove"},_10);d.place(_10,_f);return _f.innerHTML;},formatFileViewActions:function(_12,_13){var _14=d.create("div"),_15=d.create("div",{"class":"gridActions","style":"text-align:center"}),_16=_13;if(!_5){_5=m.getContextualURL(m._config.imagesSrc+m._config.imageStore.downloadIcon);}if(!_6){_6=m.getContextualURL(m._config.imagesSrc+m._config.imageStore.deleteIcon);}d.create("img",{src:_5,alt:m.getLocalization("view_label"),onclick:"misys.downloadFile("+_12+", '"+_16+"')"},_15);d.place(_15,_14);return _14.innerHTML;},getFileIcon:function(_17){var _18=d.create("div"),_19=d.create("div",{"style":"text-align:center"}),_1a=false,ext,_1b=d.create("img",{alt:m.getLocalization("download")});var _1c=m._config.uploadservice_extensions_allowed;if((_17.lastIndexOf(".")!==-1)&&(_17.lastIndexOf(".")!==_17.length-1)){ext=_17.substring(_17.lastIndexOf(".")+1).toLowerCase();for(var x=0,len=_1c.length;x<len;x++){if(ext===_1c[x]){_1a=true;d.attr(_1b,"src",m.getContextualURL(m._config.imagesSrc)+_2+ext+_4);break;}}}if(!_1a){d.attr(_1b,"src",m.getContextualURL(m._config.imagesSrc)+_3+_4);}d.place(_1b,_19);d.place(_19,_18);return _18.innerHTML;},uploadFile:function(_1d,_1e){var _1f=dj.byId("file"+_1e)?dj.byId("file"+_1e).domNode:d.byId("file"+_1e),_20=dj.byId("file"+_1e)?dj.byId("file"+_1e).get("value"):_1f.value,_21,_22;if(dj.byId("file_name")){var _23=_20.replace(/^.*(\\|\/|\:)/,"");dj.byId("file_name").set("value",_23);}if(dj.byId("file_title")&&dj.byId("file_title").get("value")==""){return false;}if(!_20){m.showTooltip(m.getLocalization("mandatoryPathToFileError"),_1f);return false;}console.warn("[misys.form.file] Sending the request, with attachmentGroup '",_1e,+"'");m.dialog.show("PROGRESS",m.getLocalization("uploadingFile"));var _24=(document.getElementById("file"+_1e)&&document.getElementById("file"+_1e).files&&document.getElementById("file"+_1e).files[0]&&document.getElementById("file"+_1e).files[0].name)?encodeURIComponent(document.getElementById("file"+_1e).files[0].name):"";if(""===_24){_24=encodeURIComponent(_20);}d.io.iframe.send({url:m.getServletURL("/screen/GTPUploadScreen"),method:"post",handleAs:"json",content:{operation:"UPLOAD",identifier:"file"+_1e,file_name:_24,att_ref_id:dj.byId("ref_id")?dj.byId("ref_id").get("value"):"",att_tnx_id:dj.byId("tnx_id")?dj.byId("tnx_id").get("value"):"",att_item_id:dj.byId("item_id")?dj.byId("item_id").get("value"):"",attachment_type:dj.byId("attachment_type")&&dj.byId("attachment_type").get("value")!==""?dj.byId("attachment_type").get("value"):"",validation_type:_a(),entity:_b(),fileType:_c(),token:document.getElementById("_token").getAttribute("value"),attachmentgroup:_1e},form:d.byId("sendfiles"+_1e),handle:function(_25,_26){console.warn("[misys.form.file] Data response is",_25);console.warn("[misys.form.file] io args are",_26);console.warn("[misys.form.file] data.status is",_25.status);if(_25&&_25.details&&_25.details.file_name){_25.details.file_name=_25.details.file_name.replace(/^.*(\\|\/|\:)/,"");}else{if(_25.details!==undefined&&_25.details!==null){_25.details.file_name=_20.replace(/^.*(\\|\/|\:)/,"");}}dj.byId("alertDialog").hide();if(_25.status==="success"){dj.byId("attachment_id"+_1e).set("value",_25.details.id);dj.byId("file_type"+_1e).set("value",_25.details.type);dj.byId("file_name"+_1e).set("value",_25.details.file_name);dj.byId("file_title"+_1e).set("value",_25.details.title);_7(_1d);}else{var _27=d.byId("alertDialog_underlay");if(_27){d.style(_27,"display","none");}if(_25.details&&_25.details.message&&_25.details.message.length>0){m.dialog.show("ERROR",_25.details.message);}else{if(_25.details===undefined||_25.details===null){_22=m.getLocalization("fileSizeExceeded");m.dialog.show("ERROR",_22);}}console.warn("[misys.form.file] File upload error, response status = "+_25.status);}}});return true;},downloadFile:function(_28,_29){var _2a=_29||"",_2b=d.create("input"),_2c;if(!dj.byId("downloadfiles"+_2a)){d.parser.parse(d.byId("downloadfiles-container"+ +_2a));}_2b.type="hidden";_2b.name="attachmentid";_2b.id="attachmentid";_2b.value=_28;d.byId("downloadfiles"+_2a).appendChild(_2b);if(dj.byId("item_id")){_2c=d.doc.createElement("input");_2c.type="hidden";_2c.name="attachment_type";_2c.id="attachment_type";_2c.value="news";d.byId("downloadfiles"+_2a).appendChild(_2c);}dojo.parser.parse(dojo.byId("downloadfiles"+_2a));dj.byId("downloadfiles"+_2a).submit();d.destroy(d.byId("attachmentid"));if(d.byId("attachment_type")&&dj.byId("item_id")){d.destroy(d.byId("attachment_type"));}},clearFilePath:function(){var x=document.getElementById("file");if(x){x.setAttribute("type","file");x.setAttribute("type","text");x.setAttribute("type","file");}var y=document.getElementById("fileinvoice");if(y){y.setAttribute("type","file");y.setAttribute("type","text");y.setAttribute("type","file");}},addFileItem:function(id){var _2d=d.byId("attachment_type");var _2e="attachment-file"+id;if(!dj.byId(_2e)){d.style("noFilesNotice"+id,"display","none");d.parser.instantiate([d.byId(_2e)]);}if(d.byId("file")){d.byId("file").value="";}if(id!==""){var _2f="file"+id;if(_2f){d.byId(_2f).value="";}}dj.byId(_2e).addItem();},addBulkFileItem:function(id){var _30=d.byId("attachment_type"),_31=dj.byId("entity")?dj.byId("entity").get("value"):"";var _32="attachment-file"+id;if(!dj.byId(_32)){d.style("noFilesNotice"+id,"display","none");d.parser.instantiate([d.byId(_32)]);}if(dj.byId("entity")&&_31===""){var _33=m.getLocalization("selectEntityForFileUpload");_31.focus();_31.set("state","Error");dijit.hideTooltip(_31.domNode);dijit.showTooltip(_33,_31.domNode,0);}else{if(d.byId("file")){d.byId("file").value="";}dj.byId(_32).addItem();}},showUploadDialog:function(_34){var _35=dj.byId("fileUploadDialog"),_36=_34||"",_37=d.byId("max-files"+_36).value||1,_38=dj.byId("file");if(!_35){d.parser.parse("fileUploadFields");_35=dj.byId("fileUploadDialog");}dj.byId("group").set("value",_36);dj.byId("uploadButton").set("disabled",(m._config.attachedFiles[_36]>=_37));dj.byId("title").set("value","");_38.set("readOnly",false);_38.set("value","");_35.show();}});d.ready(function(){d.require("misys.product.widget.AttachmentFiles");d.require("misys.product.widget.AttachmentFile");});})(dojo,dijit,misys);}