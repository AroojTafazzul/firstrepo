/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.system.widget.MultipleAccountGrid"]){dojo._hasResource["misys.system.widget.MultipleAccountGrid"]=true;dojo.provide("misys.system.widget.MultipleAccountGrid");dojo.experimental("misys.system.widget.MultipleAccountGrid");dojo.require("misys.grid.GridMultipleItems");dojo.require("misys.system.widget.AccountDataGrid");dojo.declare("misys.system.widget.MultipleAccountGrid",[misys.grid.GridMultipleItems],{data:{identifier:"store_id",label:"store_id",items:[]},templatePath:null,templateString:dojo.byId("accounts-template").innerHTML,dialogId:"account-dialog-template",xmlTagName:"accounts",xmlSubTagName:"account",viewMode:"edit",gridColumns:["account_number","type","ccy","nra","description","account_product_type","cust_account_type","bank_id","branch_code","account_type","existing_bib_account","created_dttm","routing_bic","nickname","actv_flag","sweeping_enabled","pooling_enabled","charge_account_for_liq"],propertiesMap:{account_number:{_fieldName:"account_number"},type:{_fieldName:"type"},ccy:{_fieldName:"ccy"},description:{_fieldName:"description"},nra:{_fieldName:"nra"},account_product_type:{_fieldName:"account_product_type"},cust_account_type:{_fieldName:"cust_account_type"},bank_id:{_fieldName:"bank_id"},branch_code:{_fieldName:"branch_code"},account_type:{_fieldName:"account_type"},existing_bib_account:{_fieldName:"existing_bib_account"},created_dttm:{_fieldName:"created_dttm"},routing_bic:{_fieldName:"routing_bic"},actv_flag:{_fieldName:"actv_flag"},sweeping_anabled:{_fieldName:"sweeping_enabled"},pooling_enabled:{_fieldName:"pooling_enabled"},charge_account_for_liq:{_fieldName:"charge_account_for_liq"}},layout:[],_itemFields:null,_createStoreMultipleAccountGrid:function(){var _1=dijit.byId("legal_id_type").getValue(),_2=dijit.byId("legal_id_no").getValue(),_3=dijit.byId("country_legalid").getValue(),_4=dijit.byId("reference").getValue(),_5=new dojo.data.ItemFileWriteStore({jsId:"multipleAccounts",url:misys.getServletURL("/screen/AjaxScreen/action/GetMultipleAccountsForCIF?legal_id_type="+_1+"&legal_id_no="+_2+"&legal_country_no="+_3+"&reference="+_4)});dijit.byId("account-interface-grid").setStore(_5);this._disableExistingAccountsForSelection();},onCompleteGrid1:function(_6,_7){dojo.forEach(_6,function(_8){var _9=_8["account_number"][0];dijit.byId("account-interface-grid").store.fetch({query:{store_id:"*"},onComplete:function(_a,_b){var _c=0;dojo.forEach(_a,function(_d){var _e=_d["account_number"][0];if(_9===_e){dijit.byId("account-interface-grid").store.setValue(_d,"existing_bib_account","Yes");dijit.byId("account-interface-grid").rowSelectCell.setDisabled(_c,true);}_c++;});}});});},_disableExistingAccountsForSelection:function(){if(this.grid){this.grid.store.fetch({query:{store_id:"*"},onComplete:this.onCompleteGrid1});dijit.byId("account-interface-grid").store.save();}},addItem:function(_f){if(!((dijit.byId("legal_id_type").getValue()==="")||(dijit.byId("legal_id_no").getValue()==="")||(dijit.byId("country_legalid").getValue()==="")||(dijit.byId("reference").getValue()===""))){this.dialogId="account-dialog-template";this._createStoreMultipleAccountGrid();this.inherited(arguments);}},startup:function(){if(this._started){return;}this.dataList=[];this.layout=[{name:"Account Number",field:"account_number",width:"15%",noresize:true},{name:"Account Type",field:"type",width:"10%",noresize:true},{name:"Account Product Type",field:"account_product_type",width:"10%",noresize:true},{name:"Ccy",field:"ccy",width:"5%",noresize:true},{name:"Description",field:"description",width:"20%",noresize:true},{name:"Customer Account Type",field:"cust_account_type",width:"10%",noresize:true},{name:"NRA",field:"nra",width:"5%",noresize:true},{name:"Nick Name",field:"nickname",width:"10%",noresize:true},{name:"Active",field:"actv_flag",width:"5%",noresize:true},{name:" ",field:"actions",formatter:misys.grid.formatReportActions,width:"10%",noresize:true},{name:"Id",field:"store_id",headerStyles:"display:none",cellStyles:"display:none",noresize:true},{name:"Sweeping Enabled",field:"sweeping_enabled",headerStyles:"display:none",cellStyles:"display:none",noresize:true},{name:"Pooling Enabled",field:"pooling_enabled",headerStyles:"display:none",cellStyles:"display:none",noresize:true},{name:"Charge Account for Liquidity",field:"charge_account_for_liq",headerStyles:"display:none",cellStyles:"display:none",noresize:true}];if(this.viewMode=="view"){this.layout=[{name:"Account Number",field:"account_number",width:"15%",noresize:true},{name:"Account Type",field:"type",width:"10%",noresize:true},{name:"Account Product Type",field:"account_product_type",width:"10%",noresize:true},{name:"Ccy",field:"ccy",width:"5%",noresize:true},{name:"Description",field:"description",width:"20%",noresize:true},{name:"Customer Account Type",field:"cust_account_type",width:"10%",noresize:true},{name:"NRA",field:"nra",width:"5%",noresize:true},{name:"Nick Name",field:"nickname",width:"10%",noresize:true},{name:"Id",field:"store_id",headerStyles:"display:none",cellStyles:"display:none",noresize:true},{name:"Sweeping Enabled",field:"sweeping_enabled",headerStyles:"display:none",cellStyles:"display:none",noresize:true},{name:"Pooling Enabled",field:"pooling_enabled",headerStyles:"display:none",cellStyles:"display:none",noresize:true},{name:"Charge Account for Liquidity",field:"charge_account_for_liq",headerStyles:"display:none",cellStyles:"display:none",noresize:true}];}this.dataList=[];if(this.hasChildren()){dojo.forEach(this.getChildren(),function(_10){var _11={account_number:_10.get("account_number"),type:_10.get("type"),ccy:_10.get("ccy"),nra:_10.get("nra"),description:_10.get("description"),account_product_type:_10.get("account_product_type"),cust_account_type:_10.get("cust_account_type"),bank_id:_10.get("bank_id"),branch_code:_10.get("branch_code"),account_type:_10.get("account_type"),created_dttm:_10.get("created_dttm"),routing_bic:_10.get("routing_bic"),nickname:_10.get("nickname"),actv_flag:_10.get("actv_flag"),sweeping_enabled:_10.get("sweeping_enabled"),pooling_enabled:_10.get("pooling_enabled"),charge_account_for_liq:_10.get("charge_account_for_liq")};this.dataList.push(_11);},this);}this.inherited(arguments);misys.connect(this,"onCellClick",this,this.handleGridAction);},checkDialog:function(){var _12=dijit.byId(this.dialogId);if(_12){this.dialog=_12;}else{var id=this.dialogId!==""?this.dialogId:"dialog-"+(xmlTag!==""?xmlTag+"-":"")+dojox.uuid.generateRandomUuid();var _13=this.dialogClassName!==null?this.dialogClassName:"misys.widget.Dialog";this.dialog=dojo.eval("new "+_13+"({}, dojo.byId('"+id+"'))");this.dialog.set("refocus",false);this.dialog.set("draggable",false);dojo.addClass(this.dialog.domNode,"multipleAccountDialog");this.dialog.startup();document.body.appendChild(this.dialog.domNode);}return this.dialog;},collectRequiredField:function(){},updateData:function(){var _14=this;var _15=this.grid;if(dijit.byId("account-interface-grid")){var _16={},_17=dijit.byId("account-interface-grid").selection.getSelected(),_18=[];dojo.forEach(_17,function(_19){for(var i=0,len=dijit.byId("account-dialog-template").gridMultipleItemsWidget.gridColumns.length;i<len;i++){var _1a=dijit.byId("account-dialog-template").gridMultipleItemsWidget.gridColumns[i];var _1b=_19[_1a];if((_1b!=null&&_1b!=undefined)){_16[_1a]=_1b;}}if(_15!=null&&_15.store!=null){var _1c={"store_id":_19["store_id"][0],"account_number":_19["account_number"][0],"type":_19["type"]?_19["type"][0]:"","account_product_type":_19["account_product_type"]?_19["account_product_type"][0]:"","ccy":_19["ccy"]?_19["ccy"][0]:"","description":_19["description"]?_19["description"][0]:"","cust_account_type":_19["cust_account_type"]?_19["cust_account_type"][0]:"","bank_id":_19["bank_id"]?_19["bank_id"][0]:"","branch_code":_19["branch_code"]?_19["branch_code"][0]:"","nra":_19["nra"]?_19["nra"][0]:"","existing_bib_account":_19["existing_bib_account"]?_19["existing_bib_account"][0]:"","account_type":_19["account_type"]?_19["account_type"][0]:"","routing_bic":_19["routing_bic"]?_19["routing_bic"][0]:"","nickname":_19["nickname"]?_19["nickname"][0]:"","actv_flag":_19["actv_flag"]?_19["actv_flag"][0]:"","sweeping_enabled":_19["sweeping_enabled"]?_19["sweeping_enabled"][0]:"","pooling_enabled":_19["pooling_enabled"]?_19["pooling_enabled"][0]:"","charge_account_for_liq":_19["charge_account_for_liq"]?_19["charge_account_for_liq"][0]:""};_15.store.newItem(_1c);}else{_18.push(_16);}_16={};});if(_15==null){var _1d={identifier:"store_id",label:"store_id",items:_18};_14.store=new dojo.data.ItemFileWriteStore({data:_1d});_14.createDataGrid();_15=this.grid;}}_15.store.save();_15.render();_14.renderAll();_14._retrieveAccounts();},createDataGrid:function(){var _1e=this.gridId;if(_1e===""){_1e="grid-"+(this.xmlTagName!==""?this.xmlTagName+"-":"")+dojox.uuid.generateRandomUuid();}this.grid=new misys.system.widget.AccountsDataGrid({jsId:_1e,id:_1e,store:this.store,structure:this.layout,autoHeight:true,selectionMode:"multiple",columnReordering:true,autoWidth:true,initialWidth:"100%"},document.createElement("div"));this.grid.gridMultipleItemsWidget=this;this.addChild(this.grid);this.onGridCreate();},_retrieveAccounts:function(){var _1f=[];this.grid.store.fetch({query:{store_id:"*"},onComplete:dojo.hitch(this,function(_20,_21){dojo.forEach(_20,function(_22){var _23=_22["account_number"];var ccy=_22["ccy"];_1f.push({name:_23,value:_23,ccy:ccy});},this);dijit.byId("charging_account").store=new dojo.data.ItemFileWriteStore({data:{identifier:"value",items:_1f}});})});},updateAccountNickName:function(){var _24=this.dialog.storeId;this._itemFields=this._retrieveItemFields();this._itemFields["store_id"]=(_24!=null?_24:dojox.uuid.generateRandomUuid());this.grid.store.fetch({query:{store_id:_24},onComplete:dojo.hitch(this,function(_25,_26){if(_25.length>0){var _27=_25[0];var _28=this._itemFields["nickname"];if((_28!=null&&_28!=undefined)){this.grid.store.setValue(_27,"nickname",_28);}}else{this.grid.store.newItem(this._itemFields);}})});this.grid.store.save();this.grid.render();}});}