/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.system.widget.LimitDetails"]){dojo._hasResource["misys.system.widget.LimitDetails"]=true;dojo.provide("misys.system.widget.LimitDetails");dojo.experimental("misys.system.widget.LimitDetails");dojo.require("misys.grid.GridMultipleItems");dojo.require("misys.system.widget.LimitDetail");dojo.declare("misys.system.widget.LimitDetails",[misys.grid.GridMultipleItems],{data:{identifier:"store_id",label:"store_id",items:[]},handle:null,templatePath:null,templateString:dojo.byId("limit-details-template").innerHTML,dialogId:"limit-details-dialog-template",gridId:"limit_defn_grid",xmlTagName:"limits",xmlSubTagName:"limit",gridColumns:["product_code","product_code_label","sub_product_code","sub_product_code_label","product_type_code","product_type_code_label","product_template","beneficiary_name","beneficiary_country","limit_ref","limit_amt","limit_cur_code","limit_review_date","limit_pricing","limit_outstanding_amt","limit_pending_bank_amt","limit_utilised_amt","limit_utilised_percent","entity_avail_list_limit","entity_select_list_limit","existing_limit","limit_status","limit_status_label","limit_id","linked_entities_number"],propertiesMap:{product_code:{_fieldName:"product_code"},product_code_label:{_fieldName:"product_code_label"},sub_product_code:{_fieldName:"sub_product_code"},sub_product_code_label:{_fieldName:"sub_product_code_label"},product_type_code:{_fieldName:"product_type_code"},product_type_code_label:{_fieldName:"product_type_code_label"},product_template:{_fieldName:"product_template"},beneficiary_name:{_fieldName:"beneficiary_name"},beneficiary_country:{_fieldName:"beneficiary_country"},limit_ref:{_fieldName:"limit_ref"},limit_amt:{_fieldName:"limit_amt"},limit_cur_code:{_fieldName:"limit_cur_code"},limit_review_date:{_fieldName:"limit_review_date"},limit_pricing:{_fieldName:"limit_pricing"},limit_outstanding_amt:{_fieldName:"limit_outstanding_amt"},limit_pending_bank_amt:{_fieldName:"limit_pending_bank_amt"},limit_utilised_amt:{_fieldName:"limit_utilised_amt"},limit_utilised_percent:{_fieldName:"limit_utilised_percent"},entity_avail_list_limit:{_fieldName:"entity_avail_list_limit"},entity_select_list_limit:{_fieldName:"entity_select_list_limit"},existing_limit:{_fieldName:"existing_limit"},limit_status:{_fieldName:"limit_status"},limit_status_label:{_fieldName:"limit_status_label"},linked_entities_number:{_fieldName:"linked_entities_number"}},basicMap:{product_code:{_fieldName:"product_code"},sub_product_code:{_fieldName:"sub_product_code"},product_type_code:{_fieldName:"product_type_code"},product_template:{_fieldName:"product_template"},limit_counterparty:{_fieldName:"beneficiary_name"},beneficiary_country:{_fieldName:"beneficiary_country"},limit_ref:{_fieldName:"limit_ref"},limit_amt:{_fieldName:"limit_amt"},limit_cur_code:{_fieldName:"limit_cur_code"},limit_review_date:{_fieldName:"limit_review_date"},limit_pricing:{_fieldName:"limit_pricing"},outstanding_amt:{_fieldName:"limit_outstanding_amt"},pending_bank_amt:{_fieldName:"limit_pending_bank_amt"},utilised_amt:{_fieldName:"limit_utilised_amt"},limit_status:{_fieldName:"limit_status"},limit_id:{_fieldName:"limit_id"}},entityMap:{attached_entities:{_fieldName:"entity_select_list_limit"}},layout:[{name:"limit_ref",field:"limit_ref",width:"10%"},{name:"limit_cur_code",field:"limit_cur_code",width:"3%"},{name:"limit_amt",field:"limit_amt",width:"10%"},{name:"limit_review_date",field:"limit_review_date",width:"7%"},{name:"product_code_label",field:"product_code_label",width:"8%"},{name:"sub_product_code_label",field:"sub_product_code_label",width:"8%"},{name:"limit_outstanding_amt",field:"limit_outstanding_amt",width:"10%"},{name:"limit_pending_bank_amt",field:"limit_pending_bank_amt",width:"10%"},{name:"limit_utilised_amt",field:"limit_utilised_amt",width:"10%"},{name:"limit_utilised_percent",field:"limit_utilised_percent",width:"4%"},{name:"linked_entities_number",field:"linked_entities_number",width:"5%"},{name:"limit_status_label",field:"limit_status_label",width:"5%"},{name:" ",field:"actions",formatter:misys.grid.formatReportActions,width:"5%"},{name:"Id",field:"store_id",headerStyles:"display:none",cellStyles:"display:none"}],mandatoryFields:["product_code","sub_product_code","limit_ref","limit_review_date","limit_cur_code","limit_amt","limit_status"],startup:function(){this.dataList=[];if(this.hasChildren()){dojo.forEach(this.getChildren(),function(_1){if(_1.createItem){var _2=_1.createItem();this.dataList.push(_2);}},this);}this.inherited(arguments);},openDialogFromExistingItem:function(_3,_4){var _5=_3[0];misys._config.storeId=_5.store_id[0];if(dijit.byId("sub_product_code_hidden")){dijit.byId("sub_product_code_hidden").set("value",_5.sub_product_code[0]);}this.inherited(arguments);if(this.overrideDisplaymode!=="view"){if(_5.existing_limit&&_5.existing_limit!==null&&_5.existing_limit[0]==="Y"){misys.toggleFields(false,["limit_ref","limit_cur_code","product_code","sub_product_code","product_type_code","product_template","beneficiary_name","beneficiary_country"],null,true,false);if(dijit.byId("previous_limit_amt")){dijit.byId("previous_limit_amt").set("value",_5.limit_amt[0]);}}else{misys.toggleFields(true,["limit_ref","limit_cur_code","product_code","sub_product_code","product_type_code","product_template","beneficiary_name","beneficiary_country"],null,true,false);if(dijit.byId("previous_limit_amt")){dijit.byId("previous_limit_amt").set("value","");}}}if(dijit.byId("beneficiary_name")){dijit.byId("beneficiary_name").set("readOnly",true);}var _6=dojo.byId("entity_select_list_facility");var _7=dojo.byId("entity_avail_list_limit");var _8=dijit.byId("entity_select_list_limit")?dijit.byId("entity_select_list_limit").getValue():"";if(_7&&_6){_7.innerHTML=[];for(var i=0;i<_6.options.length;i++){var _9=_6.options[i].value;if(_8.indexOf(_9)==-1){var op=dojo.create("option");op.label=_6.options[i].label;op.value=_6.options[i].value;op.innerHTML=_6.options[i].value;_7.appendChild(op);}}}if(this.overrideDisplaymode=="view"){if(dijit.byId("product_code")){dijit.byId("product_code").attr("value",_5.product_code_label[0],false);}if(dijit.byId("sub_product_code")){dijit.byId("sub_product_code").attr("value",_5.sub_product_code_label[0],false);}if(dijit.byId("product_type_code")){dijit.byId("product_type_code").attr("value",_5.product_type_code_label[0],false);}if(dijit.byId("limit_status")){dijit.byId("limit_status").attr("value",_5.limit_status_label[0],false);}}},validatePreRequisite:function(){var _a=["review_date","facility_amt","base_cur_code","bank_abbv_name","facility_reference","bo_reference","entity_select_list_facility","facility_status"];var _b=true;for(field in _a){var _c=_a[field];if(dijit.byId(_c)&&(dijit.byId(_c).getValue()==null||dijit.byId(_c).getValue()==""||dijit.byId(_c).getValue()+""=="NaN")){_b=false;}}return _b;},addItem:function(_d){misys.toggleFields(true,["limit_ref","limit_amt","limit_cur_code","product_code","sub_product_code","product_type_code","product_template","beneficiary_name","beneficiary_country"],null,true,false);misys._config.storeId="";if(dojo.byId("productTypeDiv")){misys.animate("wipeOut",dojo.byId("productTypeDiv"));}var _e=this.validatePreRequisite();var _f=dijit.byId("addLimitButton");if(_e!=true){if(dijit.byId("entity_select_list_facility")){misys.dialog.show("ERROR",misys.getLocalization("addLimitValidationWE"));}else{misys.dialog.show("ERROR",misys.getLocalization("addLimitValidationWOE"));}return;}var _10=dojo.byId("entity_select_list_facility");var _11=dojo.byId("entity_avail_list_limit");var _12=dojo.byId("entity_select_list_limit");if(_11&&_10&&_12){_11.innerHTML=[];_12.innerHTML=[];for(var i=0;i<_10.options.length;i++){var op=dojo.create("option");op.value=_10.options[i].value;op.innerHTML=_10.options[i].value;_11.appendChild(op);}}if(dijit.byId("previous_limit_amt")){dijit.byId("previous_limit_amt").set("value","");}if(dijit.byId("limit_utilised_amt")){dijit.byId("limit_utilised_amt").set("value","");}if(dijit.byId("limit_utilised_percent")){dijit.byId("limit_utilised_percent").set("value","");}this.inherited(arguments);if(dijit.byId("beneficiary_name")){dijit.byId("beneficiary_name").set("readOnly",true);}},toXML:function(){var xml=[];if(this.xmlTagName){xml.push("<",this.xmlTagName,">");}if(this.grid){this.grid.store.fetch({query:{store_id:"*"},onComplete:dojo.hitch(this,function(_13,_14){xml.push(this.itemToXML(_13,this.xmlSubTagName));})});}if(this.xmlTagName){xml.push("</",this.xmlTagName,">");}return xml.join("");},itemToXML:function(_15,_16){var xml=[];dojo.forEach(_15,function(_17){if(_17){if(_16){xml.push("<",_16,">");}for(var _18 in _17){var _19=dojo.isArray(_17[_18])?_17[_18][0]:_17[_18];if(dojo.isObject(_19)&&_19._type){var _1a=_19._type;var _1b=dojo.eval(_1a);var _1c=new _1b({});xml.push("<",_1c.xmlTagName,">");xml.push(this.itemToXML(_19._values,_1c.xmlSubTagName,xml));xml.push("</",_1c.xmlTagName,">");}else{if(_18!="store_id"&&_18.match("^_")!="_"){_19=dojo.isArray(_17[_18])?_17[_18][0]:_17[_18];_19+="";for(var _1d in this.basicMap){if(this.basicMap[_1d]._fieldName===_18){xml.push("<",_1d,">",dojox.html.entities.encode(_19,dojox.html.entities.html),"</",_1d,">");break;}}for(var _1e in this.entityMap){if(this.entityMap[_1e]._fieldName===_18){xml.push("<attached_entities>");if(_19!==""){var arr=_19.split(",");for(var i in arr){xml.push("<entity><entity_abbv_name>"+arr[i]+"</entity_abbv_name></entity>");}}xml.push("</attached_entities>");}}}}}if(_16){xml.push("</",_16,">");}}},this);return xml.join("");},createItemsFromJson:function(_1f){this.inherited(arguments);},validateTemplateEntity:function(){var _20=dijit.byId("product_template"),_21=dijit.byId("bank_abbv_name").get("value"),_22=dijit.byId("entity_select_list_limit"),_23=_22?_22.get("value"):[],_24=[];if(_23&&_23.length>0&&_20&&_20.get("value")+"S"!=="S"){var _25=misys._config.guaranteeTemplateByEntityList[_21],_26=misys._config.guaranteeTemplateByEntityList[_21]["ALL"];for(var i=0;i<_23.length;i++){var _27=_23[i],_28=_25[_27],_29=false;if(!_28||(_28&&_28.indexOf(_20.get("value"))===-1)){if(!_26||(_26.indexOf(_20.get("value"))===-1)){_24.push(_27);}}}}if(_24&&_24.length>0){misys.dialog.show("ERROR",misys.getLocalization("inValidEntitesForTemplate",[_24.toString(),_20.get("value")]));return false;}else{return true;}},performValidation:function(){if(this.overrideDisplaymode!=="view"){var _2a=dijit.byId("entity_select_list_limit")?dijit.byId("entity_select_list_limit").getValue().length:0;dijit.byId("linked_entities_number").set("value",_2a);var _2b=this.mandatoryFields;var _2c=true;for(field in _2b){var _2d=_2b[field];if(dijit.byId(_2d)&&(dijit.byId(_2d).getValue()==null||dijit.byId(_2d).getValue()==""||dijit.byId(_2d).getValue()+""=="NaN")){dijit.byId(_2d).state="Error";_2c=false;}}if(!_2c){misys.dialog.show("ERROR",misys.getLocalization("addLimitValidationWOE"));return _2c;}else{if(dijit.byId("entity_select_list_limit")&&dijit.byId("entity_select_list_limit").get("value")&&dijit.byId("entity_select_list_limit").get("value").length<1){misys.dialog.show("ERROR",misys.getLocalization("addLimitValidationWE"));return false;}}var _2e=this.validateTemplateEntity();if(!_2e){return false;}var _2f=this.grid;var _30=dijit.byId("product_code"),_31=dijit.byId("sub_product_code"),_32=dijit.byId("product_type_code"),_33=dijit.byId("product_template"),_34=dijit.byId("counterparty"),_35=dijit.byId("beneficiary_country"),_36=dijit.byId("limit_amt"),_37=dijit.byId("limit_cur_code"),_38=dijit.byId("limit_ref"),_39=dijit.byId("currency_validation"),_3a=dijit.byId("limit_total_amount_validation"),_3b=_36.get("value");var _3c=true;var _3d=true;if(_2f!==null&&_2f.store!==null&&_2f.store._arrayOfTopLevelItems.length>0){_2f.store.fetch({query:{store_id:"*"},onComplete:function(_3e,_3f){_3d=dojo.some(_3e,function(_40){if(misys._config.storeId!==_40.store_id[0]){_3b=dojo.number.parse(_3b)+dojo.number.parse(_40.limit_amt[0]);if(_30.getValue()===_40.product_code[0]&&_31.getValue()===_40.sub_product_code[0]){_3c=false;}if(!_3c&&_39&&_39.getValue()==="true"){if(_37.getValue()===_40.limit_cur_code[0]){_3c=false;}else{_3c=true;}}if(!_3c){var _41=dijit.byId("product_type_code"),_33=dijit.byId("product_template"),_34=dijit.byId("beneficiary_name"),_35=dijit.byId("beneficiary_country");if(_41&&_41.get("value")!==_40.product_type_code[0]){_3c=true;}else{if(_33&&_33.get("value")!==_40.product_template[0]){_3c=true;}else{if(!_3c&&_34&&_34.get("value")!==_40.beneficiary_name[0]){_3c=true;}else{if(!_3c&&_35&&_35.get("value")!==_40.beneficiary_country[0]){_3c=true;}}}}}}if(!_3c){return !_3c;}});}});if(_3d){misys.dialog.show("ERROR",misys.getLocalization("limitDuplicationError"));return _3c;}}if(_3a&&_3a.getValue()==="true"){if(dijit.byId("facility_amt")&&_3b>dijit.byId("facility_amt").get("value")){misys.dialog.show("ERROR",misys.getLocalization("totalLimitAmountError"));return false;}}if(dijit.byId("product_code")){dijit.byId("product_code_label").set("value",dijit.byId("product_code").get("displayedValue"));}if(dijit.byId("sub_product_code")){dijit.byId("sub_product_code_label").set("value",dijit.byId("sub_product_code").get("displayedValue"));}if(dijit.byId("limit_status")){dijit.byId("limit_status_label").set("value",dijit.byId("limit_status").get("displayedValue"));}}this.inherited(arguments);return true;},onGridCreate:function(){if(dijit.byId("enablePendingBank")&&dijit.byId("enablePendingBank").get("value")==="N"){if(this.grid&&this.grid!=null){for(var i=0;i<this.grid.layout.cellCount;i++){if(this.grid.getCell(i).field==="limit_pending_bank_amt"){this.grid.layout.setColumnVisibility(i,false);break;}}}}}});}