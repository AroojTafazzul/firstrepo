/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.product.widget.AttachmentFiles"]){dojo._hasResource["misys.product.widget.AttachmentFiles"]=true;dojo.provide("misys.product.widget.AttachmentFiles");dojo.experimental("misys.product.widget.AttachmentFiles");dojo.require("misys.grid.GridMultipleItems");dojo.declare("misys.product.widget.AttachmentFiles",[misys.grid.GridMultipleItems],{data:{identifier:"store_id",label:"store_id",items:[]},templatePath:null,templateString:"",dialogId:"file-attachment-dialog-template",xmlTagName:"attachments",xmlSubTagName:"attachment",attachmentGroup:"",dialogOKCallback:"",showStatusColumn:"",viewMode:"edit",gridColumns:["attachment_id","file_type","file_title","file_name","file_status","file_access_dttm","file_description","fileact"],propertiesMap:{},maxFiles:0,fileActVisible:false,addItem:function(_1){var _2=this;var _3=false;if(_2.grid&&_2.grid.store&&_2.maxFiles!==0&&misys._config.isCustUser){_2.grid.store.fetch({onBegin:function(_4){if(_4<_2.maxFiles){_3=true;}else{misys.dialog.show("ERROR",misys.getLocalization("maxFileUploadReached"));}}});}else{_3=true;}if(_3){_2.inherited(arguments);dojo.forEach(dijit.byId("sendfiles"+this.attachmentGroup).getChildren(),function(_5){if(_5.name!="attachment-type"){_5.set("value","");_5.set("state","");}else{_5.set("value",dijit.byId("attachment-type").get("_resetValue"));}});}},layout:[],dialogExecute:function(_6){setTimeout(dojo.hitch(this.gridMultipleItemsWidget,"updateData"),500);var _7=this.gridMultipleItemsWidget.dialogOKCallback;setTimeout(function(){dojo.eval(_7);},600);},startup:function(){if(this._started){return;}var _8=this.attachmentGroup;if(this.attachmentGroup!==""){this.templateString=dojo.byId("file-attachment-template"+this.attachmentGroup).innerHTML;this.dialogId="file-attachment"+this.attachmentGroup+"-dialog-template";this.xmlTagName="attachments-"+this.attachmentGroup;this.propertiesMap={attachment_id:{_fieldName:"attachment_id"+_8},file_type:{_fieldName:"file_type"+_8},file_title:{_fieldName:"file_title"+_8},file_name:{_fieldName:"file_name"+_8},file_status:{_fieldName:"file_status"+_8},file_status_decoded:{_fieldName:"file_status_decoded"+_8},file_access_dttm:{_fieldName:"file_access_dttm"+_8},file_description:{_fieldName:"file_description"+_8}};}var _9=this.viewMode;var _a={name:"FileAct",field:"fileact",get:function(_b,_c){var _d=this.grid.selection.isSelected(_b);if(_c&&_c.fileact&&_c.fileact[0]==="Y"&&!misys.isFormDirty){_d=true;this.grid.selection.addToSelection(_b);}var _e="<input type=\"checkbox\""+(_d?" checked=\"checked\"":"")+" />";return _e;},formatter:misys.grid.formatHTML,width:"5%",noresize:true,styles:"text-align: center;"};this.layout=[{name:"Picture",field:"file_name",formatter:function(_f){return misys.getFileIcon(_f);},width:"5%",noresize:true},{name:"Title",field:"file_title",width:"35%",noresize:true},{name:"FileName",field:"file_name",width:"35%",noresize:true,formatter:function(_10){return misys.grid.formatSimpleHTML(_10);}},{name:" ",field:"attachment_id",formatter:function(_11){return misys.formatFileActions(_11,_8);},width:"10%",noresize:true},_a];if(this.viewMode=="view"){if(this.showStatusColumn=="true"){this.layout=[{name:" ",field:"file_name",formatter:function(_12){return misys.getFileIcon(_12);},width:"5%",noresize:true},{name:"Title",field:"file_title",width:"30%",noresize:true},{name:"FileName",field:"file_name",width:"30%",noresize:true,formatter:function(_13){return misys.grid.formatSimpleHTML(_13);}},{name:"Status",field:"file_status_decoded",width:"5%",noresize:true},{name:" ",field:"attachment_id",formatter:function(_14){return misys.formatFileViewActions(_14,_8);},width:"10%",noresize:true},{name:"FileAct",field:"fileact",width:"5%",noresize:true,styles:"text-align: center;",formatter:function(_15){if(_15==="Y"){return "Yes";}else{if(_15==="Z"){return "NA";}else{return "No";}}}}];}else{this.layout=[{name:" ",field:"file_name",formatter:function(_16){return misys.getFileIcon(_16);},width:"5%",noresize:true},{name:"Title",field:"file_title",width:"30%",noresize:true},{name:"FileName",field:"file_name",width:"35%",noresize:true,formatter:function(_17){return misys.grid.formatSimpleHTML(_17);}},{name:" ",field:"attachment_id",formatter:function(_18){return misys.formatFileViewActions(_18,_8);},width:"10%",noresize:true},{name:"FileAct",field:"fileact",width:"5%",noresize:true,styles:"text-align: center;",formatter:function(_19){if(_19==="Y"){return "Yes";}else{if(_19==="Z"){return "NA";}else{return "No";}}}}];}}this.dataList=[];if(this.hasChildren()){dojo.forEach(this.getChildren(),function(_1a){var _1b={attachment_id:_1a.get("attachment_id"),file_type:_1a.get("file_type"),file_title:_1a.get("file_title"),file_name:_1a.get("file_name"),file_status:_1a.get("file_status"),file_status_decoded:_1a.get("file_status_decoded"),file_access_dttm:_1a.get("file_access_dttm"),file_description:_1a.get("file_description"),fileact:_1a.get("fileact")};this.dataList.push(_1b);},this);}dojo.parser.parse(this.dialogId);this.inherited(arguments);},onGridCreate:function(){var _1c=this;dojo.connect(_1c.grid,"onSelected",function(_1d){_1c.grid.updateRow(_1d);});dojo.connect(_1c.grid,"onDeselected",function(_1e){_1c.grid.updateRow(_1e);});dojo.connect(_1c.grid,"onCellClick",function(evt){var t=evt.target;if(t.tagName.toLowerCase()=="input"&&t.type=="checkbox"){misys.isFormDirty=true;var _1f=t.checked?"addToSelection":"deselect";_1c.grid.selection[_1f](evt.rowIndex);}});_1c.grid.selection.clickSelectEvent=function(){};if(this.viewMode==="edit"&&((typeof deliveryChannelFileAct!=="undefined")&&(deliveryChannelFileAct!==false))){_1c.displayFileAct(true);}else{if(this.viewMode==="edit"){_1c.displayFileAct(false);}else{if((typeof deliveryChannelFileAct!=="undefined")&&(deliveryChannelFileAct)&&(this.attachmentGroup!=="summarybank")){_1c.displayFileAct(true);}else{_1c.displayFileAct(false);}}}},createDataGrid:function(){var _20=this.gridId;if(!_20){_20="grid-"+(this.xmlTagName?this.xmlTagName+"-":"")+dojox.uuid.generateRandomUuid();}this.grid=new misys.grid.DataGrid({jsId:_20,id:_20,store:this.store,structure:this.layout,autoHeight:true,selectionMode:"multiple",columnReordering:true,autoWidth:true,rowsPerpage:1000,initialWidth:"100%",canSort:function(_21){var _22=true;if(this.layout.cells){var _23=this.layout.cellCount;var _24=this.layout.cellCount;this.layout.cells.forEach(function(_25,_26){if(_25.name){if(_25.name===" "){_23=_26+1;}if(_25.name==="FileAct"){_24=_26+1;}}});_22=(Math.abs(_21)!==1&&Math.abs(_21)!==_23&&Math.abs(_21)!==_24);}return _22;},showMoveOptions:this.showMoveOptions},document.createElement("div"));this.grid.gridMultipleItemsWidget=this;misys.connect(this.grid,"onStyleRow",dojo.hitch(this,function(row){var _27=this.grid.getItem(row.index);if(_27&&_27.hasOwnProperty("is_valid")){var _28=dojo.isArray(_27.is_valid)?_27.is_valid[0]:_27.is_valid;if(_28&&_28!=="Y"){row.customStyles+="background-color: #F9F7BA !important";this.state="Error";}}this.grid.focus.styleRow(row);this.grid.edit.styleRow(row);}));this.addChild(this.grid);this.onGridCreate();},displayFileAct:function(_29){var _2a=this;if(_2a.grid.layout){dojo.forEach(_2a.grid.layout.cells,function(_2b,_2c){if(_2b&&_2b.name==="FileAct"&&_29){_2a.grid.layout.setColumnVisibility(_2b.index,true);_2a.fileActVisible=true;}else{if(_2b&&_2b.name==="FileAct"&&!_29){if(_2a.grid.selection){_2a.grid.selection.deselectAll();}_2a.grid.layout.setColumnVisibility(_2b.index,false);_2a.fileActVisible=false;}}});}}});}