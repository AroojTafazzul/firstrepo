/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["misys.openaccount.widget.Payments"]){dojo._hasResource["misys.openaccount.widget.Payments"]=true;dojo.provide("misys.openaccount.widget.Payments");dojo.experimental("misys.openaccount.widget.Payments");dojo.require("misys.openaccount.FormOpenAccountEvents");dojo.require("misys.grid.GridMultipleItems");dojo.require("misys.openaccount.widget.Payment");dojo.declare("misys.openaccount.widget.Payments",[misys.grid.GridMultipleItems],{data:{identifier:"store_id",label:"store_id",items:[]},templatePath:null,templateString:dojo.byId("payments-template")?dojo.byId("payments-template").innerHTML:"",dialogId:"payment-dialog-template",xmlTagName:"payments",xmlSubTagName:"payment",gridColumns:["code","label","other_paymt_terms","nb_days","cur_code","amt","pct"],propertiesMap:{ref_id:{_fieldName:"ref_id"},tnx_id:{_fieldName:"tnx_id"},payment_id:{_fieldName:"payment_id"},code:{_fieldName:"details_code"},label:{_fieldName:"details_label"},other_paymt_terms:{_fieldName:"details_other_paymt_terms"},nb_days:{_fieldName:"details_nb_days"},cur_code:{_fieldName:"details_cur_code"},amt:{_fieldName:"details_amt"},pct:{_fieldName:"details_pct"}},layout:[{name:"Payment Type",get:misys.getPaymentType,width:"35%"},{name:"Ccy",field:"cur_code",width:"15%"},{name:"Amount/Rate",field:"amt",get:misys.getPaymentAmountRate,width:"40%"},{name:" ",field:"actions",formatter:misys.grid.formatReportActions,width:"10%"}],getMandatoryProperties:function(_1){var _2=[];_2.push("code");_2.push(_1.amt==""?"pct":"amt");return _2;},startup:function(){this.dataList=[];if(this.hasChildren()){dojo.forEach(this.getChildren(),function(_3){if(_3.createItem){var _4=_3.createItem();this.dataList.push(_4);}},this);}this.inherited(arguments);},openDialogFromExistingItem:function(_5,_6){if(misys._config.displayMode==="view"){misys.disconnectById("details_amt");misys.disconnectById("details_pct");}this.inherited(arguments);},updateData:function(_7){this.inherited(arguments);if(dijit.byId("part_ship_2")&&dijit.byId("part_ship_2").get("checked")===true&&dijit.byId("add_payment_term_button")){dijit.byId("add_payment_term_button").set("disabled",true);}},resetDialog:function(_8,_9){this.inherited(arguments);if(dijit.byId("total_cur_code")){var _a=dijit.byId("total_cur_code").get("value");dijit.byId("details_cur_code").set("value",_a);}},addItem:function(_b){this.inherited(arguments);},performValidation:function(){if(this.validateDialog(true)){if((dijit.byId("details_pct")&&dijit.byId("details_pct").get("value")==="")&&(dijit.byId("details_amt")&&isNaN(dijit.byId("details_amt").get("value")))){misys.dialog.show("ERROR",misys.getLocalization("addAmtOrPercentage"));}else{if((dijit.byId("details_code")&&dijit.byId("details_code").get("value")==="")&&(dijit.byId("details_other_paymt_terms")&&dijit.byId("details_other_paymt_terms").get("value")==="")){misys.dialog.show("ERROR",misys.getLocalization("addPaymentTermCode"));}else{if(dijit.byId("total_net_amt")){var _c=0;var _d=0;var _e=parseFloat(dijit.byId("total_net_amt").get("value"));var _f=parseFloat(dijit.byId("details_amt").get("value"));var _10=(parseFloat(dijit.byId("details_pct").get("value"))/100)*_e;if(this.grid&&this.grid.store&&this.grid.store._arrayOfTopLevelItems){var _11=this.grid.gridMultipleItemsWidget.dialog.storeId;this.grid.store.fetch({query:{store_id:"*"},onComplete:dojo.hitch(this.grid,function(_12,_13){dojo.forEach(_12,function(_14){if(_11){if(_14.amt[0]!=""&&(_14.store_id[0]!=_11)){_c=_c+parseFloat(_14.amt[0].replace(",",""));}else{if(_14.pct[0]!=""&&(_14.store_id[0]!=_11)){_d=(parseFloat(_14.pct[0])/100)*_e;_c=_c+_d;}}}else{if(_14.amt[0]!=""){_c=_c+parseFloat(_14.amt[0].replace(",",""));}else{if(_14.pct[0]!=""){_d=(parseFloat(_14.pct[0])/100)*_e;_c=_c+_d;}}}});})});}if(_f===0||_10===0){misys.dialog.show("ERROR",misys.getLocalization("paymentAmtOrPercentageIsZero"));}else{if(_f&&(_c+_f>_e)){misys.dialog.show("ERROR",misys.getLocalization("paymentAmtOrPercentage"));}else{if(_10&&(_c+_10>_e)){misys.dialog.show("ERROR",misys.getLocalization("paymentAmtOrPercentage"));}else{this.inherited(arguments);}}}}}}}}});}