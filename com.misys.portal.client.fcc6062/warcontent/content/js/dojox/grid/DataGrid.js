/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojox.grid.DataGrid"]){dojo._hasResource["dojox.grid.DataGrid"]=true;dojo.provide("dojox.grid.DataGrid");dojo.require("dojox.grid._Grid");dojo.require("dojox.grid.DataSelection");dojo.declare("dojox.grid.DataGrid",dojox.grid._Grid,{store:null,query:null,queryOptions:null,fetchText:"...",sortFields:null,updateDelay:1,items:null,_store_connects:null,_by_idty:null,_by_idx:null,_cache:null,_pages:null,_pending_requests:null,_bop:-1,_eop:-1,_requests:0,rowCount:0,_isLoaded:false,_isLoading:false,postCreate:function(){this._pages=[];this._store_connects=[];this._by_idty={};this._by_idx=[];this._cache=[];this._pending_requests={};this._setStore(this.store);this.inherited(arguments);},createSelection:function(){this.selection=new dojox.grid.DataSelection(this);},get:function(_1,_2){if(_2&&this.field=="_item"&&!this.fields){return _2;}else{if(_2&&this.fields){var _3=[];var s=this.grid.store;dojo.forEach(this.fields,function(f){_3=_3.concat(s.getValues(_2,f));});return _3;}else{if(!_2&&typeof _1==="string"){return this.inherited(arguments);}}}return (!_2?this.defaultValue:(!this.field?this.value:(this.field=="_item"?_2:this.grid.store.getValue(_2,this.field))));},_checkUpdateStatus:function(){if(this.updateDelay>0){var _4=false;if(this._endUpdateDelay){clearTimeout(this._endUpdateDelay);delete this._endUpdateDelay;_4=true;}if(!this.updating){this.beginUpdate();_4=true;}if(_4){var _5=this;this._endUpdateDelay=setTimeout(function(){delete _5._endUpdateDelay;_5.endUpdate();},this.updateDelay);}}},_onSet:function(_6,_7,_8,_9){this._checkUpdateStatus();var _a=this.getItemIndex(_6);if(_a>-1){this.updateRow(_a);}},_createItem:function(_b,_c){var _d=this._hasIdentity?this.store.getIdentity(_b):dojo.toJson(this.query)+":idx:"+_c+":sort:"+dojo.toJson(this.getSortProps());var o=this._by_idty[_d]={idty:_d,item:_b};return o;},_addItem:function(_e,_f,_10){this._by_idx[_f]=this._createItem(_e,_f);if(!_10){this.updateRow(_f);}},_onNew:function(_11,_12){this._checkUpdateStatus();var _13=this.get("rowCount");this._addingItem=true;this.updateRowCount(_13+1);this._addingItem=false;this._addItem(_11,_13);this.showMessage();},_onDelete:function(_14){this._checkUpdateStatus();var idx=this._getItemIndex(_14,true);if(_14.attachment_id){var _15=false;misys.xhrPost({url:misys.getServletURL("/screen/AjaxScreen/action/DeleteAttachmentById"),handleAs:"json",sync:true,content:{attachmentId:_14.attachment_id},load:function(_16,_17){_15=_16.isDeleted;_isError=false;},error:function(_18,_19){console.error("Technical error while deleting attachment");console.error(_18);_isError=true;misys._config=misys._config||{};}});}if(idx>=0){this._pages=[];this._bop=-1;this._eop=-1;var o=this._by_idx[idx];this._by_idx.splice(idx,1);delete this._by_idty[o.idty];this.updateRowCount(this.get("rowCount")-1);if(this.get("rowCount")===0){this.showMessage(this.noDataMessage);}}},_onRevert:function(){this._refresh();},setStore:function(_1a,_1b,_1c){this._setQuery(_1b,_1c);this._setStore(_1a);this._refresh(true);},setQuery:function(_1d,_1e){this._setQuery(_1d,_1e);this._refresh(true);},setItems:function(_1f){this.items=_1f;this._setStore(this.store);this._refresh(true);},_setQuery:function(_20,_21){this.query=_20;this.queryOptions=_21||this.queryOptions;},_setStore:function(_22){if(this.store&&this._store_connects){dojo.forEach(this._store_connects,this.disconnect,this);}this.store=_22;if(this.store){var f=this.store.getFeatures();var h=[];this._canEdit=!!f["dojo.data.api.Write"]&&!!f["dojo.data.api.Identity"];this._hasIdentity=!!f["dojo.data.api.Identity"];if(!!f["dojo.data.api.Notification"]&&!this.items){h.push(this.connect(this.store,"onSet","_onSet"));h.push(this.connect(this.store,"onNew","_onNew"));h.push(this.connect(this.store,"onDelete","_onDelete"));}if(this._canEdit){h.push(this.connect(this.store,"revert","_onRevert"));}this._store_connects=h;}},_onFetchBegin:function(_23,req){if(!this.scroller){return;}if(this.rowCount!=_23){if(req.isRender){this.scroller.init(_23,this.keepRows,this.rowsPerPage);this.rowCount=_23;this._setAutoHeightAttr(this.autoHeight,true);this._skipRowRenormalize=true;this.prerender();this._skipRowRenormalize=false;}else{this.updateRowCount(_23);}}if(_23<1){this.views.render();this._resize();this.showMessage(this.noDataMessage);this.focus.initFocusView();}else{this.showMessage();}},_onFetchComplete:function(_24,req){if(!this.scroller){return;}if(_24&&_24.length>0){dojo.forEach(_24,function(_25,idx){this._addItem(_25,req.start+idx,true);},this);this.updateRows(req.start,_24.length);if(req.isRender){this.setScrollTop(0);this.postrender();}else{if(this._lastScrollTop){this.setScrollTop(this._lastScrollTop);}}}delete this._lastScrollTop;if(!this._isLoaded){this._isLoading=false;this._isLoaded=true;}this._pending_requests[req.start]=false;},_onFetchError:function(err,req){delete this._lastScrollTop;if(!this._isLoaded){this._isLoading=false;this._isLoaded=true;this.showMessage(this.errorMessage);}this._pending_requests[req.start]=false;this.onFetchError(err,req);},onFetchError:function(err,req){},_fetch:function(_26,_27){_26=_26||0;if(this.store&&!this._pending_requests[_26]){if(!this._isLoaded&&!this._isLoading){this._isLoading=true;this.showMessage(this.loadingMessage);}this._pending_requests[_26]=true;try{if(this.items){var _28=this.items;var _29=this.store;this.rowsPerPage=_28.length;var req={start:_26,count:this.rowsPerPage,isRender:_27};this._onFetchBegin(_28.length,req);var _2a=0;dojo.forEach(_28,function(i){if(!_29.isItemLoaded(i)){_2a++;}});if(_2a===0){this._onFetchComplete(_28,req);}else{var _2b=function(_2c){_2a--;if(_2a===0){this._onFetchComplete(_28,req);}};dojo.forEach(_28,function(i){if(!_29.isItemLoaded(i)){_29.loadItem({item:i,onItem:_2b,scope:this});}},this);}}else{this.store.fetch({start:_26,count:this.rowsPerPage,query:this.query,sort:this.getSortProps(),queryOptions:this.queryOptions,isRender:_27,onBegin:dojo.hitch(this,"_onFetchBegin"),onComplete:dojo.hitch(this,"_onFetchComplete"),onError:dojo.hitch(this,"_onFetchError")});}}catch(e){this._onFetchError(e,{start:_26,count:this.rowsPerPage});}}},_clearData:function(){this.updateRowCount(0);this._by_idty={};this._by_idx=[];this._pages=[];this._bop=this._eop=-1;this._isLoaded=false;this._isLoading=false;},getItem:function(idx){var _2d=this._by_idx[idx];if(!_2d||(_2d&&!_2d.item)){this._preparePage(idx);return null;}return _2d.item;},getItemIndex:function(_2e){return this._getItemIndex(_2e,false);},_getItemIndex:function(_2f,_30){if(!_30&&!this.store.isItem(_2f)){return -1;}var _31=this._hasIdentity?this.store.getIdentity(_2f):null;for(var i=0,l=this._by_idx.length;i<l;i++){var d=this._by_idx[i];if(d&&((_31&&d.idty==_31)||(d.item===_2f))){return i;}}return -1;},filter:function(_32,_33){this.query=_32;if(_33){this._clearData();}this._fetch();},_getItemAttr:function(idx,_34){var _35=this.getItem(idx);return (!_35?this.fetchText:this.store.getValue(_35,_34));},_render:function(){if(this.domNode.parentNode){this.scroller.init(this.get("rowCount"),this.keepRows,this.rowsPerPage);this.prerender();this._fetch(0,true);}},_requestsPending:function(_36){return this._pending_requests[_36];},_rowToPage:function(_37){return (this.rowsPerPage?Math.floor(_37/this.rowsPerPage):_37);},_pageToRow:function(_38){return (this.rowsPerPage?this.rowsPerPage*_38:_38);},_preparePage:function(_39){if((_39<this._bop||_39>=this._eop)&&!this._addingItem){var _3a=this._rowToPage(_39);this._needPage(_3a);this._bop=_3a*this.rowsPerPage;this._eop=this._bop+(this.rowsPerPage||this.get("rowCount"));}},_needPage:function(_3b){if(!this._pages[_3b]){this._pages[_3b]=true;this._requestPage(_3b);}},_requestPage:function(_3c){var row=this._pageToRow(_3c);var _3d=Math.min(this.rowsPerPage,this.get("rowCount")-row);if(_3d>0){this._requests++;if(!this._requestsPending(row)){setTimeout(dojo.hitch(this,"_fetch",row,false),1);}}},getCellName:function(_3e){return _3e.field;},_refresh:function(_3f){this._clearData();this._fetch(0,_3f);},sort:function(){this.edit.apply();this._lastScrollTop=this.scrollTop;this._refresh();},canSort:function(){return (!this._isLoading);},getSortProps:function(){var c=this.getCell(this.getSortIndex());if(!c){if(this.sortFields){return this.sortFields;}return null;}else{var _40=c["sortDesc"];var si=!(this.sortInfo>0);if(typeof _40=="undefined"){_40=si;}else{_40=si?!_40:_40;}return [{attribute:c.field,descending:_40}];}},styleRowState:function(_41){if(this.store&&this.store.getState){var _42=this.store.getState(_41.index),c="";for(var i=0,ss=["inflight","error","inserting"],s;s=ss[i];i++){if(_42[s]){c=" dojoxGridRow-"+s;break;}}_41.customClasses+=c;}},onStyleRow:function(_43){this.styleRowState(_43);this.inherited(arguments);},canEdit:function(_44,_45){return this._canEdit;},_copyAttr:function(idx,_46){var row={};var _47={};var src=this.getItem(idx);return this.store.getValue(src,_46);},doStartEdit:function(_48,_49){if(!this._cache[_49]){this._cache[_49]=this._copyAttr(_49,_48.field);}this.onStartEdit(_48,_49);},doApplyCellEdit:function(_4a,_4b,_4c){this.store.fetchItemByIdentity({identity:this._by_idx[_4b].idty,onItem:dojo.hitch(this,function(_4d){var _4e=this.store.getValue(_4d,_4c);if(typeof _4e=="number"){_4a=isNaN(_4a)?_4a:parseFloat(_4a);}else{if(typeof _4e=="boolean"){_4a=_4a=="true"?true:_4a=="false"?false:_4a;}else{if(_4e instanceof Date){var _4f=new Date(_4a);_4a=isNaN(_4f.getTime())?_4a:_4f;}}}this.store.setValue(_4d,_4c,_4a);this.onApplyCellEdit(_4a,_4b,_4c);})});},doCancelEdit:function(_50){var _51=this._cache[_50];if(_51){this.updateRow(_50);delete this._cache[_50];}this.onCancelEdit.apply(this,arguments);},doApplyEdit:function(_52,_53){var _54=this._cache[_52];this.onApplyEdit(_52);},removeSelectedRows:function(){if(this._canEdit){this.edit.apply();var fx=dojo.hitch(this,function(_55){if(_55.length){dojo.forEach(_55,this.store.deleteItem,this.store);this.selection.clear();}});if(this.allItemsSelected){this.store.fetch({query:this.query,queryOptions:this.queryOptions,onComplete:fx});}else{fx(this.selection.getSelected());}}}});dojox.grid.DataGrid.cell_markupFactory=function(_56,_57,_58){var _59=dojo.trim(dojo.attr(_57,"field")||"");if(_59){_58.field=_59;}_58.field=_58.field||_58.name;var _5a=dojo.trim(dojo.attr(_57,"fields")||"");if(_5a){_58.fields=_5a.split(",");}if(_56){_56(_57,_58);}};dojox.grid.DataGrid.markupFactory=function(_5b,_5c,_5d,_5e){return dojox.grid._Grid.markupFactory(_5b,_5c,_5d,dojo.partial(dojox.grid.DataGrid.cell_markupFactory,_5e));};}